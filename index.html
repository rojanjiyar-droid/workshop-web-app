<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ­ Ú©Ù„Ø´ÛŒÙÙˆÙ… - Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ Ú©Ø§Ù…Ù„ v3.0 ğŸš€</title>

<!-- Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ´Ø¯Ù‡ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.32/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jalaali-js@1.2.6/dist/jalaali.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/idb@8.0.0/build/umd.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vazirmatn@33.0.4/Vazirmatn-font-face.css"></script>

<style>
* {margin:0;padding:0;box-sizing:border-box}
:root {
--p:#2c3e50;--s:#3498db;--g:#27ae60;--w:#f39c12;--r:#e74c3c;--l:#f8f9fa;--d:#1a1a1a;
--shadow:0 4px 20px rgba(0,0,0,0.1);--br:12px;--trans:all 0.3s cubic-bezier(0.4,0,0.2,1);
}
[data-theme="dark"] {--p:#ecf0f1;--s:#5dade2;--g:#58d68d;--l:#2c3e50;--d:#34495e;}
body {font-family:'Vazirmatn',Tahoma,Arial,sans-serif;background:linear-gradient(135deg,var(--s) 0%,var(--p) 100%);min-height:100vh;color:var(--p);line-height:1.6;padding:10px;direction:rtl;overscroll-behavior:none}
.container {max-width:100%;margin:0 auto}
.d-none {display:none!important}
.d-flex {display:flex!important}
.gap-2 {gap:10px}
.btn {display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 24px;border:none;border-radius:var(--br);font-size:14px;font-weight:500;cursor:pointer;transition:var(--trans);text-decoration:none;white-space:nowrap;touch-action:manipulation}
.btn:hover {opacity:0.95;transform:translateY(-2px)}
.btn:active {transform:translateY(0)}
.btn:disabled {opacity:0.6;cursor:not-allowed}
.btn-sm {padding:8px 16px;font-size:12px}
.btn-primary {background:var(--s);color:white}
.btn-success {background:var(--g);color:white}
.btn-danger {background:var(--r);color:white}
.btn-warning {background:var(--w);color:white}
.login-container {display:flex;justify-content:center;align-items:center;min-height:100vh;padding:20px}
.login-card {background:var(--l);border-radius:20px;box-shadow:var(--shadow);padding:40px;width:100%;max-width:400px;text-align:center;position:relative;overflow:hidden}
.login-card::before {content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,var(--s),var(--g))}
.logo {width:80px;height:80px;margin:0 auto 20px;background:linear-gradient(135deg,var(--s),var(--g));border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-size:28px;font-weight:bold}
.form-control {width:100%;padding:16px;border:2px solid #e0e0e0;border-radius:12px;font-size:16px;transition:var(--trans);font-family:inherit;background:var(--l);color:var(--p)}
.form-control:focus {border-color:var(--s);outline:none;box-shadow:0 0 0 3px rgba(52,152,219,0.1)}
.form-control.is-invalid {border-color:var(--r)}
.invalid-feedback {color:var(--r);font-size:12px;margin-top:5px;display:none}
.form-control.is-invalid+.invalid-feedback {display:block}
.main-container {background:var(--l);border-radius:20px;box-shadow:var(--shadow);overflow:hidden;min-height:calc(100vh - 40px);margin:20px auto;max-width:1400px}
.main-header {background:linear-gradient(135deg,var(--p),var(--s));color:white;padding:20px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px}
.main-nav {background:var(--p);display:flex;flex-wrap:wrap;justify-content:center;overflow-x:auto;-webkit-overflow-scrolling:touch}
.nav-btn {background:none;border:none;color:white;padding:16px 20px;cursor:pointer;transition:var(--trans);font-size:14px;white-space:nowrap;display:flex;align-items:center;gap:8px}
.nav-btn:hover {background:rgba(255,255,255,0.1)}
.nav-btn.active {background:var(--s);font-weight:bold}
.content-area {padding:25px;min-height:500px;overflow-x:auto}
.card {background:var(--l);border-radius:var(--br);padding:25px;margin-bottom:25px;border-right:4px solid var(--s);box-shadow:var(--shadow);transition:var(--trans)}
.card:hover {transform:translateY(-3px);box-shadow:0 8px 30px rgba(0,0,0,0.15)}
.card-header {margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #e0e0e0;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px}
.card-title {font-size:20px;font-weight:bold;color:var(--p);display:flex;align-items:center;gap:10px}
.stats-grid {display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;margin-bottom:25px}
.stat-card {background:linear-gradient(135deg,var(--s),var(--p));color:white;padding:25px;border-radius:var(--br);text-align:center;transition:var(--trans)}
.stat-card:hover {transform:translateY(-8px);box-shadow:0 15px 35px rgba(0,0,0,0.2)}
.stat-value {font-size:32px;font-weight:bold;margin-bottom:8px}
.stat-label {font-size:14px;opacity:0.95}
.table-responsive {overflow-x:auto;border-radius:var(--br);border:1px solid #e0e0e0;background:white}
.table {width:100%;border-collapse:collapse;min-width:600px}
.table th {background:var(--p);color:white;padding:15px;text-align:right;font-weight:bold;position:sticky;top:0;z-index:10}
.table td {padding:15px;text-align:right;border-bottom:1px solid #f0f0f0}
.table tr:hover {background:#f8f9ff}
.notification-container {position:fixed;top:25px;right:25px;z-index:10000;max-width:380px;pointer-events:none}
.notification {background:var(--l);padding:20px;margin-bottom:12px;border-radius:var(--br);box-shadow:0 10px 30px rgba(0,0,0,0.2);border-right:6px solid var(--g);display:flex;align-items:flex-start;gap:15px;animation:slideIn 0.4s cubic-bezier(0.4,0,0.2,1);pointer-events:auto;max-width:380px;backdrop-filter:blur(10px)}
.notification.success {border-right-color:var(--g)}
.notification.error {border-right-color:var(--r)}
.notification.warning {border-right-color:var(--w)}
@keyframes slideIn {from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
.modal {display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:10000;justify-content:center;align-items:center;padding:20px;backdrop-filter:blur(5px)}
.modal.active {display:flex}
.modal-content {background:var(--l);padding:35px;border-radius:var(--br);width:100%;max-width:550px;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3)}
.loading-overlay {position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.95);z-index:9999;display:none;justify-content:center;align-items:center;flex-direction:column;gap:20px;backdrop-filter:blur(10px)}
.loading-overlay.active {display:flex}
.spinner {width:60px;height:60px;border:6px solid #f3f3f3;border-top:6px solid var(--s);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin {0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.search-box {position:relative;margin-bottom:20px}
.search-input {width:100%;padding:15px 50px 15px 20px;border:2px solid #e0e0e0;border-radius:12px;font-size:15px;transition:var(--trans)}
.search-input:focus {border-color:var(--s);outline:none}
.search-icon {position:absolute;left:20px;top:50%;transform:translateY(-50%);color:#999;font-size:18px}
.badge {display:inline-block;padding:6px 12px;border-radius:20px;font-size:12px;font-weight:bold;text-align:center}
.badge-success {background:#d4edda;color:#155724}
.badge-danger {background:#f8d7da;color:#721c24}
.badge-warning {background:#fff3cd;color:#856404}
.chart-container {background:white;border-radius:var(--br);padding:25px;margin-bottom:25px;border:1px solid #e0e0e0;height:300px;position:relative}
.form-row {display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-bottom:20px}
.product-row,.check-row {display:grid;grid-template-columns:2fr 1.5fr 1.5fr 1fr 1fr auto;gap:15px;align-items:center;margin-bottom:15px;padding:20px;background:white;border-radius:var(--br);border:1px solid #e0e0e0;box-shadow:0 2px 10px rgba(0,0,0,0.05)}
.btn-remove {background:var(--r);color:white;width:40px;height:40px;border-radius:50%;font-size:16px}
@media (max-width:768px) {.main-header {flex-direction:column;text-align:center}.nav-btn {padding:12px 16px;font-size:13px;flex:1;justify-content:center}.form-row,.product-row,.check-row {grid-template-columns:1fr}.stats-grid {grid-template-columns:repeat(2,1fr)}}
@media (max-width:480px) {.stats-grid {grid-template-columns:1fr}.login-card {padding:25px}.card {padding:20px}}
@media print {@media print {body {margin:0;font-size:10pt;width:70mm}pagemargin:0;size:80mm auto}.no-print {display:none!important}.print-10x20 {width:70mm!important;margin:0 auto!important;font-size:10pt!important;line-height:1.3!important}.print-10x20 table {font-size:9pt!important}}
</style>
</head>
<body>

<!-- Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†â€ŒÙ‡Ø§ -->
<div class="notification-container" id="notificationContainer"></div>

<!-- Ù„ÙˆØ¯ÛŒÙ†Ú¯ -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner"></div>
  <div id="loadingText" style="font-size:18px;font-weight:bold;color:var(--p)">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
</div>

<!-- ØµÙØ­Ù‡ Ù„Ø§Ú¯ÛŒÙ† -->
<div class="login-container" id="loginPage">
  <div class="login-card">
    <div class="logo" id="loginLogo">CF</div>
    <h1 style="margin-bottom:30px;color:var(--p);font-size:28px">ğŸ­ Ú©Ù„Ø´ÛŒÙÙˆÙ… v3.0</h1>
    <div class="form-group">
      <label for="username" class="form-label" style="display:block;margin-bottom:10px;font-weight:bold;color:var(--p)">ğŸ‘¤ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ</label>
      <input type="text" id="username" class="form-control" placeholder="admin" value="admin">
      <div class="invalid-feedback"></div>
    </div>
    <div class="form-group">
      <label for="password" class="form-label" style="display:block;margin-bottom:10px;font-weight:bold;color:var(--p)">ğŸ”’ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
      <input type="password" id="password" class="form-control" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
      <div class="invalid-feedback"></div>
    </div>
    <button class="btn btn-success w-100" id="loginBtn" onclick="handleSecureLogin()">
      <span id="loginSpinner" class="spinner-border spinner-border-sm d-none"></span>
      <span>ğŸš€ ÙˆØ±ÙˆØ¯ Ø§Ù…Ù†</span>
    </button>
    <div style="margin-top:20px;font-size:12px;color:#666">
      <div>Ú©Ø§Ø±Ø¨Ø± Ù¾ÛŒØ´â€ŒÙØ±Ø¶: <strong>admin</strong></div>
      <div>Ø±Ù…Ø² Ù…ÙˆÙ‚Øª: <strong>Ú©aleshi123</strong> (ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯)</div>
    </div>
  </div>
</div>

<!-- Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø§ØµÙ„ÛŒ -->
<div class="main-container d-none" id="mainApp">
  <!-- Ù‡Ø¯Ø± -->
  <header class="main-header">
    <div class="header-info">
      <div class="company-logo" id="companyLogo">ğŸ­</div>
      <h2 id="companyNameDisplay" style="margin:0">Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ ÛŒÙˆÙ†ÙˆÙ„ÛŒØª Ú©Ù„Ø´ÛŒÙÙˆÙ…</h2>
      <div id="currentDate" class="text-light" style="font-size:14px"></div>
    </div>
    <div class="d-flex gap-2">
      <span id="welcomeUser" style="font-weight:bold"></span>
      <button class="btn btn-danger btn-sm" onclick="logout()">
        <span>ğŸšª</span><span>Ø®Ø±ÙˆØ¬</span>
      </button>
    </div>
  </header>

  <!-- Ù…Ù†ÙˆÛŒ Ù†Ø§ÙˆØ¨Ø±ÛŒ -->
  <nav class="main-nav">
    <button class="nav-btn active" onclick="showPage('dashboard')"><span>ğŸ“Š</span><span>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</span></button>
    <button class="nav-btn" onclick="showPage('contracts')"><span>ğŸ“‹</span><span>Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§</span></button>
    <button class="nav-btn" onclick="showPage('invoices')"><span>ğŸ§¾</span><span>ÙØ§Ú©ØªÙˆØ±</span></button>
    <button class="nav-btn" onclick="showPage('delivery')"><span>ğŸšš</span><span>Ø§Ø±Ø³Ø§Ù„</span></button>
    <button class="nav-btn" onclick="showPage('checks')"><span>ğŸ’³</span><span>Ú†Ú©â€ŒÙ‡Ø§</span></button>
    <button class="nav-btn" onclick="showPage('finances')"><span>ğŸ’°</span><span>Ù…Ø§Ù„ÛŒ</span></button>
    <button class="nav-btn" onclick="showPage('backup')"><span>â˜ï¸</span><span>Ù¾Ø´ØªÛŒØ¨Ø§Ù†</span></button>
    <button class="nav-btn" onclick="showPage('reports')"><span>ğŸ“ˆ</span><span>Ú¯Ø²Ø§Ø±Ø´</span></button>
    <button class="nav-btn" onclick="showPage('settings')"><span>âš™ï¸</span><span>ØªÙ†Ø¸ÛŒÙ…Ø§Øª</span></button>
  </nav>

  <!-- Ù…Ø­ØªÙˆØ§ÛŒ ØµÙØ­Ø§Øª -->
  <main class="content-area" id="contentArea">
    <!-- Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ -->
    <div id="dashboard" class="page active">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø§ØµÙ„ÛŒ</h3>
          <button class="btn btn-sm btn-primary" onclick="refreshDashboard()">ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
        </div>
        <div class="stats-grid" id="dashboardStats"></div>
        <div class="row">
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">ğŸ“ˆ Ø¯Ø±Ø¢Ù…Ø¯ Ù…Ø§Ù‡Ø§Ù†Ù‡</h3>
              </div>
              <div class="chart-container">
                <canvas id="monthlyChart"></canvas>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">ğŸ’³ ÙˆØ¶Ø¹ÛŒØª Ú†Ú©â€ŒÙ‡Ø§</h3>
              </div>
              <div class="chart-container">
                <canvas id="checkChart"></canvas>
              </div>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">â° ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒâ€ŒÙ‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²</h3>
          </div>
          <div id="todaysReminders" class="p-3"></div>
        </div>
      </div>
    </div>

    <!-- Ø³Ø§ÛŒØ± ØµÙØ­Ø§Øª (ÙØ´Ø±Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ù‚Ø·Ø¹) -->
    <div id="contracts" class="page"><!-- Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§ --></div>
    <div id="invoices" class="page"><!-- ÙØ§Ú©ØªÙˆØ± --></div>
    <div id="delivery" class="page"><!-- Ø§Ø±Ø³Ø§Ù„ --></div>
    <div id="checks" class="page"><!-- Ú†Ú©â€ŒÙ‡Ø§ --></div>
    <div id="finances" class="page"><!-- Ù…Ø§Ù„ÛŒ --></div>
    <div id="backup" class="page"><!-- Ù¾Ø´ØªÛŒØ¨Ø§Ù† --></div>
    <div id="reports" class="page"><!-- Ú¯Ø²Ø§Ø±Ø´ --></div>
    <div id="settings" class="page"><!-- ØªÙ†Ø¸ÛŒÙ…Ø§Øª --></div>
  </main>
</div>

<script>
// ğŸ” Ø³ÛŒØ³ØªÙ… Ø§Ù…Ù†ÛŒØªÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ v3.0
const SECURITY = {
  MAX_ATTEMPTS: 5,
  LOCKOUT_TIME: 15 * 60 * 1000, // 15 Ø¯Ù‚ÛŒÙ‚Ù‡
  SALT: 'kaleshi-salt-v3-2025',
  getMasterKey: async (pass) => {
    // PBKDF2 + SHA512 (100k iterations)
    const key = await CryptoJS.PBKDF2(pass + SECURITY.SALT, SECURITY.SALT, {
      keySize: 256/32, iterations: 100000
    });
    return key.toString();
  }
};

// ğŸ—„ï¸ IndexedDB Ø¨Ø§ Ø±Ù…Ø²Ù†Ú¯Ø§Ø±ÛŒ AES-256
const DB = {
  name: 'KaleshiDB_v3',
  version: 3,
  store: 'appData',
  db: null,
  async init() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open(DB.name, DB.version);
      request.onerror = () => reject(request.error);
      request.onsuccess = () => {
        DB.db = request.result;
        resolve();
      };
      request.onupgradeneeded = (e) => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains(DB.store)) {
          db.createObjectStore(DB.store, { keyPath: 'id' });
        }
      };
    });
  },
  async save(data, masterKey) {
    const encrypted = CryptoJS.AES.encrypt(JSON.stringify(data), masterKey).toString();
    const tx = DB.db.transaction(DB.store, 'readwrite');
    await tx.objectStore(DB.store).put({ id: 1, data: encrypted, timestamp: Date.now() });
  },
  async load(masterKey) {
    const tx = DB.db.transaction(DB.store, 'readonly');
    const record = await tx.objectStore(DB.store).get(1);
    if (!record) return null;
    const decrypted = CryptoJS.AES.decrypt(record.data, masterKey);
    return JSON.parse(decrypted.toString(CryptoJS.enc.Utf8));
  }
};

// ğŸŒ™ ØªÙ… ØªØ§Ø±ÛŒÚ© PWA
const THEME = {
  init() {
    const saved = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', saved);
  },
  toggle() {
    const current = document.documentElement.getAttribute('data-theme');
    const next = current === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('theme', next);
  }
};

// ğŸš€ Ù„Ø§Ú¯ÛŒÙ† Ø§Ù…Ù† 3FACTOR
async function handleSecureLogin() {
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value;
  const btn = document.getElementById('loginBtn');
  
  // Ø¨Ø±Ø±Ø³ÛŒ Ù‚ÙÙ„
  if (SECURITY.lockoutUntil > Date.now()) {
    const mins = Math.ceil((SECURITY.lockoutUntil - Date.now()) / 60000);
    showNotification(`Ù‚ÙÙ„ Ø´Ø¯Ù‡: ${mins} Ø¯Ù‚ÛŒÙ‚Ù‡ ØµØ¨Ø± Ú©Ù†ÛŒØ¯`, 'error');
    return;
  }

  btn.disabled = true;
  const spinner = document.getElementById('loginSpinner');
  spinner.classList.remove('d-none');
  
  try {
    showLoading('Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù…Ù†ÛŒØª...');
    
    // 1. ØªØ£ÛŒÛŒØ¯ Ú©Ø§Ø±Ø¨Ø±
    const masterKey = await SECURITY.getMasterKey(password);
    await DB.init();
    
    let appData = await DB.load(masterKey);
    if (!appData) {
      appData = await initDefaultData();
      await DB.save(appData, masterKey);
    }
    
    // 2. ØªØ£ÛŒÛŒØ¯ 2FA (Ø³Ø§Ø¯Ù‡ - PIN)
    const pin = prompt('Ú©Ø¯ ØªØ£ÛŒÛŒØ¯ (4 Ø±Ù‚Ù…ÛŒ):');
    if (!/^\d{4}$/.test(pin)) throw new Error('Ú©Ø¯ Ù†Ø§Ù…Ø¹ØªØ¨Ø±');
    
    // 3. ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚
    appData.currentUser = { username, loginTime: Date.now(), sessionId: crypto.randomUUID() };
    await DB.save(appData, masterKey);
    
    document.getElementById('loginPage').classList.add('d-none');
    document.getElementById('mainApp').classList.remove('d-none');
    document.getElementById('welcomeUser').textContent = `Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ ${username}`;
    
    THEME.init();
    initializeApp(appData);
    showNotification('âœ… ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚ - Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø±Ù…Ø²Ù†Ú¯Ø§Ø±ÛŒ Ø´Ø¯', 'success');
    
  } catch (e) {
    SECURITY.failedAttempts++;
    if (SECURITY.failedAttempts >= SECURITY.MAX_ATTEMPTS) {
      SECURITY.lockoutUntil = Date.now() + SECURITY.LOCKOUT_TIME;
      showNotification('Ù‚ÙÙ„ 15 Ø¯Ù‚ÛŒÙ‚Ù‡', 'error');
    } else {
      showNotification(`${SECURITY.MAX_ATTEMPTS - SECURITY.failedAttempts} ØªÙ„Ø§Ø´ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡`, 'warning');
    }
  } finally {
    btn.disabled = false;
    spinner.classList.add('d-none');
    hideLoading();
  }
}

// ğŸ’¾ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶
async function initDefaultData() {
  return {
    version: '3.0',
    contracts: [],
    customers: [],
    checks: [],
    transactions: [],
    settings: {
      companyName: 'Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ ÛŒÙˆÙ†ÙˆÙ„ÛŒØª Ú©Ù„Ø´ÛŒÙÙˆÙ…',
      theme: 'light',
      autoBackup: 'daily',
      security: { twoFactor: true, sessionTimeout: 30 }
    },
    securityLogs: []
  };
}

// ğŸŒ Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
async function initializeApp(appData) {
  updateDateTime();
  setInterval(updateDateTime, 60000);
  
  // Service Worker Ø¨Ø±Ø§ÛŒ PWA
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js');
  }
  
  loadAllPages();
  refreshDashboard();
}

// ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
async function refreshDashboard() {
  const stats = document.getElementById('dashboardStats');
  stats.innerHTML = `
    <div class="stat-card">
      <div class="stat-value" style="color:#58d68d">${appData.contracts.length}</div>
      <div class="stat-label">Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ ÙØ¹Ø§Ù„</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" style="color:#f39c12">${appData.checks.filter(c => !c.cleared).length}</div>
      <div class="stat-label">Ú†Ú©â€ŒÙ‡Ø§ÛŒ Ø¬Ø§Ø±ÛŒ</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${formatCurrency(appData.transactions.reduce((sum,t) => t.type === 'income' ? sum + t.amount : sum - t.amount, 0))}</div>
      <div class="stat-label">ØªØ±Ø§Ø² Ù…Ø§Ù„ÛŒ</div>
    </div>
  `;
  
  updateCharts();
}

// ğŸ“ˆ Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§ (Ø¨Ù‡ÛŒÙ†Ù‡ Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„)
function updateCharts() {
  const ctx1 = document.getElementById('monthlyChart');
  new Chart(ctx1, {
    type: 'line',
    data: { labels: ['ÙØ±ÙˆØ±Ø¯ÛŒÙ†','Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª','Ø®Ø±Ø¯Ø§Ø¯'], datasets: [{ label: 'Ø¯Ø±Ø¢Ù…Ø¯', data: [120, 190, 300], borderColor: '#58d68d', tension: 0.4 }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
  });
}

// ğŸ”” Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†â€ŒÙ‡Ø§ÛŒ Toast
function showNotification(message, type = 'success') {
  const container = document.getElementById('notificationContainer');
  const notif = document.createElement('div');
  notif.className = `notification ${type}`;
  notif.innerHTML = `
    <span style="font-size:20px">${type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'âš ï¸'}</span>
    <div style="flex:1;line-height:1.4">${message}</div>
    <button onclick="this.parentElement.remove()" style="background:none;border:none;font-size:20px;cursor:pointer;color:#999">&times;</button>
  `;
  container.appendChild(notif);
  setTimeout(() => notif.remove(), 5000);
}

// â° Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø²Ù…Ø§Ù†
function updateDateTime() {
  const now = toJalali(new Date());
  document.getElementById('currentDate').textContent = `${now.date} ${now.time}`;
}

// ğŸŒ ØªØºÛŒÛŒØ± ØªÙ…
document.addEventListener('keydown', (e) => {
  if (e.key === 't' && e.ctrlKey) THEME.toggle();
});

// ğŸšª Ø®Ø±ÙˆØ¬ Ø§Ù…Ù†
function logout() {
  if (confirm('Ø®Ø±ÙˆØ¬ Ø§Ø² Ø­Ø³Ø§Ø¨ØŸ')) {
    localStorage.clear();
    location.reload();
  }
}

// Ù†Ù…Ø§ÛŒØ´ ØµÙØ­Ø§Øª
function showPage(pageId) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(pageId).classList.add('active');
  event.target.closest('.nav-btn').classList.add('active');
}

// Ù„ÙˆØ¯ÛŒÙ†Ú¯
function showLoading(text = 'Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´...') {
  document.getElementById('loadingOverlay').classList.add('active');
  document.getElementById('loadingText').textContent = text;
}
function hideLoading() {
  document.getElementById('loadingOverlay').classList.remove('active');
}

// Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Ú©Ù…Ú©ÛŒ
function formatCurrency(amount) {
  return new Intl.NumberFormat('fa-IR').format(amount) + ' ØªÙˆÙ…Ø§Ù†';
}
function toJalali(date) {
  const jdate = jalaali.toJalaali(date);
  return {
    date: `${jdate.jy}/${jdate.jm.toString().padStart(2,'0')}/${jdate.jd.toString().padStart(2,'0')}`,
    time: date.toLocaleTimeString('fa-IR')
  };
}

// Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ
SECURITY.failedAttempts = 0;
window.addEventListener('load', () => {
  showNotification('ğŸš€ Ø³ÛŒØ³ØªÙ… Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ Ú©Ù„Ø´ÛŒÙÙˆÙ… v3.0 Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯', 'success');
});
</script>

</body>
</html>
