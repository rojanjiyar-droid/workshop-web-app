<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>سیستم حسابداری کارخانه - آفلاین (نسخه پایدار ناوبری)</title>

  <!-- UI -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/font-face.css" rel="stylesheet">

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment-jalaali@0.9.6/build/moment-jalaali.js"></script>

  <style>
    :root {
      --primary: #1e3a8a;
      --secondary: #3b82f6;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --bg: #f8f9fa;
    }
    body { font-family: 'Vazir', Tahoma, system-ui; background: var(--bg); }
    .nav-link { cursor: pointer; }
    .nav-link.active { background: var(--secondary); color: #fff !important; border-radius: 8px; }
    .card { border-radius: 12px; }
    .section-title { font-weight: 700; color: var(--primary); }
    .badge { font-size: 12px; }
    .table td, .table th { vertical-align: middle; }
    .tiny { font-size: 12px; color: #666; }
    .stat { background: linear-gradient(135deg, var(--secondary), #1d4ed8); color: #fff; border-radius: 12px; padding: 16px; text-align: center; }
    .stat .val { font-size: 20px; font-weight: 800; }
    .grid { display: grid; gap: 12px; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); }
  </style>
</head>

<body>
  <div class="container py-3">
    <!-- Header -->
    <header class="d-flex justify-content-between align-items-center mb-3">
      <div class="d-flex align-items-center gap-2">
        <div class="fw-bold" style="color:var(--primary)">سیستم حسابداری کارخانه (آفلاین)</div>
        <span class="tiny" id="appDate"></span>
      </div>
      <div class="d-flex align-items-center gap-2">
        <button class="btn btn-sm btn-outline-primary" id="btnExport">خروجی JSON</button>
        <label class="btn btn-sm btn-outline-success mb-0">
          ورودی JSON
          <input type="file" id="importFile" accept=".json" hidden>
        </label>
        <button class="btn btn-sm btn-outline-danger" id="btnClear">پاکسازی داده‌ها</button>
      </div>
    </header>

    <!-- Nav -->
    <ul class="nav nav-pills mb-3" id="mainTabs">
      <li class="nav-item"><a class="nav-link active" onclick="showPage('dashboard', this)">داشبورد</a></li>
      <li class="nav-item"><a class="nav-link" onclick="showPage('contracts', this)">قراردادها</a></li>
      <li class="nav-item"><a class="nav-link" onclick="showPage('checks', this)">چک‌ها</a></li>
      <li class="nav-item"><a class="nav-link" onclick="showPage('income', this)">درآمدها</a></li>
      <li class="nav-item"><a class="nav-link" onclick="showPage('customers', this)">مشتریان</a></li>
      <li class="nav-item"><a class="nav-link" onclick="showPage('reports', this)">گزارش‌ها</a></li>
      <li class="nav-item"><a class="nav-link" onclick="showPage('settings', this)">تنظیمات</a></li>
    </ul>

    <!-- Pages -->
    <div id="pages">

      <!-- Dashboard -->
      <section id="dashboard" class="page">
        <div class="grid mb-3">
          <div class="stat"><div>قراردادها</div><div class="val" id="statContracts">0</div></div>
          <div class="stat"><div>چک‌ها</div><div class="val" id="statChecks">0</div></div>
          <div class="stat"><div>درآمدها</div><div class="val" id="statIncome">0</div></div>
          <div class="stat"><div>مشتریان</div><div class="val" id="statCustomers">0</div></div>
          <div class="stat" style="background:linear-gradient(135deg,#10b981,#059669)"><div>مجموع درآمد</div><div class="val" id="statIncomeSum">0</div></div>
        </div>
        <div class="card">
          <div class="card-header fw-bold">نمودار مبلغ قراردادها (ماه جاری)</div>
          <div class="card-body">
            <canvas id="contractsChart" height="120"></canvas>
          </div>
        </div>
      </section>

      <!-- Contracts -->
      <section id="contracts" class="page" style="display:none">
        <div class="card mb-3">
          <div class="card-header fw-bold">ثبت قرارداد جدید</div>
          <div class="card-body">
            <div class="row g-2">
              <div class="col-md-4">
                <label class="form-label">مشتری</label>
                <input id="cCustomer" class="form-control" list="dlCustomers" placeholder="نام مشتری">
              </div>
              <div class="col-md-3">
                <label class="form-label">مبلغ (تومان)</label>
                <input id="cAmount" type="number" min="0" class="form-control" placeholder="مثلاً 20000000">
              </div>
              <div class="col-md-3">
                <label class="form-label">تاریخ</label>
                <input id="cDate" class="form-control" placeholder="1404/01/01">
              </div>
              <div class="col-md-2 d-grid">
                <label class="form-label">&nbsp;</label>
                <button class="btn btn-success" id="btnAddContract">ثبت</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span class="fw-bold">لیست قراردادها</span>
            <input id="cSearch" class="form-control" placeholder="جستجو..." style="max-width:220px">
          </div>
          <div class="card-body table-responsive">
            <table class="table table-striped align-middle">
              <thead>
                <tr>
                  <th>#</th><th>مشتری</th><th>مبلغ</th><th>تاریخ</th><th>عملیات</th>
                </tr>
              </thead>
              <tbody id="cTbody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Checks -->
      <section id="checks" class="page" style="display:none">
        <div class="card mb-3">
          <div class="card-header fw-bold">ثبت چک جدید</div>
          <div class="card-body">
            <div class="row g-2">
              <div class="col-md-3">
                <label class="form-label">شماره چک</label>
                <input id="kNumber" class="form-control" placeholder="مثلاً 123456">
              </div>
              <div class="col-md-3">
                <label class="form-label">مشتری</label>
                <input id="kCustomer" class="form-control" list="dlCustomers" placeholder="نام مشتری">
              </div>
              <div class="col-md-3">
                <label class="form-label">مبلغ (تومان)</label>
                <input id="kAmount" type="number" min="0" class="form-control">
              </div>
              <div class="col-md-3">
                <label class="form-label">سررسید</label>
                <input id="kDueDate" class="form-control" placeholder="1404/01/01">
              </div>
            </div>
            <div class="row g-2 mt-1">
              <div class="col-md-3 d-grid">
                <button class="btn btn-success" id="btnAddCheck">ثبت</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span class="fw-bold">لیست چک‌ها</span>
            <input id="kSearch" class="form-control" placeholder="جستجو..." style="max-width:220px">
          </div>
          <div class="card-body table-responsive">
            <table class="table table-striped align-middle">
              <thead>
                <tr>
                  <th>#</th><th>شماره</th><th>مشتری</th><th>مبلغ</th><th>سررسید</th><th>مانده روز</th><th>وضعیت</th><th>عملیات</th>
                </tr>
              </thead>
              <tbody id="kTbody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Income -->
      <section id="income" class="page" style="display:none">
        <div class="card mb-3">
          <div class="card-header fw-bold">ثبت درآمد جدید</div>
          <div class="card-body">
            <div class="row g-2">
              <div class="col-md-3">
                <label class="form-label">دسته‌بندی</label>
                <select id="iCategory" class="form-control">
                  <option value="فروش">فروش</option>
                  <option value="دریافت چک">دریافت چک</option>
                  <option value="سایر">سایر</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">مبلغ (تومان)</label>
                <input id="iAmount" type="number" min="0" class="form-control">
              </div>
              <div class="col-md-3">
                <label class="form-label">تاریخ</label>
                <input id="iDate" class="form-control" placeholder="1404/01/01">
              </div>
              <div class="col-md-3">
                <label class="form-label">شرح</label>
                <input id="iDesc" class="form-control" placeholder="توضیح">
              </div>
              <div class="col-md-12 d-grid mt-2">
                <button class="btn btn-success" id="btnAddIncome">ثبت</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span class="fw-bold">لیست درآمدها</span>
            <input id="iSearch" class="form-control" placeholder="جستجو..." style="max-width:220px">
          </div>
          <div class="card-body table-responsive">
            <table class="table table-striped align-middle">
              <thead>
                <tr>
                  <th>#</th><th>دسته‌بندی</th><th>شرح</th><th>مبلغ</th><th>تاریخ</th><th>عملیات</th>
                </tr>
              </thead>
              <tbody id="iTbody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Customers -->
      <section id="customers" class="page" style="display:none">
        <div class="card mb-3">
          <div class="card-header fw-bold">ثبت مشتری جدید</div>
          <div class="card-body">
            <div class="row g-2">
              <div class="col-md-4">
                <label class="form-label">نام مشتری</label>
                <input id="uName" class="form-control" placeholder="نام و نام خانوادگی">
              </div>
              <div class="col-md-4">
                <label class="form-label">تلفن</label>
                <input id="uPhone" class="form-control" placeholder="0912...">
              </div>
              <div class="col-md-4">
                <label class="form-label">تاریخ ثبت</label>
                <input id="uDate" class="form-control" placeholder="1404/01/01">
              </div>
              <div class="col-md-12 d-grid mt-2">
                <button class="btn btn-success" id="btnAddCustomer">ثبت</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header d-flex justify-content بین align-items-center">
            <span class="fw-bold">لیست مشتریان</span>
            <input id="uSearch" class="form-control" placeholder="جستجو..." style="max-width:220px">
          </div>
          <div class="card-body table-responsive">
            <table class="table table-striped align-middle">
              <thead>
                <tr>
                  <th>#</th><th>نام</th><th>تلفن</th><th>تاریخ ثبت</th><th>عملیات</th>
                </tr>
              </thead>
              <tbody id="uTbody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Reports -->
      <section id="reports" class="page" style="display:none">
        <div class="card">
          <div class="card-header fw-bold">گزارش‌ها</div>
          <div class="card-body">
            <div class="row g-2 mb-3">
              <div class="col-md-3">
                <label class="form-label">تاریخ شروع</label>
                <input id="rStart" class="form-control" placeholder="1404/01/01">
              </div>
              <div class="col-md-3">
                <label class="form-label">تاریخ پایان</label>
                <input id="rEnd" class="form-control" placeholder="1404/01/30">
              </div>
              <div class="col-md-6 d-grid">
                <label class="form-label">&nbsp;</label>
                <button class="btn btn-primary" id="btnGenerateReport">تولید گزارش</button>
              </div>
            </div>
            <div id="reportResults">
              <div class="alert alert-info">گزارش را بر اساس بازه تاریخ تولید کنید.</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Settings -->
      <section id="settings" class="page" style="display:none">
        <div class="card">
          <div class="card-header fw-bold">تنظیمات</div>
          <div class="card-body">
            <div class="row g-2">
              <div class="col-md-4">
                <label class="form-label">نام شرکت</label>
                <input id="sCompany" class="form-control" value="کارخانه یونولیت کلشی‌فوم">
              </div>
              <div class="col-md-4">
                <label class="form-label">نسخه داده</label>
                <input id="sVersion" class="form-control" value="1.0">
              </div>
              <div class="col-md-4 d-grid">
                <label class="form-label">&nbsp;</label>
                <button class="btn btn-success" id="btnSaveSettings">ذخیره تنظیمات</button>
              </div>
            </div>
            <div class="tiny mt-2">داده‌ها در مرورگر دستگاه شما ذخیره می‌شوند (localStorage). برای انتقال، از خروجی JSON استفاده کنید.</div>
          </div>
        </div>
      </section>

    </div>

    <!-- Datalist -->
    <datalist id="dlCustomers"></datalist>

  </div>

  <script>
    // Jalali init
    try { moment.loadPersian({usePersianDigits: true}); } catch(e){ console.error(e); }

    // App state
    const KEY = 'factoryAccountingData';
    const App = {
      version: '1.0',
      company: 'کارخانه یونولیت کلشی‌فوم',
      customers: [],
      contracts: [],
      checks: [],
      incomes: []
    };

    // Utils
    const toISO = (sh) => {
      if (!sh) return new Date().toISOString();
      const m = moment(sh, 'jYYYY/jMM/jDD');
      return m.isValid() ? m.toDate().toISOString() : new Date().toISOString();
    };
    const toShamsi = (iso) => {
      try { return moment(iso).format('jYYYY/jMM/jDD'); } catch(e){ return ''; }
    };
    const fmt = (n) => Number(n||0).toLocaleString('fa-IR');

    // Navigation (guaranteed)
    function showPage(id, el){
      try {
        // activate tab
        document.querySelectorAll('#mainTabs .nav-link').forEach(x=>x.classList.remove('active'));
        if (el) el.classList.add('active');
        // show page
        document.querySelectorAll('.page').forEach(p=>p.style.display='none');
        const pageEl = document.getElementById(id);
        if (pageEl) pageEl.style.display = '';
        // optional: refresh dashboard chart when entering dashboard
        if (id === 'dashboard') renderDashboard();
      } catch(e) {
        console.error('Navigation error:', e);
        alert('خطا در ناوبری. لطفاً صفحه را رفرش کنید.');
      }
    }

    // Storage
    function load() {
      const raw = localStorage.getItem(KEY);
      if (raw) {
        try {
          const parsed = JSON.parse(raw);
          if (parsed.version) Object.assign(App, parsed);
        } catch (e) { console.error(e); }
      }
      renderAll();
    }
    function save() { localStorage.setItem(KEY, JSON.stringify(App)); }

    // Header actions
    document.getElementById('appDate').textContent = toShamsi(new Date().toISOString());
    document.getElementById('btnExport').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(App,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `backup_${toShamsi(new Date().toISOString()).replace(/\//g,'-')}.json`;
      a.click();
      URL.revokeObjectURL(url);
    });
    document.getElementById('importFile').addEventListener('change', (e)=>{
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        try {
          const data = JSON.parse(reader.result);
          if (!confirm('اطلاعات فعلی جایگزین شوند؟')) return;
          Object.assign(App, data);
          save();
          renderAll();
          alert('بازیابی انجام شد.');
        } catch(err) { alert('فایل نامعتبر است.'); }
      };
      reader.readAsText(file);
    });
    document.getElementById('btnClear').addEventListener('click', ()=>{
      if (!confirm('کل داده‌ها پاک شوند؟')) return;
      localStorage.removeItem(KEY);
      App.customers = []; App.contracts = []; App.checks = []; App.incomes = [];
      save(); renderAll();
    });

    // Customers
    document.getElementById('btnAddCustomer').addEventListener('click', ()=>{
      const name = document.getElementById('uName').value.trim();
      const phone = document.getElementById('uPhone').value.trim();
      const date = document.getElementById('uDate').value.trim();
      if (!name || !phone) return alert('نام و تلفن لازم است.');
      App.customers.push({id: Date.now(), name, phone, date: toISO(date)});
      save(); renderCustomers();
      document.getElementById('uName').value='';
      document.getElementById('uPhone').value='';
      document.getElementById('uDate').value='';
    });
    function renderCustomers() {
      const term = (document.getElementById('uSearch').value||'').toLowerCase();
      const tb = document.getElementById('uTbody'); tb.innerHTML='';
      App.customers
        .filter(u=>u.name.toLowerCase().includes(term) || u.phone.includes(term))
        .forEach((u,i)=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${i+1}</td>
            <td>${u.name}</td>
            <td>${u.phone}</td>
            <td>${toShamsi(u.date)}</td>
            <td>
              <button class="btn btn-sm btn-warning">ویرایش</button>
              <button class="btn btn-sm btn-danger">حذف</button>
            </td>`;
          tr.querySelector('.btn-warning').onclick = ()=>{
            const name = prompt('نام:', u.name);
            const phone = prompt('تلفن:', u.phone);
            const date = prompt('تاریخ (مثلاً 1404/01/01):', toShamsi(u.date));
            if (name && phone && date) { u.name=name; u.phone=phone; u.date=toISO(date); save(); renderCustomers(); renderDatalist(); }
          };
          tr.querySelector('.btn-danger').onclick = ()=>{
            if (confirm('حذف مشتری؟')) { App.customers = App.customers.filter(x=>x.id!==u.id); save(); renderCustomers(); renderDatalist(); }
          };
          tb.appendChild(tr);
        });
      renderDatalist();
    }
    document.getElementById('uSearch').addEventListener('input', renderCustomers);
    function renderDatalist(){
      const dl = document.getElementById('dlCustomers'); dl.innerHTML='';
      App.customers.forEach(u=>{
        const opt = document.createElement('option');
        opt.value = u.name; dl.appendChild(opt);
      });
    }

    // Contracts
    document.getElementById('btnAddContract').addEventListener('click', ()=>{
      const customer = document.getElementById('cCustomer').value.trim();
      const amount = parseInt(document.getElementById('cAmount').value||'0',10);
      const date = document.getElementById('cDate').value.trim();
      if (!customer || !amount) return alert('مشتری و مبلغ لازم است.');
      App.contracts.push({id:Date.now(), customer, amount, date: toISO(date)});
      save(); renderContracts(); renderDashboard();
      document.getElementById('cCustomer').value='';
      document.getElementById('cAmount').value='';
      document.getElementById('cDate').value='';
    });
    function renderContracts(){
      const term = (document.getElementById('cSearch').value||'').toLowerCase();
      const tb = document.getElementById('cTbody'); tb.innerHTML='';
      App.contracts
        .filter(c=>c.customer.toLowerCase().includes(term) || String(c.amount).includes(term))
        .forEach((c,i)=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${i+1}</td>
            <td>${c.customer}</td>
            <td>${fmt(c.amount)} تومان</td>
            <td>${toShamsi(c.date)}</td>
            <td>
              <button class="btn btn-sm btn-warning">ویرایش</button>
              <button class="btn btn-sm btn-danger">حذف</button>
            </td>`;
          tr.querySelector('.btn-warning').onclick = ()=>{
            const customer = prompt('مشتری:', c.customer);
            const amount = prompt('مبلغ:', c.amount);
            const date = prompt('تاریخ (1404/01/01):', toShamsi(c.date));
            if (customer && amount && date) { c.customer=customer; c.amount=parseInt(amount,10)||0; c.date=toISO(date); save(); renderContracts(); renderDashboard(); }
          };
          tr.querySelector('.btn-danger').onclick = ()=>{
            if (confirm('حذف قرارداد؟')) { App.contracts = App.contracts.filter(x=>x.id!==c.id); save(); renderContracts(); renderDashboard(); }
          };
          tb.appendChild(tr);
        });
    }
    document.getElementById('cSearch').addEventListener('input', renderContracts);

    // Checks
    document.getElementById('btnAddCheck').addEventListener('click', ()=>{
      const number = document.getElementById('kNumber').value.trim();
      const customer = document.getElementById('kCustomer').value.trim();
      const amount = parseInt(document.getElementById('kAmount').value||'0',10);
      const dueDate = document.getElementById('kDueDate').value.trim();
      if (!number || !customer || !amount || !dueDate) return alert('همه فیلدها لازم است.');
      App.checks.push({id:Date.now(), number, customer, amount, dueDate: toISO(dueDate), status:'در جریان'});
      save(); renderChecks(); renderDashboard();
      document.getElementById('kNumber').value='';
      document.getElementById('kCustomer').value='';
      document.getElementById('kAmount').value='';
      document.getElementById('kDueDate').value='';
    });
    function renderChecks(){
      const term = (document.getElementById('kSearch').value||'').toLowerCase();
      const tb = document.getElementById('kTbody'); tb.innerHTML='';
      const today = new Date();
      App.checks
        .filter(k=>k.number.includes(term) || k.customer.toLowerCase().includes(term))
        .forEach((k,i)=>{
          const dDue = new Date(k.dueDate);
          const diffDays = Math.ceil((dDue.getTime()-today.getTime())/(1000*60*60*24));
          const badge = k.status==='در جریان'?'badge-warning':k.status==='وصول شده'?'badge-success':'badge-danger';
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${i+1}</td>
            <td>${k.number}</td>
            <td>${k.customer}</td>
            <td>${fmt(k.amount)} تومان</td>
            <td>${toShamsi(k.dueDate)}</td>
            <td><span class="badge ${diffDays<0?'bg-danger':'bg-info'}">${diffDays} روز</span></td>
            <td><span class="badge ${badge}">${k.status}</span></td>
            <td class="d-flex gap-1 flex-wrap">
              <button class="btn btn-sm btn-success">وصول</button>
              <button class="btn btn-sm btn-outline-danger">برگشت</button>
              <button class="btn btn-sm btn-warning">ویرایش</button>
              <button class="btn btn-sm btn-danger">حذف</button>
            </td>`;
          tr.querySelector('.btn-success').onclick = ()=>{ k.status='وصول شده'; save(); renderChecks(); };
          tr.querySelector('.btn-outline-danger').onclick = ()=>{ k.status='برگشت خورده'; save(); renderChecks(); };
          tr.querySelector('.btn-warning').onclick = ()=>{
            const number = prompt('شماره چک:', k.number);
            const customer = prompt('مشتری:', k.customer);
            const amount = prompt('مبلغ:', k.amount);
            const due = prompt('سررسید (1404/01/01):', toShamsi(k.dueDate));
            if (number && customer && amount && due) {
              k.number=number; k.customer=customer; k.amount=parseInt(amount,10)||0; k.dueDate=toISO(due);
              save(); renderChecks(); renderDashboard();
            }
          };
          tr.querySelector('.btn-danger').onclick = ()=>{
            if (confirm('حذف چک؟')) { App.checks = App.checks.filter(x=>x.id!==k.id); save(); renderChecks(); renderDashboard(); }
          };
          tb.appendChild(tr);
        });
    }
    document.getElementById('kSearch').addEventListener('input', renderChecks);

    // Income
    document.getElementById('btnAddIncome').addEventListener('click', ()=>{
      const category = document.getElementById('iCategory').value;
      const amount = parseInt(document.getElementById('iAmount').value||'0',10);
      const date = document.getElementById('iDate').value.trim();
      const desc = document.getElementById('iDesc').value.trim();
      if (!amount || !date) return alert('مبلغ و تاریخ لازم است.');
      App.incomes.push({id:Date.now(), category, amount, date: toISO(date), desc});
      save(); renderIncomes(); renderDashboard();
      document.getElementById('iAmount').value='';
      document.getElementById('iDate').value='';
      document.getElementById('iDesc').value='';
    });
    function renderIncomes(){
      const term = (document.getElementById('iSearch').value||'').toLowerCase();
      const tb = document.getElementById('iTbody'); tb.innerHTML='';
      App.incomes
        .filter(i=>i.category.toLowerCase().includes(term) || (i.desc||'').toLowerCase().includes(term))
        .forEach((i,idx)=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${idx+1}</td>
            <td>${i.category}</td>
            <td>${i.desc||'-'}</td>
            <td>${fmt(i.amount)} تومان</td>
            <td>${toShamsi(i.date)}</td>
            <td>
              <button class="btn btn-sm btn-warning">ویرایش</button>
              <button class="btn btn-sm btn-danger">حذف</button>
            </td>`;
          tr.querySelector('.btn-warning').onclick = ()=>{
            const cat = prompt('دسته‌بندی:', i.category);
            const amount = prompt('مبلغ:', i.amount);
            const date = prompt('تاریخ (1404/01/01):', toShamsi(i.date));
            const desc = prompt('شرح:', i.desc||'');
            if (cat && amount && date) {
              i.category=cat; i.amount=parseInt(amount,10)||0; i.date=toISO(date); i.desc=desc||'';
              save(); renderIncomes(); renderDashboard();
            }
          };
          tr.querySelector('.btn-danger').onclick = ()=>{
            if (confirm('حذف درآمد؟')) { App.incomes = App.incomes.filter(x=>x.id!==i.id); save(); renderIncomes(); renderDashboard(); }
          };
          tb.appendChild(tr);
        });
    }
    document.getElementById('iSearch').addEventListener('input', renderIncomes);

    // Reports
    document.getElementById('btnGenerateReport').addEventListener('click', ()=>{
      const start = document.getElementById('rStart').value.trim();
      const end = document.getElementById('rEnd').value.trim();
      const s = start ? new Date(toISO(start)) : new Date('1970-01-01');
      const e = end ? new Date(toISO(end)) : new Date('2999-01-01');

      function inRange(d){ const x=new Date(d); return x>=s && x<=e; }

      const contracts = App.contracts.filter(c=>inRange(c.date));
      const checks = App.checks.filter(k=>inRange(k.dueDate));
      const incomes = App.incomes.filter(i=>inRange(i.date));

      const sumContracts = contracts.reduce((a,b)=>a+b.amount,0);
      const sumIncomes = incomes.reduce((a,b)=>a+b.amount,0);
      const sumChecks = checks.reduce((a,b)=>a+b.amount,0);

      const html = `
        <div class="grid mb-3">
          <div class="stat"><div>تعداد قرارداد</div><div class="val">${fmt(contracts.length)}</div></div>
          <div class="stat"><div>جمع قرارداد</div><div class="val">${fmt(sumContracts)} تومان</div></div>
          <div class="stat"><div>تعداد چک</div><div class="val">${fmt(checks.length)}</div></div>
          <div class="stat"><div>جمع چک</div><div class="val">${fmt(sumChecks)} تومان</div></div>
          <div class="stat" style="background:linear-gradient(135deg,#10b981,#059669)"><div>جمع درآمد</div><div class="val">${fmt(sumIncomes)} تومان</div></div>
        </div>

        <h6 class="section-title mt-3">قراردادها</h6>
        <div class="table-responsive"><table class="table table-sm"><thead><tr><th>#</th><th>مشتری</th><th>مبلغ</th><th>تاریخ</th></tr></thead><tbody>
          ${contracts.map((c,i)=>`<tr><td>${i+1}</td><td>${c.customer}</td><td>${fmt(c.amount)} تومان</td><td>${toShamsi(c.date)}</td></tr>`).join('')}
        </tbody></table></div>

        <h6 class="section-title mt-3">چک‌ها</h6>
        <div class="table-responsive"><table class="table table-sm"><thead><tr><th>#</th><th>شماره</th><th>مشتری</th><th>مبلغ</th><th>سررسید</th><th>وضعیت</th></tr></thead><tbody>
          ${checks.map((k,i)=>`<tr><td>${i+1}</td><td>${k.number}</td><td>${k.customer}</td><td>${fmt(k.amount)} تومان</td><td>${toShamsi(k.dueDate)}</td><td>${k.status}</td></tr>`).join('')}
        </tbody></table></div>

        <h6 class="section-title mt-3">درآمدها</h6>
        <div class="table-responsive"><table class="table table-sm"><thead><tr><th>#</th><th>دسته‌بندی</th><th>شرح</th><th>مبلغ</th><th>تاریخ</th></tr></thead><tbody>
          ${incomes.map((i,idx)=>`<tr><td>${idx+1}</td><td>${i.category}</td><td>${i.desc||'-'}</td><td>${fmt(i.amount)} تومان</td><td>${toShamsi(i.date)}</td></tr>`).join('')}
        </tbody></table></div>
      `;
      document.getElementById('reportResults').innerHTML = html;
    });

    // Dashboard
    function renderDashboard(){
      document.getElementById('statContracts').textContent = App.contracts.length;
      document.getElementById('statChecks').textContent = App.checks.length;
      document.getElementById('statIncome').textContent = App.incomes.length;
      document.getElementById('statCustomers').textContent = App.customers.length;
      document.getElementById('statIncomeSum').textContent = fmt(App.incomes.reduce((a,b)=>a+b.amount,0))+' تومان';

      const canvas = document.getElementById('contractsChart');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');

      const currentYear = moment().format('jYYYY');
      const currentMonth = moment().format('jMM');
      const monthContracts = App.contracts.filter(c=>{
        const [jy,jm] = toShamsi(c.date).split('/'); return jy===currentYear && jm===currentMonth;
      });

      const labels = monthContracts.map(c=>c.customer);
      const data = monthContracts.map(c=>c.amount);
      if (window.contractsChart) try { window.contractsChart.destroy(); } catch(e){}
      window.contractsChart = new Chart(ctx, {
        type:'bar',
        data:{ labels, datasets:[{ label:'مبلغ قرارداد', data, backgroundColor:'#3b82f6' }] },
        options:{ responsive:true, plugins:{ legend:{display:false} } }
      });
    }

    // Render all
    function renderAll(){
      renderCustomers();
      renderContracts();
      renderChecks();
      renderIncomes();
      renderDashboard();
      // ensure initial page state
      document.querySelectorAll('.page').forEach(p=>{
        p.style.display = (p.id==='dashboard') ? '' : 'none';
      });
    }

    // Settings
    document.getElementById('btnSaveSettings').addEventListener('click', ()=>{
      App.company = document.getElementById('sCompany').value.trim() || App.company;
      App.version = document.getElementById('sVersion').value.trim() || App.version;
      save(); alert('تنظیمات ذخیره شد.');
    });

    // Defaults
    document.getElementById('uDate').value = moment().format('YYYY/MM/DD');
    document.getElementById('cDate').value = moment().format('YYYY/MM/DD');
    document.getElementById('kDueDate').value = moment().add(7,'day').format('YYYY/MM/DD');
    document.getElementById('iDate').value = moment().format('YYYY/MM/DD');

    // Start
    load();
  </script>
</body>
</html>
