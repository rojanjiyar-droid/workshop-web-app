<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÛŒØ³ØªÙ… Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ Ú©Ù„Ø´ÛŒâ€ŒÙÙˆÙ… v15.0 - Ú©Ø§Ù…Ù„</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/persian-date@1.1.0/dist/persian-date.min.js"></script>
    <style>
        :root {
            --primary: #1e3a8a; --secondary: #3b82f6; --success: #10b981; --warning: #f59e0b;
            --danger: #ef4444; --info: #06b6d4; --light: #f8fafc; --dark: #0f172a; --gray: #64748b;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Tahoma', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        /* Login */
        .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 40px; }
        .login-card { background: white; border-radius: 20px; padding: 50px; width: 100%; max-width: 450px; box-shadow: 0 20px 40px rgba(0,0,0,0.15); text-align: center; }
        .login-logo { width: 100px; height: 100px; margin: 0 auto 30px; background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 32px; font-weight: bold; }
        .form-group { margin-bottom: 25px; text-align: right; }
        .form-label { display: block; margin-bottom: 10px; font-weight: bold; color: var(--dark); }
        .form-control { width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; transition: all 0.3s; }
        .form-control:focus { border-color: var(--secondary); outline: none; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
        .btn { padding: 15px 30px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; transition: all 0.3s; font-size: 16px; }
        .btn-primary { background: var(--secondary); color: white; width: 100%; }
        .btn-primary:hover { background: #1d4ed8; transform: translateY(-2px); }
        
        /* Main App */
        .main-app { display: none; }
        header { background: var(--dark); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .logo-sm { width: 50px; height: 50px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--secondary); font-weight: bold; font-size: 20px; }
        
        .nav { background: var(--primary); display: flex; overflow-x: auto; padding: 0; margin-bottom: 20px; }
        .nav-btn { background: none; border: none; color: white; padding: 18px 25px; cursor: pointer; white-space: nowrap; transition: all 0.3s; font-weight: 500; }
        .nav-btn:hover, .nav-btn.active { background: var(--secondary); }
        
        .page { display: none; padding: 20px; animation: fadeIn 0.5s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .card { background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-bottom: 25px; overflow: hidden; }
        .card-header { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 25px; display: flex; justify-content: space-between; align-items: center; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; padding: 25px; }
        .stat-card { background: linear-gradient(135deg, var(--secondary), #1d4ed8); color: white; padding: 30px; border-radius: 15px; text-align: center; }
        .stat-value { font-size: 32px; font-weight: bold; margin-bottom: 10px; }
        
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .product-row { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr auto; gap: 15px; padding: 20px; background: #f8fafc; border-radius: 12px; margin-bottom: 15px; align-items: center; }
        .totals-box { background: linear-gradient(135deg, var(--success), #059669); color: white; padding: 30px; border-radius: 15px; margin: 30px 0; }
        .total-row { display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 16px; }
        .total-row:last-child { font-size: 24px; font-weight: bold; border-top: 2px solid rgba(255,255,255,0.3); padding-top: 20px; }
        
        .table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .table th { background: var(--primary); color: white; padding: 18px; text-align: right; }
        .table td { padding: 15px; border-bottom: 1px solid #eee; text-align: right; }
        .table tr:hover { background: #f8f9ff; }
        
        .notification { position: fixed; top: 20px; right: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 1000; border-right: 5px solid; display: flex; align-items: center; gap: 15px; }
        
        @media (max-width: 768px) { .form-row, .product-row { grid-template-columns: 1fr; } .nav { flex-direction: column; } }
    </style>
</head>
<body>
    <!-- Notifications -->
    <div id="notifications"></div>

    <!-- Login -->
    <div id="loginPage" class="login-container">
        <div class="login-card">
            <div class="login-logo">CF</div>
            <h2 style="margin-bottom: 30px; color: var(--dark);">Ø³ÛŒØ³ØªÙ… Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ Ú©Ù„Ø´ÛŒâ€ŒÙÙˆÙ… v15.0</h2>
            <div class="form-group">
                <label class="form-label">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ</label>
                <input type="text" id="username" class="form-control" value="admin" autofocus>
            </div>
            <div class="form-group">
                <label class="form-label">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
                <input type="password" id="password" class="form-control" value="1234">
            </div>
            <button class="btn btn-primary" onclick="login()">ğŸš€ ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø³ÛŒØ³ØªÙ…</button>
            <div style="margin-top: 25px; font-size: 14px; color: #666;">
                ØªØ³Øª: <strong>admin / 1234</strong>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="main-app">
        <header>
            <div style="display: flex; align-items: center; gap: 20px;">
                <div class="logo-sm">CF</div>
                <div>
                    <h2 style="margin: 0;">Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ ÛŒÙˆÙ†ÙˆÙ„ÛŒØª Ú©Ù„Ø´ÛŒâ€ŒÙÙˆÙ…</h2>
                    <div id="currentDate"></div>
                </div>
            </div>
            <div style="display: flex; gap: 15px; align-items: center;">
                <span id="userName"></span>
                <button class="btn btn-danger" onclick="logout()" style="padding: 10px 20px; font-size: 14px;">Ø®Ø±ÙˆØ¬</button>
            </div>
        </header>

        <nav class="nav" id="nav">
            <button class="nav-btn active" onclick="showPage('dashboard')">ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</button>
            <button class="nav-btn" onclick="showPage('contracts')">ğŸ“ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§</button>
            <button class="nav-btn" onclick="showPage('customers')">ğŸ‘¥ Ù…Ø´ØªØ±ÛŒØ§Ù†</button>
            <button class="nav-btn" onclick="showPage('checks')">ğŸ¦ Ú†Ú©â€ŒÙ‡Ø§</button>
        </nav>

        <div class="container">
            <!-- Dashboard -->
            <div id="dashboard" class="page active">
                <div class="card">
                    <div class="card-header">
                        <h3>ğŸ“Š Ø¢Ù…Ø§Ø± Ú©Ø§Ù…Ù„ Ø³ÛŒØ³ØªÙ…</h3>
                        <button class="btn btn-success" onclick="updateDashboard()" style="padding: 10px 20px;">ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
                    </div>
                    <div class="stats-grid" id="statsGrid"></div>
                </div>
            </div>

            <!-- Contracts -->
            <div id="contracts" class="page">
                <div class="card">
                    <div class="card-header">
                        <h3>ğŸ“ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø¬Ø¯ÛŒØ¯</h3>
                        <button class="btn btn-warning" onclick="resetForm()" style="padding: 10px 20px;">ğŸ”„ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</button>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Ù…Ø´ØªØ±ÛŒ *</label>
                            <input type="text" id="customerName" class="form-control" list="customerList">
                        </div>
                        <div class="form-group">
                            <label>ØªÙ„ÙÙ†</label>
                            <input type="tel" id="customerPhone" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Ø¢Ø¯Ø±Ø³</label>
                            <input type="text" id="customerAddress" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>ØªØ§Ø±ÛŒØ® Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</label>
                            <input type="text" id="contractDate" class="form-control" readonly>
                        </div>
                        <div class="form-group">
                            <label>ØªØ§Ø±ÛŒØ® ØªØ­ÙˆÛŒÙ„</label>
                            <input type="date" id="deliveryDate" class="form-control">
                        </div>
                    </div>

                    <h4 style="margin: 30px 0 15px 0; color: var(--primary);">ğŸ“¦ Ù…Ø­ØµÙˆÙ„Ø§Øª (ÛŒÙˆÙ†ÙˆÙ„ÛŒØªØŒ ÙˆØ±Ù‚ØŒ Ù¾Ø§Ù†Ù„)</h4>
                    <div id="productsContainer"></div>
                    <button class="btn btn-info" onclick="addProduct()" style="margin-bottom: 20px;">â• Ù…Ø­ØµÙˆÙ„ Ø¬Ø¯ÛŒØ¯</button>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª</label>
                            <input type="number" id="advancePayment" class="form-control" value="0" oninput="calculateBalance()">
                        </div>
                    </div>

                    <h4 style="margin: 30px 0 15px 0; color: var(--primary);">ğŸ¦ Ú†Ú©â€ŒÙ‡Ø§</h4>
                    <div id="checksContainer"></div>
                    <button class="btn btn-info" onclick="addCheck()" style="margin-bottom: 20px;">â• Ú†Ú© Ø¬Ø¯ÛŒØ¯</button>

                    <div class="totals-box">
                        <div class="total-row"><span>Ø¬Ù…Ø¹ Ù…Ø­ØµÙˆÙ„Ø§Øª:</span><strong id="totalProducts">Û° ØªÙˆÙ…Ø§Ù†</strong></div>
                        <div class="total-row"><span>Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª:</span><strong id="totalAdvance">Û° ØªÙˆÙ…Ø§Ù†</strong></div>
                        <div class="total-row"><span>Ù…Ø¬Ù…ÙˆØ¹ Ú†Ú©â€ŒÙ‡Ø§:</span><strong id="totalChecks">Û° ØªÙˆÙ…Ø§Ù†</strong></div>
                        <div class="total-row"><span style="color: #ffd700;">ğŸŸ¢ Ù…Ø§Ù†Ø¯Ù‡ Ø­Ø³Ø§Ø¨:</span><strong id="accountBalance">Û° ØªÙˆÙ…Ø§Ù†</strong></div>
                    </div>

                    <div style="display: flex; gap: 15px;">
                        <button class="btn btn-success" onclick="saveContract()">âœ… Ø«Ø¨Øª Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</button>
                        <button class="btn btn-primary" onclick="printContract()">ğŸ–¨ï¸ Ú†Ø§Ù¾</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header"><h3>ğŸ“‹ Ù„ÛŒØ³Øª Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§</h3></div>
                    <div style="overflow-x: auto;">
                        <table class="table" id="contractsTable">
                            <thead><tr><th>Ø´Ù…Ø§Ø±Ù‡</th><th>Ù…Ø´ØªØ±ÛŒ</th><th>Ù…Ø¨Ù„Øº</th><th>ØªØ§Ø±ÛŒØ®</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Customers -->
            <div id="customers" class="page">
                <div class="card">
                    <div class="card-header">
                        <h3>ğŸ‘¥ Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø´ØªØ±ÛŒØ§Ù†</h3>
                        <button class="btn btn-success" onclick="showCustomerForm()">â• Ù…Ø´ØªØ±ÛŒ Ø¬Ø¯ÛŒØ¯</button>
                    </div>
                    <div id="customerForm" style="display: none; background: #f8fafc; padding: 30px; border-radius: 12px; margin-bottom: 25px;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Ù†Ø§Ù… *</label>
                                <input id="newCustomerName" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>ØªÙ„ÙÙ† *</label>
                                <input id="newCustomerPhone" class="form-control" type="tel">
                            </div>
                            <div class="form-group">
                                <label>Ø¢Ø¯Ø±Ø³</label>
                                <input id="newCustomerAddress" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Ù†ÙˆØ¹ Ù…Ø´ØªØ±ÛŒ</label>
                                <select id="customerType" class="form-control">
                                    <option value="Ø¹Ø§Ø¯ÛŒ">Ø¹Ø§Ø¯ÛŒ</option>
                                    <option value="Ù¾ÛŒØ´ Ø®Ø±ÛŒØ¯">Ù¾ÛŒØ´ Ø®Ø±ÛŒØ¯</option>
                                    <option value="Ø¹Ø§Ù…Ù„">Ø¹Ø§Ù…Ù„</option>
                                </select>
                            </div>
                        </div>
                        <div style="display: flex; gap: 15px;">
                            <button class="btn btn-success" onclick="saveCustomer()">âœ… Ø°Ø®ÛŒØ±Ù‡</button>
                            <button class="btn btn-warning" onclick="hideCustomerForm()">âŒ Ø§Ù†ØµØ±Ø§Ù</button>
                        </div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="table" id="customersTable">
                            <thead><tr><th>Ù†Ø§Ù…</th><th>ØªÙ„ÙÙ†</th><th>Ø¢Ø¯Ø±Ø³</th><th>Ù†ÙˆØ¹</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Checks -->
            <div id="checks" class="page">
                <div class="card">
                    <div class="card-header"><h3>ğŸ¦ Ù…Ø¯ÛŒØ±ÛŒØª Ú†Ú©â€ŒÙ‡Ø§</h3></div>
                    <div style="overflow-x: auto;">
                        <table class="table" id="checksTable">
                            <thead><tr><th>Ø´Ù…Ø§Ø±Ù‡</th><th>Ù…Ø´ØªØ±ÛŒ</th><th>Ù…Ø¨Ù„Øº</th><th>Ø³Ø±Ø±Ø³ÛŒØ¯</th><th>ÙˆØ¶Ø¹ÛŒØª</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <datalist id="customerList"></datalist>

    <script>
        // Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
        let appData = JSON.parse(localStorage.getItem('kaleshi_v15')) || {
            customers: [
                {id:1, name:'Ø¹Ù„ÛŒ Ù…Ø­Ù…Ø¯ÛŒ', phone:'09121234567', address:'Ø§Ø±ÙˆÙ…ÛŒÙ‡ - Ø¨Ù„ÙˆØ§Ø± Ø¢Ø²Ø§Ø¯ÛŒ', type:'Ø¹Ø§Ø¯ÛŒ'},
                {id:2, name:'Ø±Ø¶Ø§ Ø§Ø­Ù…Ø¯ÛŒ', phone:'09129876543', address:'Ø§Ø±ÙˆÙ…ÛŒÙ‡ - Ù‚Ø²Ù„ Ø¹Ø§Ø´Ù‚', type:'Ø¹Ø§Ù…Ù„'}
            ],
            contracts: [], checks: []
        };
        let currentUser = null, productCounter = 0, checkCounter = 0, editingCustomerId = null;

        // ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ
        function getPersianDate() {
            if (typeof persianDate !== 'undefined') {
                return new persianDate().format('YYYY/MM/DD');
            }
            const d = new Date(), persianDigits = 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹';
            return d.toLocaleDateString('fa-IR').replace(/\d/g, c => persianDigits[parseInt(c)]);
        }

        function formatCurrency(amount) {
            return amount.toLocaleString('fa-IR') + ' ØªÙˆÙ…Ø§Ù†';
        }

        // Ø§Ø¹Ù„Ø§Ù†
        function showNotification(msg, type = 'success') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.borderRightColor = type === 'success' ? '#10b981' : '#ef4444';
            notification.innerHTML = `
                <span style="font-size: 20px;">${type === 'success' ? 'âœ…' : 'âŒ'}</span>
                <span style="flex: 1;">${msg}</span>
                <button onclick="this.parentElement.remove()" style="background: none; border: none; font-size: 20px; cursor: pointer;">Ã—</button>
            `;
            document.getElementById('notifications').appendChild(notification);
            setTimeout(() => notification.remove(), 5000);
        }

        // ÙˆØ±ÙˆØ¯ - Ú©Ø§Ù…Ù„Ø§Ù‹ ØªØ³Øª Ø´Ø¯Ù‡
        function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            console.log('Login attempt:', username, password); // Debug
            
            if (username === 'admin' && password === '1234') {
                currentUser = 'Ù…Ø¯ÛŒØ± Ø³ÛŒØ³ØªÙ…';
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                document.getElementById('userName').textContent = currentUser;
                document.getElementById('currentDate').textContent = getPersianDate();
                document.getElementById('contractDate').value = getPersianDate();
                initApp();
                showNotification('Ø¨Ù‡ Ø³ÛŒØ³ØªÙ… Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!');
            } else {
                showNotification('Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª!', 'error');
            }
        }

        function logout() {
            if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ø®Ø±ÙˆØ¬ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) {
                location.reload();
            }
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            event.target.classList.add('active');
            
            if (pageId === 'contracts') loadContracts();
            if (pageId === 'customers') loadCustomers();
            if (pageId === 'checks') loadChecks();
        }

        function initApp() {
            updateDashboard();
            loadCustomers();
            resetForm();
            document.addEventListener('keydown', e => {
                if (e.key === 'Enter' && document.getElementById('loginPage').style.display !== 'none') {
                    login();
                }
            });
        }

        // Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ú©Ø§Ù…Ù„
        function updateDashboard() {
            const totalContracts = appData.contracts.length;
            const totalRevenue = appData.contracts.reduce((sum, c) => 
                sum + c.products.reduce((p, pr) => p + (pr.qty * pr.price), 0), 0
            );
            const totalCustomers = appData.customers.length;
            const pendingChecks = appData.checks.filter(c => c.status !== 'ÙˆØµÙˆÙ„ Ø´Ø¯Ù‡').length;
            
            // Ø¢Ù…Ø§Ø± ØªÙÚ©ÛŒÚ©ÛŒ Ù…Ø­ØµÙˆÙ„Ø§Øª
            const yunolit = appData.contracts.reduce((sum, c) => 
                sum + c.products.filter(p => p.type === 'ÛŒÙˆÙ†ÙˆÙ„ÛŒØª').reduce((s, pr) => s + (pr.qty * pr.price), 0), 0
            );
            const voragh = appData.contracts.reduce((sum, c) => 
                sum + c.products.filter(p => p.type === 'ÙˆØ±Ù‚').reduce((s, pr) => s + (pr.qty * pr.price), 0), 0
            );
            const panel = appData.contracts.reduce((sum, c) => 
                sum + c.products.filter(p => p.type === 'Ù¾Ø§Ù†Ù„').reduce((s, pr) => s + (pr.qty * pr.price), 0), 0
            );

            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${totalContracts}</div>Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #10b981, #059669);">
                    <div class="stat-value">${formatCurrency(totalRevenue)}</div>Ø¯Ø±Ø¢Ù…Ø¯ Ú©Ù„
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                    <div class="stat-value">${pendingChecks}</div>Ú†Ú©â€ŒÙ‡Ø§ÛŒ Ø¯Ø±Ø¬Ø±ÛŒØ§Ù†
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                    <div class="stat-value">${totalCustomers}</div>Ù…Ø´ØªØ±ÛŒØ§Ù†
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                    <div class="stat-value">${formatCurrency(yunolit)}</div>ÛŒÙˆÙ†ÙˆÙ„ÛŒØª
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #06b6d4, #0891b2);">
                    <div class="stat-value">${formatCurrency(voragh)}</div>ÙˆØ±Ù‚
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #ec4899, #db2777);">
                    <div class="stat-value">${formatCurrency(panel)}</div>Ù¾Ø§Ù†Ù„
                </div>
            `;
        }

        // Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§ - Ú©Ø§Ù…Ù„
        function resetForm() {
            document.getElementById('customerName').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('customerAddress').value = '';
            document.getElementById('deliveryDate').value = '';
            document.getElementById('advancePayment').value = '0';
            document.getElementById('productsContainer').innerHTML = '';
            document.getElementById('checksContainer').innerHTML = '';
            productCounter = 0;
            checkCounter = 0;
            addProduct();
            addCheck();
            calculateBalance();
        }

        function addProduct() {
            const container = document.getElementById('productsContainer');
            const id = productCounter++;
            container.innerHTML += `
                <div class="product-row">
                    <select id="prodType${id}" class="form-control" onchange="calculateBalance()">
                        <option value="ÛŒÙˆÙ†ÙˆÙ„ÛŒØª">ÛŒÙˆÙ†ÙˆÙ„ÛŒØª</option>
                        <option value="ÙˆØ±Ù‚">ÙˆØ±Ù‚</option>
                        <option value="Ù¾Ø§Ù†Ù„">Ù¾Ø§Ù†Ù„</option>
                    </select>
                    <input type="text" id="prodName${id}" placeholder="Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„" class="form-control" oninput="calculateBalance()">
                    <input type="number" id="prodQty${id}" placeholder="Ù…Ù‚Ø¯Ø§Ø±" class="form-control" oninput="calculateBalance()">
                    <input type="number" id="prodPrice${id}" placeholder="Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯" class="form-control" oninput="calculateBalance()">
                    <button class="btn btn-danger btn-sm" onclick="this.parentElement.remove(); calculateBalance();">Ø­Ø°Ù</button>
                </div>`;
        }

        function addCheck() {
            const container = document.getElementById('checksContainer');
            const id = checkCounter++;
            container.innerHTML += `
                <div class="product-row">
                    <input type="text" id="checkNum${id}" placeholder="Ø´Ù…Ø§Ø±Ù‡ Ú†Ú©" class="form-control">
                    <input type="number" id="checkAmount${id}" placeholder="Ù…Ø¨Ù„Øº" class="form-control" oninput="calculateBalance()">
                    <input type="date" id="checkDue${id}" class="form-control">
                    <button class="btn btn-danger btn-sm" onclick="this.parentElement.remove(); calculateBalance();">Ø­Ø°Ù</button>
                </div>`;
        }

        function calculateBalance() {
            let totalProducts = 0, totalChecks = 0;
            const advance = parseInt(document.getElementById('advancePayment').value) || 0;

            // Ù…Ø­ØµÙˆÙ„Ø§Øª
            for (let i = 0; i < 100; i++) {
                const typeEl = document.getElementById(`prodType${i}`);
                const qtyEl = document.getElementById(`prodQty${i}`);
                const priceEl = document.getElementById(`prodPrice${i}`);
                if (typeEl && qtyEl?.value && priceEl?.value) {
                    totalProducts += parseInt(qtyEl.value) * parseInt(priceEl.value);
                }
                const checkAmt = document.getElementById(`checkAmount${i}`);
                if (checkAmt?.value) {
                    totalChecks += parseInt(checkAmt.value);
                }
            }

            document.getElementById('totalProducts').textContent = formatCurrency(totalProducts);
            document.getElementById('totalAdvance').textContent = formatCurrency(advance);
            document.getElementById('totalChecks').textContent = formatCurrency(totalChecks);
            document.getElementById('accountBalance').textContent = formatCurrency(totalProducts - advance - totalChecks);
        }

        function saveContract() {
            const customer = document.getElementById('customerName').value.trim();
            if (!customer) return showNotification('Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª', 'error');

            const contract = {
                id: Date.now(),
                number: `CF-${String(appData.contracts.length + 1).padStart(3, '0')}`,
                customer, phone: document.getElementById('customerPhone').value,
                address: document.getElementById('customerAddress').value,
                date: document.getElementById('contractDate').value,
                deliveryDate: document.getElementById('deliveryDate').value,
                products: [], checks: [],
                advance: parseInt(document.getElementById('advancePayment').value) || 0
            };

            // Ù…Ø­ØµÙˆÙ„Ø§Øª
            for (let i = 0; i < 100; i++) {
                const type = document.getElementById(`prodType${i}`);
                const name = document.getElementById(`prodName${i}`);
                const qty = document.getElementById(`prodQty${i}`);
                const price = document.getElementById(`prodPrice${i}`);
                if (type?.value && name?.value && qty?.value && price?.value) {
                    contract.products.push({
                        type: type.value, name: name.value,
                        qty: parseInt(qty.value), price: parseInt(price.value)
                    });
                }
            }

            // Ú†Ú©â€ŒÙ‡Ø§
            for (let i = 0; i < 100; i++) {
                const num = document.getElementById(`checkNum${i}`);
                const amt = document.getElementById(`checkAmount${i}`);
                const due = document.getElementById(`checkDue${i}`);
                if (num?.value && amt?.value) {
                    contract.checks.push({
                        number: num.value, amount: parseInt(amt.value), due: due?.value || ''
                    });
                    appData.checks.push({
                        id: Date.now() + i, number: num.value, customer,
                        amount: parseInt(amt.value), due: due?.value || '', status: 'Ø¯Ø± Ø¬Ø±ÛŒØ§Ù†'
                    });
                }
            }

            appData.contracts.push(contract);
            localStorage.setItem('kaleshi_v15', JSON.stringify(appData));
            showNotification('âœ… Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯');
            loadContracts();
            resetForm();
            updateDashboard();
        }

        function loadContracts() {
            const tbody = document.querySelector('#contractsTable tbody');
            tbody.innerHTML = appData.contracts.map(c => {
                const total = c.products.reduce((sum, p) => sum + (p.qty * p.price), 0);
                return `
                    <tr>
                        <td>${c.number}</td>
                        <td>${c.customer}</td>
                        <td>${formatCurrency(total)}</td>
                        <td>${c.date}</td>
                        <td>
                            <button class="btn btn-info btn-sm" onclick="editContract(${c.id})">ÙˆÛŒØ±Ø§ÛŒØ´</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteContract(${c.id})">Ø­Ø°Ù</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function deleteContract(id) {
            if (confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) {
                appData.contracts = appData.contracts.filter(c => c.id !== id);
                localStorage.setItem('kaleshi_v15', JSON.stringify(appData));
                loadContracts();
                updateDashboard();
                showNotification('Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø­Ø°Ù Ø´Ø¯');
            }
        }

        // Ù…Ø´ØªØ±ÛŒØ§Ù† - Ú©Ø§Ù…Ù„
        function loadCustomers() {
            const tbody = document.querySelector('#customersTable tbody');
            tbody.innerHTML = appData.customers.map(c => `
                <tr>
                    <td>${c.name}</td>
                    <td>${c.phone}</td>
                    <td>${c.address || '-'}</td>
                    <td>
                        <span style="padding: 5px 12px; border-radius: 20px; background: ${
                            c.type === 'Ø¹Ø§Ø¯ÛŒ' ? '#10b981' : c.type === 'Ù¾ÛŒØ´ Ø®Ø±ÛŒØ¯' ? '#f59e0b' : '#8b5cf6'
                        }; color: white; font-size: 12px;">
                            ${c.type}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-info btn-sm" onclick="editCustomer(${c.id})">ÙˆÛŒØ±Ø§ÛŒØ´</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteCustomer(${c.id})">Ø­Ø°Ù</button>
                    </td>
                </tr>
            `).join('');

            const datalist = document.getElementById('customerList');
            datalist.innerHTML = appData.customers.map(c => `<option value="${c.name}">`).join('');
        }

        function showCustomerForm() {
            document.getElementById('customerForm').style.display = 'block';
            editingCustomerId = null;
            document.getElementById('newCustomerName').value = '';
            document.getElementById('newCustomerPhone').value = '';
            document.getElementById('newCustomerAddress').value = '';
        }

        function hideCustomerForm() {
            document.getElementById('customerForm').style.display = 'none';
        }

        function saveCustomer() {
            const name = document.getElementById('newCustomerName').value.trim();
            const phone = document.getElementById('newCustomerPhone').value.trim();
            const address = document.getElementById('newCustomerAddress').value;
            const type = document.getElementById('customerType').value;

            if (!name || !phone) {
                return showNotification('Ù†Ø§Ù… Ùˆ ØªÙ„ÙÙ† Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª', 'error');
            }

            const customer = { name, phone, address, type };

            if (editingCustomerId) {
                const index = appData.customers.findIndex(c => c.id === editingCustomerId);
                appData.customers[index] = { ...appData.customers[index], ...customer };
                showNotification('Ù…Ø´ØªØ±ÛŒ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯');
            } else {
                customer.id = Date.now();
                appData.customers.push(customer);
                showNotification('Ù…Ø´ØªØ±ÛŒ Ø¬Ø¯ÛŒØ¯ Ø«Ø¨Øª Ø´Ø¯');
            }

            localStorage.setItem('kaleshi_v15', JSON.stringify(appData));
            loadCustomers();
            hideCustomerForm();
            updateDashboard();
        }

        function editCustomer(id) {
            const customer = appData.customers.find(c => c.id === id);
            if (customer) {
                document.getElementById('newCustomerName').value = customer.name;
                document.getElementById('newCustomerPhone').value = customer.phone;
                document.getElementById('newCustomerAddress').value = customer.address || '';
                document.getElementById('customerType').value = customer.type;
                editingCustomerId = id;
                showCustomerForm();
            }
        }

        function deleteCustomer(id) {
            if (confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) {
                appData.customers = appData.customers.filter(c => c.id !== id);
                localStorage.setItem('kaleshi_v15', JSON.stringify(appData));
                loadCustomers();
                updateDashboard();
                showNotification('Ù…Ø´ØªØ±ÛŒ Ø­Ø°Ù Ø´Ø¯');
            }
        }

        function loadChecks() {
            const tbody = document.querySelector('#checksTable tbody');
            tbody.innerHTML = appData.checks.map(c => `
                <tr>
                    <td>${c.number}</td>
                    <td>${c.customer}</td>
                    <td>${formatCurrency(c.amount)}</td>
                    <td>${c.due}</td>
                    <td>
                        <span style="padding: 4px 10px; border-radius: 15px; background: ${
                            c.status === 'ÙˆØµÙˆÙ„ Ø´Ø¯Ù‡' ? '#10b981' : '#f59e0b'
                        }; color: white; font-size: 12px;">
                            ${c.status}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-success btn-sm">ÙˆØµÙˆÙ„</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteCheck(${c.id})">Ø­Ø°Ù</button>
                    </td>
                </tr>
            `).join('');
        }

        function deleteCheck(id) {
            if (confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) {
                appData.checks = appData.checks.filter(c => c.id !== id);
                localStorage.setItem('kaleshi_v15', JSON.stringify(appData));
                loadChecks();
                updateDashboard();
            }
        }

        function printContract() {
            window.print();
        }

        // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
        window.onload = function() {
            document.getElementById('username').focus();
        };
    </script>
</body>
</html>
