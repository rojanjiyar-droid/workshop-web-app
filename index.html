<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ú©Ù„Ø´ÛŒâ€ŒÙÙˆÙ… v20</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/font-face.css " rel="stylesheet">
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/print.css">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js "></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js "></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js "></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js "></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js "></script>
    <script src="https://cdn.jsdelivr.net/npm/moment-jalaali@0.9.6/build/moment-jalaali.js "></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css ">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr "></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/fa.js "></script>
</head>
<body>
<div id="loading" class="loading"><div class="spinner"></div><div>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div></div>
<div id="notifications"></div>

<!-- LOGIN -->
<div id="loginPage" class="login-container">
    <div class="login-card">
        <div class="login-logo">CF</div>
        <h2>Ø³ÛŒØ³ØªÙ… Ø¬Ø§Ù…Ø¹ Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ Ú©Ù„Ø´ÛŒâ€ŒÙÙˆÙ…</h2>
        <input type="text" id="username" placeholder="admin">
        <input type="password" id="password" placeholder="1234">
        <button class="btn btn-primary w-100" onclick="login()">ÙˆØ±ÙˆØ¯</button>
    </div>
</div>

<!-- MAIN APP -->
<div id="mainApp" style="display:none">
    <header class="main-header">
        <button class="hamburger-menu" onclick="toggleNav()">â˜°</button>
        <span id="userName"></span>
        <button class="btn btn-danger btn-sm" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
    </header>
    <nav class="main-nav" id="mainNav"></nav>
    <main class="container" id="pagesContainer"></main>
</div>

<!-- Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ -->
<script src="assets/js/utils/date.js"></script>
<script src="assets/js/utils/validate.js"></script>
<script src="assets/js/utils/export.js"></script>
<script src="assets/js/modules/auth.js"></script>
<script src="assets/js/modules/customers.js"></script>
<script src="assets/js/modules/contracts.js"></script>
<script src="assets/js/modules/invoices.js"></script>
<script src="assets/js/modules/checks.js"></script>
<script src="assets/js/modules/inventory.js"></script>
<script src="assets/js/modules/ai.js"></script>
<script src="assets/js/modules/pwa.js"></script>
<script src="assets/js/modules/printer.js"></script>
<script src="assets/js/modules/backup.js"></script>
<script src="assets/js/app.js"></script>
</body>
</html>

{
  "name": "Ú©Ù„Ø´ÛŒâ€ŒÙÙˆÙ… v20 â€“ Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯",
  "short_name": "Ú©Ù„Ø´ÛŒâ€ŒÙÙˆÙ…",
  "start_url": "index.html",
  "display": "standalone",
  "background_color": "#1e3a8a",
  "theme_color": "#3b82f6",
  "orientation": "portrait",
  "icons": [
    {
      "src": "assets/icons/icon-192.png",
      "sizes": "192x192",
      "type": "image/png"
    },
    {
      "src": "assets/icons/icon-512.png",
      "sizes": "512x512",
      "type": "image/png"
    }
  ]
}

:root{
  --primary:#1e3a8a;
  --secondary:#3b82f6;
  --success:#10b981;
  --warning:#f59e0b;
  --danger:#ef4444;
  --info:#06b6d4;
  --light:#f8fafc;
  --dark:#0f172a;
  --gray:#64748b;
  --shadow:0 10px 15px -3px rgba(0,0,0,.1);
  --border-radius:12px;
  --transition:all .3s ease;
}
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:'Vazirmatn',Tahoma,system-ui,sans-serif;
  background:linear-gradient(135deg,#667eea 0%,#764ba2 50%,#f093fb 100%);
  min-height:100vh;color:var(--dark);line-height:1.6;
}
.container{max-width:1400px;margin:0 auto;padding:0 20px}
.loading{position:fixed;inset:0;background:rgba(255,255,255,.9);z-index:9999;display:none;flex-direction:column;align-items:center;justify-content:center}
.spinner{width:50px;height:50px;border:4px solid #f3f3f3;border-top:4px solid var(--secondary);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.login-container{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:40px 20px}
.login-card{background:#fff;border-radius:20px;padding:40px;width:100%;max-width:400px;box-shadow:var(--shadow)}
.login-logo{width:80px;height:80px;margin:0 auto 24px;background:linear-gradient(135deg,var(--primary),var(--secondary));border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:24px;font-weight:800}
.main-header{background:var(--dark);color:#fff;padding:16px 24px;display:flex;justify-content:space-between;align-items:center}
.hamburger-menu{background:none;border:none;color:#fff;font-size:24px;cursor:pointer}
.main-nav{background:var(--dark);display:flex;flex-wrap:wrap;justify-content:center;gap:2px;padding:8px}
.nav-btn{background:none;border:none;color:rgba(255,255,255,.9);padding:14px 18px;cursor:pointer;white-space:nowrap;transition:var(--transition);border-bottom:3px solid transparent}
.nav-btn:hover{background:rgba(255,255,255,.1);color:#fff}
.nav-btn.active{background:var(--secondary);color:#fff}
.page{display:none;padding:20px;animation:fadeIn .5s}
.page.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.card{background:#fff;border-radius:var(--border-radius);box-shadow:var(--shadow);overflow:hidden;margin-bottom:20px}
.card-header{background:linear-gradient(135deg,var(--primary),#1e40af);color:#fff;padding:20px;display:flex;justify-content:space-between;align-items:center}
.btn{padding:12px 24px;border:none;border-radius:8px;font-weight:600;cursor:pointer;transition:var(--transition);display:inline-flex;align-items:center;gap:8px;font-size:14px}
.btn:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,.2)}
.btn-primary{background:var(--secondary);color:#fff}
.btn-success{background:var(--success);color:#fff}
.btn-danger{background:var(--danger);color:#fff}
.btn-warning{background:var(--warning);color:#fff}
.btn-info{background:var(--info);color:#fff}
.btn-sm{padding:8px 16px;font-size:13px}
.form-group{margin-bottom:20px}
.form-label{display:block;margin-bottom:8px;font-weight:600;color:var(--dark)}
.form-control{width:100%;padding:12px 16px;border:2px solid #e2e8f0;border-radius:8px;font-size:15px;transition:var(--transition)}
.form-control:focus{outline:none;border-color:var(--secondary);box-shadow:0 0 0 3px rgba(59,130,246,.1)}
.table-container{overflow-x:auto;margin-top:20px}
.table{width:100%;border-collapse-collapse}
.table th{background:var(--primary);color:#fff;padding:15px;text-align:right;font-weight:600}
.table td{padding:12px 15px;border-bottom:1px solid #eee;text-align:right}
.table tr:hover{background:#f8f9ff}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin:20px 0}
.stat-card{background:linear-gradient(135deg,var(--secondary),#1d4ed8);color:#fff;padding:24px;border-radius:var(--border-radius);text-align:center}
.stat-value{font-size:28px;font-weight:800;margin-bottom:8px}
.notification{position:fixed;top:20px;right:20px;background:#fff;padding:16px 20px;border-radius:8px;box-shadow:0 10px 25px rgba(0,0,0,.15);z-index:10000;border-right:4px solid;display:flex;align-items:center;gap:12px;max-width:350px;animation:slideInRight .3s ease-out}
@keyframes slideInRight{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
.connection-status{position:fixed;bottom:20px;left:20px;background:#fff;padding:10px 16px;border-radius:8px;box-shadow:0 5px 15px rgba(0,0,0,.1);font-size:14px;z-index:1000;display:flex;align-items:center;gap:8px}
.connection-status.online{border-left:4px solid var(--success)}
.connection-status.offline{border-left:4px solid var(--danger)}
@media print{body{background:#fff!important}.no-print{display:none!important}}

@page {
  size: A4;
  margin: 10mm;
  /* Ú©ÙˆÚ†Ú©â€ŒØªØ±ÛŒÙ† Ø­Ø§Ø´ÛŒÙ‡ Ù…Ø¬Ø§Ø² Ø¨Ø±Ø§ÛŒ Ø­Ø¯Ø§Ú©Ø«Ø± Ù…Ø­ØªÙˆØ§ */
}

body.print {
  font-size: 10pt;
  line-height: 1.3;
  color: #000;
  background: #fff;
}

.print .print-only {
  display: block !important;
}

.print .no-print,
.print .main-header,
.print .main-nav,
.print .btn {
  display: none !important;
}

.print-header {
  text-align: center;
  border-bottom: 2px solid #000;
  padding-bottom: 6mm;
  margin-bottom: 6mm;
}

.print-logo {
  width: 20mm;
  height: 20mm;
  margin: 0 auto 4mm;
  object-fit: contain;
}

.print-company {
  font-weight: bold;
  font-size: 12pt;
}

.print-customer {
  margin-top: 4mm;
  font-size: 9pt;
}

.print-table {
  width: 100%;
  border-collapse: collapse;
  margin: 4mm 0;
}

.print-table th,
.print-table td {
  border: 1px solid #000;
  padding: 2mm 3mm;
  text-align: right;
  font-size: 9pt;
}

.print-totals {
  margin-top: 4mm;
  padding: 3mm;
  border: 1px dashed #000;
  width: 50%;
  margin-left: auto;
}

.print-totals .row {
  display: flex;
  justify-content: space-between;
  margin-bottom: 1mm;
}

.print-signatures {
  display: flex;
  justify-content: space-between;
  margin-top: 15mm;
}

.print-signatures div {
  text-align: center;
  width: 30%;
}

.print-signatures .line {
  border-top: 1px solid #000;
  margin-top: 10mm;
}

.print-footer {
  position: fixed;
  bottom: 10mm;
  right: 10mm;
  left: 10mm;
  text-align: center;
  font-size: 8pt;
  border-top: 1px solid #ccc;
  padding-top: 2mm;
}

@media print {
  .print-header {
    page-break-after: avoid;
  }
  .print-table {
    page-break-inside: avoid;
  }
  .print-signatures {
    page-break-before: always;
  }
}

// ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø¨Ù‡ Ø´Ù…Ø³ÛŒ
const toShamsi = (date) => {
  return moment(date).format('YYYY/MM/DD');
};

// ØªØ¨Ø¯ÛŒÙ„ Ø´Ù…Ø³ÛŒ Ø¨Ù‡ Ù…ÛŒÙ„Ø§Ø¯ÛŒ
const toMiladi = (shamsi) => {
  return moment(shamsi, 'YYYY/MM/DD').toISOString();
};

// ØªØ§Ø±ÛŒØ® Ù…Ø±ÙˆØ² Ø´Ø³ÛŒ
const todayShamsi = () => moment().format('YYYY/MM/DD');

// Ø´Ø±ÙˆØ¹ Flatpickr ÙØ§Ø±Ø³ÛŒ
const initCalendar = () => {
  flatpickr('.date-picker', {
    locale: 'fa',
    dateFormat: 'YYYY/MM/DD',
    altInput: true,
    altFormat: 'YYYY/MM/DD',
    defaultDate: todayShamsi(),
    minDate: '1398/01/01',
    maxDate: '1420/12/29'
  });
};

// Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ØªÙ„ÙÙ† Ù‡Ù…Ø±Ø§Ù‡
const validateMobile = (v) => /^09[0-9]{9}$/.test(v);

// Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ú©Ø¯ Ù…Ù„ÛŒ
const validateNationalCode = (code) => {
  if (!/^\d{10}$/.test(code)) return false;
  const L = code.length, b = +code[L - 1], c = +code.substr(0, L - 1);
  let d = 0, i = L;
  while (i--) d += +code[i] * (L - i);
  return (d - b) % 11 < 2 && b === +code[9];
};

// ÙÙ‚Ø· Ø­Ø±ÙˆÙ ÙØ§Ø±Ø³ÛŒ
const validatePersianText = (t) => /^[\u0600-\u06FF\s\.\-\ØŒ]+$/.test(t);

// Ù†Ù…Ø§ÛŒØ´ Ø®Ø·Ø§
const showError = (input, msg) => {
  input.classList.add('error');
  const box = document.createElement('div');
  box.className = 'validation-error';
  box.textContent = msg;
  input.parentElement.appendChild(box);
  setTimeout(() => box.remove(), 3000);
};

// Ø®Ø±ÙˆØ¬ÛŒ Ø§Ú©Ø³Ù„ Ø¹Ù…ÙˆÙ…ÛŒ
const exportToExcel = (data, fileName, sheetName) => {
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, sheetName);
  XLSX.writeFile(wb, `${fileName}_${moment().format('YYYY-MM-DD')}.xlsx`);
};

// Ø¯Ø§Ù†Ù„ÙˆØ¯ JSON
const downloadJSON = (obj, name) => {
  const blob = new Blob([JSON.stringify(obj, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `${name}.json`; a.click();
  URL.revokeObjectURL(url);
};

const auth = {
  login() {
    const u = document.getElementById('username').value.trim();
    const p = document.getElementById('password').value.trim();
    if (!u || !p) return alert('Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ùˆ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
    const hp = CryptoJS.SHA256(p).toString();
    if (u === 'admin' && hp === appData.auth.password) {
      appData.currentUser = { name: 'Ù…Ø¯ÛŒØ± Ø³ÛŒØ³ØªÙ…' };
      saveData();
      document.getElementById('loginPage').style.display = 'none';
      document.getElementById('mainApp').style.display = 'block';
      document.getElementById('userName').textContent = appData.currentUser.name;
      initNav(); initPages(); showNotification('ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚', 'success');
    } else {
      showNotification('Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª', 'error');
    }
  },
  logout() {
    if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ø®Ø±ÙˆØ¬ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
      appData.currentUser = null; saveData(); location.reload();
    }
  }
};

// Ø°Ø®ÛŒØ±Ù‡/Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡
const saveData = () => localStorage.setItem('kaleshiData', JSON.stringify(appData));
const loadData = () => {
  const d = localStorage.getItem('kaleshiData');
  if (d) appData = JSON.parse(d);
};

// Ø³Ø§Ø®ØªØ§Ø± Ø§ÙˆÙ„ÛŒÙ‡ Ø¯Ø§Ø¯Ù‡
let appData = {
  auth: { username: 'admin', password: CryptoJS.SHA256('1234').toString() },
  currentUser: null,
  customers: [],
  contracts: [],
  checks: [],
  transactions: [],
  workers: [],
  invoices: [],
  inventory: [],
  settings: {
    companyName: 'Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ ÛŒÙˆÙ†ÙˆÙ„ÛŒØª Ú©Ù„Ø´ÛŒâ€ŒÙÙˆÙ…',
    companyPhone: '09149431013',
    companyAddress: 'Ø§Ø±ÙˆÙ…ÛŒÙ‡ - Ø¬Ø§Ø¯Ù‡ Ø³Ù„Ù…Ø§Ø³',
    taxRate: 9,
    minSalary: 45000000,
    overtimeRate: 40,
    primaryColor: '#1e3a8a',
    secondaryColor: '#3b82f6',
    themeMode: 'light',
    autoBackupInterval: 7
  },
  version: '20.0'
};

// Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
window.addEventListener('DOMContentLoaded', () => {
  loadData();
  if (appData.currentUser) {
    document.getElementById('loginPage').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    document.getElementById('userName').textContent = appData.currentUser.name;
    initNav(); initPages(); updateDashboard();
  }
});

const customers = {
  list: () => appData.customers,

  // Ø§ÙØ²ÙˆØ¯Ù† Ø®ÙˆØ¯Ú©Ø§Ø± Ø§Ø² Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯
  autoAddFromContract(name, phone, address) {
    const exists = this.list().some(c => c.phone === phone);
    if (exists) return;
    const customer = {
      id: Date.now(),
      name,
      phone,
      address: address || '',
      nationalCode: '',
      type: 'Ø¹Ø§Ø¯ÛŒ',
      registrationDate: new Date().toISOString(),
      totalSpent: 0,
      level: 'Ø¨Ø±Ù†Ø²ÛŒ'
    };
    this.list().push(customer);
    saveData();
  },

  // Ø­Ø°Ù Ú¯Ø±ÙˆÙ‡ÛŒ
  deleteSelected() {
    const selected = Array.from(document.querySelectorAll('.customer-checkbox:checked')).map(cb => cb.value);
    if (!selected.length) return showNotification('Ù…ÙˆØ±Ø¯ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡', 'warning');
    if (!confirm(`Ø­Ø°Ù ${selected.length} Ù…Ø´ØªØ±ÛŒØŸ`)) return;
    selected.forEach(id => {
      const idx = this.list().findIndex(c => c.id == id);
      if (idx > -1) this.list().splice(idx, 1);
    });
    saveData(); this.render(); showNotification('Ù…Ø´ØªØ±ÛŒØ§Ù† Ø­Ø°Ù Ø´Ø¯Ù†Ø¯', 'success');
  },

  // Ø±Ù†Ø¯Ø± Ø¬Ø¯ÙˆÙ„
  render() {
    const tbody = document.querySelector('#customersTable tbody');
    if (!tbody) return;
    tbody.innerHTML = '';
    this.list().forEach((c, i) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="checkbox" class="customer-checkbox" value="${c.id}"></td>
        <td>${i + 1}</td>
        <td>${c.name}</td>
        <td>${c.phone}</td>
        <td>${c.nationalCode || '-'}</td>
        <td><span class="badge badge-${c.level}">${c.level}</span></td>
        <td>${toShamsi(c.registrationDate)}</td>
        <td>${c.totalSpent.toLocaleString('fa-IR')}</td>
        <td>
          <button class="btn btn-sm btn-warning" onclick="customers.edit('${c.id}')">âœï¸</button>
          <button class="btn btn-sm btn-danger" onclick="customers.delete('${c.id}')">ğŸ—‘ï¸</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  },

  edit(id) {
    const c = this.list().find(c => c.id == id);
    if (!c) return;
    const name = prompt('Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯:', c.name);
    const phone = prompt('ØªÙ„ÙÙ† Ø¬Ø¯ÛŒØ¯:', c.phone);
    if (name && phone) {
      c.name = name; c.phone = phone;
      saveData(); this.render(); showNotification('ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯', 'success');
    }
  },

  delete(id) {
    if (!confirm('Ø­Ø°Ù Ù…Ø´ØªØ±ÛŒØŸ')) return;
    const idx = this.list().findIndex(c => c.id == id);
    if (idx > -1) { this.list().splice(idx, 1); saveData(); this.render(); }
  }
};

const contracts = {
  list: () => appData.contracts,

  // Ø«Ø¨Øª Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ + Ø§ÙØ²ÙˆØ¯Ù† Ø®ÙˆØ¯Ú©Ø§Ø± Ù…Ø´ØªØ±ÛŒ
  save() {
    const customer = document.getElementById('contractCustomer').value.trim();
    const phone    = document.getElementById('contractPhone').value.trim();
    if (!customer || !phone) return showNotification('Ù…Ø´ØªØ±ÛŒ Ùˆ ØªÙ„ÙÙ† Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª', 'error');
    customers.autoAddFromContract(customer, phone, document.getElementById('contractAddress').value);

    const products = [], checks = [];
    document.querySelectorAll('.product-row').forEach(r => {
      const cat = r.querySelector('.product-category').value;
      const qty = parseFloat(r.querySelector('.product-qty').value) || 0;
      const prc = parseFloat(r.querySelector('.product-price').value) || 0;
      if (qty && prc) products.push({ category: cat, qty, price: prc, total: qty * prc });
    });
    if (!products.length) return showNotification('Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ù…Ø­ØµÙˆÙ„ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error');

    document.querySelectorAll('.check-row').forEach(r => {
      const num = r.querySelector('.check-number').value;
      const amt = parseFloat(r.querySelector('.check-amount').value) || 0;
      const due = r.querySelector('.check-due-date').value;
      if (num && amt && due) checks.push({ number: num, amount: amt, dueDate: due });
    });

    const advance = parseFloat(document.getElementById('advancePayment').value) || 0;
    const totalProducts = products.reduce((s, p) => s + p.total, 0);
    const totalChecks   = checks.reduce((s, c) => s + c.amount, 0);
    const balance       = totalProducts - advance - totalChecks;

    const year = moment().format('YYYY');
    const seq  = (this.list().length + 1).toString().padStart(4, '0');
    const contractNumber = `${year}-${seq}`;

    const contract = {
      id: Date.now(),
      contractNumber,
      customer, phone,
      address: document.getElementById('contractAddress').value,
      date: toMiladi(document.getElementById('contractDate').value) || new Date().toISOString(),
      products, checks,
      totalAmount: totalProducts,
      advance,
      checkAmount: totalChecks,
      balance,
      status: 'ÙØ¹Ø§Ù„'
    };

    this.list().push(contract);
    checks.forEach(ch => {
      appData.checks.push({
        id: Date.now() + Math.random(),
        contractId: contract.id,
        customer,
        number: ch.number,
        amount: ch.amount,
        dueDate: toMiladi(ch.dueDate),
        bank: 'Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡',
        status: 'Ø¯Ø± Ø¬Ø±ÛŒØ§Ù†'
      });
    });

    saveData(); showNotification('Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø«Ø¨Øª Ø´Ø¯', 'success');
    this.resetForm(); this.render(); customers.render();
  },

  resetForm() {
    document.getElementById('contractCustomer').value = '';
    document.getElementById('contractPhone').value = '';
    document.getElementById('contractAddress').value = '';
    document.getElementById('advancePayment').value = '0';
    document.getElementById('productsContainer').innerHTML = '';
    document.getElementById('checksContainer').innerHTML = '';
    let productRowCount = 0, checkRowCount = 0;
    window.addProductRow(); window.addCheckRow();
    window.calculateContractTotals();
  },

  render() {
    const tbody = document.querySelector('#contractsTable tbody');
    if (!tbody) return;
    tbody.innerHTML = '';
    this.list().forEach((c, i) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="checkbox" class="contract-checkbox" value="${c.id}"></td>
        <td>${i + 1}</td>
        <td>${c.contractNumber}</td>
        <td>${c.customer}</td>
        <td>${c.phone}</td>
        <td>${c.totalAmount.toLocaleString('fa-IR')}</td>
        <td>${c.advance.toLocaleString('fa-IR')}</td>
        <td>${c.checkAmount.toLocaleString('fa-IR')}</td>
        <td>${c.balance.toLocaleString('fa-IR')}</td>
        <td>${toShamsi(c.date)}</td>
        <td><span class="badge badge-success">${c.status}</span></td>
        <td>
          <button class="btn btn-sm btn-primary" onclick="contracts.print('${c.id}')">ğŸ–¨ï¸</button>
          <button class="btn btn-sm btn-danger" onclick="contracts.delete('${c.id}')">ğŸ—‘ï¸</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  },

  print(id) {
    const c = this.list().find(c => c.id == id);
    if (!c) return;
    const printWin = window.open('', '', 'width=800,height=600');
    printWin.document.write(`
      <html><head><meta charset="utf-8"/><title>Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ ${c.contractNumber}</title>
      <link rel="stylesheet" href="assets/css/print.css">
      </head><body class="print">
      <div class="print-header">
        <img class="print-logo" src="${localStorage.getItem('companyLogo') || ''}" onerror="this.style.display='none'">
        <div class="print-company">${appData.settings.companyName}</div>
        <div class="print-customer">Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø´Ù…Ø§Ø±Ù‡: ${c.contractNumber}</div>
      </div>
      <div class="print-customer">
        <div>Ù…Ø´ØªØ±ÛŒ: ${c.customer}</div><div>ØªÙ„ÙÙ†: ${c.phone}</div><div>ØªØ§Ø±ÛŒØ®: ${toShamsi(c.date)}</div>
      </div>
      <table class="print-table"><thead><tr><th>Ø±Ø¯ÛŒÙ</th><th>Ù…Ø­ØµÙˆÙ„</th><th>Ù…Ù‚Ø¯Ø§Ø±</th><th>Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯</th><th>Ø¬Ù…Ø¹</th></tr></thead><tbody>
      ${c.products.map((p, i) => `
        <tr><td>${i + 1}</td><td>${p.category}</td><td>${p.qty}</td><td>${p.price.toLocaleString('fa-IR')}</td><td>${p.total.toLocaleString('fa-IR')}</td></tr>
      `).join('')}
      </tbody></table>
      <div class="print-totals">
        <div class="row"><span>Ø¬Ù…Ø¹ Ú©Ù„:</span><span>${c.totalAmount.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†</span></div>
        <div class="row"><span>Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª:</span><span>${c.advance.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†</span></div>
        <div class="row"><span>Ù…Ø§Ù†Ø¯Ù‡:</span><span>${c.balance.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†</span></div>
      </div>
      <div class="print-signatures">
        <div>Ø§Ù…Ø¶Ø§Ø¡ Ù…Ø´ØªØ±ÛŒ<div class="line"></div></div>
        <div>Ø§Ù…Ø¶Ø§Ø¡ ÙØ±ÙˆØ´Ù†Ø¯Ù‡<div class="line"></div></div>
      </div>
      </body></html>
    `);
    printWin.document.close(); printWin.print();
  },

  delete(id) {
    if (!confirm('Ø­Ø°Ù Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ØŸ')) return;
    const idx = this.list().findIndex(c => c.id == id);
    if (idx > -1) { this.list().splice(idx, 1); saveData(); this.render(); }
  }
};

const checks = {
  list: () => appData.checks,

  // Ø­Ø°Ù Ú¯Ø±ÙˆÙ‡ÛŒ
  deleteSelected() {
    const selected = Array.from(document.querySelectorAll('.check-checkbox:checked')).map(cb => cb.value);
    if (!selected.length) return showNotification('Ú†Ú©ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡', 'warning');
    if (!confirm(`Ø­Ø°Ù ${selected.length} Ú†Ú©ØŸ`)) return;
    selected.forEach(id => {
      const idx = this.list().findIndex(ch => ch.id == id);
      if (idx > -1) this.list().splice(idx, 1);
    });
    saveData(); this.render(); showNotification('Ú†Ú©â€ŒÙ‡Ø§ Ø­Ø°Ù Ø´Ø¯Ù†Ø¯', 'success');
  },

  // Ù‡Ø´Ø¯Ø§Ø± Ø³Ø±Ø±Ø³ÛŒØ¯
  notifyDue() {
    const today = new Date();
    this.list().filter(ch => ch.status === 'Ø¯Ø± Ø¬Ø±ÛŒØ§Ù†').forEach(ch => {
      const due = new Date(ch.dueDate);
      const diff = Math.ceil((due - today) / (1000 * 60 * 60 * 24));
      if (diff >= 0 && diff <= 3) {
        showNotification(`Ú†Ú© Ø´Ù…Ø§Ø±Ù‡ ${ch.number} ÙØ±Ø¯Ø§ Ø³Ø±Ø±Ø³ÛŒØ¯ Ø¯Ø§Ø±Ø¯`, 'warning', 0);
      }
    });
  },

  render() {
    const tbody = document.querySelector('#checksTable tbody');
    if (!tbody) return;
    tbody.innerHTML = '';
    const today = new Date();
    this.list().forEach((ch, i) => {
      const due = new Date(ch.dueDate);
      const diff = Math.ceil((due - today) / (1000 * 60 * 60 * 24));
      const statusCls = ch.status === 'Ø¯Ø± Ø¬Ø±ÛŒØ§Ù†' ? 'warning' : ch.status === 'ÙˆØµÙˆÙ„ Ø´Ø¯Ù‡' ? 'success' : 'danger';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="checkbox" class="check-checkbox" value="${ch.id}"></td>
        <td>${i + 1}</td>
        <td>${ch.number}</td>
        <td>${ch.customer}</td>
        <td>${ch.amount.toLocaleString('fa-IR')}</td>
        <td>${ch.bank}</td>
        <td>${toShamsi(ch.dueDate)}</td>
        <td><span class="badge badge-${diff <= 0 ? 'danger' : 'info'}">${diff} Ø±ÙˆØ²</span></td>
        <td><span class="badge badge-${statusCls}">${ch.status}</span></td>
        <td>
          <button class="btn btn-sm btn-success" onclick="checks.setStatus('${ch.id}', 'ÙˆØµÙˆÙ„ Ø´Ø¯Ù‡')">âœ…</button>
          <button class="btn btn-sm btn-danger" onclick="checks.setStatus('${ch.id}', 'Ø¨Ø±Ú¯Ø´Øª Ø®ÙˆØ±Ø¯Ù‡')">âŒ</button>
          <button class="btn btn-sm btn-primary" onclick="checks.print('${ch.id}')">ğŸ–¨ï¸</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  },

  setStatus(id, status) {
    const ch = this.list().find(ch => ch.id == id);
    if (ch) { ch.status = status; saveData(); this.render(); }
  },

  print(id) {
    const ch = this.list().find(ch => ch.id == id);
    if (!ch) return;
    const win = window.open('', '', 'width=600,height=400');
    win.document.write(`
      <html><head><meta charset="utf-8"/><title>Ú†Ú© ${ch.number}</title>
      <link rel="stylesheet" href="assets/css/print.css">
      </head><body class="print">
      <div class="print-header">
        <div class="print-company">${appData.settings.companyName}</div>
        <div class="print-customer">Ú†Ú© Ø´Ù…Ø§Ø±Ù‡: ${ch.number}</div>
      </div>
      <div class="print-customer">
        <div>Ù…Ø´ØªØ±ÛŒ: ${ch.customer}</div>
        <div>Ù…Ø¨Ù„Øº: ${ch.amount.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†</div>
        <div>Ø¨Ø§Ù†Ú©: ${ch.bank}</div>
        <div>Ø³Ø±Ø±Ø³ÛŒØ¯: ${toShamsi(ch.dueDate)}</div>
        <div>ÙˆØ¶Ø¹ÛŒØª: ${ch.status}</div>
      </div>
      </body></html>
    `);
    win.document.close(); win.print();
  }
};

// Ø§Ø¬Ø±Ø§ÛŒ Ù‡Ø´Ø¯Ø§Ø± Ø±ÙˆØ²Ø§Ù†Ù‡
setInterval(() => checks.notifyDue(), 1000 * 60 * 60 * 24);

const inventory = {
  list: () => appData.inventory,

  // Ø§ÙØ²ÙˆØ¯Ù†/Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ÙˆØ¬ÙˆØ¯ÛŒ
  update(item) {
    const { category, qty, price, type } = item; // type: 'ÙˆØ±ÙˆØ¯' ÛŒØ§ 'Ø®Ø±ÙˆØ¬'
    const exist = this.list().find(i => i.category === category);
    if (exist) {
      exist.stock += (type === 'ÙˆØ±ÙˆØ¯' ? 1 : -1) * qty;
      exist.lastPrice = price;
    } else {
      this.list().push({
        id: Date.now(),
        category,
        stock: qty,
        lastPrice: price,
        minStock: 50,
        unit: 'Ø¹Ø¯Ø¯'
      });
    }
    saveData(); this.render(); this.lowStockAlert();
  },

  // Ú©Ø³Ø± Ø§Ø² Ø§Ù†Ø¨Ø§Ø± Ù‡Ù†Ú¯Ø§Ù… Ø«Ø¨Øª Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯
  consume(category, qty) {
    const item = this.list().find(i => i.category === category);
    if (!item) return showNotification('Ú©Ø§Ù„Ø§ Ø¯Ø± Ø§Ù†Ø¨Ø§Ø± ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡', 'error');
    if (item.stock < qty) return showNotification('Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª', 'error');
    item.stock -= qty;
    saveData(); this.render(); this.lowStockAlert();
  },

  // Ù‡Ø´Ø¯Ø§Ø± Ú©Ù…Ø¨ÙˆØ¯
  lowStockAlert() {
    this.list().forEach(i => {
      if (i.stock <= i.minStock) {
        showNotification(`Ù…ÙˆØ¬ÙˆØ¯ÛŒ ${i.category} Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯Ù‡`, 'warning');
      }
    });
  },

  render() {
    const tbody = document.querySelector('#inventoryTable tbody');
    if (!tbody) return;
    tbody.innerHTML = '';
    this.list().forEach((i, idx) => {
      const tr = document.createElement('tr');
      const badge = i.stock <= i.minStock ? 'danger' : 'success';
      tr.innerHTML = `
        <td>${idx + 1}</td>
        <td>${i.category}</td>
        <td>${i.stock}</td>
        <td>${i.minStock}</td>
        <td>${i.lastPrice.toLocaleString('fa-IR')}</td>
        <td><span class="badge badge-${badge}">${i.stock <= i.minStock ? 'Ú©Ù…Ø¨ÙˆØ¯' : 'Ú©Ø§ÙÛŒ'}</span></td>
        <td>
          <button class="btn btn-sm btn-info" onclick="inventory.adjust('${i.id}')">âœï¸</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  },

  adjust(id) {
    const item = this.list().find(i => i.id == id);
    if (!item) return;
    const newStock = prompt('Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¬Ø¯ÛŒØ¯:', item.stock);
    if (newStock !== null && !isNaN(newStock)) {
      item.stock = parseInt(newStock);
      saveData(); this.render(); showNotification('Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ù†Ø¨Ø§Ø± Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯', 'success');
    }
  }
};

const ai = {
  // Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ø¬Ø±ÛŒØ§Ù† Ù†Ù‚Ø¯ÛŒ Û³Û°-Û¶Û°-Û¹Û° Ø±ÙˆØ² Ø¢ÛŒÙ†Ø¯Ù‡
  cashFlowForecast() {
    const today = new Date();
    const days30 = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);
    const days60 = new Date(today.getTime() + 60 * 24 * 60 * 60 * 1000);
    const days90 = new Date(today.getTime() + 90 * 24 * 60 * 60 * 1000);

    let in30 = 0, in60 = 0, in90 = 0;

    appData.checks.forEach(ch => {
      if (ch.status !== 'Ø¯Ø± Ø¬Ø±ÛŒØ§Ù†') return;
      const due = new Date(ch.dueDate);
      if (due <= days30) in30 += ch.amount;
      else if (due <= days60) in60 += ch.amount;
      else if (due <= days90) in90 += ch.amount;
    });

    return {
      30: in30,
      60: in60,
      90: in90,
      total: in30 + in60 + in90
    };
  },

  // Ù…Ø´ØªØ±ÛŒØ§Ù† Ø¯Ø± Ù…Ø¹Ø±Ø¶ Ø±ÛŒØ³Ú©
  riskyCustomers() {
    const risky = [];
    const customerStats = {};
    appData.contracts.forEach(c => {
      if (!customerStats[c.customer]) customerStats[c.customer] = { total: 0, late: 0 };
      customerStats[c.customer].total += c.totalAmount;
      // Ø§Ú¯Ø± Ú†Ú© Ø¯ÛŒØ±Ú©Ø±Ø¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯
      const hasLateCheck = appData.checks.some(ch => ch.customer === c.customer && new Date(ch.dueDate) < new Date() && ch.status === 'Ø¯Ø± Ø¬Ø±ÛŒØ§Ù†');
      if (hasLateCheck) customerStats[c.customer].late += 1;
    });

    Object.entries(customerStats).forEach(([name, stat]) => {
      if (stat.late > 0) risky.push({ name, risk: (stat.late / Math.max(stat.total, 1)) * 100 });
    });
    return risky.sort((a, b) => b.risk - a.risk);
  },

  // Ù‡Ø´Ø¯Ø§Ø± Ø®Ø·Ø± ÙˆØ±Ø´Ú©Ø³ØªÚ¯ÛŒ
  bankruptcyAlert() {
    const income = appData.transactions.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
    const expense = appData.transactions.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
    const profit = income - expense;
    const ratio = profit / Math.max(income, 1);
    if (ratio < 0.05) {
      showNotification('âš ï¸ Ù‡Ø´Ø¯Ø§Ø± Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ: Ø®Ø·Ø± ÙˆØ±Ø´Ú©Ø³ØªÚ¯ÛŒ Ø¨Ø§ Ø§Ø¯Ø§Ù…Ù‡ Ø±ÙˆÙ†Ø¯ ÙØ¹Ù„ÛŒ', 'error');
    }
  },

  // Ù†Ù…Ø§ÛŒØ´ Ú¯Ø²Ø§Ø±Ø´ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø¯Ø± Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
  renderDashboardCard() {
    const forecast = this.cashFlowForecast();
    const risky = this.riskyCustomers().slice(0, 5);
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="card-header"><h5>ğŸ§  Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ</h5></div>
      <div style="padding:20px">
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-value">${forecast.total.toLocaleString('fa-IR')}</div><div>ÙˆØ±ÙˆØ¯ÛŒ Û¹Û° Ø±ÙˆØ² Ø¢ÛŒÙ†Ø¯Ù‡</div></div>
        </div>
        <h6 style="margin-top:20px">Ûµ Ù…Ø´ØªØ±ÛŒ Ù¾Ø±Ø±ÛŒØ³Ú©:</h6>
        <table class="table table-sm"><thead><tr><th>Ù…Ø´ØªØ±ÛŒ</th><th>Ø¯Ø±ØµØ¯ Ø±ÛŒØ³Ú©</th></tr></thead><tbody>
        ${risky.map(r => `<tr><td>${r.name}</td><td>${r.risk.toFixed(1)}%</td></tr>`).join('')}
        </tbody></table>
      </div>
    `;
    document.getElementById('stats').after(card);
  }
};

// Ø§Ø¬Ø±Ø§ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ù‡Ø´Ø¯Ø§Ø± ÙˆØ±Ø´Ú©Ø³ØªÚ¯ÛŒ Ù‡Ø± Û²Û´ Ø³Ø§Ø¹Øª
setInterval(() => ai.bankruptcyAlert(), 1000 * 60 * 60 * 24);

// Ø«Ø¨Øª Ø³Ø±ÙˆÛŒØ³â€ŒÙˆØ±Ú©Ø± Ø¨Ø±Ø§ÛŒ Ø¢ÙÙ„Ø§ÛŒÙ†
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('data:text/javascript;base64,' + btoa(`
    const CACHE = 'k-v20';
    const URLS = ['index.html', 'assets/css/main.css', 'assets/css/print.css'];
    self.addEventListener('install', e => e.waitUntil(caches.open(CACHE).then(c => c.addAll(URLS))));
    self.addEventListener('fetch', e => e.respondWith(caches.match(e.request).then(r => r || fetch(e.request))));
  `)).then(() => console.log('SW registered'));
}

// Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø¹Ù„Ø§Ù†
const requestNotificationPermission = () => {
  if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission().then(p => {
      if (p === 'granted') new Notification('Ú©Ù„Ø´ÛŒâ€ŒÙÙˆÙ…', { body: 'Ø§Ø¹Ù„Ø§Ù† ÙØ¹Ø§Ù„ Ø´Ø¯', icon: 'assets/icons/icon-192.png' });
    });
  }
};

// Push Ø¨Ø±Ø§ÛŒ Ø³Ø±Ø±Ø³ÛŒØ¯ Ú†Ú©
const pushDueChecks = () => {
  if (Notification.permission !== 'granted') return;
  const today = new Date();
  appData.checks.forEach(ch => {
    if (ch.status !== 'Ø¯Ø± Ø¬Ø±ÛŒØ§Ù†') return;
    const diff = Math.ceil((new Date(ch.dueDate) - today) / (1000 * 60 * 60 * 24));
    if (diff === 1) {
      new Notification('Ø³Ø±Ø±Ø³ÛŒØ¯ Ú†Ú©', { body: `Ú†Ú© ${ch.number} ÙØ±Ø¯Ø§ Ø³Ø±Ø±Ø³ÛŒØ¯ Ø¯Ø§Ø±Ø¯`, icon: 'assets/icons/icon-192.png' });
    }
  });
};

// Ø§Ø¬Ø±Ø§ Ù‡Ø± Ø±ÙˆØ²
setInterval(pushDueChecks, 1000 * 60 * 60 * 24);

// Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ ØµÙØ­Ù‡ Ø®Ø§Ù†Ú¯ÛŒ
let deferredPrompt;
window.addEventListener('beforeinstallprompt', e => {
  deferredPrompt = e;
  const addBtn = document.createElement('button');
  addBtn.className = 'btn btn-info btn-sm no-print';
  addBtn.textContent = 'Ù†ØµØ¨ Ø¨Ø±Ù†Ø§Ù…Ù‡';
  addBtn.onclick = () => {
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then(() => deferredPrompt = null);
  };
  document.body.appendChild(addBtn);
});

const printer = {
  // Ú†Ø§Ù¾ Ø¨Ø§ Ù¾Ø±ÛŒÙ†ØªØ± Ø­Ø±Ø§Ø±ØªÛŒ Ø§Ø² Ø·Ø±ÛŒÙ‚ WebUSB
  async printThermal(text) {
    if (!navigator.usb) return showNotification('Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ WebUSB Ø±Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯', 'error');
    try {
      const device = await navigator.usb.requestDevice({ filters: [{ vendorId: 0x0416 }] }); // Ø³Ù…Ù¾Ù„ VendorID
      await device.open();
      await device.selectConfiguration(1);
      await device.claimInterface(0);
      const encoder = new TextEncoder();
      const data = encoder.encode(text + '\n\n\n' + String.fromCharCode(0x1B) + String.fromCharCode(0x64)); // Ø¨Ø±Ø´ Ú©Ø§ØºØ°
      await device.transferOut(1, data);
      await device.close();
      showNotification('Ú†Ø§Ù¾ Ø­Ø±Ø§Ø±ØªÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯', 'success');
    } catch (e) {
      showNotification('Ø®Ø·Ø§ Ø¯Ø± Ú†Ø§Ù¾ Ø­Ø±Ø§Ø±ØªÛŒ: ' + e.message, 'error');
    }
  },

  // Ú†Ø§Ù¾ ÙØ§Ú©ØªÙˆØ± Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø­Ø±Ø§Ø±ØªÛŒ
  printInvoiceThermal(invoice) {
    let output = '';
    output += appData.settings.companyName + '\n';
    output += 'ÙØ§Ú©ØªÙˆØ±: ' + invoice.invoiceNumber + '\n';
    output += 'ØªØ§Ø±ÛŒØ®: ' + toShamsi(invoice.date) + '\n';
    output += 'Ù…Ø´ØªØ±ÛŒ: ' + invoice.customer + '\n';
    output += '----------------------\n';
    invoice.items.forEach(it => {
      output += `${it.description} ${it.qty}Ã—${it.price}=${it.total}\n`;
    });
    output += '----------------------\n';
    output += 'Ø¬Ù…Ø¹ Ú©Ù„: ' + invoice.total.toLocaleString('fa-IR') + ' ØªÙˆÙ…Ø§Ù†\n';
    output += '----------------------\n';
    output += 'www.kaleshi-foum.ir\n';
    this.printThermal(output);
  }
};

const backup = {
  // Ø°Ø®ÛŒØ±Ù‡ Ø±ÙˆÛŒ Google Drive (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
  async saveToGoogleDrive() {
    if (!window.gapi || !gapi.client) {
      showNotification('Ø§Ø¨ØªØ¯Ø§ API Google Ø±Ø§ ÙØ¹Ø§Ù„ Ú©Ù†ÛŒØ¯', 'warning');
      return;
    }
    const file = new Blob([JSON.stringify(appData, null, 2)], { type: 'application/json' });
    const metadata = {
      name: `kaleshi-backup-${moment().format('jYYYY-jMM-jDD-HHmm')}.json`,
      mimeType: 'application/json'
    };
    const form = new FormData();
    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
    form.append('file', file);
    try {
      await gapi.client.request({
        path: '/upload/drive/v3/files',
        method: 'POST',
        params: { uploadType: 'multipart' },
        body: form
      });
      showNotification('Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø¯Ø± Google Drive Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', 'success');
    } catch (e) {
      showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ù„ÙˆØ¯: ' + e.message, 'error');
    }
  },

  // Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø±Ù…Ø²Ù†Ú¯Ø§Ø±ÛŒâ€ŒØ´Ø¯Ù‡ Ù…Ø­Ù„ÛŒ
  exportEncrypted() {
    const password = prompt('Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¨Ø±Ø§ÛŒ Ø±Ù…Ø²Ù†Ú¯Ø§Ø±ÛŒ:');
    if (!password) return;
    const encrypted = CryptoJS.AES.encrypt(JSON.stringify(appData), password).toString();
    downloadJSON({ encrypted, meta: { date: new Date().toISOString(), version: appData.version } }, 'kaleshi-encrypted');
    showNotification('Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø±Ù…Ø²Ù†Ú¯Ø§Ø±ÛŒâ€ŒØ´Ø¯Ù‡ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯', 'success');
  },

  // Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø±Ù…Ø²Ù†Ú¯Ø§Ø±ÛŒâ€ŒØ´Ø¯Ù‡
  importEncrypted() {
    const input = document.createElement('input');
    input.type = 'file'; input.accept = '.json';
    input.onchange = e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = evt => {
        try {
          const { encrypted, meta } = JSON.parse(evt.target.result);
          const password = prompt('Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:');
          if (!password) return;
          const decrypted = CryptoJS.AES.decrypt(encrypted, password).toString(CryptoJS.enc.Utf8);
          appData = JSON.parse(decrypted);
          saveData(); location.reload();
        } catch (err) {
          showNotification('Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ù†Ø§Ù…ÙˆÙÙ‚ - Ø±Ù…Ø² ÛŒØ§ ÙØ§ÛŒÙ„ Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª', 'error');
        }
      };
      reader.readAsText(file);
    };
    input.click();
  },

  // Ø®ÙˆØ¯Ú©Ø§Ø± Ù‡Ø± Û²Û´ Ø³Ø§Ø¹Øª
  autoBackupLocal() {
    if (appData.settings.autoBackupInterval <= 0) return;
    setInterval(() => {
      downloadJSON(appData, `auto-backup-${moment().format('jYYYY-jMM-jDD')}`);
    }, 1000 * 60 * 60 * 24 * appData.settings.autoBackupInterval);
  }
};

// Ø§Ø¬Ø±Ø§ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ø¯Ø± Ø¨Ø§Ø± Ø§ÙˆÙ„
window.addEventListener('DOMContentLoaded', () => backup.autoBackupLocal());
