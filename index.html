<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÛŒØ³ØªÙ… Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ Ú©Ù„Ø´ÛŒâ€ŒÙÙˆÙ… v16.0 - Ú©Ø§Ù…Ù„</title>
    <script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Tahoma, Arial; background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); min-height: 100vh; direction: rtl; padding: 20px; }
        .login-box { max-width: 400px; margin: 50px auto; background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center; }
        .logo { width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, #1e3a8a, #3b82f6); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 28px; font-weight: bold; }
        input, select { width: 100%; padding: 15px; margin: 15px 0; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; box-sizing: border-box; }
        input:focus, select:focus { border-color: #3b82f6; outline: none; }
        button { width: 100%; padding: 15px; background: #3b82f6; color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        button:hover { background: #1d4ed8; }
        .main-app { display: none; }
        .nav { background: #1e3a8a; padding: 0; display: flex; overflow-x: auto; border-radius: 10px; margin-bottom: 20px; }
        .nav button { background: none; color: white; border: none; padding: 15px 20px; cursor: pointer; white-space: nowrap; font-weight: bold; flex: 1; }
        .nav button.active { background: #3b82f6; }
        .page { display: none; }
        .page.active { display: block; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
        .stat { background: white; padding: 25px; border-radius: 15px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .stat-value { font-size: 28px; font-weight: bold; color: #3b82f6; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: right; border-bottom: 1px solid #eee; }
        th { background: #1e3a8a; color: white; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .product-row, .check-row { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 15px; display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap: 10px; align-items: center; }
        .totals { background: #10b981; color: white; padding: 25px; border-radius: 15px; margin: 25px 0; }
        .total-row { display: flex; justify-content: space-between; margin-bottom: 12px; }
        .status-badge { padding: 4px 12px; border-radius: 20px; color: white; font-size: 12px; font-weight: bold; }
        .status-daraj { background: #f59e0b; }
        .status-vasol { background: #10b981; }
        .status-bargashti { background: #ef4444; }
        .notification { position: fixed; top: 20px; right: 20px; background: white; padding: 15px 20px; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); z-index: 999; border-right: 5px solid #10b981; display: flex; align-items: center; gap: 10px; }
        .card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); margin-bottom: 25px; }
        @media (max-width: 768px) { .form-row, .product-row, .check-row { grid-template-columns: 1fr; } .nav { flex-direction: column; } }
        .persian-datepicker { direction: rtl; }
    </style>
</head>
<body>
<div id="loginBox" class="login-box">
    <div class="logo">CF</div>
    <h2>Ø³ÛŒØ³ØªÙ… Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ Ú©Ù„Ø´ÛŒâ€ŒÙÙˆÙ… v16.0</h2>
    <input type="text" id="userInput" placeholder="admin" value="admin">
    <input type="password" id="passInput" placeholder="1234" value="1234">
    <button onclick="loginNow()">ğŸš€ ÙˆØ±ÙˆØ¯</button>
    <p style="margin-top: 20px; color: #666; font-size: 14px;">admin / 1234</p>
</div>

<div id="mainApp" class="main-app">
    <div style="background: #0f172a; color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
        <div style="display: flex; align-items: center; gap: 20px;">
            <div style="width: 50px; height: 50px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #3b82f6; font-weight: bold; font-size: 20px;">CF</div>
            <div><h2 style="margin: 0;">Ú©Ù„Ø´ÛŒâ€ŒÙÙˆÙ…</h2><div id="dateNow"></div></div>
        </div>
        <button onclick="logoutNow()" style="background: #ef4444; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">Ø®Ø±ÙˆØ¬</button>
    </div>

    <div class="nav" id="navBar">
        <button class="active" onclick="showPage('dashboard')">ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</button>
        <button onclick="showPage('contracts')">ğŸ“ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§</button>
        <button onclick="showPage('checks')">ğŸ¦ Ú†Ú©â€ŒÙ‡Ø§</button>
        <button onclick="showPage('customers')">ğŸ‘¥ Ù…Ø´ØªØ±ÛŒØ§Ù†</button>
        <button onclick="showPage('invoices')">ğŸ“„ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§</button>
        <button onclick="showPage('expenses')">ğŸ’¸ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§</button>
        <button onclick="showPage('employees')">ğŸ‘· Ú©Ø§Ø±Ú©Ù†Ø§Ù†</button>
        <button onclick="showPage('scheduling')">ğŸ“… Ù†ÙˆØ¨Øªâ€ŒØ¯Ù‡ÛŒ</button>
        <button onclick="showPage('settings')">âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>
        <button onclick="showPage('backup')">ğŸ’¾ Ù¾Ø´ØªÛŒØ¨Ø§Ù†</button>
    </div>

    <div class="container" style="max-width: 1400px; margin: 0 auto; padding: 20px;">
        <!-- Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ -->
        <div id="dashboard" class="page active">
            <div class="card">
                <h3 style="margin-bottom: 25px; color: #1e3a8a;">ğŸ“Š Ø¢Ù…Ø§Ø± Ú©Ø§Ù…Ù„ Ø³ÛŒØ³ØªÙ…</h3>
                <div class="stats" id="statsBox"></div>
            </div>
        </div>

        <!-- Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§ -->
        <div id="contracts" class="page">
            <div class="card">
                <h3 style="margin-bottom: 25px; color: #1e3a8a;">ğŸ“ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø¬Ø¯ÛŒØ¯</h3>
                <div class="form-row">
                    <div><label>Ù…Ø´ØªØ±ÛŒ *</label><input id="custName" list="custList"></div>
                    <div><label>ØªÙ„ÙÙ†</label><input id="custPhone" type="tel"></div>
                    <div><label>Ø¢Ø¯Ø±Ø³</label><input id="custAddr"></div>
                    <div><label>ØªØ§Ø±ÛŒØ® Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</label><input id="contDate" readonly class="persian-datepicker-input"></div>
                    <div><label>ØªØ§Ø±ÛŒØ® ØªØ­ÙˆÛŒÙ„</label><input id="delDate" class="persian-datepicker-input"></div>
                </div>
                <h4 style="margin: 25px 0 15px 0; color: #1e3a8a;">ğŸ“¦ Ù…Ø­ØµÙˆÙ„Ø§Øª</h4>
                <div id="prodCont"></div>
                <button onclick="addProd()" style="background: #06b6d4; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; margin-bottom: 20px;">â• Ù…Ø­ØµÙˆÙ„</button>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                    <div><label>Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª</label><input id="prePay" type="number" value="0" oninput="calcAll()"></div>
                </div>
                <h4 style="margin: 25px 0 15px 0; color: #1e3a8a;">ğŸ¦ Ú†Ú©â€ŒÙ‡Ø§</h4>
                <div id="chkCont"></div>
                <button onclick="addChk()" style="background: #06b6d4; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; margin-bottom: 20px;">â• Ú†Ú©</button>
                <div class="totals">
                    <div class="total-row"><span>Ø¬Ù…Ø¹ Ù…Ø­ØµÙˆÙ„Ø§Øª:</span><strong id="prodTot">0 ØªÙˆÙ…Ø§Ù†</strong></div>
                    <div class="total-row"><span>Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª:</span><strong id="advTot">0 ØªÙˆÙ…Ø§Ù†</strong></div>
                    <div class="total-row"><span>Ú†Ú©â€ŒÙ‡Ø§:</span><strong id="chkTot">0 ØªÙˆÙ…Ø§Ù†</strong></div>
                    <div class="total-row" style="font-size: 22px; color: #ffd700;"><span>ğŸŸ¢ Ù…Ø§Ù†Ø¯Ù‡:</span><strong id="balTot">0 ØªÙˆÙ…Ø§Ù†</strong></div>
                </div>
                <button onclick="saveCont()" style="background: #10b981; color: white; border: none; padding: 18px 36px; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; margin: 20px 10px 0 0;">âœ… Ø«Ø¨Øª Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</button>
            </div>
            <div class="card">
                <h3 style="margin-bottom: 25px; color: #1e3a8a;">ğŸ“‹ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§ÛŒ Ø«Ø¨Øª Ø´Ø¯Ù‡</h3>
                <div style="overflow-x: auto;">
                    <table id="contTable"><tr><th>Ø´Ù…Ø§Ø±Ù‡</th><th>Ù…Ø´ØªØ±ÛŒ</th><th>Ù…Ø¨Ù„Øº</th><th>ØªØ§Ø±ÛŒØ®</th><th>Ø­Ø°Ù</th></tr></table>
                </div>
            </div>
        </div>

        <!-- Ú†Ú©â€ŒÙ‡Ø§ -->
        <div id="checks" class="page">
            <div class="card">
                <h3 style="margin-bottom: 25px; color: #1e3a8a;">ğŸ¦ Ø«Ø¨Øª Ú†Ú© Ø¬Ø¯ÛŒØ¯</h3>
                <div class="form-row">
                    <div><label>Ù…Ø´ØªØ±ÛŒ</label><input id="newCheckCustomer" list="custList"></div>
                    <div><label>Ø´Ù…Ø§Ø±Ù‡ Ú†Ú©</label><input id="newCheckNumber"></div>
                    <div><label>Ù…Ø¨Ù„Øº</label><input id="newCheckAmount" type="number"></div>
                    <div><label>Ø³Ø±Ø±Ø³ÛŒØ¯</label><input id="newCheckDue" class="persian-datepicker-input"></div>
                    <div><label>ÙˆØ¶Ø¹ÛŒØª</label>
                        <select id="newCheckStatus">
                            <option>Ø¯Ø± Ø¬Ø±ÛŒØ§Ù†</option>
                            <option>ÙˆØµÙˆÙ„ Ø´Ø¯</option>
                            <option>Ø¨Ø±Ú¯Ø´ØªÛŒ</option>
                        </select>
                    </div>
                </div>
                <button onclick="saveNewCheck()" style="background: #10b981; color: white; border: none; padding: 15px 30px; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer;">âœ… Ø«Ø¨Øª Ú†Ú©</button>
            </div>
            <div class="card">
                <h3 style="margin-bottom: 25px; color: #1e3a8a;">ğŸ“‹ Ù„ÛŒØ³Øª Ú†Ú©â€ŒÙ‡Ø§</h3>
                <div style="overflow-x: auto;">
                    <table id="chkTab"><tr><th>Ø´Ù…Ø§Ø±Ù‡</th><th>Ù…Ø´ØªØ±ÛŒ</th><th>Ù…Ø¨Ù„Øº</th><th>Ø³Ø±Ø±Ø³ÛŒØ¯</th><th>ÙˆØ¶Ø¹ÛŒØª</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr></table>
                </div>
            </div>
        </div>

        <!-- Ù…Ø´ØªØ±ÛŒØ§Ù† -->
        <div id="customers" class="page">
            <div class="card">
                <h3 style="margin-bottom: 25px; color: #1e3a8a;">ğŸ‘¥ Ù…Ø´ØªØ±ÛŒØ§Ù†</h3>
                <button onclick="toggleCustForm()" style="background: #10b981; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">â• Ù…Ø´ØªØ±ÛŒ Ø¬Ø¯ÛŒØ¯</button>
                <div id="custForm" style="display: none; background: #f8f9fa; padding: 25px; margin: 25px 0; border-radius: 12px;">
                    <div class="form-row">
                        <div><label>Ù†Ø§Ù… *</label><input id="newName"></div>
                        <div><label>ØªÙ„ÙÙ† *</label><input id="newPhone" type="tel"></div>
                        <div><label>Ø¢Ø¯Ø±Ø³</label><input id="newAddr"></div>
                        <div><label>Ù†ÙˆØ¹</label>
                            <select id="custType">
                                <option>Ø¹Ø§Ø¯ÛŒ</option><option>Ù¾ÛŒØ´ Ø®Ø±ÛŒØ¯</option><option>Ø¹Ø§Ù…Ù„</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="saveCust()" style="background: #10b981; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">âœ… Ø°Ø®ÛŒØ±Ù‡</button>
                </div>
                <table id="custTab"><tr><th>Ù†Ø§Ù…</th><th>ØªÙ„ÙÙ†</th><th>Ø¢Ø¯Ø±Ø³</th><th>Ù†ÙˆØ¹</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr></table>
            </div>
        </div>

        <!-- Ø³Ø§ÛŒØ± Ù…Ù†ÙˆÙ‡Ø§ -->
        <div id="invoices" class="page"><div class="card"><h3>ğŸ“„ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§</h3><p>Ù…Ø¯ÛŒØ±ÛŒØª ÙØ§Ú©ØªÙˆØ±Ù‡Ø§...</p></div></div>
        <div id="expenses" class="page"><div class="card"><h3>ğŸ’¸ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§</h3><p>Ù…Ø¯ÛŒØ±ÛŒØª Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§...</p></div></div>
        <div id="employees" class="page"><div class="card"><h3>ğŸ‘· Ú©Ø§Ø±Ú©Ù†Ø§Ù†</h3><p>Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ú©Ù†Ø§Ù†...</p></div></div>
        <div id="scheduling" class="page"><div class="card"><h3>ğŸ“… Ù†ÙˆØ¨Øªâ€ŒØ¯Ù‡ÛŒ</h3><p>Ø³ÛŒØ³ØªÙ… Ù†ÙˆØ¨Øªâ€ŒØ¯Ù‡ÛŒ...</p></div></div>
        <div id="settings" class="page"><div class="card"><h3>âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</h3><p>ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³ÛŒØ³ØªÙ…...</p></div></div>
        <div id="backup" class="page">
            <div class="card">
                <h3>ğŸ’¾ Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ</h3>
                <button onclick="backupData()" style="background: #10b981; color: white; border: none; padding: 15px 30px; border-radius: 10px; font-size: 16px; cursor: pointer;">ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù¾Ø´ØªÛŒØ¨Ø§Ù†</button>
                <input type="file" id="restoreFile" style="margin-top: 20px;" onchange="restoreData(event)">
            </div>
        </div>
    </div>
</div>

<datalist id="custList"></datalist>

<script>
let data = JSON.parse(localStorage.getItem('kaleshi16')) || {
    customers: [{id:1,name:'Ø¹Ù„ÛŒ Ù…Ø­Ù…Ø¯ÛŒ',phone:'09121234567',address:'Ø§Ø±ÙˆÙ…ÛŒÙ‡',type:'Ø¹Ø§Ø¯ÛŒ'},{id:2,name:'Ø±Ø¶Ø§ Ø§Ø­Ù…Ø¯ÛŒ',phone:'09129876543',address:'Ø§Ø±ÙˆÙ…ÛŒÙ‡',type:'Ø¹Ø§Ù…Ù„'}],
    contracts: [], checks: [], invoices: [], expenses: [], employees: []
};
let pCount=0, cCount=0;

// ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ
function pd(){const d=new Date(),p='Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹';return d.toLocaleDateString('fa-IR').replace(/\d/g,c=>p[c]);}
function fmt(n){return n.toLocaleString('fa-IR')+' ØªÙˆÙ…Ø§Ù†';}
function notif(msg,t='success'){const d=document.createElement('div');d.className='notification';d.style.borderRightColor=t=='success'?'#10b981':'#ef4444';d.innerHTML=`${t=='success'?'âœ…':'âŒ'}${msg}<button onclick="this.parentNode.remove()" style="float:left;background:none;border:none;font-size:20px;cursor:pointer;">Ã—</button>`;document.body.appendChild(d);setTimeout(()=>d.remove(),4000);}
function save(){localStorage.setItem('kaleshi16',JSON.stringify(data));}

// ØªÙ‚ÙˆÛŒÙ… Ø¬Ù„Ø§Ù„ÛŒ
$(document).ready(function() {
    $('.persian-datepicker-input').persianDatepicker({
        initialValue: false,
        format: 'YYYY/MM/DD',
        autoClose: true,
        calendar: { persian: { locale: 'fa' } }
    });
});

// ÙˆØ±ÙˆØ¯
function loginNow(){
    const u=document.getElementById('userInput').value,p=document.getElementById('passInput').value;
    if(u=='admin'&&p=='1234'){
        document.getElementById('loginBox').style.display='none';
        document.getElementById('mainApp').style.display='block';
        document.getElementById('dateNow').textContent=pd();
        document.getElementById('contDate').value=pd();
        startApp();
        notif('ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚! ğŸš€');
    }else notif('Ø§Ø´ØªØ¨Ø§Ù‡!','error');
}

function logoutNow(){if(confirm('Ø®Ø±ÙˆØ¬ØŸ'))location.reload();}
function showPage(p){
    document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('.nav button').forEach(x=>x.classList.remove('active'));
    document.getElementById(p).classList.add('active');
    event.target.classList.add('active');
    if(p=='contracts')loadConts();
    if(p=='checks')loadChks();
    if(p=='customers')loadCusts();
}
function startApp(){updateDash();loadCusts();loadChks();loadConts();resetForm();}

function updateDash(){
    const tc=data.contracts.length,tr=data.contracts.reduce((s,c)=>s+c.products.reduce((p,pr)=>p+pr.qty*pr.price,0),0);
    const ch=data.checks.length;
    document.getElementById('statsBox').innerHTML=`
        <div class="stat"><div class="stat-value">${tc}</div>Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§</div>
        <div class="stat"><div class="stat-value">${fmt(tr)}</div>Ø¯Ø±Ø¢Ù…Ø¯</div>
        <div class="stat"><div class="stat-value">${data.customers.length}</div>Ù…Ø´ØªØ±ÛŒØ§Ù†</div>
        <div class="stat"><div class="stat-value">${ch}</div>Ú†Ú©â€ŒÙ‡Ø§</div>`;
}

// Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§ (Ù‡Ù…Ø§Ù† Ú©Ø¯ Ù‚Ø¨Ù„ÛŒ)
function resetForm(){document.getElementById('custName').value=document.getElementById('custPhone').value=document.getElementById('custAddr').value=document.getElementById('delDate').value=document.getElementById('prePay').value='0';document.getElementById('prodCont').innerHTML=document.getElementById('chkCont').innerHTML='';pCount=cCount=0;addProd();addChk();calcAll();}
function addProd(){const id=pCount++;document.getElementById('prodCont').innerHTML+=`<div class="product-row"><select id="t${id}"><option>ÛŒÙˆÙ†ÙˆÙ„ÛŒØª</option><option>ÙˆØ±Ù‚</option><option>Ù¾Ø§Ù†Ù„</option></select><input id="n${id}" placeholder="Ù†Ø§Ù…"><input id="q${id}" type="number" placeholder="Ù…Ù‚Ø¯Ø§Ø±" oninput="calcAll()"><input id="p${id}" type="number" placeholder="Ù‚ÛŒÙ…Øª" oninput="calcAll()"><button onclick="this.parentNode.remove();calcAll()" style="background:#ef4444;color:white;border:none;padding:8px;border-radius:5px;cursor:pointer;">Ø­Ø°Ù</button></div>`;}
function addChk(){const id=cCount++;document.getElementById('chkCont').innerHTML+=`<div class="check-row"><input id="cn${id}" placeholder="Ø´Ù…Ø§Ø±Ù‡ Ú†Ú©"><input id="ca${id}" type="number" placeholder="Ù…Ø¨Ù„Øº" oninput="calcAll()"><input id="cd${id}" class="persian-datepicker-input"><button onclick="this.parentNode.remove();calcAll()" style="background:#ef4444;color:white;border:none;padding:8px;border-radius:5px;cursor:pointer;">Ø­Ø°Ù</button></div>`;}
function calcAll(){let pt=0,ct=0,ad=parseInt(document.getElementById('prePay').value)||0;for(let i=0;i<50;i++){const q=document.getElementById(`q${i}`),p=document.getElementById(`p${i}`);if(q?.value&&p?.value)pt+=parseInt(q.value)*parseInt(p.value);const ca=document.getElementById(`ca${i}`);if(ca?.value)ct+=parseInt(ca.value);}document.getElementById('prodTot').textContent=fmt(pt);document.getElementById('advTot').textContent=fmt(ad);document.getElementById('chkTot').textContent=fmt(ct);document.getElementById('balTot').textContent=fmt(pt-ad-ct);}
function saveCont(){const cust=document.getElementById('custName').value;if(!cust)return notif('Ù…Ø´ØªØ±ÛŒ Ø§Ù„Ø²Ø§Ù…ÛŒ','error');const cont={id:Date.now(),number:'CF'+(data.contracts.length+1),customer:cust,phone:document.getElementById('custPhone').value,address:document.getElementById('custAddr').value,date:document.getElementById('contDate').value,delivery:document.getElementById('delDate').value,products:[],checks:[],advance:parseInt(document.getElementById('prePay').value)||0};for(let i=0;i<50;i++){const t=document.getElementById(`t${i}`),n=document.getElementById(`n${i}`),q=document.getElementById(`q${i}`),p=document.getElementById(`p${i}`);if(t?.value&&n?.value&&q?.value&&p?.value)cont.products.push({type:t.value,name:n.value,qty:parseInt(q.value),price:parseInt(p.value)});const cn=document.getElementById(`cn${i}`),ca=document.getElementById(`ca${i}`),cd=document.getElementById(`cd${i}`);if(cn?.value&&ca?.value){cont.checks.push({number:cn.value,amount:parseInt(ca.value),due:cd?.value||''});}}data.contracts.push(cont);save();notif('Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø«Ø¨Øª Ø´Ø¯ âœ…');loadConts();resetForm();updateDash();}
function loadConts(){document.getElementById('contTable').innerHTML='<tr><th>Ø´Ù…Ø§Ø±Ù‡</th><th>Ù…Ø´ØªØ±ÛŒ</th><th>Ù…Ø¨Ù„Øº</th><th>ØªØ§Ø±ÛŒØ®</th><th>Ø­Ø°Ù</th></tr>'+data.contracts.map(c=>{const t=c.products.reduce((s,p)=>s+p.qty*p.price,0);return `<tr><td>${c.number}</td><td>${c.customer}</td><td>${fmt(t)}</td><td>${c.date}</td><td><button onclick="delCont(${c.id})" style="background:#ef4444;color:white;border:none;padding:8px;border-radius:5px;cursor:pointer;">Ø­Ø°Ù</button></td></tr>`;}).join('');}
function delCont(id){if(confirm('Ø­Ø°ÙØŸ')){data.contracts=data.contracts.filter(c=>c.id!==id);save();loadConts();updateDash();notif('Ø­Ø°Ù Ø´Ø¯');}}

// Ú†Ú©â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯
function saveNewCheck(){
    const cust=document.getElementById('newCheckCustomer').value;
    const num=document.getElementById('newCheckNumber').value;
    const amt=document.getElementById('newCheckAmount').value;
    const due=document.getElementById('newCheckDue').value;
    const status=document.getElementById('newCheckStatus').value;
    
    if(!cust || !num || !amt) return notif('Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø§Ù„Ø²Ø§Ù…ÛŒ','error');
    
    data.checks.push({
        id: Date.now(),
        customer: cust,
        number: num,
        amount: parseInt(amt),
        due: due,
        status: status
    });
    save();
    loadChks();
    document.getElementById('newCheckCustomer').value = document.getElementById('newCheckNumber').value = 
    document.getElementById('newCheckAmount').value = document.getElementById('newCheckDue').value = '';
    notif('Ú†Ú© Ø«Ø¨Øª Ø´Ø¯ âœ…');
}

function loadChks(){
    document.getElementById('chkTab').innerHTML='<tr><th>Ø´Ù…Ø§Ø±Ù‡</th><th>Ù…Ø´ØªØ±ÛŒ</th><th>Ù…Ø¨Ù„Øº</th><th>Ø³Ø±Ø±Ø³ÛŒØ¯</th><th>ÙˆØ¶Ø¹ÛŒØª</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr>'+data.checks.map(c=>{
        const statusClass = c.status=='Ø¯Ø± Ø¬Ø±ÛŒØ§Ù†' ? 'status-daraj' : c.status=='ÙˆØµÙˆÙ„ Ø´Ø¯' ? 'status-vasol' : 'status-bargashti';
        return `<tr><td>${c.number}</td><td>${c.customer}</td><td>${fmt(c.amount)}</td><td>${c.due}</td><td><span class="status-badge ${statusClass}">${c.status}</span></td><td><button onclick="delChk(${c.id})" style="background:#ef4444;color:white;border:none;padding:8px;border-radius:5px;cursor:pointer;">Ø­Ø°Ù</button></td></tr>`;
    }).join('');
}

function delChk(id){if(confirm('Ø­Ø°ÙØŸ')){data.checks=data.checks.filter(c=>c.id!==id);save();loadChks();updateDash();notif('Ú†Ú© Ø­Ø°Ù Ø´Ø¯');}}

// Ù…Ø´ØªØ±ÛŒØ§Ù†
function toggleCustForm(){document.getElementById('custForm').style.display=document.getElementById('custForm').style.display=='none'?'block':'none';}
function saveCust(){const n=document.getElementById('newName').value,ph=document.getElementById('newPhone').value;if(!n||!ph)return notif('Ù†Ø§Ù… Ùˆ ØªÙ„ÙÙ† Ø§Ù„Ø²Ø§Ù…ÛŒ','error');data.customers.push({id:Date.now(),name:n,phone:ph,address:document.getElementById('newAddr').value,type:document.getElementById('custType').value});save();loadCusts();toggleCustForm();notif('Ù…Ø´ØªØ±ÛŒ Ø«Ø¨Øª Ø´Ø¯');}
function loadCusts(){document.getElementById('custList').innerHTML=data.customers.map(c=>`<option>${c.name}</option>`).join('');document.getElementById('custTab').innerHTML='<tr><th>Ù†Ø§Ù…</th><th>ØªÙ„ÙÙ†</th><th>Ø¢Ø¯Ø±Ø³</th><th>Ù†ÙˆØ¹</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr>'+data.customers.map(c=>`<tr><td>${c.name}</td><td>${c.phone}</td><td>${c.address}</td><td style="color:${c.type=='Ø¹Ø§Ø¯ÛŒ'?'green':c.type=='Ù¾ÛŒØ´ Ø®Ø±ÛŒØ¯'?'orange':'purple'}">${c.type}</td><td><button onclick="delCust(${c.id})" style="background:#ef4444;color:white;border:none;padding:5px 10px;border-radius:5px;">Ø­Ø°Ù</button></td></tr>`).join('');}
function delCust(id){data.customers=data.customers.filter(c=>c.id!==id);save();loadCusts();}

// Ù¾Ø´ØªÛŒØ¨Ø§Ù†
function backupData(){
    const dataStr = JSON.stringify(data, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'backup-kaleshi16-'+pd()+'.json';
    a.click();
    notif('Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯');
}

function restoreData(event){
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                data = JSON.parse(e.target.result);
                save();
                notif('Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø´Ø¯');
                updateDash();
                loadCusts();
                loadChks();
                loadConts();
            } catch {
                notif('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ','error');
            }
        };
        reader.readAsText(file);
    }
}

document.addEventListener('keydown',e=>e.key=='Enter'&&document.getElementById('loginBox').style.display!='none'?loginNow():null);
addProd();addChk();calcAll();
</script>
</body>
</html>
