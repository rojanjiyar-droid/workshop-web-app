<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÛŒØ³ØªÙ… Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ Ú©Ù„Ø´ÛŒâ€ŒÙÙˆÙ…</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Tahoma, Arial; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); 
            min-height: 100vh; direction: rtl; padding: 20px;
        }
        .login-box {
            max-width: 400px; margin: 50px auto; background: white; 
            padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }
        .logo { 
            width: 80px; height: 80px; margin: 0 auto 20px; 
            background: linear-gradient(135deg, #1e3a8a, #3b82f6); 
            border-radius: 50%; display: flex; align-items: center; 
            justify-content: center; color: white; font-size: 28px; font-weight: bold;
        }
        input { 
            width: 100%; padding: 15px; margin: 15px 0; border: 2px solid #ddd; 
            border-radius: 10px; font-size: 16px; box-sizing: border-box;
        }
        input:focus { border-color: #3b82f6; outline: none; }
        button { 
            width: 100%; padding: 15px; background: #3b82f6; color: white; 
            border: none; border-radius: 10px; font-size: 16px; font-weight: bold;
            cursor: pointer; margin-top: 10px;
        }
        button:hover { background: #1d4ed8; }
        .main-app { display: none; }
        .nav { 
            background: #1e3a8a; padding: 0; display: flex; overflow-x: auto; 
            border-radius: 10px; margin-bottom: 20px;
        }
        .nav button { 
            background: none; color: white; border: none; padding: 15px 25px; 
            cursor: pointer; white-space: nowrap; font-weight: bold;
        }
        .nav button.active { background: #3b82f6; }
        .page { display: none; }
        .page.active { display: block; }
        .stats { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 20px; margin: 20px 0;
        }
        .stat { 
            background: white; padding: 25px; border-radius: 15px; text-align: center; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .stat-value { font-size: 28px; font-weight: bold; color: #3b82f6; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: right; border-bottom: 1px solid #eee; }
        th { background: #1e3a8a; color: white; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .product-row { 
            background: #f8f9fa; padding: 20px; border-radius: 10px; 
            margin-bottom: 15px; display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 10px;
            align-items: center;
        }
        select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; }
    </style>
</head>
<body>

<div id="loginBox" class="login-box">
    <div class="logo">CF</div>
    <h2>Ø³ÛŒØ³ØªÙ… Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ Ú©Ù„Ø´ÛŒâ€ŒÙÙˆÙ…</h2>
    <input type="text" id="userInput" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ: admin" value="admin">
    <input type="password" id="passInput" placeholder="Ø±Ù…Ø²: 1234" value="1234">
    <button onclick="loginFunction()">ÙˆØ±ÙˆØ¯</button>
    <p style="margin-top: 20px; color: #666; font-size: 14px;">
        ØªØ³Øª: <strong>admin / 1234</strong>
    </p>
</div>

<div id="mainApp" class="main-app">
    <div class="nav" id="navButtons">
        <button class="active" onclick="showPage('dashboard')">ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</button>
        <button onclick="showPage('contracts')">ğŸ“ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§</button>
        <button onclick="showPage('customers')">ğŸ‘¥ Ù…Ø´ØªØ±ÛŒØ§Ù†</button>
        <button onclick="showPage('checks')">ğŸ¦ Ú†Ú©â€ŒÙ‡Ø§</button>
    </div>

    <div class="container">
        <!-- Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ -->
        <div id="dashboard" class="page active">
            <div class="stats" id="dashboardStats">
                <!-- Ø¢Ù…Ø§Ø± Ø§ÛŒÙ†Ø¬Ø§ -->
            </div>
        </div>

        <!-- Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§ -->
        <div id="contracts" class="page">
            <div class="form-row">
                <div><label>Ù…Ø´ØªØ±ÛŒ</label><input id="custName" list="custList"></div>
                <div><label>ØªÙ„ÙÙ†</label><input id="custPhone" type="tel"></div>
                <div><label>Ø¢Ø¯Ø±Ø³</label><input id="custAddr"></div>
                <div><label>ØªØ§Ø±ÛŒØ®</label><input id="contDate" readonly></div>
                <div><label>ØªØ­ÙˆÛŒÙ„</label><input id="delivDate"></div>
            </div>
            
            <h3>Ù…Ø­ØµÙˆÙ„Ø§Øª:</h3>
            <div id="prodContainer"></div>
            <button class="btn" onclick="addProductRow()">â• Ù…Ø­ØµÙˆÙ„</button>
            
            <div><label>Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª</label><input id="advanceAmt" type="number" value="0" oninput="calcTotals()"></div>
            
            <h3>Ú†Ú©â€ŒÙ‡Ø§:</h3>
            <div id="checkContainer"></div>
            <button class="btn" onclick="addCheckRow()">â• Ú†Ú©</button>
            
            <div style="background: #10b981; color: white; padding: 20px; border-radius: 10px; margin: 20px 0;">
                <div>Ø¬Ù…Ø¹ Ù…Ø­ØµÙˆÙ„Ø§Øª: <span id="prodTotal">0 ØªÙˆÙ…Ø§Ù†</span></div>
                <div>Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª: <span id="advTotal">0 ØªÙˆÙ…Ø§Ù†</span></div>
                <div>Ú†Ú©â€ŒÙ‡Ø§: <span id="chkTotal">0 ØªÙˆÙ…Ø§Ù†</span></div>
                <div style="font-size: 20px; margin-top: 10px;">Ù…Ø§Ù†Ø¯Ù‡: <span id="balance">0 ØªÙˆÙ…Ø§Ù†</span></div>
            </div>
            
            <button class="btn" onclick="saveContract()" style="background: #10b981;">Ø«Ø¨Øª Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</button>
            
            <h3 style="margin-top: 40px;">Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§:</h3>
            <table id="contractTable">
                <tr><th>Ø´Ù…Ø§Ø±Ù‡</th><th>Ù…Ø´ØªØ±ÛŒ</th><th>Ù…Ø¨Ù„Øº</th><th>ØªØ§Ø±ÛŒØ®</th><th>Ø­Ø°Ù</th></tr>
            </table>
        </div>

        <!-- Ù…Ø´ØªØ±ÛŒØ§Ù† -->
        <div id="customers" class="page">
            <button class="btn" onclick="toggleCustForm()">â• Ù…Ø´ØªØ±ÛŒ Ø¬Ø¯ÛŒØ¯</button>
            <div id="custForm" style="display:none; background:#f8f9fa; padding:20px; margin:20px 0; border-radius:10px;">
                <div class="form-row">
                    <div><label>Ù†Ø§Ù…</label><input id="newCustName"></div>
                    <div><label>ØªÙ„ÙÙ†</label><input id="newCustPhone" type="tel"></div>
                    <div><label>Ø¢Ø¯Ø±Ø³</label><input id="newCustAddr"></div>
                    <div><label>Ù†ÙˆØ¹</label>
                        <select id="newCustType">
                            <option>Ø¹Ø§Ø¯ÛŒ</option><option>Ù¾ÛŒØ´ Ø®Ø±ÛŒØ¯</option><option>Ø¹Ø§Ù…Ù„</option>
                        </select>
                    </div>
                </div>
                <button class="btn" onclick="saveCust()">Ø°Ø®ÛŒØ±Ù‡</button>
            </div>
            <table id="custTable">
                <tr><th>Ù†Ø§Ù…</th><th>ØªÙ„ÙÙ†</th><th>Ø¢Ø¯Ø±Ø³</th><th>Ù†ÙˆØ¹</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr>
            </table>
        </div>

        <!-- Ú†Ú©â€ŒÙ‡Ø§ -->
        <div id="checks" class="page">
            <table id="checkTable">
                <tr><th>Ø´Ù…Ø§Ø±Ù‡</th><th>Ù…Ø´ØªØ±ÛŒ</th><th>Ù…Ø¨Ù„Øº</th><th>Ø³Ø±Ø±Ø³ÛŒØ¯</th><th>ÙˆØ¶Ø¹ÛŒØª</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr>
            </table>
        </div>
    </div>
</div>

<datalist id="custList"></datalist>

<script>
let data = JSON.parse(localStorage.getItem('kaleshiData')) || {
    customers: [
        {id:1,name:'Ø¹Ù„ÛŒ Ù…Ø­Ù…Ø¯ÛŒ',phone:'09121234567',address:'Ø§Ø±ÙˆÙ…ÛŒÙ‡',type:'Ø¹Ø§Ø¯ÛŒ'},
        {id:2,name:'Ø±Ø¶Ø§ Ø§Ø­Ù…Ø¯ÛŒ',phone:'09129876543',address:'Ø§Ø±ÙˆÙ…ÛŒÙ‡',type:'Ø¹Ø§Ù…Ù„'}
    ],
    contracts: [],
    checks: []
};
let prodCount = 0, checkCount = 0;
let currentPage = 'dashboard';

function persianDate() {
    const d = new Date();
    const pd = 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹';
    return d.toLocaleDateString('fa-IR').replace(/\d/g,c=>pd[c]);
}

function formatNum(n) {
    return n.toLocaleString('fa-IR') + ' ØªÙˆÙ…Ø§Ù†';
}

function showMsg(msg, type='success') {
    const div = document.createElement('div');
    div.style.cssText = 'position:fixed;top:20px;right:20px;background:white;padding:15px 20px;border-radius:10px;box-shadow:0 5px 20px rgba(0,0,0,0.2);z-index:999;border-right:5px solid '+ (type=='success'?'#10b981':'#ef4444');
    div.innerHTML = (type=='success'?'âœ…':'âŒ') + msg + '<button onclick="this.parentNode.remove()" style="float:left;background:none;border:none;font-size:20px;cursor:pointer;">Ã—</button>';
    document.body.appendChild(div);
    setTimeout(()=>div.remove(), 4000);
}

function doLogin() {
    const user = document.getElementById('userInput').value;
    const pass = document.getElementById('passInput').value;
    
    if(user === 'admin' && pass === '1234') {
        document.getElementById('loginBox').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        document.getElementById('contDate').value = persianDate();
        updateAll();
        showMsg('ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚!');
    } else {
        showMsg('Ø§Ø´ØªØ¨Ø§Ù‡!', 'error');
    }
}

function loginFunction() { doLogin(); }

document.addEventListener('keydown', function(e) {
    if(e.key === 'Enter') doLogin();
});

function logoutApp() {
    if(confirm('Ø®Ø±ÙˆØ¬ØŸ')) location.reload();
}

function showPage(page) {
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));
    document.getElementById(page).classList.add('active');
    event.target.classList.add('active');
    currentPage = page;
    if(page === 'dashboard') updateDashboardStats();
    if(page === 'contracts') loadContracts();
    if(page === 'customers') loadCustomers();
    if(page === 'checks') loadChecks();
}

function updateAll() {
    updateDashboardStats();
    loadCustomers();
    loadContracts();
    loadChecks();
}

function updateDashboardStats() {
    const totalCont = data.contracts.length;
    const totalRev = data.contracts.reduce((s,c)=>s+c.products.reduce((p,pr)=>p+pr.qty*pr.price,0),0);
    const yun = data.contracts.reduce((s,c)=>s+c.products.filter(p=>p.type=='ÛŒÙˆÙ†ÙˆÙ„ÛŒØª').reduce((p,pr)=>p+pr.qty*pr.price,0),0);
    const vor = data.contracts.reduce((s,c)=>s+c.products.filter(p=>p.type=='ÙˆØ±Ù‚').reduce((p,pr)=>p+pr.qty*pr.price,0),0);
    const pnl = data.contracts.reduce((s,c)=>s+c.products.filter(p=>p.type=='Ù¾Ø§Ù†Ù„').reduce((p,pr)=>p+pr.qty*pr.price,0),0);
    
    document.getElementById('dashboardStats').innerHTML = `
        <div class="stat"><div class="stat-value">${totalCont}</div>Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§</div>
        <div class="stat"><div class="stat-value">${formatNum(totalRev)}</div>Ø¯Ø±Ø¢Ù…Ø¯ Ú©Ù„</div>
        <div class="stat"><div class="stat-value">${data.customers.length}</div>Ù…Ø´ØªØ±ÛŒØ§Ù†</div>
        <div class="stat"><div class="stat-value">${data.checks.filter(c=>c.status!='ÙˆØµÙˆÙ„').length}</div>Ú†Ú©â€ŒÙ‡Ø§</div>
        <div class="stat"><div class="stat-value">${formatNum(yun)}</div>ÛŒÙˆÙ†ÙˆÙ„ÛŒØª</div>
        <div class="stat"><div class="stat-value">${formatNum(vor)}</div>ÙˆØ±Ù‚</div>
        <div class="stat"><div class="stat-value">${formatNum(pnl)}</div>Ù¾Ø§Ù†Ù„</div>
    `;
}

function saveLocal() {
    localStorage.setItem('kaleshiData', JSON.stringify(data));
}

function addProductRow() {
    const id = prodCount++;
    document.getElementById('prodContainer').innerHTML += `
        <div class="product-row">
            <select id="prodType${id}">
                <option>ÛŒÙˆÙ†ÙˆÙ„ÛŒØª</option><option>ÙˆØ±Ù‚</option><option>Ù¾Ø§Ù†Ù„</option>
            </select>
            <input id="prodName${id}" placeholder="Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„">
            <input id="prodQty${id}" type="number" placeholder="Ù…Ù‚Ø¯Ø§Ø±" oninput="calcTotals()">
            <input id="prodPrice${id}" type="number" placeholder="Ù‚ÛŒÙ…Øª" oninput="calcTotals()">
            <button onclick="this.parentNode.remove();calcTotals()" style="background:#ef4444;padding:8px 12px;">Ø­Ø°Ù</button>
        </div>`;
}

function addCheckRow() {
    const id = checkCount++;
    document.getElementById('checkContainer').innerHTML += `
        <div class="product-row">
            <input id="chkNum${id}" placeholder="Ø´Ù…Ø§Ø±Ù‡ Ú†Ú©">
            <input id="chkAmt${id}" type="number" placeholder="Ù…Ø¨Ù„Øº" oninput="calcTotals()">
            <input id="chkDate${id}" placeholder="Ø³Ø±Ø±Ø³ÛŒØ¯">
            <button onclick="this.parentNode.remove();calcTotals()" style="background:#ef4444;padding:8px 12px;">Ø­Ø°Ù</button>
        </div>`;
}

function calcTotals() {
    let prodTotal = 0, checkTotal = 0, advance = parseInt(document.getElementById('advanceAmt')?.value||0);
    
    for(let i=0; i<50; i++) {
        const qty = document.getElementById(`prodQty${i}`), price = document.getElementById(`prodPrice${i}`);
        if(qty?.value && price?.value) prodTotal += parseInt(qty.value) * parseInt(price.value);
        
        const chk = document.getElementById(`chkAmt${i}`);
        if(chk?.value) checkTotal += parseInt(chk.value);
    }
    
    document.getElementById('prodTotal').textContent = formatNum(prodTotal);
    document.getElementById('advTotal').textContent = formatNum(advance);
    document.getElementById('chkTotal').textContent = formatNum(checkTotal);
    document.getElementById('balance').textContent = formatNum(prodTotal - advance - checkTotal);
}

function saveContract() {
    const customer = document.getElementById('custName').value;
    if(!customer) return showMsg('Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª', 'error');
    
    const contract = {
        id: Date.now(),
        number: 'CF'+(data.contracts.length+1),
        customer, phone: document.getElementById('custPhone').value,
        address: document.getElementById('custAddr').value,
        date: document.getElementById('contDate').value,
        delivery: document.getElementById('delivDate').value,
        products: [], checks: [], advance: parseInt(document.getElementById('advanceAmt').value||0)
    };
    
    for(let i=0; i<50; i++) {
        const type = document.getElementById(`prodType${i}`), name = document.getElementById(`prodName${i}`),
              qty = document.getElementById(`prodQty${i}`), price = document.getElementById(`prodPrice${i}`);
        if(type?.value && name?.value && qty?.value && price?.value) {
            contract.products.push({
                type:type.value, name:name.value, qty:parseInt(qty.value), price:parseInt(price.value)
            });
        }
        const cnum = document.getElementById(`chkNum${i}`), camt = document.getElementById(`chkAmt${i}`),
              cdate = document.getElementById(`chkDate${i}`);
        if(cnum?.value && camt?.value) {
            contract.checks.push({number:cnum.value, amount:parseInt(camt.value), due:cdate?.value||''});
            data.checks.push({
                id:Date.now()+i, number:cnum.value, customer, amount:parseInt(camt.value),
                due:cdate?.value||'', status:'Ø¯Ø±Ø¬Ø±ÛŒØ§Ù†'
            });
        }
    }
    
    data.contracts.push(contract);
    saveLocal();
    showMsg('Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø«Ø¨Øª Ø´Ø¯!');
    resetContractForm();
    loadContracts();
}

function resetContractForm() {
    document.getElementById('custName').value = document.getElementById('custPhone').value = 
    document.getElementById('custAddr').value = document.getElementById('delivDate').value = 
    document.getElementById('advanceAmt').value = '0';
    document.getElementById('prodContainer').innerHTML = '';
    document.getElementById('checkContainer').innerHTML = '';
    prodCount = checkCount = 0;
    addProductRow(); addCheckRow(); calcTotals();
}

function loadContracts() {
    document.getElementById('contractTable').innerHTML += data.contracts.map(c=>{
        const total = c.products.reduce((s,p)=>s+p.qty*p.price,0);
        return `<tr><td>${c.number}</td><td>${c.customer}</td><td>${formatNum(total)}</td><td>${c.date}</td>
                <td><button onclick="deleteContract(${c.id})" style="background:#ef4444;color:white;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;">Ø­Ø°Ù</button></td></tr>`;
    }).join('');
}

function deleteContract(id) {
    if(confirm('Ø­Ø°ÙØŸ')) {
        data.contracts = data.contracts.filter(c=>c.id!==id);
        saveLocal();
        loadContracts();
        updateDashboardStats();
    }
}

function loadCustomers() {
    document.getElementById('custList').innerHTML = data.customers.map(c=>`<option>${c.name}</option>`).join('');
    document.getElementById('custTable').innerHTML = data.customers.map(c=>`
        <tr><td>${c.name}</td><td>${c.phone}</td><td>${c.address}</td>
        <td style="color:${c.type=='Ø¹Ø§Ø¯ÛŒ'?'green':c.type=='Ù¾ÛŒØ´ Ø®Ø±ÛŒØ¯'?'orange':'purple'}">${c.type}</td>
        <td><button onclick="deleteCustomer(${c.id})" style="background:#ef4444;color:white;border:none;padding:5px 10px;border-radius:5px;">Ø­Ø°Ù</button></td></tr>
    `).join('');
}

function toggleCustForm() {
    const form = document.getElementById('custForm');
    form.style.display = form.style.display === 'none' ? 'block' : 'none';
}

function saveCust() {
    const name = document.getElementById('newCustName').value;
    const phone = document.getElementById('newCustPhone').value;
    if(!name || !phone) return showMsg('Ù†Ø§Ù… Ùˆ ØªÙ„ÙÙ† Ø§Ù„Ø²Ø§Ù…ÛŒ', 'error');
    
    data.customers.push({
        id: Date.now(),
        name, phone, address: document.getElementById('newCustAddr').value,
        type: document.getElementById('newCustType').value
    });
    saveLocal();
    loadCustomers();
    toggleCustForm();
    showMsg('Ù…Ø´ØªØ±ÛŒ Ø«Ø¨Øª Ø´Ø¯');
}

function deleteCustomer(id) {
    data.customers = data.customers.filter(c=>c.id!==id);
    saveLocal();
    loadCustomers();
}

function loadChecks() {
    document.getElementById('checkTable').innerHTML = data.checks.map(c=>`
        <tr><td>${c.number}</td><td>${c.customer}</td><td>${formatNum(c.amount)}</td>
        <td>${c.due}</td><td>${c.status}</td>
        <td><button onclick="deleteCheck(${c.id})" style="background:#ef4444;color:white;border:none;padding:5px 10px;">Ø­Ø°Ù</button></td></tr>
    `).join('');
}

function deleteCheck(id) {
    data.checks = data.checks.filter(c=>c.id!==id);
    saveLocal();
    loadChecks();
}

// Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
addProductRow();
addCheckRow();
calcTotals();
document.getElementById('contDate').value = persianDate();
</script>
</body>
</html>
