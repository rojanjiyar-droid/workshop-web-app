function addExpense() {
    const type = document.getElementById('expenseType').value;
    const amount = parseFloat(document.getElementById('expenseAmount').value) || 0;
    const date = document.getElementById('expenseDate').value || getCurrentPersianDate();
    const description = document.getElementById('expenseDescription')?.value || '';
    
    if (!amount || amount <= 0) {
        showAlert('Ù„Ø·ÙØ§ Ù…Ø¨Ù„Øº Ù‡Ø²ÛŒÙ†Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error');
        return;
    }
    
    const expense = {
        id: 'EXP' + Date.now(),
        type: type,
        amount: amount,
        date: date,
        description: description,
        createdBy: document.getElementById('currentUser').textContent
    };
    
    expenses.push(expense);
    saveAllData();
    updateDashboard();
    
    // Ø«Ø¨Øª Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡
    addToHistory('Ù‡Ø²ÛŒÙ†Ù‡ Ø¬Ø¯ÛŒØ¯', `Ù‡Ø²ÛŒÙ†Ù‡ ${getExpenseTypeName(type)} Ø¨Ù‡ Ù…Ø¨Ù„Øº ${amount.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù† Ø«Ø¨Øª Ø´Ø¯`);
    
    showAlert('Ù‡Ø²ÛŒÙ†Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯', 'success');
    document.getElementById('expenseAmount').value = '';
    if (document.getElementById('expenseDescription')) {
        document.getElementById('expenseDescription').value = '';
    }
}

function getExpenseTypeName(type) {
    const types = {
        'material': 'Ù…ÙˆØ§Ø¯ Ø§ÙˆÙ„ÛŒÙ‡',
        'crane': 'Ø¬Ø±Ø«Ù‚ÛŒÙ„',
        'repairs': 'ØªØ¹Ù…ÛŒØ±Ø§Øª',
        'salary': 'Ø­Ù‚ÙˆÙ‚ Ù¾Ø±Ø³Ù†Ù„',
        'transport': 'Ú©Ø±Ø§ÛŒÙ‡ Ø­Ù…Ù„',
        'driver': 'Ú©Ø±Ø§ÛŒÙ‡ Ø±Ø§Ù†Ù†Ø¯Ù‡',
        'rent': 'Ø§Ø¬Ø§Ø±Ù‡',
        'water': 'ÙÛŒØ´ Ø¢Ø¨',
        'electricity': 'ÙÛŒØ´ Ø¨Ø±Ù‚',
        'gas': 'ÙÛŒØ´ Ú¯Ø§Ø²',
        'other': 'Ø³Ø§ÛŒØ±'
    };
    return types[type] || type;
}

function updateDashboard() {
    // Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ù…Ø§Ù„ÛŒ
    const totalIncome = contracts.reduce((sum, contract) => sum + contract.totalAmount, 0);
    const totalExpenses = expenses.reduce((sum, expense) => sum + expense.amount, 0);
    const netProfit = totalIncome - totalExpenses;
    
    // Ø¢Ù…Ø§Ø± Ù¾Ø±Ø³Ù†Ù„
    const activeWorkers = workers.filter(worker => worker.status === 'active').length;
    const totalWorkers = workers.length;
    
    // Ù…Ø¯ÛŒØ±ÛŒØª Ú†Ú©â€ŒÙ‡Ø§
    const today = new PersianDate();
    const dueChecks = checks.filter(check => {
        if (check.status !== 'pending') return false;
        const checkDate = new PersianDate(check.dueDate);
        return checkDate <= today;
    });
    
    const upcomingChecks = checks.filter(check => {
        if (check.status !== 'pending') return false;
        const checkDate = new PersianDate(check.dueDate);
        const diffDays = checkDate.diff(today, 'days');
        return diffDays > 0 && diffDays <= 7;
    });
    
    // Ø¢Ù¾Ø¯ÛŒØª Ù…Ù‚Ø§Ø¯ÛŒØ±
    document.getElementById('totalIncome').textContent = totalIncome.toLocaleString('fa-IR');
    document.getElementById('totalExpenses').textContent = totalExpenses.toLocaleString('fa-IR');
    document.getElementById('activeWorkers').textContent = `${activeWorkers}/${totalWorkers}`;
    document.getElementById('dueChecks').textContent = dueChecks.length;
    
    // Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§ÛŒ Ú†Ú©
    const checkAlerts = document.getElementById('checkAlerts');
    if (dueChecks.length > 0 || upcomingChecks.length > 0) {
        checkAlerts.style.display = 'block';
        let alertHTML = '';
        
        if (dueChecks.length > 0) {
            alertHTML += `âš ï¸ <strong>${dueChecks.length} Ú†Ú© Ø³Ø±Ø±Ø³ÛŒØ¯ Ø´Ø¯Ù‡</strong> Ø¯Ø§Ø±ÛŒØ¯! `;
        }
        
        if (upcomingChecks.length > 0) {
            alertHTML += `ğŸ”” <strong>${upcomingChecks.length} Ú†Ú©</strong> Ø¯Ø± Û· Ø±ÙˆØ² Ø¢ÛŒÙ†Ø¯Ù‡ Ø³Ø±Ø±Ø³ÛŒØ¯ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.`;
        }
        
        checkAlerts.innerHTML = alertHTML;
        checkAlerts.className = dueChecks.length > 0 ? 'alert alert-danger' : 'alert alert-warning';
    } else {
        checkAlerts.style.display = 'none';
    }
    
    // Ø¢Ù¾Ø¯ÛŒØª Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§ (Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ù†Ø¯)
    updateCharts();
}
