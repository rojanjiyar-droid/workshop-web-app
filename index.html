<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÛŒØ³ØªÙ… Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ Ú©Ù„Ø´ÛŒâ€ŒÙÙˆÙ… v17.0 - Ú©Ø§Ù…Ù„</title>
    <script src="https://cdn.jsdelivr.net/npm/persian-date@1.1.0/dist/persian-date.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Tahoma, Arial; background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); min-height: 100vh; direction: rtl; padding: 20px; }
        .login-box { max-width: 400px; margin: 50px auto; background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center; }
        .logo { width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, #1e3a8a, #3b82f6); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 28px; font-weight: bold; }
        input, select { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box; }
        input:focus, select:focus { border-color: #3b82f6; outline: none; }
        button { padding: 12px 24px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer; margin: 5px; }
        button:hover { background: #1d4ed8; }
        button.btn-sm { padding: 6px 12px; font-size: 12px; }
        .btn-success { background: #10b981; }
        .btn-success:hover { background: #059669; }
        .btn-danger { background: #ef4444; }
        .btn-danger:hover { background: #dc2626; }
        .btn-warning { background: #f59e0b; }
        .btn-warning:hover { background: #d97706; }
        .btn-info { background: #06b6d4; }
        .btn-info:hover { background: #0891b2; }
        .main-app { display: none; }
        .nav { background: #1e3a8a; padding: 0; display: flex; overflow-x: auto; border-radius: 10px; margin-bottom: 20px; }
        .nav button { background: none; color: white; border: none; padding: 15px 20px; cursor: pointer; white-space: nowrap; font-weight: bold; flex: 1; min-width: 120px; }
        .nav button.active { background: #3b82f6; }
        .page { display: none; }
        .page.active { display: block; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
        .stat { background: white; padding: 25px; border-radius: 15px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .stat-value { font-size: 28px; font-weight: bold; color: #3b82f6; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: right; border-bottom: 1px solid #eee; }
        th { background: #1e3a8a; color: white; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .product-row, .check-row { background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px; display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap: 10px; align-items: center; }
        .totals { background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 25px; border-radius: 15px; margin: 25px 0; }
        .total-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 16px; }
        .total-row:last-child { font-size: 24px; font-weight: bold; border-top: 2px solid rgba(255,255,255,0.3); padding-top: 15px; }
        .status-badge { padding: 6px 12px; border-radius: 20px; color: white; font-size: 12px; font-weight: bold; }
        .status-daraj { background: #f59e0b; }
        .status-vasol { background: #10b981; }
        .status-bargashti { background: #ef4444; }
        .notification { position: fixed; top: 20px; right: 20px; background: white; padding: 15px 20px; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); z-index: 999; border-right: 5px solid #10b981; display: flex; align-items: center; gap: 10px; }
        .card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); margin-bottom: 25px; }
        .date-picker { position: relative; }
        .date-picker input { background: #f8f9fa; cursor: pointer; }
        @media (max-width: 768px) { .form-row, .product-row, .check-row { grid-template-columns: 1fr; } .nav { flex-direction: column; } }
    </style>
</head>
<body>
<div id="loginBox" class="login-box">
    <div class="logo">CF</div>
    <h2>Ø³ÛŒØ³ØªÙ… Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ Ú©Ù„Ø´ÛŒâ€ŒÙÙˆÙ… v17.0</h2>
    <input type="text" id="userInput" placeholder="admin" value="admin">
    <input type="password" id="passInput" placeholder="1234" value="1234">
    <button onclick="loginNow()">ğŸš€ ÙˆØ±ÙˆØ¯</button>
    <p style="margin-top: 20px; color: #666; font-size: 14px;">admin / 1234</p>
</div>

<div id="mainApp" class="main-app">
    <div style="background: #0f172a; color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
        <div style="display: flex; align-items: center; gap: 20px;">
            <div style="width: 50px; height: 50px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #3b82f6; font-weight: bold; font-size: 20px;">CF</div>
            <div><h2 style="margin: 0;">Ú©Ù„Ø´ÛŒâ€ŒÙÙˆÙ…</h2><div id="dateNow"></div></div>
        </div>
        <button class="btn-danger" onclick="logoutNow()">Ø®Ø±ÙˆØ¬</button>
    </div>

    <div class="nav" id="navBar">
        <button class="active" onclick="showPage('dashboard')">ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</button>
        <button onclick="showPage('contracts')">ğŸ“ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§</button>
        <button onclick="showPage('checks')">ğŸ¦ Ú†Ú©â€ŒÙ‡Ø§</button>
        <button onclick="showPage('customers')">ğŸ‘¥ Ù…Ø´ØªØ±ÛŒØ§Ù†</button>
        <button onclick="showPage('expenses')">ğŸ’¸ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§</button>
        <button onclick="showPage('backup')">ğŸ’¾ Ù¾Ø´ØªÛŒØ¨Ø§Ù†</button>
    </div>

    <div class="container" style="max-width: 1400px; margin: 0 auto; padding: 20px;">
        <!-- Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ -->
        <div id="dashboard" class="page active">
            <div class="card">
                <h3 style="margin-bottom: 25px; color: #1e3a8a;">ğŸ“Š Ø¢Ù…Ø§Ø± Ú©Ø§Ù…Ù„ Ø³ÛŒØ³ØªÙ…</h3>
                <div class="stats" id="statsBox"></div>
            </div>
        </div>

        <!-- Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§ -->
        <div id="contracts" class="page">
            <div class="card">
                <h3 style="margin-bottom: 25px; color: #1e3a8a;">ğŸ“ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø¬Ø¯ÛŒØ¯</h3>
                <button class="btn-warning" onclick="resetForm()" style="width: auto;">ğŸ”„ Ø¬Ø¯ÛŒØ¯</button>
                <div class="form-row">
                    <div><label>Ù…Ø´ØªØ±ÛŒ *</label><input id="custName" list="custList"></div>
                    <div><label>ØªÙ„ÙÙ†</label><input id="custPhone" type="tel"></div>
                    <div><label>Ø¢Ø¯Ø±Ø³</label><input id="custAddr"></div>
                    <div><label>ØªØ§Ø±ÛŒØ® Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</label><input id="contDate" class="date-picker" readonly></div>
                    <div><label>ØªØ§Ø±ÛŒØ® ØªØ­ÙˆÛŒÙ„</label><input id="delDate" class="date-picker"></div>
                </div>
                <h4 style="margin: 25px 0 15px 0; color: #1e3a8a;">ğŸ“¦ Ù…Ø­ØµÙˆÙ„Ø§Øª</h4>
                <div id="prodCont"></div>
                <button class="btn-info" onclick="addProd()" style="width: auto;">â• Ù…Ø­ØµÙˆÙ„</button>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 25px 0;">
                    <div><label>Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª</label><input id="prePay" type="number" value="0" oninput="calcAll()"></div>
                </div>
                <h4 style="margin: 25px 0 15px 0; color: #1e3a8a;">ğŸ¦ Ú†Ú©â€ŒÙ‡Ø§</h4>
                <div id="chkCont"></div>
                <button class="btn-info" onclick="addChk()" style="width: auto;">â• Ú†Ú©</button>
                <div class="totals">
                    <div class="total-row"><span>Ø¬Ù…Ø¹ Ù…Ø­ØµÙˆÙ„Ø§Øª:</span><strong id="prodTot">0 ØªÙˆÙ…Ø§Ù†</strong></div>
                    <div class="total-row"><span>Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª:</span><strong id="advTot">0 ØªÙˆÙ…Ø§Ù†</strong></div>
                    <div class="total-row"><span>Ú†Ú©â€ŒÙ‡Ø§:</span><strong id="chkTot">0 ØªÙˆÙ…Ø§Ù†</strong></div>
                    <div class="total-row"><span style="color: #ffd700;">ğŸŸ¢ Ù…Ø§Ù†Ø¯Ù‡:</span><strong id="balTot">0 ØªÙˆÙ…Ø§Ù†</strong></div>
                </div>
                <button class="btn-success" onclick="saveCont()" style="width: auto; padding: 15px 30px; font-size: 16px;">âœ… Ø«Ø¨Øª Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</button>
            </div>
            <div class="card">
                <h3 style="margin-bottom: 25px; color: #1e3a8a;">ğŸ“‹ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§ÛŒ Ø«Ø¨Øª Ø´Ø¯Ù‡</h3>
                <div style="overflow-x: auto;">
                    <table id="contTable">
                        <tr><th>Ø´Ù…Ø§Ø±Ù‡</th><th>Ù…Ø´ØªØ±ÛŒ</th><th>Ù…Ø¨Ù„Øº</th><th>ØªØ§Ø±ÛŒØ®</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr>
                    </table>
                </div>
            </div>
        </div>

        <!-- Ú†Ú©â€ŒÙ‡Ø§ -->
        <div id="checks" class="page">
            <div class="card">
                <h3 style="margin-bottom: 25px; color: #1e3a8a;">ğŸ¦ Ø«Ø¨Øª Ú†Ú© Ø¬Ø¯ÛŒØ¯</h3>
                <div class="form-row">
                    <div><label>Ù…Ø´ØªØ±ÛŒ</label><input id="newCheckCustomer" list="custList"></div>
                    <div><label>Ø´Ù…Ø§Ø±Ù‡ Ú†Ú©</label><input id="newCheckNumber"></div>
                    <div><label>Ù…Ø¨Ù„Øº</label><input id="newCheckAmount" type="number"></div>
                    <div><label>Ø³Ø±Ø±Ø³ÛŒØ¯</label><input id="newCheckDue" class="date-picker"></div>
                    <div><label>ÙˆØ¶Ø¹ÛŒØª</label>
                        <select id="newCheckStatus">
                            <option>Ø¯Ø± Ø¬Ø±ÛŒØ§Ù†</option>
                            <option>ÙˆØµÙˆÙ„ Ø´Ø¯</option>
                            <option>Ø¨Ø±Ú¯Ø´ØªÛŒ</option>
                        </select>
                    </div>
                </div>
                <button class="btn-success" onclick="saveNewCheck()">âœ… Ø«Ø¨Øª Ú†Ú©</button>
            </div>
            <div class="card">
                <h3 style="margin-bottom: 25px; color: #1e3a8a;">ğŸ“‹ Ù„ÛŒØ³Øª Ú†Ú©â€ŒÙ‡Ø§</h3>
                <div style="overflow-x: auto;">
                    <table id="chkTab">
                        <tr><th>Ø´Ù…Ø§Ø±Ù‡</th><th>Ù…Ø´ØªØ±ÛŒ</th><th>Ù…Ø¨Ù„Øº</th><th>Ø³Ø±Ø±Ø³ÛŒØ¯</th><th>ÙˆØ¶Ø¹ÛŒØª</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr>
                    </table>
                </div>
            </div>
        </div>

        <!-- Ù…Ø´ØªØ±ÛŒØ§Ù† -->
        <div id="customers" class="page">
            <div class="card">
                <h3 style="margin-bottom: 25px; color: #1e3a8a;">ğŸ‘¥ Ù…Ø´ØªØ±ÛŒØ§Ù†</h3>
                <button class="btn-success" onclick="toggleCustForm()">â• Ù…Ø´ØªØ±ÛŒ Ø¬Ø¯ÛŒØ¯</button>
                <div id="custForm" style="display: none; background: #f8f9fa; padding: 25px; margin: 25px 0; border-radius: 12px;">
                    <div class="form-row">
                        <div><label>Ù†Ø§Ù… *</label><input id="newName"></div>
                        <div><label>ØªÙ„ÙÙ† *</label><input id="newPhone" type="tel"></div>
                        <div><label>Ø¢Ø¯Ø±Ø³</label><input id="newAddr"></div>
                        <div><label>Ù†ÙˆØ¹</label>
                            <select id="custType">
                                <option>Ø¹Ø§Ø¯ÛŒ</option><option>Ù¾ÛŒØ´ Ø®Ø±ÛŒØ¯</option><option>Ø¹Ø§Ù…Ù„</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn-success" onclick="saveCust()">âœ… Ø°Ø®ÛŒØ±Ù‡</button>
                    <button class="btn-danger" onclick="toggleCustForm()">âŒ Ø§Ù†ØµØ±Ø§Ù</button>
                </div>
                <div style="overflow-x: auto;">
                    <table id="custTab">
                        <tr><th>Ù†Ø§Ù…</th><th>ØªÙ„ÙÙ†</th><th>Ø¢Ø¯Ø±Ø³</th><th>Ù†ÙˆØ¹</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr>
                    </table>
                </div>
            </div>
        </div>

        <!-- Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ -->
        <div id="expenses" class="page">
            <div class="card">
                <h3 style="margin-bottom: 25px; color: #1e3a8a;">ğŸ’¸ Ø«Ø¨Øª Ù‡Ø²ÛŒÙ†Ù‡ Ø¬Ø¯ÛŒØ¯</h3>
                <div class="form-row">
                    <div><label>Ø´Ø±Ø­ Ù‡Ø²ÛŒÙ†Ù‡ *</label><input id="expDesc"></div>
                    <div><label>Ù…Ø¨Ù„Øº *</label><input id="expAmount" type="number"></div>
                    <div><label>ØªØ§Ø±ÛŒØ®</label><input id="expDate" class="date-picker" readonly></div>
                    <div><label>Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</label>
                        <select id="expCategory">
                            <option>Ø­Ù‚ÙˆÙ‚</option>
                            <option>Ø§Ø¬Ø§Ø±Ù‡</option>
                            <option>Ø¢Ø¨/Ø¨Ø±Ù‚/Ú¯Ø§Ø²</option>
                            <option>Ù…ÙˆØ§Ø¯ Ø§ÙˆÙ„ÛŒÙ‡</option>
                            <option>Ø­Ù…Ù„ Ùˆ Ù†Ù‚Ù„</option>
                            <option>Ø³Ø§ÛŒØ±</option>
                        </select>
                    </div>
                </div>
                <button class="btn-success" onclick="saveExpense()">âœ… Ø«Ø¨Øª Ù‡Ø²ÛŒÙ†Ù‡</button>
            </div>
            <div class="card">
                <h3 style="margin-bottom: 25px; color: #1e3a8a;">ğŸ“‹ Ù„ÛŒØ³Øª Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§</h3>
                <div style="overflow-x: auto;">
                    <table id="expTab">
                        <tr><th>Ø´Ø±Ø­</th><th>Ù…Ø¨Ù„Øº</th><th>ØªØ§Ø±ÛŒØ®</th><th>Ø¯Ø³ØªÙ‡</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr>
                    </table>
                </div>
            </div>
        </div>

        <!-- Ù¾Ø´ØªÛŒØ¨Ø§Ù† -->
        <div id="backup" class="page">
            <div class="card">
                <h3>ğŸ’¾ Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ</h3>
                <button class="btn-success" onclick="backupData()" style="width: auto; padding: 15px 30px;">ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù¾Ø´ØªÛŒØ¨Ø§Ù†</button>
                <br><input type="file" id="restoreFile" style="margin: 20px 0;" onchange="restoreData(event)">
                <div style="margin-top: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px;">
                    <strong>Ø±Ø§Ù‡Ù†Ù…Ø§:</strong> ÙØ§ÛŒÙ„ JSON Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯Ù‡ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯
                </div>
            </div>
        </div>
    </div>
</div>

<datalist id="custList"></datalist>

<script>
let data = JSON.parse(localStorage.getItem('kaleshi17')) || {
    customers: [
        {id:1,name:'Ø¹Ù„ÛŒ Ù…Ø­Ù…Ø¯ÛŒ',phone:'09121234567',address:'Ø§Ø±ÙˆÙ…ÛŒÙ‡ - Ø¨Ù„ÙˆØ§Ø± Ø¢Ø²Ø§Ø¯ÛŒ',type:'Ø¹Ø§Ø¯ÛŒ'},
        {id:2,name:'Ø±Ø¶Ø§ Ø§Ø­Ù…Ø¯ÛŒ',phone:'09129876543',address:'Ø§Ø±ÙˆÙ…ÛŒÙ‡ - Ù‚Ø²Ù„ Ø¹Ø§Ø´Ù‚',type:'Ø¹Ø§Ù…Ù„'}
    ],
    contracts: [], checks: [], expenses: []
};
let pCount=0, cCount=0, editingId = null;

// ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ
function pd(){const d=new persianDate();return d.format('YYYY/MM/DD');}
function fmt(n){return n.toLocaleString('fa-IR')+' ØªÙˆÙ…Ø§Ù†';}
function notif(msg,t='success'){
    const d=document.createElement('div');
    d.className='notification';
    d.style.borderRightColor=t=='success'?'#10b981':'#ef4444';
    d.innerHTML=`${t=='success'?'âœ…':'âŒ'}${msg}<button onclick="this.parentNode.remove()" style="float:left;background:none;border:none;font-size:20px;cursor:pointer;">Ã—</button>`;
    document.body.appendChild(d);setTimeout(()=>d.remove(),4000);
}
function save(){localStorage.setItem('kaleshi17',JSON.stringify(data));}

// ØªÙ‚ÙˆÛŒÙ… Ø¬Ù„Ø§Ù„ÛŒ popup
function showDatePicker(inputId) {
    const input = document.getElementById(inputId);
    const rect = input.getBoundingClientRect();
    let dateStr = prompt('ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ (YYYY/MM/DD):', input.value || pd());
    if (dateStr && isValidPersianDate(dateStr)) {
        input.value = dateStr;
        if (inputId.includes('delDate') || inputId.includes('cd') || inputId.includes('newCheckDue') || inputId.includes('expDate')) calcAll();
    }
}

function isValidPersianDate(dateStr) {
    const p = 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹';
    const regex = /^1[3-9]\d{2}\/(0[1-9]|1[0-2])\/(0[1-9]|[12]\d|3[01])$/;
    return regex.test(dateStr.replace(/[Û°-Û¹]/g, d => p.indexOf(d).toString()));
}

// ÙˆØ±ÙˆØ¯
function loginNow(){
    const u=document.getElementById('userInput').value,p=document.getElementById('passInput').value;
    if(u=='admin'&&p=='1234'){
        document.getElementById('loginBox').style.display='none';
        document.getElementById('mainApp').style.display='block';
        document.getElementById('dateNow').textContent=pd();
        document.getElementById('contDate').value=pd();
        document.getElementById('expDate').value=pd();
        startApp();
        notif('ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚! ğŸš€');
    }else notif('Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡!','error');
}

function logoutNow(){if(confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ'))location.reload();}
function showPage(p){
    document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('.nav button').forEach(x=>x.classList.remove('active'));
    document.getElementById(p).classList.add('active');
    event.target.classList.add('active');
    if(p=='contracts') {loadConts(); resetForm();}
    if(p=='checks') loadChks();
    if(p=='customers') loadCusts();
    if(p=='expenses') loadExpenses();
}
function startApp(){updateDash();loadCusts();loadChks();loadConts();loadExpenses();resetForm();}

function updateDash(){
    const tc=data.contracts.length, tr=data.contracts.reduce((s,c)=>s+c.products.reduce((p,pr)=>p+pr.qty*pr.price,0),0);
    const ch=data.checks.length, ex=data.expenses.reduce((s,e)=>s+e.amount,0);
    document.getElementById('statsBox').innerHTML=`
        <div class="stat"><div class="stat-value">${tc}</div>Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§</div>
        <div class="stat"><div class="stat-value">${fmt(tr)}</div>Ø¯Ø±Ø¢Ù…Ø¯</div>
        <div class="stat"><div class="stat-value">${data.customers.length}</div>Ù…Ø´ØªØ±ÛŒØ§Ù†</div>
        <div class="stat"><div class="stat-value">${ch}</div>Ú†Ú©â€ŒÙ‡Ø§</div>
        <div class="stat"><div class="stat-value">${fmt(ex)}</div>Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§</div>
        <div class="stat"><div class="stat-value">${data.expenses.length}</div>ØªØ¹Ø¯Ø§Ø¯ Ù‡Ø²ÛŒÙ†Ù‡</div>`;
}

// Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§
function resetForm(){
    document.getElementById('custName').value=document.getElementById('custPhone').value=document.getElementById('custAddr').value='';
    document.getElementById('delDate').value=document.getElementById('prePay').value='0';
    // Ù…Ø­ØµÙˆÙ„Ø§Øª Ùˆ Ú†Ú©â€ŒÙ‡Ø§ Ù¾Ø§Ú© Ù†Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯!
    calcAll();
}

function addProd(){
    const id=pCount++;
    document.getElementById('prodCont').innerHTML+=`
        <div class="product-row">
            <select id="t${id}" onchange="calcAll()">
                <option>ÛŒÙˆÙ†ÙˆÙ„ÛŒØª</option><option>ÙˆØ±Ù‚</option><option>Ù¾Ø§Ù†Ù„</option>
            </select>
            <input id="n${id}" placeholder="Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„">
            <input id="q${id}" type="number" placeholder="Ù…Ù‚Ø¯Ø§Ø±" oninput="calcAll()">
            <input id="p${id}" type="number" placeholder="Ù‚ÛŒÙ…Øª" oninput="calcAll()">
            <button class="btn-danger btn-sm" onclick="this.parentNode.remove();calcAll()">Ø­Ø°Ù</button>
        </div>`;
}

function addChk(){
    const id=cCount++;
    document.getElementById('chkCont').innerHTML+=`
        <div class="check-row">
            <input id="cn${id}" placeholder="Ø´Ù…Ø§Ø±Ù‡ Ú†Ú©">
            <input id="ca${id}" type="number" placeholder="Ù…Ø¨Ù„Øº" oninput="calcAll()">
            <input id="cd${id}" class="date-picker" onclick="showDatePicker('cd${id}')">
            <button class="btn-danger btn-sm" onclick="this.parentNode.remove();calcAll()">Ø­Ø°Ù</button>
        </div>`;
}

function calcAll(){
    let pt=0,ct=0,ad=parseInt(document.getElementById('prePay').value)||0;
    for(let i=0;i<50;i++){
        const q=document.getElementById(`q${i}`),p=document.getElementById(`p${i}`);
        if(q?.value&&p?.value)pt+=parseInt(q.value)*parseInt(p.value);
        const ca=document.getElementById(`ca${i}`);
        if(ca?.value)ct+=parseInt(ca.value);
    }
    document.getElementById('prodTot').textContent=fmt(pt);
    document.getElementById('advTot').textContent=fmt(ad);
    document.getElementById('chkTot').textContent=fmt(ct);
    document.getElementById('balTot').textContent=fmt(pt-ad-ct);
}

function saveCont(){
    const cust=document.getElementById('custName').value;
    if(!cust)return notif('Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª','error');
    const cont={
        id: Date.now(),
        number: `CF${String(data.contracts.length+1).padStart(3,'0')}`,
        customer: cust,
        phone: document.getElementById('custPhone').value,
        address: document.getElementById('custAddr').value,
        date: document.getElementById('contDate').value,
        delivery: document.getElementById('delDate').value,
        products: [], checks: [],
        advance: parseInt(document.getElementById('prePay').value)||0
    };
    for(let i=0;i<50;i++){
        const t=document.getElementById(`t${i}`),n=document.getElementById(`n${i}`),
              q=document.getElementById(`q${i}`),p=document.getElementById(`p${i}`);
        if(t?.value&&n?.value&&q?.value&&p?.value){
            cont.products.push({
                type: t.value, name: n.value,
                qty: parseInt(q.value), price: parseInt(p.value)
            });
        }
        const cn=document.getElementById(`cn${i}`),ca=document.getElementById(`ca${i}`),
              cd=document.getElementById(`cd${i}`);
        if(cn?.value&&ca?.value){
            cont.checks.push({
                number: cn.value, amount: parseInt(ca.value), due: cd?.value||''
            });
        }
    }
    data.contracts.push(cont);
    save();
    notif('âœ… Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø«Ø¨Øª Ø´Ø¯');
    loadConts();
    resetForm();
    updateDash();
}

function loadConts(){
    document.getElementById('contTable').innerHTML='<tr><th>Ø´Ù…Ø§Ø±Ù‡</th><th>Ù…Ø´ØªØ±ÛŒ</th><th>Ù…Ø¨Ù„Øº</th><th>ØªØ§Ø±ÛŒØ®</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr>'+
    data.contracts.map(c=>{
        const total=c.products.reduce((s,p)=>s+p.qty*p.price,0);
        return `<tr>
            <td>${c.number}</td>
            <td>${c.customer}</td>
            <td>${fmt(total)}</td>
            <td>${c.date}</td>
            <td>
                <button class="btn-warning btn-sm" onclick="editCont(${c.id})">ÙˆÛŒØ±Ø§ÛŒØ´</button>
                <button class="btn-danger btn-sm" onclick="delCont(${c.id})">Ø­Ø°Ù</button>
            </td>
        </tr>`;
    }).join('');
}

function delCont(id){
    if(confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')){
        data.contracts=data.contracts.filter(c=>c.id!==id);
        save();loadConts();updateDash();notif('Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø­Ø°Ù Ø´Ø¯');
    }
}

// Ú†Ú©â€ŒÙ‡Ø§
function saveNewCheck(){
    const cust=document.getElementById('newCheckCustomer').value,
          num=document.getElementById('newCheckNumber').value,
          amt=document.getElementById('newCheckAmount').value,
          due=document.getElementById('newCheckDue').value,
          status=document.getElementById('newCheckStatus').value;
    if(!cust||!num||!amt)return notif('ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ Ø§Ù„Ø²Ø§Ù…ÛŒ','error');
    data.checks.push({id:Date.now(),customer:cust,number:num,amount:parseInt(amt),due:due,status:status});
    save();loadChks();clearCheckForm();notif('âœ… Ú†Ú© Ø«Ø¨Øª Ø´Ø¯');
}

function clearCheckForm(){
    document.getElementById('newCheckCustomer').value=document.getElementById('newCheckNumber').value=
    document.getElementById('newCheckAmount').value=document.getElementById('newCheckDue').value='';
}

function loadChks(){
    document.getElementById('chkTab').innerHTML='<tr><th>Ø´Ù…Ø§Ø±Ù‡</th><th>Ù…Ø´ØªØ±ÛŒ</th><th>Ù…Ø¨Ù„Øº</th><th>Ø³Ø±Ø±Ø³ÛŒØ¯</th><th>ÙˆØ¶Ø¹ÛŒØª</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr>'+
    data.checks.map(c=>{
        const statusClass=c.status=='Ø¯Ø± Ø¬Ø±ÛŒØ§Ù†'?'status-daraj':c.status=='ÙˆØµÙˆÙ„ Ø´Ø¯'?'status-vasol':'status-bargashti';
        return `<tr>
            <td>${c.number}</td><td>${c.customer}</td><td>${fmt(c.amount)}</td><td>${c.due}</td>
            <td><span class="status-badge ${statusClass}">${c.status}</span></td>
            <td>
                <button class="btn-warning btn-sm" onclick="editCheck(${c.id})">ÙˆÛŒØ±Ø§ÛŒØ´</button>
                <button class="btn-danger btn-sm" onclick="delChk(${c.id})">Ø­Ø°Ù</button>
            </td>
        </tr>`;
    }).join('');
}

function delChk(id){
    if(confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')){
        data.checks=data.checks.filter(c=>c.id!==id);
        save();loadChks();updateDash();notif('Ú†Ú© Ø­Ø°Ù Ø´Ø¯');
    }
}

// Ù…Ø´ØªØ±ÛŒØ§Ù†
function toggleCustForm(){
    const form=document.getElementById('custForm');
    editingId=null;
    form.style.display=form.style.display=='none'?'block':'none';
    if(form.style.display=='block'){
        document.getElementById('newName').value=document.getElementById('newPhone').value='';
    }
}

function saveCust(){
    const name=document.getElementById('newName').value, phone=document.getElementById('newPhone').value;
    if(!name||!phone)return notif('Ù†Ø§Ù… Ùˆ ØªÙ„ÙÙ† Ø§Ù„Ø²Ø§Ù…ÛŒ','error');
    const customer={
        name:name, phone:phone,
        address:document.getElementById('newAddr').value,
        type:document.getElementById('custType').value
    };
    if(editingId){
        const idx=data.customers.findIndex(c=>c.id==editingId);
        data.customers[idx]={...data.customers[idx],...customer};
        notif('Ù…Ø´ØªØ±ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯');
    }else{
        customer.id=Date.now();
        data.customers.push(customer);
        notif('Ù…Ø´ØªØ±ÛŒ Ø¬Ø¯ÛŒØ¯ Ø«Ø¨Øª Ø´Ø¯');
    }
    save();loadCusts();toggleCustForm();updateDash();
}

function loadCusts(){
    document.getElementById('custList').innerHTML=data.customers.map(c=>`<option value="${c.name}">`).join('');
    document.getElementById('custTab').innerHTML='<tr><th>Ù†Ø§Ù…</th><th>ØªÙ„ÙÙ†</th><th>Ø¢Ø¯Ø±Ø³</th><th>Ù†ÙˆØ¹</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr>'+
    data.customers.map(c=>`<tr>
        <td>${c.name}</td><td>${c.phone}</td><td>${c.address||'-'}</td>
        <td style="color:${c.type=='Ø¹Ø§Ø¯ÛŒ'?'green':c.type=='Ù¾ÛŒØ´ Ø®Ø±ÛŒØ¯'?'orange':'purple'}">${c.type}</td>
        <td>
            <button class="btn-warning btn-sm" onclick="editCust(${c.id})">ÙˆÛŒØ±Ø§ÛŒØ´</button>
            <button class="btn-danger btn-sm" onclick="delCust(${c.id})">Ø­Ø°Ù</button>
        </td>
    </tr>`).join('');
}

function editCust(id){
    const cust=data.customers.find(c=>c.id==id);
    if(cust){
        editingId=id;
        document.getElementById('newName').value=cust.name;
        document.getElementById('newPhone').value=cust.phone;
        document.getElementById('newAddr').value=cust.address||'';
        document.getElementById('custType').value=cust.type;
        document.getElementById('custForm').style.display='block';
    }
}

function delCust(id){
    if(confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')){
        data.customers=data.customers.filter(c=>c.id!==id);
        save();loadCusts();updateDash();notif('Ù…Ø´ØªØ±ÛŒ Ø­Ø°Ù Ø´Ø¯');
    }
}

// Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§
function saveExpense(){
    const desc=document.getElementById('expDesc').value,
          amount=document.getElementById('expAmount').value,
          date=document.getElementById('expDate').value,
          cat=document.getElementById('expCategory').value;
    if(!desc||!amount)return notif('Ø´Ø±Ø­ Ùˆ Ù…Ø¨Ù„Øº Ø§Ù„Ø²Ø§Ù…ÛŒ','error');
    data.expenses.push({
        id: Date.now(),
        desc: desc,
        amount: parseInt(amount),
        date: date,
        category: cat
    });
    save();loadExpenses();clearExpenseForm();notif('âœ… Ù‡Ø²ÛŒÙ†Ù‡ Ø«Ø¨Øª Ø´Ø¯');
}

function clearExpenseForm(){
    document.getElementById('expDesc').value=document.getElementById('expAmount').value='';
}

function loadExpenses(){
    document.getElementById('expTab').innerHTML='<tr><th>Ø´Ø±Ø­</th><th>Ù…Ø¨Ù„Øº</th><th>ØªØ§Ø±ÛŒØ®</th><th>Ø¯Ø³ØªÙ‡</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr>'+
    data.expenses.map(e=>`<tr>
        <td>${e.desc}</td><td>${fmt(e.amount)}</td><td>${e.date}</td><td>${e.category}</td>
        <td>
            <button class="btn-danger btn-sm" onclick="delExpense(${e.id})">Ø­Ø°Ù</button>
        </td>
    </tr>`).join('');
}

function delExpense(id){
    if(confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')){
        data.expenses=data.expenses.filter(e=>e.id!==id);
        save();loadExpenses();updateDash();notif('Ù‡Ø²ÛŒÙ†Ù‡ Ø­Ø°Ù Ø´Ø¯');
    }
}

// Ù¾Ø´ØªÛŒØ¨Ø§Ù†
function backupData(){
    const dataStr=JSON.stringify(data,null,2);
    const blob=new Blob([dataStr],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;a.download=`kaleshi17-${pd()}.json`;a.click();
    notif('âœ… Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯');
}

function restoreData(e){
    const file=e.target.files[0];
    if(file){
        const reader=new FileReader();
        reader.onload=function(ev){
            try{
                data=JSON.parse(ev.target.result);
                save();
                notif('âœ… Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø´Ø¯');
                updateDash();loadCusts();loadChks();loadConts();loadExpenses();
            }catch{notif('Ø®Ø·Ø§ Ø¯Ø± ÙØ§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù†','error');}
        };
        reader.readAsText(file);
    }
}

// Event Listeners
document.addEventListener('keydown',e=>{
    if(e.key=='Enter'&&document.getElementById('loginBox').style.display!='none') loginNow();
});
document.querySelectorAll('.date-picker').forEach(el=>el.onclick=function(){showDatePicker(this.id);});

// Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
addProd();addChk();calcAll();
</script>
</body>
</html>
