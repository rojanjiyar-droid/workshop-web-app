<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ููููุช ฺฉูุดโููู โ ูุณุฎู ฺฉุงูู</title>
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogItmB2YbYp9mE2K/Yp9mGINii2KjYp9mE2KzYp9mFIiwKICAic2hvcnRfbmFtZSI6ICLYotio2KfZhNis2KfZhSIsCiAgInN0YXJ0X3VybCI6ICIvaW5kZXguaHRtbCIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2ZmZmZmZiIsCiAgInRoZW1lX2NvbG9yIjogIiMyYzNlNTAiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3BuZztiYXNlNjQsaVZNQk1LR3Y0V3A0akNyd0F3KzRLLzQ9PSAxMDB4MTAwIiwKICAgICAgInNpemVzIjogIjEwMHgxMDAiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciCiAgICB9CiAgXQp9Cg==">
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:Tahoma,Arial,sans-serif}
        body{background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;color:#333;display:flex;align-items:center;justify-content:center;padding:20px}
        .login-box{background:white;width:90%;max-width:400px;padding:30px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.2);text-align:center}
        .login-box h2{margin-bottom:20px}
        .input-group{margin-bottom:15px;text-align:right}
        .input-group label{display:block;margin-bottom:5px;font-weight:bold}
        .input-group input,.input-group select,.input-group textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:5px}
        .btn{background:#27ae60;color:white;border:none;padding:10px 20px;border-radius:5px;cursor:pointer;margin-top:10px}
        .btn:hover{opacity:.9}
        .main-page{display:none;width:100%;max-width:1400px;margin:0 auto;background:white;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.2);overflow:hidden}
        .header{background:#2c3e50;color:white;padding:15px;display:flex;justify-content:space-between;align-items:center}
        .nav{background:#34495e;display:flex;overflow-x:auto}
        .nav-btn{padding:12px 18px;border:none;background:none;color:white;cursor:pointer;white-space:nowrap;border-bottom:3px solid transparent}
        .nav-btn.active{background:#2980b9;border-bottom-color:#e74c3c}
        .content{padding:20px;min-height:500px}
        .tab-content{display:none}
        .tab-content.active{display:block;animation:fadeIn .5s ease-in}
        .form-section{background:#f8f9fa;border-radius:10px;padding:20px;margin-bottom:20px;border-right:4px solid #3498db}
        .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px;margin-bottom:15px}
        .form-group{text-align:right}
        .form-group label{display:block;margin-bottom:5px;font-weight:bold}
        .product-row{display:grid;grid-template-columns:2fr 1fr 1fr 1fr auto;gap:10px;align-items:end;margin-bottom:10px;padding:10px;background:white;border-radius:5px;border:1px solid #ddd}
        .check-row{background:#f0f8ff;padding:10px;margin:5px 0;border-radius:5px;border:1px solid #b0d4f3;display:flex;justify-content:space-between;align-items:center}
        .notification-container{position:fixed;top:20px;right:20px;z-index:1000;max-width:400px}
        .notification{background:white;padding:15px;margin-bottom:10px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.15);border-right:4px solid #27ae60;display:flex;align-items:center;gap:10px;animation:slideIn .3s ease-out}
        .notification.error{border-right-color:#e74c3c}
        .table-container{overflow-x:auto;margin-top:20px;border-radius:8px;border:1px solid #ddd}
        table{width:100%;border-collapse:collapse}th,td{padding:12px;text-align:right;border-bottom:1px solid #ddd}
        th{background:#34495e;color:white;font-weight:bold}tr:hover{background:#f5f5f5}
        .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:2000;justify-content:center;align-items:center}
        .modal-content{background:white;padding:30px;border-radius:10px;width:90%;max-width:500px}
        .search-box{margin-bottom:15px}.search-box input{width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:16px}
        .thermal-print{font-size:10px;font-family:'Courier New',monospace;width:80mm;margin:0 auto}
        .logo-preview{width:100px;margin:10px auto;display:block;border-radius:8px}
        .watermark{position:fixed;bottom:10px;right:10px;opacity:.08;z-index:-1;width:200px}
        .home-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:20px}
        .home-stats>div{background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:20px;border-radius:10px;text-align:center}
        .home-stats>div>div{font-size:24px;font-weight:bold}
        .module-list{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-bottom:20px}
        .module-card{background:#2c3e50;color:white;padding:15px 20px;border-radius:8px;cursor:pointer;transition:all .3s;text-align:center;min-width:140px}
        .module-card:hover{background:#3c5570;transform:translateY(-2px)}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
        @media (max-width:768px){.nav{flex-direction:column}.nav-btn{text-align:right;border-bottom:1px solid #3c5570}.form-grid{grid-template-columns:1fr}.product-row{grid-template-columns:1fr;gap:5px}.header{flex-direction:column;gap:15px;text-align:center}}
    </style>
</head>
<body>
<div class="notification-container" id="notificationContainer"></div>

<!-- ุตูุญู ูุฑูุฏ -->
<div class="login-box" id="loginPage">
    <div class="logo">ฺฉูุด ููู</div>
    <h2>ุณุณุชู ุญุณุงุจุฏุงุฑ ฺฉุงุฑุฎุงูู ููููุช</h2>
    <div class="input-group"><label>ูุงู ฺฉุงุฑุจุฑ</label><input id="username" value="admin"></div>
    <div class="input-group"><label>ุฑูุฒ ุนุจูุฑ</label><input id="password" type="password" value="1234"></div>
    <div class="input-group"><label>ุขูพููุฏ ููฺฏู</label><input type="file" id="loginLogoUpload" accept="image/*"></div>
    <img id="loginLogoPreview" class="logo-preview" style="display:none">
    <button class="btn btn-success" onclick="login()">ูุฑูุฏ</button>
</div>

<!-- ุตูุญู ุงุตู -->
<div class="container main-page" id="mainPage">
    <img class="watermark" id="watermark" style="display:none">
    <div class="header">
        <h1 id="companyTitle">ฺฉุงุฑุฎุงูู ููููุช ฺฉูุด ููู</h1>
        <div>
            <button class="btn btn-purple btn-sm" onclick="openModal('changePasswordModal')">ุชุบุฑ ุฑูุฒ</button>
            <button class="btn btn-danger btn-sm" onclick="logout()">ุฎุฑูุฌ</button>
        </div>
    </div>

    <div class="nav">
        <button class="nav-btn active" onclick="showTab('dashboard')">๐ ุตูุญู ุงุตู</button>
        <button class="nav-btn" onclick="showTab('contracts')">๐ ูุฑุงุฑุฏุงุฏูุง</button>
        <button class="nav-btn" onclick="showTab('customers')">๐ฅ ูุดุชุฑุงู</button>
        <button class="nav-btn" onclick="showTab('checks')">๐ฆ ฺฺฉโูุง</button>
        <button class="nav-btn" onclick="showTab('finance')">๐ฐ ูุงู</button>
        <button class="nav-btn" onclick="showTab('invoice')">๐ ูุงฺฉุชูุฑ</button>
        <button class="nav-btn" onclick="showTab('delivery')">๐ ููุจุช ุงุฑุณุงู</button>
        <button class="nav-btn" onclick="showTab('workers')">๐จโ๐ผ ฺฉุงุฑฺฉูุงู</button>
        <button class="nav-btn" onclick="showTab('reports')">๐ ฺฏุฒุงุฑุดโฺฏุฑ</button>
        <button class="nav-btn" onclick="showTab('backup')">๐พ ูพุดุชุจุงู</button>
        <button class="nav-btn" onclick="showTab('settings')">โ๏ธ ุชูุธูุงุช</button>
    </div>

    <div class="content">
        <!-- ุตูุญู ุงุตู -->
        <div id="dashboard" class="tab-content active">
            <div class="home-stats">
                <div><div id="totalContracts">ฐ</div><div>ูุฑุงุฑุฏุงุฏูุง</div></div>
                <div><div id="totalIncome">ฐ</div><div>ุฏุฑุขูุฏ ฺฉู</div></div>
                <div><div id="pendingChecks">ฐ</div><div>ฺฺฉ ุฏุฑ ุฌุฑุงู</div></div>
                <div><div id="nearDueChecks">ฐ</div><div>ฺฺฉ ูุฒุฏฺฉ ุณุฑุฑุณุฏ</div></div>
                <div><div id="totalCustomers">ฐ</div><div>ูุดุชุฑุงู</div></div>
                <div><div id="totalWorkers">ฐ</div><div>ฺฉุงุฑฺฉูุงู</div></div>
            </div>
            <div class="module-list">
                <div class="module-card" onclick="showTab('contracts')">๐ ูุฑุงุฑุฏุงุฏูุง</div>
                <div class="module-card" onclick="showTab('customers')">๐ฅ ูุดุชุฑุงู</div>
                <div class="module-card" onclick="showTab('checks')">๐ฆ ฺฺฉโูุง</div>
                <div class="module-card" onclick="showTab('finance')">๐ฐ ูุงู</div>
                <div class="module-card" onclick="showTab('invoice')">๐ ูุงฺฉุชูุฑ</div>
                <div class="module-card" onclick="showTab('delivery')">๐ ููุจุช ุงุฑุณุงู</div>
                <div class="module-card" onclick="showTab('workers')">๐จโ๐ผ ฺฉุงุฑฺฉูุงู</div>
                <div class="module-card" onclick="showTab('reports')">๐ ฺฏุฒุงุฑุดโฺฏุฑ</div>
                <div class="module-card" onclick="showTab('backup')">๐พ ูพุดุชุจุงู</div>
                <div class="module-card" onclick="showTab('settings')">โ๏ธ ุชูุธูุงุช</div>
            </div>
        </div>

        <!-- ูุฑุงุฑุฏุงุฏูุง -->
        <div id="contracts" class="tab-content">
            <div class="form-section">
                <h3>๐ ุซุจุช / ูุฑุงุด ูุฑุงุฑุฏุงุฏ</h3>
                <div class="form-grid">
                    <div class="form-group"><label>ูุงู ูุดุชุฑ *</label><input id="contractCustomer" placeholder="ูุงู ฺฉุงูู"></div>
                    <div class="form-group"><label>ุดูุงุฑู ุชูุงุณ *</label><input id="contractPhone" placeholder="09xxxxxxxxx"></div>
                    <div class="form-group"><label>ุขุฏุฑุณ</label><textarea id="contractAddress" rows="2"></textarea></div>
                    <div class="form-group"><label>ุชุงุฑุฎ ุชุญูู *</label><input id="contractDeliveryDate" type="date"></div>
                </div>
                <h4>ูุญุตููุงุช</h4>
                <div id="productRowsContainer"></div>
                <button type="button" class="btn btn-info btn-sm" onclick="addProductRow()">โ ุงูุฒูุฏู ูุญุตูู</button>
                <h4>๐ฆ ฺฺฉโูุง ูุฑุงุฑุฏุงุฏ</h4>
                <div id="checkRowsContainer"></div>
                <button type="button" class="btn btn-info btn-sm" onclick="addCheckRow()">โ ุงูุฒูุฏู ฺฺฉ</button>
                <div class="form-group"><label>ูพุดโูพุฑุฏุงุฎุช ููุฏ (ุชููุงู)</label><input id="contractAdvance" type="number" min="0" value="0"></div>
                <div style="background:#e8f4fd;padding:15px;border-radius:8px;margin:15px 0;text-align:center;font-weight:bold">
                    <div id="contractTotalDisplay">ุฌูุน ฺฉู ูุญุตููุงุช: ฐ ุชููุงู</div>
                    <div id="contractAdvanceDisplay">ูพุดโูพุฑุฏุงุฎุช ููุฏ: ฐ ุชููุงู</div>
                    <div id="contractCheckDisplay">ูุฌููุน ฺฺฉโูุง: ฐ ุชููุงู</div>
                    <div id="contractBalanceDisplay" style="color:#e74c3c;font-size:16px">ูุงูุฏู ูพุฑุฏุงุฎุช: ฐ ุชููุงู</div>
                </div>
                <div style="display:flex;gap:10px;margin-top:20px;flex-wrap:wrap">
                    <button class="btn btn-success" onclick="saveContract()">โ ุซุจุช / ุจูโุฑูุฒุฑุณุงู</button>
                    <button class="btn btn-warning" onclick="resetContractForm()">๐ ูพุงฺฉ ฺฉุฑุฏู</button>
                    <button class="btn btn-primary" onclick="printThermal()">๐จ๏ธ ฺุงูพ ุญุฑุงุฑุช</button>
                    <button class="btn btn-info" onclick="sendPDF('contract')">ุงุฑุณุงู PDF (ูุงุชุณุงูพ/ุชูฺฏุฑุงู)</button>
                </div>
            </div>
            <div class="form-section">
                <h3>๐ ูุณุช ูุฑุงุฑุฏุงุฏูุง</h3>
                <div class="search-box"><input id="searchContracts" placeholder="ุฌุณุชุฌู..." oninput="filterTable('contractsTable',this.value)"></div>
                <div class="table-container"><table><thead><tr><th>ุฑุฏู</th><th>ูุดุชุฑ</th><th>ุชูุงุณ</th><th>ูุจูุบ ฺฉู</th><th>ูพุดโูพุฑุฏุงุฎุช</th><th>ฺฺฉ</th><th>ูุงูุฏู</th><th>ุชุงุฑุฎ</th><th>ุนููุงุช</th></tr></thead><tbody id="contractsTable"></tbody></table></div>
            </div>
        </div>

        <!-- ูุดุชุฑุงู -->
        <div id="customers" class="tab-content">
            <div class="form-section">
                <h3>๐ฅ ูุฏุฑุช ูุดุชุฑุงู</h3>
                <div class="form-grid">
                    <div class="form-group"><label>ูุงู ู ูุงู ุฎุงููุงุฏฺฏ *</label><input id="customerName" placeholder="ูุงู ฺฉุงูู"></div>
                    <div class="form-group"><label>ุดูุงุฑู ุชูุงุณ *</label><input id="customerPhone" placeholder="09xxxxxxxxx"></div>
                    <div class="form-group"><label>ููุน ูุดุชุฑ</label><select id="customerType"><option value="ุนุงุฏ">ุนุงุฏ</option><option value="ูพุดโุฎุฑุฏ">ูพุดโุฎุฑุฏ</option><option value="ุนุงูู">ุนุงูู</option></select></div>
                </div>
                <div class="form-group"><label>ุขุฏุฑุณ</label><textarea id="customerAddress" rows="2"></textarea></div>
                <div style="display:flex;gap:10px"><button class="btn btn-success" onclick="saveCustomer()">โ ุซุจุช / ุจูโุฑูุฒุฑุณุงู</button><button class="btn btn-warning" onclick="resetCustomerForm()">๐ ูพุงฺฉ ฺฉุฑุฏู</button></div>
            </div>
            <div class="form-section">
                <h3>๐ ูุณุช ูุดุชุฑุงู</h3>
                <div class="search-box"><input id="searchCustomers" placeholder="ุฌุณุชุฌู..." oninput="filterTable('customersTable',this.value)"></div>
                <div class="table-container"><table><thead><tr><th>ุฑุฏู</th><th>ูุงู</th><th>ุชูุงุณ</th><th>ููุน</th><th>ุขุฏุฑุณ</th><th>ูุงูุฏู ุญุณุงุจ</th><th>ุจุงุฑ ุงุฑุณุงูโุดุฏู</th><th>ุจุงุฑ ูุงูุฏู</th><th>ุนููุงุช</th></tr></thead><tbody id="customersTable"></tbody></table></div>
            </div>
        </div>

        <!-- ฺฺฉโูุง -->
        <div id="checks" class="tab-content">
            <div class="form-section">
                <h3>๐ฆ ุซุจุช / ูุฑุงุด ฺฺฉ ุฌุฏุฏ</h3>
                <div class="form-grid">
                    <div class="form-group"><label>ูุงู ูุดุชุฑ / ุตุงุฏุฑฺฉููุฏู *</label><input id="checkCustomer" placeholder="ูุงู ฺฉุงูู"></div>
                    <div class="form-group"><label>ุดูุงุฑู ฺฺฉ *</label><input id="checkNumber" placeholder="ุดูุงุฑู ฺฺฉ"></div>
                    <div class="form-group"><label>ูุจูุบ (ุชููุงู) *</label><input id="checkAmount" type="number" min="0"></div>
                    <div class="form-group"><label>ุชุงุฑุฎ ุณุฑุฑุณุฏ *</label><input id="checkDueDate" type="date"></div>
                    <div class="form-group"><label>ุจุงูฺฉ *</label><input id="checkBank" placeholder="ูุงู ุจุงูฺฉ"></div>
                </div>
                <div style="display:flex;gap:10px"><button class="btn btn-success" onclick="saveCheck()">โ ุซุจุช ฺฺฉ</button><button class="btn btn-warning" onclick="resetCheckForm()">๐ ูพุงฺฉ ฺฉุฑุฏู</button></div>
            </div>
            <div class="form-section">
                <h3>๐ ูุณุช ฺฺฉโูุง (ูุฑุชุจ ุจุฑ ุงุณุงุณ ุณุฑุฑุณุฏ)</h3>
                <div class="search-box"><input id="searchChecks" placeholder="ุฌุณุชุฌู..." oninput="filterTable('checksTable',this.value)"></div>
                <div class="table-container"><table><thead><tr><th>ุฑุฏู</th><th>ุตุงุฏุฑฺฉููุฏู</th><th>ุดูุงุฑู</th><th>ูุจูุบ</th><th>ุณุฑุฑุณุฏ</th><th>ุจุงูฺฉ</th><th>ูุถุนุช</th><th>ุนููุงุช</th></tr></thead><tbody id="checksTable"></tbody></table></div>
            </div>
        </div>

        <!-- ูุงู -->
        <div id="finance" class="tab-content">
            <div class="form-section">
                <h3>๐ฐ ุซุจุช ุชุฑุงฺฉูุด</h3>
                <div class="form-grid">
                    <div class="form-group"><label>ููุน ุชุฑุงฺฉูุด *</label><select id="transactionType" onchange="toggleFinanceCats()"><option value="income">ุฏุฑุขูุฏ</option><option value="expense">ูุฒูู</option></select></div>
                    <div class="form-group"><label>ูุจูุบ (ุชููุงู) *</label><input id="transactionAmount" type="number" min="0"></div>
                    <div class="form-group"><label>ุฏุณุชูโุจูุฏ *</label><select id="transactionCategory"></select></div>
                    <div class="form-group"><label>ุชุงุฑุฎ *</label><input id="transactionDate" type="date"></div>
                </div>
                <div class="form-group"><label>ุดุฑุญ</label><textarea id="transactionDescription" rows="3"></textarea></div>
                <div style="display:flex;gap:10px"><button class="btn btn-success" onclick="saveTransaction()">โ ุซุจุช</button><button class="btn btn-warning" onclick="resetTransactionForm()">๐ ูพุงฺฉ ฺฉุฑุฏู</button></div>
            </div>
            <div class="form-section">
                <h3>๐ ุขูุงุฑ ูุงู</h3>
                <div class="home-stats">
                    <div><div id="totalIncomeFinance">ฐ</div><div>ฺฉู ุฏุฑุขูุฏ</div></div>
                    <div><div id="totalExpenseFinance">ฐ</div><div>ฺฉู ูุฒูู</div></div>
                    <div><div id="netProfit">ฐ</div><div>ุณูุฏ ุฎุงูุต</div></div>
                </div>
            </div>
            <div class="form-section">
                <h3>๐ ุชุงุฑุฎฺู ุชุฑุงฺฉูุดโูุง</h3>
                <div class="search-box"><input id="searchTransactions" placeholder="ุฌุณุชุฌู..." oninput="filterTable('transactionsTable',this.value)"></div>
                <div class="table-container"><table><thead><tr><th>ุฑุฏู</th><th>ุชุงุฑุฎ</th><th>ููุน</th><th>ุฏุณุชูโุจูุฏ</th><th>ุดุฑุญ</th><th>ูุจูุบ (ุชููุงู)</th><th>ุนููุงุช</th></tr></thead><tbody id="transactionsTable"></tbody></table></div>
            </div>
        </div>

        <!-- ูุงฺฉุชูุฑ -->
        <div id="invoice" class="tab-content">
            <div class="form-section">
                <h3>๐ ุตุฏูุฑ ูุงฺฉุชูุฑ ุฌุฏุฏ</h3>
                <div class="form-grid">
                    <div class="form-group"><label>ุงูุชุฎุงุจ ูุดุชุฑ *</label><select id="invoiceCustomerSelect" onchange="fillInvoiceCustomer()"><option value="">-- ุงูุชุฎุงุจ ฺฉูุฏ --</option></select></div>
                    <div class="form-group"><label>ุง ุซุจุช ุฏุณุช ูุงู *</label><input id="invoiceCustomerName" placeholder="ูุงู ฺฉุงูู"></div>
                    <div class="form-group"><label>ุดูุงุฑู ุชูุงุณ *</label><input id="invoiceCustomerPhone" placeholder="09xxxxxxxxx"></div>
                    <div class="form-group"><label>ุขุฏุฑุณ</label><textarea id="invoiceCustomerAddress" rows="2"></textarea></div>
                    <div class="form-group"><label>ูุงู ุฑุงููุฏู *</label><select id="invoiceDriverSelect"><option value="">-- ุงูุชุฎุงุจ ฺฉูุฏ --</option></select></div>
                    <div class="form-group"><label>ูพูุงฺฉ ุฎูุฏุฑู</label><input id="invoiceCarPlate" placeholder="ฑฒณดตถ ุงุฑุงู ทธ"></div>
                    <div class="form-group"><label>ุชุงุฑุฎ ุงุฑุณุงู *</label><input id="invoiceDeliveryDate" type="date"></div>
                    <div class="form-group"><label>ููุน ุญูู</label><select id="invoiceTransportType"><option value="ุจุง ุฑุงููุฏู">ุจุง ุฑุงููุฏู</option><option value="ุญูู ุจุง ูุดุชุฑ">ุญูู ุจุง ูุดุชุฑ</option></select></div>
                </div>
                <h4>ูุญุตููุงุช</h4>
                <div id="invoiceProductRowsContainer"></div>
                <button type="button" class="btn btn-info btn-sm" onclick="addInvoiceProductRow()">โ ุงูุฒูุฏู ูุญุตูู</button>
                <div style="display:flex;gap:10px;margin-top:20px;flex-wrap:wrap">
                    <button class="btn btn-success" onclick="saveInvoice()">โ ุตุฏูุฑ ูุงฺฉุชูุฑ</button>
                    <button class="btn btn-primary" onclick="printInvoice()">๐จ๏ธ ฺุงูพ ูุงฺฉุชูุฑ</button>
                    <button class="btn btn-info" onclick="sendPDF('invoice')">ุงุฑุณุงู PDF (ูุงุชุณุงูพ/ุชูฺฏุฑุงู)</button>
                </div>
            </div>
            <div class="form-section">
                <h3>๐ ูุณุช ูุงฺฉุชูุฑูุง</h3>
                <div class="search-box"><input id="searchInvoices" placeholder="ุฌุณุชุฌู..." oninput="filterTable('invoicesTable',this.value)"></div>
                <div class="table-container"><table><thead><tr><th>ุฑุฏู</th><th>ูุดุชุฑ</th><th>ุฑุงููุฏู</th><th>ูพูุงฺฉ</th><th>ุชุงุฑุฎ ุงุฑุณุงู</th><th>ูุจูุบ ฺฉู</th><th>ุนููุงุช</th></tr></thead><tbody id="invoicesTable"></tbody></table></div>
            </div>
        </div>

        <!-- ููุจุช ุงุฑุณุงู -->
        <div id="delivery" class="tab-content">
            <div class="form-section">
                <h3>๐ ููุจุชโุฏู ุงุฑุณุงู ุจุงุฑ</h3>
                <div class="form-grid">
                    <div class="form-group"><label>ูุงู ูุดุชุฑ *</label><input id="deliveryCustomer" placeholder="ูุงู ฺฉุงูู"></div>
                    <div class="form-group"><label>ุชุงุฑุฎ ุงุฑุณุงู *</label><input id="deliveryDateInput" type="date"></div>
                    <div class="form-group"><label>ุจุงุฒู ุฒูุงู *</label><select id="deliveryTimeSlot"><option value="">ุงูุชุฎุงุจ ฺฉูุฏ</option><option value="8-10">ธ-ฑฐ ุตุจุญ</option><option value="10-12">ฑฐ-ฑฒ ุธูุฑ</option><option value="12-14">ฑฒ-ฑด ุจุนุฏุงุฒุธูุฑ</option><option value="14-16">ฑด-ฑถ ุนุตุฑ</option><option value="16-18">ฑถ-ฑธ ุดุจ</option></select></div>
                </div>
                <div class="form-group"><label>ุชูุถุญุงุช ุงุฑุณุงู</label><textarea id="deliveryDescription" rows="3"></textarea></div>
                <div style="display:flex;gap:10px"><button class="btn btn-success" onclick="saveDelivery()">โ ุซุจุช</button><button class="btn btn-warning" onclick="resetDeliveryForm()">๐ ูพุงฺฉ ฺฉุฑุฏู</button></div>
            </div>
            <div class="form-section">
                <h3>๐ ููุจุชโูุง ุงุฑุณุงู</h3>
                <div class="search-box"><input id="searchDeliveries" placeholder="ุฌุณุชุฌู..." oninput="filterTable('deliveriesTable',this.value)"></div>
                <div class="table-container"><table><thead><tr><th>ุฑุฏู</th><th>ูุดุชุฑ</th><th>ุชุงุฑุฎ</th><th>ุจุงุฒู</th><th>ุชูุถุญุงุช</th><th>ุนููุงุช</th></tr></thead><tbody id="deliveriesTable"></tbody></table></div>
            </div>
        </div>

        <!-- ฺฉุงุฑฺฉูุงู -->
        <div id="workers" class="tab-content">
            <div class="form-section">
                <h3>๐จโ๐ผ ูุฏุฑุช ฺฉุงุฑฺฉูุงู</h3>
                <div class="form-grid">
                    <div class="form-group"><label>ูุงู ู ูุงู ุฎุงููุงุฏฺฏ *</label><input id="workerName" placeholder="ูุงู ฺฉุงูู"></div>
                    <div class="form-group"><label>ฺฉุฏ ูู</label><input id="workerNationalCode" placeholder="ฺฉุฏ ูู"></div>
                    <div class="form-group"><label>ุดูุงุฑู ุชูุงุณ</label><input id="workerPhone" placeholder="09xxxxxxxxx"></div>
                    <div class="form-group"><label>ุณูุช</label><select id="workerPosition"><option>ฺฉุงุฑฺฏุฑ</option><option>ุฑุงููุฏู</option><option>ุงุฏุงุฑ</option><option>ูุฏุฑ</option></select></div>
                    <div class="form-group"><label>ุญููู ูพุงู (ุชููุงู)</label><input id="workerSalary" type="number" min="0"></div>
                    <div class="form-group"><label>ุชุงุฑุฎ ุงุณุชุฎุฏุงู</label><input id="workerHireDate" type="date"></div>
                    <div class="form-group"><label>ุชุงุฑุฎ ุงุชูุงู ููฺฉุงุฑ</label><input id="workerEndDate" type="date"></div>
                </div>
                <div style="display:flex;gap:10px"><button class="btn btn-success" onclick="saveWorker()">โ ุซุจุช / ุจูโุฑูุฒุฑุณุงู</button><button class="btn btn-warning" onclick="resetWorkerForm()">๐ ูพุงฺฉ ฺฉุฑุฏู</button></div>
            </div>
            <div class="form-section">
                <h3>๐ ูุณุช ฺฉุงุฑฺฉูุงู</h3>
                <div class="search-box"><input id="searchWorkers" placeholder="ุฌุณุชุฌู..." oninput="filterTable('workersTable',this.value)"></div>
                <div class="table-container"><table><thead><tr><th>ุฑุฏู</th><th>ูุงู</th><th>ฺฉุฏ ูู</th><th>ุชูุงุณ</th><th>ุณูุช</th><th>ุญููู</th><th>ุชุงุฑุฎ ุงุณุชุฎุฏุงู</th><th>ุงุชูุงู ููฺฉุงุฑ</th><th>ุนููุงุช</th></tr></thead><tbody id="workersTable"></tbody></table></div>
            </div>
        </div>

        <!-- ฺฏุฒุงุฑุดโฺฏุฑ -->
        <div id="reports" class="tab-content">
            <div class="form-section">
                <h3>๐ ฺฏุฒุงุฑุดโฺฏุฑ</h3>
                <div class="form-grid">
                    <div class="form-group"><label>ููุน ฺฏุฒุงุฑุด</label><select id="reportType"><option value="financial">ูุงู</option><option value="contracts">ูุฑุงุฑุฏุงุฏูุง</option><option value="checks">ฺฺฉโูุง</option><option value="customers">ูุดุชุฑุงู</option></select></div>
                    <div class="form-group"><label>ุงุฒ ุชุงุฑุฎ</label><input id="reportFromDate" type="date"></div>
                    <div class="form-group"><label>ุชุง ุชุงุฑุฎ</label><input id="reportToDate" type="date"></div>
                </div>
                <div style="display:flex;gap:10px"><button class="btn btn-success" onclick="generateReport()">๐ ุงุฌุงุฏ</button><button class="btn btn-info" onclick="exportReportToExcel()">๐ ุงฺฉุณู</button><button class="btn btn-warning" onclick="exportReportToPDF()">๐ PDF</button><button class="btn btn-primary" onclick="printReport()">๐จ๏ธ ฺุงูพ</button></div>
            </div>
            <div class="form-section"><h3>๐ ูพุดโููุงุด ฺฏุฒุงุฑุด</h3><div id="reportPreview" style="padding:20px;background:#f8f9fa;border-radius:10px;min-height:200px"><p style="text-align:center;color:#666;padding:40px">ฺฏุฒุงุฑุด ุงูุชุฎุงุจ ูุดุฏู ุงุณุช</p></div></div>
        </div>

        <!-- ูพุดุชุจุงู -->
        <div id="backup" class="tab-content">
            <div class="form-section">
                <h3>๐พ ูพุดุชุจุงูโฺฏุฑ ู ุจุงุฒุงุจ</h3>
                <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center">
                    <button class="btn btn-success" onclick="exportBackup()">๐ฅ ุฏุงูููุฏ ูพุดุชุจุงู (JSON)</button>
                    <button class="btn btn-primary" onclick="document.getElementById('importFile').click()">๐ค ุจุงุฒุงุจ ุงุฒ ูุงู</button>
                    <input type="file" id="importFile" style="display:none" accept=".json" onchange="importBackup(event)">
                    <button class="btn btn-info" onclick="exportToExcel()">๐ ุฎุฑูุฌ ุงฺฉุณู</button>
                    <button class="btn btn-warning" onclick="exportToPDF()">๐ ุฎุฑูุฌ PDF</button>
                </div>
                <div style="margin-top:20px;text-align:center;color:#666"><p>ุขุฎุฑู ูพุดุชุจุงูโฺฏุฑ: <span id="lastBackupDate">ูฺ</span></p></div>
            </div>
        </div>

        <!-- ุชูุธูุงุช -->
        <div id="settings" class="tab-content">
            <div class="form-section">
                <h3>โ๏ธ ุชูุธูุงุช ุณุณุชู</h3>
                <div class="form-grid">
                    <div class="form-group"><label>ูุงู ุดุฑฺฉุช *</label><input id="companyName" value="ฺฉุงุฑุฎุงูู ููููุช ฺฉูุด ููู"></div>
                    <div class="form-group"><label>ุดูุงุฑู ุชูุงุณ ุดุฑฺฉุช *</label><input id="companyPhone" value="09149431013"></div>
                    <div class="form-group"><label>ุขุฏุฑุณ ุดุฑฺฉุช</label><textarea id="companyAddress" rows="2">ุงุฑููู - ุฌุงุฏู ุณููุงุณุ ูุฑุณุฏู ุจู ุฑูุณุชุง ูุฒู ุนุงุดูุ ุฎุงุจุงู ุขุฒุงุฏ</textarea></div>
                    <div class="form-group"><label>ุจุงุฑฺฏุฐุงุฑ ููฺฏู</label><input type="file" id="logoUpload" accept="image/*" onchange="uploadLogo(event)"><img id="logoPreview" class="logo-preview" style="display:none"></div>
                </div>
                <div style="display:flex;gap:10px"><button class="btn btn-success" onclick="saveSettings()">๐พ ุฐุฎุฑู</button><button class="btn btn-info" onclick="showSystemInfo()">โน๏ธ ุงุทูุงุนุงุช ุณุณุชู</button></div>
            </div>
        </div>
    </div>

    <!-- ููุฏุงู ุชุบุฑ ุฑูุฒ -->
    <div class="modal" id="changePasswordModal">
        <div class="modal-content">
            <h3>ุชุบุฑ ุฑูุฒ ุนุจูุฑ</h3>
            <div class="form-group"><label>ุฑูุฒ ูุนู</label><input type="password" id="currentPassword"></div>
            <div class="form-group"><label>ุฑูุฒ ุฌุฏุฏ</label><input type="password" id="newPassword" placeholder="ุญุฏุงูู ด ฺฉุงุฑุงฺฉุชุฑ"></div>
            <div class="form-group"><label>ุชฺฉุฑุงุฑ ุฑูุฒ ุฌุฏุฏ</label><input type="password" id="confirmNewPassword"></div>
            <div style="display:flex;gap:10px"><button class="btn btn-success" onclick="changePassword()">ุชุบุฑ</button><button class="btn btn-warning" onclick="closeModal('changePasswordModal')">ุงูุตุฑุงู</button></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        /*========== ุฏุงุฏูโูุง ุจุฑูุงูู ==========*/
        let appData={
            contracts:[],customers:[],workers:[],transactions:[],checks:[],deliveries:[],invoices:[],
            settings:{companyName:'ฺฉุงุฑุฎุงูู ููููุช ฺฉูุด ููู',companyPhone:'09149431013',companyAddress:'ุงุฑููู - ุฌุงุฏู ุณููุงุณ',logo:null},
            auth:{username:'admin',password: btoa('1234')}
        };
        let editingId=null,productRowCount=0,checkRowCount=0,invoiceProductRowCount=0;

        /*========== ุจุงุฑฺฏุฑ ู ุฐุฎุฑู ==========*/
        function loadData(){
            const saved=localStorage.getItem('kaleshiFoamDataV6');
            if(saved){appData=JSON.parse(saved);applyLogo();}
            updateAll();
        }
        function saveData(){localStorage.setItem('kaleshiFoamDataV6',JSON.stringify(appData));localStorage.setItem('lastBackup',new Date().toLocaleDateString('fa-IR'));}

        /*========== ุงุนูุงู ==========*/
        function showNotification(msg,type='success'){
            const n=document.createElement('div');n.className=`notification ${type}`;
            n.innerHTML=`<span>${type==='error'?'โ':'โ'}</span><span>${msg}</span><button onclick="this.parentElement.remove()" style="margin-left:auto;background:none;border:none;font-size:18px;cursor:pointer">ร</button>`;
            document.getElementById('notificationContainer').appendChild(n);setTimeout(()=>n.remove(),4000);
        }

        /*========== ูุฑูุฏ ู ุฎุฑูุฌ ==========*/
        function login(){
            const u=document.getElementById('username').value,p=document.getElementById('password').value;
            if(u===appData.auth.username && btoa(p)===appData.auth.password){
                document.getElementById('loginPage').style.display='none';
                document.getElementById('mainPage').style.display='block';
                loadData();showNotification('ุฎูุด ุขูุฏุฏ');
                const logoFile=document.getElementById('loginLogoUpload').files[0];
                if(logoFile){
                    const reader=new FileReader();
                    reader.onload=function(ev){appData.settings.logo=ev.target.result;saveData();applyLogo();};
                    reader.readAsDataURL(logoFile);
                }
            }else{showNotification('ูุงู ฺฉุงุฑุจุฑ ุง ุฑูุฒ ุงุดุชุจุงู ุงุณุช','error');}
        }
        function logout(){if(confirm('ุฎุงุฑุฌ ูโุดูุฏุ')){saveData();location.reload();}}

        /*========== ุชุจโูุง ==========*/
        function showTab(tab){
            document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
            document.getElementById(tab).classList.add('active');event.target.classList.add('active');
            if(tab==='dashboard')updateDashboard();
            if(tab==='contracts'){displayContracts();}
            if(tab==='customers')displayCustomers();
            if(tab==='checks')displayChecks();
            if(tab==='finance'){displayTransactions();toggleFinanceCats();}
            if(tab==='invoice'){loadInvoiceCustomers();loadInvoiceDrivers();addInvoiceProductRow();}
            if(tab==='delivery')displayDeliveries();
            if(tab==='workers')displayWorkers();
            if(tab==='reports')loadReportSettings();
            if(tab==='backup')updateBackupInfo();
            if(tab==='settings')loadSettings();
        }

        /*========== ุฏุงุดุจูุฑุฏ ==========*/
        function updateDashboard(){
            document.getElementById('totalContracts').textContent=appData.contracts.length;
            const income=appData.transactions.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
            document.getElementById('totalIncome').textContent=income.toLocaleString('fa-IR');
            document.getElementById('totalCustomers').textContent=appData.customers.length;
            document.getElementById('totalWorkers').textContent=appData.workers.length;
            const pending=appData.checks.filter(c=>c.status==='ุฏุฑ ุฌุฑุงู').length;
            document.getElementById('pendingChecks').textContent=pending;
            const near=appData.checks.filter(c=>isNearDue(c.dueDate)&&c.status==='ุฏุฑ ุฌุฑุงู').length;
            document.getElementById('nearDueChecks').textContent=near;
            if(near)showNotification(`${near} ฺฺฉ ูุฒุฏฺฉ ุณุฑุฑุณุฏ ุงุณุช!`,'warning');
        }
        function isNearDue(dueDate){const today=new Date();const[y,m,d]=dueDate.split('-').map(Number);const due=new Date(y,m-1,d);const diff=(due-today)/(1000*60*60*24);return diff>=0&&diff<=1;}

        /*========== ููุฏุงู ==========*/
        function openModal(id){document.getElementById(id).style.display='flex';}
        function closeModal(id){document.getElementById(id).style.display='none';}

        /*========== ููฺฏู ==========*/
        function uploadLogo(e){
            const file=e.target.files[0];if(!file)return;
            const reader=new FileReader();
            reader.onload=function(ev){appData.settings.logo=ev.target.result;saveData();applyLogo();showNotification('ููฺฏู ุฐุฎุฑู ุดุฏ');};
            reader.readAsDataURL(file);
        }
        function applyLogo(){
            const logo=appData.settings.logo;
            if(logo){
                document.getElementById('watermark').src=logo;
                document.getElementById('watermark').style.display='block';
                document.getElementById('companyTitle').textContent=appData.settings.companyName;
                const prev=document.getElementById('logoPreview');
                if(prev){prev.src=logo;prev.style.display='block';}
            }
        }

        /*========== ูุฑุงุฑุฏุงุฏูุง ==========*/
        function addProductRow(){
            productRowCount++;const row=document.createElement('div');row.className='product-row';row.setAttribute('data-row',productRowCount);
            row.innerHTML=`
                <div class="form-group"><label>ููุน ูุญุตูู</label><select class="productType" onchange="calculateContract()"><option value="ููู ุณูู">ููู ุณูู</option><option value="ูุฑู ููููุช">ูุฑู ููููุช</option><option value="ูพุงูู">ูพุงูู</option><option value="ุณูุงุฑุด">ุณูุงุฑุด</option></select></div>
                <div class="form-group"><label>ูุชุฑุงฺ (ูุชุฑ)</label><input type="number" class="productMeterage" min="0" step="0.1" oninput="calculateContract()"></div>
                <div class="form-group"><label>ููุช ู ูุชุฑ (ุชููุงู)</label><input type="number" class="productPrice" min="0" oninput="calculateContract()"></div>
                <div class="form-group"><label>ูุจูุบ ฺฉู</label><input class="productTotal" readonly style="background:#f8f9fa;font-weight:bold"></div>
                <button type="button" class="btn btn-danger btn-sm" onclick="removeProductRow(${productRowCount})">โ</button>
            `;document.getElementById('productRowsContainer').appendChild(row);
        }
        function removeProductRow(rowNumber){const row=document.querySelector(`[data-row="${rowNumber}"]`);if(row){row.remove();calculateContract();}}
        function addCheckRow(){
            checkRowCount++;const row=document.createElement('div');row.className='check-row';row.setAttribute('data-check',checkRowCount);
            row.innerHTML=`
                <div class="form-grid" style="grid-template-columns:1fr 1fr 1fr 1fr;gap:5px">
                    <div class="form-group"><label>ุดูุงุฑู ฺฺฉ</label><input class="checkNumber" placeholder="ุดูุงุฑู ฺฺฉ"></div>
                    <div class="form-group"><label>ูุจูุบ (ุชููุงู)</label><input type="number" class="checkAmount" min="0" oninput="calculateContract()"></div>
                    <div class="form-group"><label>ุชุงุฑุฎ ุณุฑุฑุณุฏ</label><input class="checkDueDate" type="date"></div>
                    <div class="form-group"><label>ุจุงูฺฉ</label><input class="checkBank" placeholder="ูุงู ุจุงูฺฉ"></div>
                </div>
                <button type="button" class="btn btn-danger btn-sm" onclick="removeCheckRow(${checkRowCount})">โ</button>
            `;document.getElementById('checkRowsContainer').appendChild(row);
        }
        function removeCheckRow(checkNumber){const row=document.querySelector(`[data-check="${checkNumber}"]`);if(row){row.remove();calculateContract();}}
        function calculateContract(){
            let totalProducts=0;
            document.querySelectorAll('.product-row').forEach(row=>{
                const meterage=parseFloat(row.querySelector('.productMeterage').value)||0;
                const price=parseFloat(row.querySelector('.productPrice').value)||0;
                const total=meterage*price;
                row.querySelector('.productTotal').value=total.toLocaleString('fa-IR');
                totalProducts+=total;
            });
            let totalChecks=0;
            document.querySelectorAll('.check-row').forEach(row=>{
                totalChecks+=parseFloat(row.querySelector('.checkAmount').value)||0;
            });
            const advance=parseFloat(document.getElementById('contractAdvance').value)||0;
            const balance=totalProducts-advance-totalChecks;
            document.getElementById('contractTotalDisplay').textContent=`ุฌูุน ฺฉู ูุญุตููุงุช: ${totalProducts.toLocaleString('fa-IR')} ุชููุงู`;
            document.getElementById('contractAdvanceDisplay').textContent=`ูพุดโูพุฑุฏุงุฎุช ููุฏ: ${advance.toLocaleString('fa-IR')} ุชููุงู`;
            document.getElementById('contractCheckDisplay').textContent=`ูุฌููุน ฺฺฉโูุง: ${totalChecks.toLocaleString('fa-IR')} ุชููุงู`;
            document.getElementById('contractBalanceDisplay').innerHTML=`ูุงูุฏู ูพุฑุฏุงุฎุช: <span style="color:${balance>0?'#27ae60':balance<0?'#e74c3c':'#f39c12'}">${balance.toLocaleString('fa-IR')}</span> ุชููุงู`;
        }
        function saveContract(){
            const customer=document.getElementById('contractCustomer').value.trim();
            const phone=document.getElementById('contractPhone').value.trim();
            if(!customer||!phone){showNotification('ูุงู ู ุชูุงุณ ูุดุชุฑ ุงูุฒุงู ุงุณุช','error');return;}
            if(!/^09[0-9]{9}$/.test(phone)){showNotification('ุดูุงุฑู ููุจุงู ูุนุชุจุฑ ูุณุช','error');return;}
            const products=[],checks=[];
            document.querySelectorAll('.product-row').forEach(row=>{
                const m=parseFloat(row.querySelector('.productMeterage').value)||0;
                const p=parseFloat(row.querySelector('.productPrice').value)||0;
                if(m>0&&p>0)products.push({type:row.querySelector('.productType').value,meterage:m,price:p,total:m*p});
            });
            document.querySelectorAll('.check-row').forEach(row=>{
                const num=row.querySelector('.checkNumber').value.trim();
                const amt=parseFloat(row.querySelector('.checkAmount').value)||0;
                const due=row.querySelector('.checkDueDate').value;
                const bank=row.querySelector('.checkBank').value.trim();
                if(num&&amt>0&&due&&bank)checks.push({number:num,amount:amt,dueDate:due,bank:bank,status:'ุฏุฑ ุฌุฑุงู'});
            });
            const totalProducts=products.reduce((s,p)=>s+p.total,0);
            const totalChecks=checks.reduce((s,c)=>s+c.amount,0);
            const advance=parseFloat(document.getElementById('contractAdvance').value)||0;
            const balance=totalProducts-advance-totalChecks;
            const contract={id:editingId||Date.now(),customer,phone,address:document.getElementById('contractAddress').value,deliveryDate:document.getElementById('contractDeliveryDate').value,products,checks,totalAmount:totalProducts,advance,checkAmount:totalChecks,balance,date:new Date().toLocaleDateString('fa-IR'),status:'ูุนุงู'};
            if(editingId){const i=appData.contracts.findIndex(c=>c.id===editingId);appData.contracts[i]=contract;}else{appData.contracts.push(contract);}
            checks.forEach(c=>appData.checks.push({id:Date.now()+Math.random(),contractId:contract.id,customer,number:c.number,amount:c.amount,dueDate:c.dueDate,bank:c.bank,status:'ุฏุฑ ุฌุฑุงู',createdDate:new Date().toLocaleDateString('fa-IR')}));
            appData.transactions.push({id:Date.now(),type:'income',amount:totalProducts,category:'ูุฑูุด',description:`ูุฑุงุฑุฏุงุฏ ุจุง ${customer}`,date:new Date().toLocaleDateString('fa-IR')});
            const existing=appData.customers.find(c=>c.phone===phone);
            if(!existing)appData.customers.push({id:Date.now(),name:customer,phone,address:contract.address,type:'ุนุงุฏ',registrationDate:new Date().toLocaleDateString('fa-IR')});
            saveData();updateAll();resetContractForm();showNotification(`ูุฑุงุฑุฏุงุฏ ุซุจุช ุดุฏ! ูุงูุฏู: ${balance.toLocaleString('fa-IR')} ุชููุงู`);
            autoBackup();
        }
        function resetContractForm(){editingId=null;document.getElementById('contractCustomer').value='';document.getElementById('contractPhone').value='';document.getElementById('contractAddress').value='';document.getElementById('contractAdvance').value='0';document.getElementById('contractDeliveryDate').value='';productRowCount=0;checkRowCount=0;document.getElementById('productRowsContainer').innerHTML='';document.getElementById('checkRowsContainer').innerHTML='';addProductRow();addCheckRow();calculateContract();}
        function displayContracts(){
            const tbody=document.getElementById('contractsTable');tbody.innerHTML='';
            if(appData.contracts.length===0){tbody.innerHTML='<tr><td colspan="9" style="text-align:center;padding:20px">ูฺ ูุฑุงุฑุฏุงุฏ ุซุจุช ูุดุฏู ุงุณุช</td></tr>';return;}
            appData.contracts.forEach((c,i)=>{
                const row=document.createElement('tr');
                row.innerHTML=`
                    <td>${i+1}</td><td>${c.customer}</td><td>${c.phone}</td><td>${c.totalAmount.toLocaleString('fa-IR')}</td><td>${c.advance.toLocaleString('fa-IR')}</td><td>${c.checkAmount.toLocaleString('fa-IR')}</td>
                    <td style="color:${c.balance>0?'#27ae60':c.balance<0?'#e74c3c':'#f39c12'};font-weight:bold">${c.balance.toLocaleString('fa-IR')}</td><td>${c.date}</td>
                    <td>
                        <button class="btn btn-info btn-sm" onclick="viewContract(${c.id})">ูุดุงูุฏู</button>
                        <button class="btn btn-warning btn-sm" onclick="editContract(${c.id})">ูุฑุงุด</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteContract(${c.id})">ุญุฐู</button>
                        <button class="btn btn-primary btn-sm" onclick="printThermal(${c.id})">ฺุงูพ</button>
                        <button class="btn btn-info btn-sm" onclick="sendPDF(${c.id})">PDF + ุงุฑุณุงู</button>
                    </td>
                `;tbody.appendChild(row);
            });
        }
        function viewContract(id){const c=appData.contracts.find(x=>x.id===id);if(!c)return;let txt=`ูุดุชุฑ: ${c.customer}\nุชูุงุณ: ${c.phone}\nุชุงุฑุฎ: ${c.date}\n\nูุญุตููุงุช:\n`;c.products.forEach((p,i)=>txt+=`${i+1}. ${p.type} - ${p.meterage} ูุชุฑ ร ${p.price.toLocaleString('fa-IR')} = ${p.total.toLocaleString('fa-IR')} ุชููุงู\n`);txt+=`\nุฌูุน ฺฉู: ${c.totalAmount.toLocaleString('fa-IR')} ุชููุงู\nููุฏ: ${c.advance.toLocaleString('fa-IR')} ุชููุงู\nฺฺฉ: ${c.checkAmount.toLocaleString('fa-IR')} ุชููุงู\nูุงูุฏู: ${c.balance.toLocaleString('fa-IR')} ุชููุงู`;alert(txt);}
        function editContract(id){const c=appData.contracts.find(x=>x.id===id);if(!c)return;editingId=c.id;document.getElementById('contractCustomer').value=c.customer;document.getElementById('contractPhone').value=c.phone;document.getElementById('contractAddress').value=c.address;document.getElementById('contractAdvance').value=c.advance;document.getElementById('contractDeliveryDate').value=c.deliveryDate;productRowCount=0;checkRowCount=0;document.getElementById('productRowsContainer').innerHTML='';document.getElementById('checkRowsContainer').innerHTML='';c.products.forEach(p=>{addProductRow();const row=document.querySelector(`[data-row="${productRowCount}"]`);row.querySelector('.productType').value=p.type;row.querySelector('.productMeterage').value=p.meterage;row.querySelector('.productPrice').value=p.price;});c.checks.forEach(ch=>{addCheckRow();const row=document.querySelector(`[data-check="${checkRowCount}"]`);row.querySelector('.checkNumber').value=ch.number;row.querySelector('.checkAmount').value=ch.amount;row.querySelector('.checkDueDate').value=ch.dueDate;row.querySelector('.checkBank').value=ch.bank;});calculateContract();showNotification('ูุฑุงุฑุฏุงุฏ ุฏุฑ ุญุงูุช ูุฑุงุด ูุฑุงุฑ ฺฏุฑูุช','info');}
        function deleteContract(id){if(confirm('ุขุง ุงุฒ ุญุฐู ุงู ูุฑุงุฑุฏุงุฏ ุงุทููุงู ุฏุงุฑุฏุ')){appData.contracts=appData.contracts.filter(c=>c.id!==id);appData.checks=appData.checks.filter(c=>c.contractId!==id);saveData();displayContracts();updateDashboard();showNotification('ูุฑุงุฑุฏุงุฏ ุญุฐู ุดุฏ');}}

        /*========== ูุดุชุฑุงู ==========*/
        function saveCustomer(){
            const name=document.getElementById('customerName').value.trim();
            const phone=document.getElementById('customerPhone').value.trim();
            if(!name||!phone){showNotification('ูุงู ู ุชูุงุณ ุงูุฒุงู ุงุณุช','error');return;}
            if(!/^09[0-9]{9}$/.test(phone)){showNotification('ุดูุงุฑู ููุจุงู ูุนุชุจุฑ ูุณุช','error');return;}
            const customer={id:editingId||Date.now(),name,phone,address:document.getElementById('customerAddress').value,type:document.getElementById('customerType').value,registrationDate:new Date().toLocaleDateString('fa-IR')};
            if(editingId){const i=appData.customers.findIndex(c=>c.id===editingId);appData.customers[i]=customer;}else{appData.customers.push(customer);}
            saveData();displayCustomers();resetCustomerForm();showNotification('ูุดุชุฑ ุซุจุช ุดุฏ');
        }
        function resetCustomerForm(){editingId=null;document.getElementById('customerName').value='';document.getElementById('customerPhone').value='';document.getElementById('customerAddress').value='';document.getElementById('customerType').value='ุนุงุฏ';}
        function displayCustomers(){
            const tbody=document.getElementById('customersTable');tbody.innerHTML='';
            if(appData.customers.length===0){tbody.innerHTML='<tr><td colspan="9" style="text-align:center;padding:20px">ูุดุชุฑโุง ุซุจุช ูุดุฏู ุงุณุช</td></tr>';return;}
            appData.customers.forEach((c,i)=>{
                const customerContracts=appData.contracts.filter(co=>co.phone===c.phone);
                const totalSent=customerContracts.reduce((s,co)=>s+co.totalAmount,0);
                const totalPaid=customerContracts.reduce((s,co)=>s+co.advance+co.checkAmount,0);
                const remaining=totalSent-totalPaid;
                const deliveredQty=customerContracts.reduce((s,co)=>s+co.products.reduce((ss,p)=>ss+p.meterage,0),0);
                tbody.innerHTML+=`
                    <tr>
                        <td>${i+1}</td><td>${c.name}</td><td>${c.phone}</td><td>${c.type}</td><td>${c.address}</td>
                        <td>${remaining.toLocaleString('fa-IR')}</td><td>${deliveredQty.toFixed(1)}</td><td>${(remaining>0?remaining:0).toLocaleString('fa-IR')}</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="editCustomer(${c.id})">ูุฑุงุด</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteCustomer(${c.id})">ุญุฐู</button>
                        </td>
                    </tr>`;
            });
        }
        function editCustomer(id){const c=appData.customers.find(x=>x.id===id);if(!c)return;editingId=c.id;document.getElementById('customerName').value=c.name;document.getElementById('customerPhone').value=c.phone;document.getElementById('customerAddress').value=c.address;document.getElementById('customerType').value=c.type;showNotification('ูุดุชุฑ ุฏุฑ ุญุงูุช ูุฑุงุด ูุฑุงุฑ ฺฏุฑูุช','info');}
        function deleteCustomer(id){if(confirm('ูุดุชุฑ ุญุฐู ุดูุฏุ')){appData.customers=appData.customers.filter(x=>x.id!==id);saveData();displayCustomers();showNotification('ูุดุชุฑ ุญุฐู ุดุฏ');}}

        /*========== ฺฺฉโูุง ==========*/
        function saveCheck(){
            const customer=document.getElementById('checkCustomer').value.trim();
            const number=document.getElementById('checkNumber').value.trim();
            const amount=parseFloat(document.getElementById('checkAmount').value);
            const dueDate=document.getElementById('checkDueDate').value;
            const bank=document.getElementById('checkBank').value.trim();
            if(!customer||!number||!amount||!dueDate||!bank){showNotification('ุชูุงู ููุฏูุง ุณุชุงุฑูโุฏุงุฑ ุฑุง ูพุฑ ฺฉูุฏ','error');return;}
            const check={id:Date.now(),customer,number,amount,dueDate,bank,status:'ุฏุฑ ุฌุฑุงู',createdDate:new Date().toLocaleDateString('fa-IR')};
            appData.checks.push(check);
            saveData();displayChecks();resetCheckForm();showNotification('ฺฺฉ ุซุจุช ุดุฏ');
        }
        function resetCheckForm(){document.getElementById('checkCustomer').value='';document.getElementById('checkNumber').value='';document.getElementById('checkAmount').value='';document.getElementById('checkDueDate').value='';document.getElementById('checkBank').value='';}
        function displayChecks(){
            const tbody=document.getElementById('checksTable');tbody.innerHTML='';
            const sorted=[...appData.checks].sort((a,b)=>new Date(a.dueDate)-new Date(b.dueDate));
            if(sorted.length===0){tbody.innerHTML='<tr><td colspan="8" style="text-align:center;padding:20px">ฺฺฉ ุซุจุช ูุดุฏู ุงุณุช</td></tr>';return;}
            sorted.forEach((c,i)=>{
                const row=document.createElement('tr');
                row.innerHTML=`
                    <td>${i+1}</td><td>${c.customer}</td><td>${c.number}</td><td>${c.amount.toLocaleString('fa-IR')}</td><td>${c.dueDate}</td><td>${c.bank}</td><td>${c.status}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editCheck(${c.id})">ูุฑุงุด</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteCheck(${c.id})">ุญุฐู</button>
                    </td>
                `;tbody.appendChild(row);
            });
        }
        function editCheck(id){const c=appData.checks.find(x=>x.id===id);if(!c)return;const status=prompt('ูุถุนุช ุฌุฏุฏ ุฑุง ูุงุฑุฏ ฺฉูุฏ (ุฏุฑ ุฌุฑุงู / ูุตูู ุดุฏู / ุจุฑฺฏุดุช ุฎูุฑุฏู)',c.status);if(status){c.status=status;saveData();displayChecks();showNotification('ูุถุนุช ฺฺฉ ุจูโุฑูุฒ ุดุฏ');}}
        function deleteCheck(id){if(confirm('ฺฺฉ ุญุฐู ุดูุฏุ')){appData.checks=appData.checks.filter(x=>x.id!==id);saveData();displayChecks();showNotification('ฺฺฉ ุญุฐู ุดุฏ');}}

        /*========== ูุงู ==========*/
        const incomeCats=['ูุฑูุด ููููุช','ูุฑูุด ูุฑู','ูุฑูุด ูพุงูู','ูุฑูุด ฺฏูู','ุณุงุฑ'];
        const expenseCats=['ุฎุฑุฏ ููุงุฏ','ุญููู ฺฉุงุฑฺฏุฑุงู','ฺฉุฑุงู ุฑุงููุฏฺฏุงู','ฺฉุฑุงู ุฌุฑุซูู','ุงุฌุงุฑู','ุจุฑู','ุขุจ','ฺฏุงุฒ','ููุงุฒู ุฏฺฉ','ุชุนูุฑฺฉุงุฑ','ูพุงุฏุงุด','ุณุงุฑ'];
        function toggleFinanceCats(){
            const type=document.getElementById('transactionType').value;
            const sel=document.getElementById('transactionCategory');
            sel.innerHTML='';
            (type==='income'?incomeCats:expenseCats).forEach(cat=>{
                const o=document.createElement('option');o.value=cat;o.textContent=cat;sel.appendChild(o);
            });
        }
        function saveTransaction(){
            const type=document.getElementById('transactionType').value;
            const amount=parseFloat(document.getElementById('transactionAmount').value);
            const category=document.getElementById('transactionCategory').value;
            const description=document.getElementById('transactionDescription').value;
            const date=document.getElementById('transactionDate').value||new Date().toLocaleDateString('fa-IR');
            if(!amount||amount<=0){showNotification('ูุจูุบ ูุนุชุจุฑ ูุงุฑุฏ ฺฉูุฏ','error');return;}
            const transaction={id:Date.now(),type,amount,category,description,date};
            appData.transactions.push(transaction);
            saveData();displayTransactions();resetTransactionForm();showNotification('ุชุฑุงฺฉูุด ุซุจุช ุดุฏ');
        }
        function resetTransactionForm(){document.getElementById('transactionAmount').value='';document.getElementById('transactionDescription').value='';document.getElementById('transactionDate').value='';}
        function displayTransactions(){
            const tbody=document.getElementById('transactionsTable');tbody.innerHTML='';
            if(appData.transactions.length===0){tbody.innerHTML='<tr><td colspan="7" style="text-align:center;padding:20px">ุชุฑุงฺฉูุด ุซุจุช ูุดุฏู ุงุณุช</td></tr>';return;}
            const income=appData.transactions.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
            const expense=appData.transactions.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
            document.getElementById('totalIncomeFinance').textContent=income.toLocaleString('fa-IR');
            document.getElementById('totalExpenseFinance').textContent=expense.toLocaleString('fa-IR');
            document.getElementById('netProfit').textContent=(income-expense).toLocaleString('fa-IR');
            appData.transactions.forEach((t,i)=>{
                const row=document.createElement('tr');
                row.innerHTML=`
                    <td>${i+1}</td><td>${t.date}</td><td>${t.type==='income'?'ุฏุฑุขูุฏ':'ูุฒูู'}</td><td>${t.category}</td><td>${t.description}</td><td>${t.amount.toLocaleString('fa-IR')}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editTransaction(${t.id})">ูุฑุงุด</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteTransaction(${t.id})">ุญุฐู</button>
                    </td>
                `;tbody.appendChild(row);
            });
        }
        function editTransaction(id){const t=appData.transactions.find(x=>x.id===id);if(!t)return;document.getElementById('transactionType').value=t.type;toggleFinanceCats();document.getElementById('transactionAmount').value=t.amount;document.getElementById('transactionCategory').value=t.category;document.getElementById('transactionDescription').value=t.description;document.getElementById('transactionDate').value=t.date;appData.transactions=appData.transactions.filter(x=>x.id!==id);saveData();displayTransactions();showNotification('ุชุฑุงฺฉูุด ุฏุฑ ุญุงูุช ูุฑุงุด ูุฑุงุฑ ฺฏุฑูุช','info');}
        function deleteTransaction(id){if(confirm('ุชุฑุงฺฉูุด ุญุฐู ุดูุฏุ')){appData.transactions=appData.transactions.filter(x=>x.id!==id);saveData();displayTransactions();showNotification('ุชุฑุงฺฉูุด ุญุฐู ุดุฏ');}}

        /*========== ูุงฺฉุชูุฑ ==========*/
        function loadInvoiceCustomers(){
            const sel=document.getElementById('invoiceCustomerSelect');
            sel.innerHTML='<option value="">-- ุงูุชุฎุงุจ ฺฉูุฏ --</option>';
            appData.customers.forEach(c=>{
                const o=document.createElement('option');o.value=c.phone;o.textContent=`${c.name} (${c.phone})`;sel.appendChild(o);
            });
        }
        function loadInvoiceDrivers(){
            const sel=document.getElementById('invoiceDriverSelect');
            sel.innerHTML='<option value="">-- ุงูุชุฎุงุจ ฺฉูุฏ --</option>';
            appData.workers.filter(w=>w.position==='ุฑุงููุฏู').forEach(w=>{
                const o=document.createElement('option');o.value=w.name;o.textContent=`${w.name} (${w.phone})`;sel.appendChild(o);
            });
        }
        function fillInvoiceCustomer(){
            const phone=document.getElementById('invoiceCustomerSelect').value;
            const c=appData.customers.find(x=>x.phone===phone);
            if(c){document.getElementById('invoiceCustomerName').value=c.name;document.getElementById('invoiceCustomerPhone').value=c.phone;document.getElementById('invoiceCustomerAddress').value=c.address;}
        }
        function addInvoiceProductRow(){
            invoiceProductRowCount++;const row=document.createElement('div');row.className='product-row';row.setAttribute('data-invoice-row',invoiceProductRowCount);
            row.innerHTML=`
                <div class="form-group"><label>ููุน ูุญุตูู</label><select class="invoiceProductType"><option value="ููู ุณูู">ููู ุณูู</option><option value="ูุฑู ููููุช">ูุฑู ููููุช</option><option value="ูพุงูู">ูพุงูู</option><option value="ฺฏูู">ฺฏูู</option><option value="ุณุงุฑ">ุณุงุฑ</option></select></div>
                <div class="form-group"><label>ูุชุฑุงฺ (ูุชุฑ)</label><input type="number" class="invoiceProductMeterage" min="0" step="0.1"></div>
                <div class="form-group"><label>ููุช ู ูุชุฑ (ุชููุงู)</label><input type="number" class="invoiceProductPrice" min="0"></div>
                <div class="form-group"><label>ูุจูุบ ฺฉู</label><input class="invoiceProductTotal" readonly style="background:#f8f9fa;font-weight:bold"></div>
                <button type="button" class="btn btn-danger btn-sm" onclick="removeInvoiceProductRow(${invoiceProductRowCount})">โ</button>
            `;document.getElementById('invoiceProductRowsContainer').appendChild(row);row.querySelector('.invoiceProductMeterage').addEventListener('input',calculateInvoice);row.querySelector('.invoiceProductPrice').addEventListener('input',calculateInvoice);}
        function removeInvoiceProductRow(rowNumber){const row=document.querySelector(`[data-invoice-row="${rowNumber}"]`);if(row){row.remove();calculateInvoice();}}
        function calculateInvoice(){
            let total=0;
            document.querySelectorAll('#invoiceProductRowsContainer .product-row').forEach(row=>{
                const m=parseFloat(row.querySelector('.invoiceProductMeterage').value)||0;
                const p=parseFloat(row.querySelector('.invoiceProductPrice').value)||0;
                const t=m*p;
                row.querySelector('.invoiceProductTotal').value=t.toLocaleString('fa-IR');
                total+=t;
            });
            return total;
        }
        function saveInvoice(){
            const customerName=document.getElementById('invoiceCustomerName').value.trim();
            const customerPhone=document.getElementById('invoiceCustomerPhone').value.trim();
            const customerAddress=document.getElementById('invoiceCustomerAddress').value.trim();
            const driverName=document.getElementById('invoiceDriverSelect').value||document.getElementById('invoiceDriverSelect').nextElementSibling.value;
            const carPlate=document.getElementById('invoiceCarPlate').value.trim();
            const deliveryDate=document.getElementById('invoiceDeliveryDate').value;
            const transportType=document.getElementById('invoiceTransportType').value;
            if(!customerName||!customerPhone||!deliveryDate){showNotification('ููุฏูุง ุณุชุงุฑูโุฏุงุฑ ุฑุง ูพุฑ ฺฉูุฏ','error');return;}
            if(!/^09[0-9]{9}$/.test(customerPhone)){showNotification('ุดูุงุฑู ููุจุงู ูุนุชุจุฑ ูุณุช','error');return;}
            const products=[];
            document.querySelectorAll('#invoiceProductRowsContainer .product-row').forEach(row=>{
                const m=parseFloat(row.querySelector('.invoiceProductMeterage').value)||0;
                const p=parseFloat(row.querySelector('.invoiceProductPrice').value)||0;
                if(m>0&&p>0)products.push({type:row.querySelector('.invoiceProductType').value,meterage:m,price:p,total:m*p});
            });
            const total=calculateInvoice();
            const invoice={id:Date.now(),customerName,customerPhone,customerAddress,driverName,carPlate,deliveryDate,transportType,products,totalAmount:total,date:new Date().toLocaleDateString('fa-IR')};
            appData.invoices.push(invoice);
            appData.transactions.push({id:Date.now(),type:'income',amount:total,category:'ูุฑูุด',description:`ูุงฺฉุชูุฑ ุจู ${customerName}`,date:new Date().toLocaleDateString('fa-IR')});
            saveData();displayInvoices();resetInvoiceForm();showNotification('ูุงฺฉุชูุฑ ุตุงุฏุฑ ุดุฏ');
            autoBackup();
        }
        function resetInvoiceForm(){
            document.getElementById('invoiceCustomerSelect').value='';
            document.getElementById('invoiceCustomerName').value='';
            document.getElementById('invoiceCustomerPhone').value='';
            document.getElementById('invoiceCustomerAddress').value='';
            document.getElementById('invoiceDriverSelect').value='';
            document.getElementById('invoiceCarPlate').value='';
            document.getElementById('invoiceDeliveryDate').value='';
            document.getElementById('invoiceTransportType').value='ุจุง ุฑุงููุฏู';
            invoiceProductRowCount=0;
            document.getElementById('invoiceProductRowsContainer').innerHTML='';
            addInvoiceProductRow();
        }
        function displayInvoices(){
            const tbody=document.getElementById('invoicesTable');tbody.innerHTML='';
            if(appData.invoices.length===0){tbody.innerHTML='<tr><td colspan="7" style="text-align:center;padding:20px">ูุงฺฉุชูุฑ ุตุงุฏุฑ ูุดุฏู ุงุณุช</td></tr>';return;}
            appData.invoices.forEach((inv,i)=>{
                const row=document.createElement('tr');
                row.innerHTML=`
                    <td>${i+1}</td><td>${inv.customerName}</td><td>${inv.driverName}</td><td>${inv.carPlate}</td><td>${inv.deliveryDate}</td><td>${inv.totalAmount.toLocaleString('fa-IR')}</td>
                    <td>
                        <button class="btn btn-info btn-sm" onclick="viewInvoice(${inv.id})">ูุดุงูุฏู</button>
                        <button class="btn btn-primary btn-sm" onclick="printInvoice(${inv.id})">ฺุงูพ</button>
                        <button class="btn btn-info btn-sm" onclick="sendPDF(${inv.id})">PDF + ุงุฑุณุงู</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteInvoice(${inv.id})">ุญุฐู</button>
                    </td>
                `;tbody.appendChild(row);
            });
        }
        function viewInvoice(id){const inv=appData.invoices.find(x=>x.id===id);if(!inv)return;let txt=`ูุดุชุฑ: ${inv.customerName}\nุชูุงุณ: ${inv.customerPhone}\nุฑุงููุฏู: ${inv.driverName}\nูพูุงฺฉ: ${inv.carPlate}\nุชุงุฑุฎ ุงุฑุณุงู: ${inv.deliveryDate}\nููุน ุญูู: ${inv.transportType}\n\nูุญุตููุงุช:\n`;inv.products.forEach((p,i)=>txt+=`${i+1}. ${p.type} - ${p.meterage} ูุชุฑ ร ${p.price.toLocaleString('fa-IR')} = ${p.total.toLocaleString('fa-IR')} ุชููุงู\n`);txt+=`\nุฌูุน ฺฉู: ${inv.totalAmount.toLocaleString('fa-IR')} ุชููุงู`;alert(txt);}
        function printInvoice(id){
            const inv=appData.invoices.find(x=>x.id===id);
            if(!inv){showNotification('ูุงฺฉุชูุฑ ุงูุช ูุดุฏ','error');return;}
            const printWindow=window.open('','printWindow','width=800,height=600');
            printWindow.document.write(`
                <html dir="rtl">
                <head><title>ูุงฺฉุชูุฑ ุงุฑุณุงู</title></head>
                <body style="font-family:Tahoma;font-size:12px;margin:20px;">
                <div style="text-align:center;margin-bottom:20px;">
                    <img src="${appData.settings.logo||''}" style="max-width:80px;opacity:.08;position:absolute;bottom:20px;right:20px;">
                    <h2>${appData.settings.companyName}</h2>
                    <p>ุชุงุฑุฎ: ${inv.date}</p>
                </div>
                <table border="1" style="width:100%;border-collapse:collapse;">
                    <tr><td>ูุงู ูุดุชุฑ</td><td>${inv.customerName}</td><td>ุดูุงุฑู ุชูุงุณ</td><td>${inv.customerPhone}</td></tr>
                    <tr><td>ุขุฏุฑุณ</td><td colspan="3">${inv.customerAddress}</td></tr>
                    <tr><td>ูุงู ุฑุงููุฏู</td><td>${inv.driverName}</td><td>ูพูุงฺฉ ุฎูุฏุฑู</td><td>${inv.carPlate}</td></tr>
                    <tr><td>ุชุงุฑุฎ ุงุฑุณุงู</td><td>${inv.deliveryDate}</td><td>ููุน ุญูู</td><td>${inv.transportType}</td></tr>
                </table>
                <br>
                <table border="1" style="width:100%;border-collapse:collapse;">
                    <thead><tr><th>ุฑุฏู</th><th>ูุญุตูู</th><th>ูุชุฑุงฺ</th><th>ู (ุชููุงู)</th><th>ฺฉู (ุชููุงู)</th></tr></thead>
                    <tbody>
                        ${inv.products.map((p,i)=>`<tr><td>${i+1}</td><td>${p.type}</td><td>${p.meterage}</td><td>${p.price.toLocaleString('fa-IR')}</td><td>${p.total.toLocaleString('fa-IR')}</td></tr>`).join('')}
                    </tbody>
                </table>
                <br>
                <div style="text-align:center;font-weight:bold;">ุฌูุน ฺฉู: ${inv.totalAmount.toLocaleString('fa-IR')} ุชููุงู</div>
                <br>
                <table style="width:100%;">
                    <tr><td style="width:33%;text-align:center;">ุงูุถุง ู ููุฑ ฺฉุงุฑุฎุงูู<br><br><br>______________</td><td style="width:33%;text-align:center;">ุงูุถุง ุฑุงููุฏู<br><br><br>______________</td><td style="width:33%;text-align:center;">ุงูุถุง ุชุญููโฺฏุฑูุฏู<br><br><br>______________</td></tr>
                </table>
                <hr>
                <p style="text-align:center;font-size:10px;">ุขุฏุฑุณ: ${appData.settings.companyAddress} | ุชููู: ${appData.settings.companyPhone}</p>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
            printWindow.close();
        }
        function deleteInvoice(id){if(confirm('ูุงฺฉุชูุฑ ุญุฐู ุดูุฏุ')){appData.invoices=appData.invoices.filter(x=>x.id!==id);saveData();displayInvoices();showNotification('ูุงฺฉุชูุฑ ุญุฐู ุดุฏ');}}

        /*========== ููุจุช ุงุฑุณุงู ==========*/
        function saveDelivery(){
            const customer=document.getElementById('deliveryCustomer').value.trim();
            const date=document.getElementById('deliveryDateInput').value;
            const slot=document.getElementById('deliveryTimeSlot').value;
            if(!customer||!date||!slot){showNotification('ุชูุงู ููุฏูุง ุณุชุงุฑูโุฏุงุฑ ุฑุง ูพุฑ ฺฉูุฏ','error');return;}
            const delivery={id:Date.now(),customer,date,timeSlot:slot,description:document.getElementById('deliveryDescription').value};
            appData.deliveries.push(delivery);
            saveData();displayDeliveries();resetDeliveryForm();showNotification('ููุจุช ุงุฑุณุงู ุซุจุช ุดุฏ');
        }
        function resetDeliveryForm(){document.getElementById('deliveryCustomer').value='';document.getElementById('deliveryDateInput').value='';document.getElementById('deliveryTimeSlot').value='';document.getElementById('deliveryDescription').value='';}
        function displayDeliveries(){
            const tbody=document.getElementById('deliveriesTable');tbody.innerHTML='';
            if(appData.deliveries.length===0){tbody.innerHTML='<tr><td colspan="6" style="text-align:center;padding:20px">ููุจุช ุซุจุช ูุดุฏู ุงุณุช</td></tr>';return;}
            appData.deliveries.forEach((d,i)=>{
                const row=document.createElement('tr');
                row.innerHTML=`
                    <td>${i+1}</td><td>${d.customer}</td><td>${d.date}</td><td>${d.timeSlot}</td><td>${d.description}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editDelivery(${d.id})">ูุฑุงุด</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteDelivery(${d.id})">ุญุฐู</button>
                    </td>
                `;tbody.appendChild(row);
            });
        }
        function editDelivery(id){const d=appData.deliveries.find(x=>x.id===id);if(!d)return;document.getElementById('deliveryCustomer').value=d.customer;document.getElementById('deliveryDateInput').value=d.date;document.getElementById('deliveryTimeSlot').value=d.timeSlot;document.getElementById('deliveryDescription').value=d.description;appData.deliveries=appData.deliveries.filter(x=>x.id!==id);saveData();displayDeliveries();showNotification('ููุจุช ุฏุฑ ุญุงูุช ูุฑุงุด ูุฑุงุฑ ฺฏุฑูุช','info');}
        function deleteDelivery(id){if(confirm('ููุจุช ุญุฐู ุดูุฏุ')){appData.deliveries=appData.deliveries.filter(x=>x.id!==id);saveData();displayDeliveries();showNotification('ููุจุช ุญุฐู ุดุฏ');}}

        /*========== ฺฉุงุฑฺฉูุงู ==========*/
        function saveWorker(){
            const name=document.getElementById('workerName').value.trim();
            const phone=document.getElementById('workerPhone').value.trim();
            if(!name){showNotification('ูุงู ฺฉุงุฑฺฏุฑ ุงูุฒุงู ุงุณุช','error');return;}
            if(phone&&!/^09[0-9]{9}$/.test(phone)){showNotification('ุดูุงุฑู ููุจุงู ูุนุชุจุฑ ูุณุช','error');return;}
            const worker={id:editingId||Date.now(),name,nationalCode:document.getElementById('workerNationalCode').value,phone,position:document.getElementById('workerPosition').value,salary:parseFloat(document.getElementById('workerSalary').value)||0,hireDate:document.getElementById('workerHireDate').value,endDate:document.getElementById('workerEndDate').value};
            if(editingId){const i=appData.workers.findIndex(w=>w.id===editingId);appData.workers[i]=worker;}else{appData.workers.push(worker);}
            saveData();displayWorkers();resetWorkerForm();showNotification('ฺฉุงุฑฺฏุฑ ุซุจุช ุดุฏ');
        }
        function resetWorkerForm(){editingId=null;document.getElementById('workerName').value='';document.getElementById('workerNationalCode').value='';document.getElementById('workerPhone').value='';document.getElementById('workerPosition').value='ฺฉุงุฑฺฏุฑ';document.getElementById('workerSalary').value='';document.getElementById('workerHireDate').value='';document.getElementById('workerEndDate').value='';}
        function displayWorkers(){
            const tbody=document.getElementById('workersTable');tbody.innerHTML='';
            if(appData.workers.length===0){tbody.innerHTML='<tr><td colspan="9" style="text-align:center;padding:20px">ฺฉุงุฑฺฏุฑ ุซุจุช ูุดุฏู ุงุณุช</td></tr>';return;}
            appData.workers.forEach((w,i)=>{
                const row=document.createElement('tr');
                row.innerHTML=`
                    <td>${i+1}</td><td>${w.name}</td><td>${w.nationalCode}</td><td>${w.phone}</td><td>${w.position}</td><td>${w.salary.toLocaleString('fa-IR')}</td><td>${w.hireDate}</td><td>${w.endDate||'--'}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editWorker(${w.id})">ูุฑุงุด</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteWorker(${w.id})">ุญุฐู</button>
                    </td>
                `;tbody.appendChild(row);
            });
        }
        function editWorker(id){const w=appData.workers.find(x=>x.id===id);if(!w)return;editingId=w.id;document.getElementById('workerName').value=w.name;document.getElementById('workerNationalCode').value=w.nationalCode;document.getElementById('workerPhone').value=w.phone;document.getElementById('workerPosition').value=w.position;document.getElementById('workerSalary').value=w.salary;document.getElementById('workerHireDate').value=w.hireDate;document.getElementById('workerEndDate').value=w.endDate;showNotification('ฺฉุงุฑฺฏุฑ ุฏุฑ ุญุงูุช ูุฑุงุด ูุฑุงุฑ ฺฏุฑูุช','info');}
        function deleteWorker(id){if(confirm('ฺฉุงุฑฺฏุฑ ุญุฐู ุดูุฏุ')){appData.workers=appData.workers.filter(x=>x.id!==id);saveData();displayWorkers();showNotification('ฺฉุงุฑฺฏุฑ ุญุฐู ุดุฏ');}}

        /*========== ฺฏุฒุงุฑุดโฺฏุฑ ==========*/
        function loadReportSettings(){}
        function generateReport(){
            const type=document.getElementById('reportType').value;
            const from=document.getElementById('reportFromDate').value;
            const to=document.getElementById('reportToDate').value;
            let html='<h3>ฺฏุฒุงุฑุด '+type+'</h3><p>ุงุฒ '+from+' ุชุง '+to+'</p><table border="1" style="width:100%;text-align:center;"><thead><tr><th>ุฑุฏู</th><th>ูุดุฎุตุงุช</th><th>ูุจูุบ</th></tr></thead><tbody>';
            if(type==='financial'){
                const income=appData.transactions.filter(t=>t.type==='income'&&t.date>=from&&t.date<=to).reduce((s,t)=>s+t.amount,0);
                const expense=appData.transactions.filter(t=>t.type==='expense'&&t.date>=from&&t.date<=to).reduce((s,t)=>s+t.amount,0);
                html+=`<tr><td>1</td><td>ฺฉู ุฏุฑุขูุฏ</td><td>${income.toLocaleString('fa-IR')}</td></tr>`;
                html+=`<tr><td>2</td><td>ฺฉู ูุฒูู</td><td>${expense.toLocaleString('fa-IR')}</td></tr>`;
                html+=`<tr><td>3</td><td>ุณูุฏ ุฎุงูุต</td><td>${(income-expense).toLocaleString('fa-IR')}</td></tr>`;
            }
            html+='</tbody></table>';
            document.getElementById('reportPreview').innerHTML=html;
        }
        function exportReportToExcel(){
            const wb=XLSX.utils.book_new();
            const ws=XLSX.utils.json_to_sheet(appData.transactions);
            XLSX.utils.book_append_sheet(wb,ws,'ฺฏุฒุงุฑุด');
            XLSX.writeFile(wb,`ฺฏุฒุงุฑุด-ุงูุชุฎุงุจ-${new Date().toLocaleDateString('fa-IR')}.xlsx`);
        }
        function exportReportToPDF(){
            const {jsPDF}=window.jspdf;
            const doc=new jsPDF();
            doc.text('ฺฏุฒุงุฑุด ุงูุชุฎุงุจ',10,10);
            doc.text(JSON.stringify(appData.transactions,null,2),10,20);
            doc.save(`ฺฏุฒุงุฑุด-ุงูุชุฎุงุจ-${new Date().toLocaleDateString('fa-IR')}.pdf`);
        }
        function printReport(){
            const printWindow=window.open('','printWindow');
            printWindow.document.write(document.getElementById('reportPreview').innerHTML);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
            printWindow.close();
        }

        /*========== ุชูุธูุงุช ==========*/
        function saveSettings(){
            appData.settings.companyName=document.getElementById('companyName').value;
            appData.settings.companyPhone=document.getElementById('companyPhone').value;
            appData.settings.companyAddress=document.getElementById('companyAddress').value;
            saveData();applyLogo();showNotification('ุชูุธูุงุช ุฐุฎุฑู ุดุฏ');
        }
        function loadSettings(){
            document.getElementById('companyName').value=appData.settings.companyName;
            document.getElementById('companyPhone').value=appData.settings.companyPhone;
            document.getElementById('companyAddress').value=appData.settings.companyAddress;
            if(appData.settings.logo){document.getElementById('logoPreview').src=appData.settings.logo;document.getElementById('logoPreview').style.display='block';}
        }
        function showSystemInfo(){
            alert(`ูุฑฺู ุจุฑูุงูู: ถ.ฐ\nุชุงุฑุฎ ุณุงุฎุช: ฒฐฒต\nุณุงุฒูุฏู: ฺฉูุดโููู\nุญุฌู ุฏุงุฏู: ${JSON.stringify(appData).length} ฺฉุงุฑุงฺฉุชุฑ`);
        }

        /*========== ุชุบุฑ ุฑูุฒ ==========*/
        function changePassword(){
            const current= document.getElementById('currentPassword').value;
            const newPass= document.getElementById('newPassword').value;
            const confirmPass= document.getElementById('confirmNewPassword').value;
            if(btoa(current)!==appData.auth.password){showNotification('ุฑูุฒ ูุนู ุงุดุชุจุงู ุงุณุช','error');return;}
            if(newPass.length<4){showNotification('ุฑูุฒ ุฌุฏุฏ ุญุฏุงูู ด ฺฉุงุฑุงฺฉุชุฑ ุจุงุดุฏ','error');return;}
            if(newPass!==confirmPass){showNotification('ุชฺฉุฑุงุฑ ุฑูุฒ ูุทุงุจูุช ูุฏุงุฑุฏ','error');return;}
            appData.auth.password=btoa(newPass);
            saveData();closeModal('changePasswordModal');showNotification('ุฑูุฒ ุนูุถ ุดุฏ');
        }

        /*========== ุชูุงุจุน ุนููู ==========*/
        function filterTable(tableId,value){
            const rows=document.querySelectorAll(`#${tableId} tr`);
            rows.forEach(r=>{const txt=r.textContent||r.innerText;if(txt.indexOf(value)>-1){r.style.display=''}else{r.style.display='none';}});
        }
        function updateAll(){
            updateDashboard();
            displayContracts();
            displayDeliveries();
            displayCustomers();
            displayWorkers();
            displayTransactions();
            displayChecks();
            displayInvoices();
            updateBackupInfo();
            loadSettings();
        }
        function autoBackup(){
            const blob=new Blob([localStorage.getItem('kaleshiFoamDataV6')],{type:'application/json'});
            const a=document.createElement('a');
            a.href=URL.createObjectURL(blob);
            a.download=`auto-backup-${new Date().toLocaleDateString('fa-IR')}.json`;
            a.click();
        }
        function exportBackup(){
            const blob=new Blob([localStorage.getItem('kaleshiFoamDataV6')],{type:'application/json'});
            const a=document.createElement('a');
            a.href=URL.createObjectURL(blob);
            a.download=`backup-${new Date().toLocaleDateString('fa-IR')}.json`;
            a.click();
            showNotification('ูพุดุชุจุงู ุฏุงูููุฏ ุดุฏ');
        }
        function importBackup(e){
            const file=e.target.files[0];if(!file)return;
            const reader=new FileReader();
            reader.onload=function(ev){
                try{localStorage.setItem('kaleshiFoamDataV6',ev.target.result);location.reload();}catch{showNotification('ูุงู ูุงูุนุชุจุฑ ุงุณุช','error');}
            };
            reader.readAsText(file);
        }
        function exportToExcel(){
            const wb=XLSX.utils.book_new();
            const ws1=XLSX.utils.json_to_sheet(appData.contracts);
            const ws2=XLSX.utils.json_to_sheet(appData.customers);
            const ws3=XLSX.utils.json_to_sheet(appData.workers);
            const ws4=XLSX.utils.json_to_sheet(appData.transactions);
            const ws5=XLSX.utils.json_to_sheet(appData.checks);
            XLSX.utils.book_append_sheet(wb,ws1,'ูุฑุงุฑุฏุงุฏูุง');
            XLSX.utils.book_append_sheet(wb,ws2,'ูุดุชุฑุงู');
            XLSX.utils.book_append_sheet(wb,ws3,'ฺฉุงุฑฺฉูุงู');
            XLSX.utils.book_append_sheet(wb,ws4,'ุชุฑุงฺฉูุดโูุง');
            XLSX.utils.book_append_sheet(wb,ws5,'ฺฺฉโูุง');
            XLSX.writeFile(wb,`ฺฏุฒุงุฑุด-ฺฉุงูู-${new Date().toLocaleDateString('fa-IR')}.xlsx');
        }
        function exportToPDF(){
            const {jsPDF}=window.jspdf;
            const doc=new jsPDF();
            doc.text('ฺฏุฒุงุฑุด ฺฉุงูู',10,10);
            doc.text(JSON.stringify(appData,null,2),10,20);
            doc.save(`ฺฏุฒุงุฑุด-ฺฉุงูู-${new Date().toLocaleDateString('fa-IR')}.pdf`);
        }
        function updateBackupInfo(){document.getElementById('lastBackupDate').textContent=localStorage.getItem('lastBackup')||'ูฺ';}

        /*========== ฺุงูพ ู PDF ==========*/
        function printThermal(id){
            const c=appData.contracts.find(x=>x.id===id);
            if(!c){showNotification('ูุฑุงุฑุฏุงุฏ ุงูุช ูุดุฏ','error');return;}
            const printWindow=window.open('','printWindow','width=80,height=400');
            printWindow.document.write(`
                <html dir="rtl">
                <head><title>ูุงฺฉุชูุฑ ุญุฑุงุฑุช</title></head>
                <body style="font-family:Tahoma;font-size:10px;width:80mm;margin:0 auto;">
                <div style="text-align:center;margin-bottom:10px;">
                    <img src="${appData.settings.logo||''}" style="max-width:50px;opacity:0.1;position:absolute;bottom:10px;right:10px;">
                    <h3>${appData.settings.companyName}</h3>
                    <p>ุชุงุฑุฎ: ${c.date}</p>
                </div>
                <hr>
                <p>ูุดุชุฑ: ${c.customer} | ุชููู: ${c.phone}</p>
                <hr>
                <table style="width:100%;font-size:10px;">
                    <thead><tr><th>ุฑุฏู</th><th>ูุญุตูู</th><th>ูุชุฑุงฺ</th><th>ู</th><th>ฺฉู</th></tr></thead>
                    <tbody>
                        ${c.products.map((p,i)=>`<tr><td>${i+1}</td><td>${p.type}</td><td>${p.meterage}</td><td>${p.price.toLocaleString('fa-IR')}</td><td>${p.total.toLocaleString('fa-IR')}</td></tr>`).join('')}
                    </tbody>
                </table>
                <hr>
                <p>ุฌูุน ฺฉู: ${c.totalAmount.toLocaleString('fa-IR')} ุชููุงู</p>
                <p>ููุฏ: ${c.advance.toLocaleString('fa-IR')} ุชููุงู</p>
                <p>ฺฺฉ: ${c.checkAmount.toLocaleString('fa-IR')} ุชููุงู</p>
                <p style="font-weight:bold;color:${c.balance>0?'green':c.balance<0?'red':'orange'};">ูุงูุฏู: ${c.balance.toLocaleString('fa-IR')} ุชููุงู</p>
                <hr>
                <p style="text-align:center;font-size:8px;">ุขุฏุฑุณ: ${appData.settings.companyAddress} | ุชููู: ${appData.settings.companyPhone}</p>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
            printWindow.close();
        }
        function sendPDF(type,id){
            const {jsPDF}=window.jspdf;
            const doc=new jsPDF({orientation:'p',unit:'mm',format:'a4'});
            doc.setFont('Tahoma');
            doc.addImage(appData.settings.logo||'', 'PNG', 170, 10, 30, 30, undefined, 'FAST');
            doc.text(appData.settings.companyName, 10, 20);
            if(type==='contract'){
                const c=appData.contracts.find(x=>x.id===id);
                if(!c){showNotification('ูุฑุงุฑุฏุงุฏ ุงูุช ูุดุฏ','error');return;}
                doc.text(`ุชุงุฑุฎ: ${c.date}`, 10, 30);
                doc.text(`ูุดุชุฑ: ${c.customer}`, 10, 40);
                doc.text(`ุชููู: ${c.phone}`, 10, 50);
                doc.text(`ุขุฏุฑุณ: ${c.address}`, 10, 60);
                doc.autoTable({
                    head:[['ุฑุฏู','ูุญุตูู','ูุชุฑุงฺ','ู (ุชููุงู)','ฺฉู (ุชููุงู)']],
                    body:c.products.map((p,i)=>[i+1,p.type,p.meterage,p.price.toLocaleString('fa-IR'),p.total.toLocaleString('fa-IR')]),
                    startY:70,
                    theme:'grid',
                    styles:{font:'Tahoma',halign:'right'}
                });
                const finalY=doc.lastAutoTable.finalY+10;
                doc.text(`ุฌูุน ฺฉู: ${c.totalAmount.toLocaleString('fa-IR')} ุชููุงู`, 10, finalY);
                doc.text(`ููุฏ: ${c.advance.toLocaleString('fa-IR')} ุชููุงู`, 10, finalY+10);
                doc.text(`ฺฺฉ: ${c.checkAmount.toLocaleString('fa-IR')} ุชููุงู`, 10, finalY+20);
                doc.text(`ูุงูุฏู: ${c.balance.toLocaleString('fa-IR')} ุชููุงู`, 10, finalY+30);
            }else if(type==='invoice'){
                const inv=appData.invoices.find(x=>x.id===id);
                if(!inv){showNotification('ูุงฺฉุชูุฑ ุงูุช ูุดุฏ','error');return;}
                doc.text(`ุชุงุฑุฎ: ${inv.date}`, 10, 30);
                doc.text(`ูุดุชุฑ: ${inv.customerName}`, 10, 40);
                doc.text(`ุชููู: ${inv.customerPhone}`, 10, 50);
                doc.text(`ุขุฏุฑุณ: ${inv.customerAddress}`, 10, 60);
                doc.autoTable({
                    head:[['ุฑุฏู','ูุญุตูู','ูุชุฑุงฺ','ู (ุชููุงู)','ฺฉู (ุชููุงู)']],
                    body:inv.products.map((p,i)=>[i+1,p.type,p.meterage,p.price.toLocaleString('fa-IR'),p.total.toLocaleString('fa-IR')]),
                    startY:70,
                    theme:'grid',
                    styles:{font:'Tahoma',halign:'right'}
                });
                const finalY=doc.lastAutoTable.finalY+10;
                doc.text(`ุฌูุน ฺฉู: ${inv.totalAmount.toLocaleString('fa-IR')} ุชููุงู`, 10, finalY);
            }
            const pdfBlob=doc.output('blob');
            const url=URL.createObjectURL(pdfBlob);
            const a=document.createElement('a');
            a.href=url;
            a.download=`${type}-${type==='contract'?appData.contracts.find(x=>x.id===id).customer:appData.invoices.find(x=>x.id===id).customerName}-${new Date().toLocaleDateString('fa-IR')}.pdf`;
            a.click();
            showNotification('PDF ุงุฌุงุฏ ุดุฏ. ุจุฑุง ุงุฑุณุงู ูุงุชุณุงูพ/ุชูฺฏุฑุงูุ ูุงู ุฑุง ุงุฒ ูพูุดู ุฏุงูููุฏ ุงูุชุฎุงุจ ฺฉูุฏ.');
        }

        /*========== ุดุฑูุน ุจุฑูุงูู ==========*/
        window.onload=()=>{
            // ููุงุด ููฺฏู ุตูุญู ูุฑูุฏ ุฏุฑ ุตูุฑุช ูุฌูุฏ
            const loginUpload=document.getElementById('loginLogoUpload');
            loginUpload.addEventListener('change',function(){
                const file=this.files[0];
                if(file){
                    const reader=new FileReader();
                    reader.onload=function(ev){
                        document.getElementById('loginLogoPreview').src=ev.target.result;
                        document.getElementById('loginLogoPreview').style.display='block';
                    };
                    reader.readAsDataURL(file);
                }
            });
            // ุชูุธู ุชุงุฑุฎโูุง ูพุดโูุฑุถ
            const today=new Date().toISOString().split('T')[0];
            document.querySelectorAll('input[type=date]').forEach(inp=>{
                if(!inp.value)inp.value=today;
            });
            // ุงุฌุฑุง ุชูุงุจุน ุงููู
            initDatepickers();
            addProductRow();
            addCheckRow();
            calculateContract();
        };
        function initDatepickers(){
            const today=new Date().toISOString().split('T')[0];
            document.querySelectorAll('input[type=date]').forEach(inp=>{
                if(!inp.value)inp.value=today;
            });
        }
    </script>
</body>
</html>
