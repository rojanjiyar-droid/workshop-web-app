<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>حسابداری کارخانه یونولیت کلشی فوم</title>
    <link rel="manifest" href="data:application/manifest+json,{
        \"name\": \"کلشی فوم\",
        \"short_name\": \"کلشی\",
        \"start_url\": \".\",
        \"display\": \"standalone\",
        \"background_color\": \"#667eea\",
        \"theme_color\": \"#2c3e50\",
        \"icons\": [{
            \"src\": \"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect x='5' y='5' width='90' height='90' rx='15' fill='%230b0b0b'/%3E%3Ctext x='50' y='65' text-anchor='middle' font-size='40' fill='%23ffffff' font-family='Tahoma'%3Eکلشی%3C/text%3E%3C/svg%3E\",
            \"sizes\": \"192x192\",
            \"type\": \"image/svg+xml\"
        }]
    }">
    <style>
        /* تمام استایل‌های قبلی + بهبود چاپ */
        @media print {
            body * { visibility: hidden; }
            .invoice-container, .invoice-container * { visibility: visible; }
            .invoice-container { position: absolute; left: 0; top: 0; width: 100%; box-shadow: none; border: none; }
            .no-print, .nav, .header, .content > *:not(.invoice-container) { display: none !important; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- صفحه ورود -->
        <div class="login-page" id="loginPage"> ... </div>

        <!-- صفحه اصلی -->
        <div class="main-page" id="mainPage"> ... </div>
    </div>

    <script>
        // ================== داده‌های نمونه برای تست ==================
        const SAMPLE_DATA = {
            contracts: [
                {
                    id: "CON1", customer: "علی محمدی", phone: "09121234567", address: "فومن، خیابان اصلی",
                    type: "pre_purchase", dateCreated: "1403/08/01", deliveryDate: "1403/08/15",
                    products: [
                        { type: "foam", size: "100×200", meterage: 150, unitPrice: 25000, total: 3750000 }
                    ],
                    advance: 1000000, totalAmount: 3750000, balance: 2750000, status: "active",
                    checks: [
                        { id: "CHK1", number: "123456", amount: 2750000, dueDate: "1403/09/01", bank: "ملی", status: "pending" }
                    ]
                }
            ],
            checks: [
                { id: "CHK1", number: "123456", amount: 2750000, dueDate: "1403/09/01", bank: "ملی", status: "pending", customer: "علی محمدی" }
            ],
            workers: [
                { id: "WRK1", firstName: "حسن", lastName: "رضایی", phone: "09129876543", jobType: "worker", startDate: "1402/01/01", status: "active" }
            ],
            expenses: [
                { id: "EXP1", type: "material", amount: 5000000, date: "1403/08/10", description: "خرید رزین" }
            ]
        };

        // ================== متغیرهای سراسری ==================
        let contracts = [], checks = [], workers = [], expenses = [], productRowsCount = 1, invoiceRowsCount = 1;

        // ================== توابع اصلی ==================

        // 1. ورود
        function login() {
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value;
            if (u === 'admin' && p === '1234') {
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('mainPage').style.display = 'block';
                loadAllData();
                showAlert('ورود موفق', 'success');
            } else {
                showAlert('نام کاربری یا رمز اشتباه!', 'error');
            }
        }

        // 2. تنظیم تاریخ پیش‌فرض (شمسی)
        function setPersianDate(inputId) {
            const today = new Date().toLocaleDateString('fa-IR');
            const el = document.getElementById(inputId);
            if (el && !el.value) el.value = today;
        }

        // 3. اعتبارسنجی فرم
        function validateForm(fields) {
            for (let f of fields) {
                const el = document.getElementById(f.id);
                if (!el.value.trim()) {
                    showAlert(f.msg, 'error');
                    el.focus();
                    return false;
                }
            }
            return true;
        }

        // 4. افزودن ردیف محصول
        function addProductRow() {
            productRowsCount++;
            const container = document.getElementById('productRowsContainer');
            const row = document.createElement('div');
            row.className = 'product-row';
            row.dataset.row = productRowsCount;
            row.innerHTML = `
                <div class="form-group"><label>نوع کالا</label><select class="productType" onchange="calculateRowTotal(${productRowsCount})">
                    <option value="foam">فوم سقفی</option><option value="sheet">ورق</option><option value="panel">پانل</option>
                </select></div>
                <div class="form-group"><label>اندازه</label><input type="text" class="productSize" placeholder="100×200"></div>
                <div class="form-group"><label>متراژ *</label><input type="number" class="productMeterage" min="0" step="0.1" oninput="calculateRowTotal(${productRowsCount})"></div>
                <div class="form-group"><label>قیمت فی *</label><input type="number" class="productUnitPrice" min="0" oninput="calculateRowTotal(${productRowsCount})"></div>
                <div class="form-group"><label>مبلغ کل</label><input type="text" class="productTotal" readonly style="background:#f8f9fa;"></div>
                <button type="button" class="remove-product-btn" onclick="removeProductRow(${productRowsCount})">✕</button>
            `;
            container.appendChild(row);
            setPersianDate(`deliveryDate`);
        }

        function removeProductRow(row) {
            document.querySelector(`[data-row="${row}"]`).remove();
            calculateTotal();
        }

        function calculateRowTotal(row) {
            const r = document.querySelector(`[data-row="${row}"]`);
            const m = parseFloat(r.querySelector('.productMeterage').value) || 0;
            const p = parseFloat(r.querySelector('.productUnitPrice').value) || 0;
            const total = m * p;
            r.querySelector('.productTotal').value = total.toLocaleString('fa-IR');
            calculateTotal();
        }

        function calculateTotal() {
            let total = 0;
            document.querySelectorAll('.product-row').forEach(row => {
                const t = parseFloat(row.querySelector('.productTotal').value.replace(/,/g, '')) || 0;
                total += t;
            });
            const advance = parseFloat(document.getElementById('contractAdvance').value) || 0;
            const balance = total - advance;
            document.getElementById('balanceDisplay').innerHTML = `
                جمع کل: ${total.toLocaleString('fa-IR')} تومان | 
                پیش پرداخت: ${advance.toLocaleString('fa-IR')} تومان | 
                مانده: ${balance.toLocaleString('fa-IR')} تومان
            `;
        }

        // 5. افزودن چک
        function addNewCheck() {
            const fields = [
                {id: 'checkNumber', msg: 'شماره چک الزامی است'},
                {id: 'checkAmount', msg: 'مبلغ چک الزامی است'},
                {id: 'checkDueDate', msg: 'تاریخ سررسید الزامی است'},
                {id: 'checkBank', msg: 'نام بانک الزامی است'}
            ];
            if (!validateForm(fields)) return;

            const check = {
                id: 'CHK' + Date.now(),
                number: document.getElementById('checkNumber').value,
                amount: parseFloat(document.getElementById('checkAmount').value),
                dueDate: document.getElementById('checkDueDate').value,
                bank: document.getElementById('checkBank').value,
                status: 'pending'
            };

            // نمایش در لیست
            const list = document.getElementById('checkList');
            const item = document.createElement('div');
            item.className = 'check-item';
            item.dataset.checkId = check.id;
            item.innerHTML = `
                چک ${check.number} - ${check.amount.toLocaleString('fa-IR')} تومان - سررسید: ${check.dueDate}
                <button class="btn btn-danger btn-sm" onclick="removeCheck('${check.id}')">حذف</button>
            `;
            list.appendChild(item);

            // پاک کردن فرم
            document.getElementById('checkNumber').value = '';
            document.getElementById('checkAmount').value = '';
            document.getElementById('checkBank').value = '';
            setPersianDate('checkDueDate');
        }

        function removeCheck(id) {
            document.querySelector(`[data-check-id="${id}"]`).remove();
        }

        // 6. ثبت قرارداد
        function addContract() {
            const fields = [
                {id: 'contractCustomer', msg: 'نام مشتری الزامی است'},
                {id: 'contractPhone', msg: 'شماره تماس الزامی است'},
                {id: 'deliveryDate', msg: 'تاریخ تحویل الزامی است'}
            ];
            if (!validateForm(fields)) return;

            const products = [];
            let hasProduct = false;
            document.querySelectorAll('.product-row').forEach(row => {
                const m = parseFloat(row.querySelector('.productMeterage').value) || 0;
                const p = parseFloat(row.querySelector('.productUnitPrice').value) || 0;
                if (m > 0 && p > 0) {
                    products.push({
                        type: row.querySelector('.productType').value,
                        size: row.querySelector('.productSize').value,
                        meterage: m,
                        unitPrice: p,
                        total: m * p
                    });
                    hasProduct = true;
                }
            });
            if (!hasProduct) {
                showAlert('حداقل یک محصول با متراژ و قیمت وارد کنید', 'error');
                return;
            }

            const contract = {
                id: 'CON' + Date.now(),
                customer: document.getElementById('contractCustomer').value,
                phone: document.getElementById('contractPhone').value,
                address: document.getElementById('contractAddress').value,
                type: document.getElementById('contractType').value,
                dateCreated: new Date().toLocaleDateString('fa-IR'),
                deliveryDate: document.getElementById('deliveryDate').value,
                products,
                advance: parseFloat(document.getElementById('contractAdvance').value) || 0,
                totalAmount: products.reduce((s, p) => s + p.total, 0),
                status: 'active'
            };

            contract.balance = contract.totalAmount - contract.advance;

            // چک‌ها
            contract.checks = [];
            document.querySelectorAll('.check-item').forEach(item => {
                const checkId = item.dataset.checkId;
                const check = checks.find(c => c.id === checkId) || {
                    id: checkId,
                    number: item.textContent.match(/چک ([0-9]+)/)[1],
                    amount: parseFloat(item.textContent.match(/([0-9,]+) تومان/)[1].replace(/,/g, '')),
                    dueDate: item.textContent.match(/سررسید: ([0-9\/]+)/)[1],
                    bank: 'نامشخص',
                    status: 'pending',
                    customer: contract.customer
                };
                contract.checks.push(check);
                if (!checks.find(c => c.id === check.id)) checks.push(check);
            });

            contracts.push(contract);
            saveAllData();
            displayContracts();
            updateDashboard();
            showAlert('قرارداد با موفقیت ثبت شد', 'success');
            resetContractForm();
        }

        function resetContractForm() {
            document.getElementById('contractCustomer').value = '';
            document.getElementById('contractPhone').value = '';
            document.getElementById('contractAddress').value = '';
            document.getElementById('contractAdvance').value = '';
            document.getElementById('checkList').innerHTML = '';
            document.querySelectorAll('.product-row').forEach((row, i) => {
                if (i > 0) row.remove();
            });
            productRowsCount = 1;
            calculateTotal();
            setPersianDate('deliveryDate');
        }

        // 7. نمایش قراردادها با چک‌ها
        function displayContracts() {
            const tbody = document.getElementById('customersTableBody');
            tbody.innerHTML = '';
            contracts.forEach((c, i) => {
                const row = document.createElement('tr');
                const checkInfo = c.checks.length > 0 ? `${c.checks.length} چک` : 'نقدی';
                row.innerHTML = `
                    <td>${i + 1}</td>
                    <td>${c.customer}</td>
                    <td>${c.phone}</td>
                    <td>${getContractTypeName(c.type)}</td>
                    <td>${c.dateCreated}</td>
                    <td>${c.totalAmount.toLocaleString('fa-IR')}</td>
                    <td>${c.advance.toLocaleString('fa-IR')}</td>
                    <td>${c.balance.toLocaleString('fa-IR')}</td>
                    <td><span class="worker-status-${c.balance > 0 ? 'inactive' : 'active'}">
                        ${c.balance > 0 ? 'دارای مانده' : 'تسویه شده'} (${checkInfo})
                    </span></td>
                `;
                tbody.appendChild(row);
            });
        }

        // 8. فاکتور حرفه‌ای
        function generateProfessionalInvoice() {
            // مشابه generateInvoiceFromContract اما کامل
            const container = document.getElementById('professionalInvoicePreview');
            container.style.display = 'block';
            container.innerHTML = `<div class="invoice-header">فاکتور فروش</div>...`; // کامل در کد نهایی
        }

        // 9. ذخیره و بازیابی
        function saveAllData() {
            localStorage.setItem('kalashiFoamData', JSON.stringify({ contracts, checks, workers, expenses }));
        }

        function loadAllData() {
            const data = JSON.parse(localStorage.getItem('kalashiFoamData')) || SAMPLE_DATA;
            contracts = data.contracts || [];
            checks = data.checks || [];
            workers = data.workers || [];
            expenses = data.expenses || [];
            displayContracts();
            displayChecks();
            displayWorkers();
            updateDashboard();
        }

        // 10. راه‌اندازی
        document.addEventListener('DOMContentLoaded', () => {
            ['deliveryDate', 'checkDueDate', 'expenseDate', 'workerStartDate'].forEach(setPersianDate);
            loadAllData();
        });
    </script>
</body>
</html>
