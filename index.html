<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>حسابداری کارخانه یونولیت کلشی فوم</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
    <style>
        * { font-family: 'Vazirmatn', Tahoma, sans-serif; }
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container { max-width: 1400px; }
        .login-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            max-width: 420px;
            margin: 60px auto;
        }
        .logo {
            width: 130px;
            height: 130px;
            object-fit: cover;
            border-radius: 15px;
            border: 4px solid #3498db;
            margin-bottom: 20px;
        }
        .main-card {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            margin-bottom: 30px;
        }
        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .nav-tabs .nav-link {
            color: white;
            border: none;
            padding: 15px 20px;
            font-weight: 500;
        }
        .nav-tabs .nav-link.active {
            background: #2980b9;
            border-bottom: 4px solid #e74c3c;
        }
        .watermark {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) rotate(-30deg);
            font-size: 90px;
            color: rgba(0,0,0,0.05);
            font-weight: bold;
            pointer-events: none;
            z-index: 0;
            white-space: nowrap;
        }
        .tab-pane { position: relative; }
        .form-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            border-right: 5px solid #3498db;
        }
        .product-row {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            display: grid;
            grid-template-columns: 2fr 1.5fr 1fr 1fr 1fr auto;
            gap: 10px;
            align-items: end;
        }
        .add-btn {
            background: #3498db;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            font-size: 18px;
        }
        .remove-btn {
            background: #e74c3c;
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 16px;
        }
        .balance-display {
            background: #e8f4fd;
            padding: 18px;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            font-size: 20px;
            color: #2c3e50;
            margin: 15px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            transition: transform 0.3s;
        }
        .stat-card:hover { transform: translateY(-5px); }
        .invoice-container {
            background: white;
            padding: 40px;
            border: 2px solid #333;
            border-radius: 15px;
            max-width: 900px;
            margin: 30px auto;
            box-shadow: 0 0 25px rgba(0,0,0,0.15);
        }
        .factory-stamp {
            border: 3px dashed #333;
            padding: 25px;
            text-align: center;
            font-weight: bold;
            font-size: 20px;
            border-radius: 12px;
        }
        @media (max-width: 768px) {
            .product-row { grid-template-columns: 1fr; }
            .watermark { font-size: 50px; }
        }
        @media print {
            body * { visibility: hidden; }
            .invoice-container, .invoice-container * { visibility: visible; }
            .invoice-container { position: absolute; left: 0; top: 0; width: 100%; box-shadow: none; border: none; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>
    <div class="container">

        <!-- صفحه ورود -->
        <div id="loginPage" class="login-card text-center">
            <img src="logo.jpg" alt="لوگو" class="logo mx-auto d-block">
            <h2 class="mb-4">کارخانه یونولیت کلشی فوم</h2>
            <div class="mb-3">
                <input type="text" id="username" class="form-control form-control-lg" placeholder="نام کاربری" value="admin">
            </div>
            <div class="mb-4">
                <input type="password" id="password" class="form-control form-control-lg" placeholder="رمز عبور" value="1234">
            </div>
            <button class="btn btn-success btn-lg w-100" onclick="login()">ورود به سیستم</button>
        </div>

        <!-- صفحه اصلی -->
        <div id="mainPage" class="main-card" style="display: none;">
            <div class="header">
                <div class="d-flex align-items-center gap-3">
                    <img src="logo.jpg" alt="لوگو" width="55" height="55" class="rounded">
                    <h4 class="mb-0">حسابداری کلشی فوم</h4>
                </div>
                <div>
                    <span id="currentUser" class="me-3">مدیر سیستم</span>
                    <button class="btn btn-warning btn-sm" onclick="logout()">خروج</button>
                </div>
            </div>

            <ul class="nav nav-tabs" id="myTab">
                <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#dashboard">داشبورد</a></li>
                <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#contracts">قرارداد جدید</a></li>
                <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#invoices">فاکتورها</a></li>
                <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#expenses">هزینه‌ها</a></li>
                <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#reports">گزارش‌ها</a></li>
            </ul>

            <div class="tab-content p-4">
                <div class="watermark">کلشی فوم</div>

                <!-- داشبورد -->
                <div class="tab-pane fade show active" id="dashboard">
                    <div class="row g-4 mb-4">
                        <div class="col-md-3"><div class="stat-card"><div class="display-6" id="totalIncome">۰</div><small>کل درآمد</small></div></div>
                        <div class="col-md-3"><div class="stat-card"><div class="display-6" id="totalExpenses">۰</div><small>کل هزینه</small></div></div>
                        <div class="col-md-3"><div class="stat-card"><div class="display-6" id="activeContracts">۰</div><small>قرارداد فعال</small></div></div>
                        <div class="col-md-3"><div class="stat-card"><div class="display-6" id="dueChecks">۰</div><small>چک سررسید</small></div></div>
                    </div>
                    <div class="alert alert-warning">هشدار: ۳ چک تا فردا سررسید می‌شوند</div>
                </div>

                <!-- قراردادها -->
                <div class="tab-pane fade" id="contracts">
                    <div class="form-section">
                        <h4>ثبت قرارداد جدید</h4>
                        <div class="row g-3 mb-3">
                            <div class="col-md-4"><input type="text" id="contractCustomer" class="form-control" placeholder="نام مشتری"></div>
                            <div class="col-md-4"><input type="tel" id="contractPhone" class="form-control" placeholder="تلفن"></div>
                            <div class="col-md-4"><input type="text" id="contractAddress" class="form-control" placeholder="آدرس"></div>
                        </div>

                        <div id="productRows">
                            <div class="product-row">
                                <div><select class="form-select" onchange="updateProductTypes(this)">
                                    <option value="فوم سقفی">فوم سقفی</option>
                                    <option value="ورق">ورق</option>
                                </select></div>
                                <div><input type="text" class="form-control" placeholder="اندازه (مثل 100x200)" oninput="calculateRow(this)"></div>
                                <div><input type="number" class="form-control" placeholder="متراژ" oninput="calculateRow(this)"></div>
                                <div><input type="number" class="form-control" placeholder="قیمت فی" oninput="calculateRow(this)"></div>
                                <div><input type="number" class="form-control" placeholder="جمع ردیف" readonly></div>
                                <div><button class="remove-btn" onclick="removeRow(this)" title="حذف"><i class="bi bi-trash"></i></button></div>
                            </div>
                        </div>

                        <button class="btn btn-primary add-btn" onclick="addProductRow()">+</button>

                        <div class="row mt-3">
                            <div class="col-md-6"><input type="number" id="contractAdvance" class="form-control" placeholder="پیش‌پرداخت" oninput="updateTotal()"></div>
                            <div class="col-md-6"><select id="paymentType" class="form-select" onchange="toggleChecks()"><option value="cash">نقدی</option><option value="check">چک</option></select></div>
                        </div>

                        <div id="checkSection" class="mt-3" style="display:none;">
                            <div class="border p-3 rounded bg-light">
                                <div class="row g-2" id="checkInputs"></div>
                                <button class="btn btn-success btn-sm mt-2" onclick="addCheck()">افزودن چک</button>
                            </div>
                        </div>

                        <div class="balance-display" id="totalDisplay">جمع کل: ۰ تومان | مانده: ۰ تومان</div>

                        <div class="text-end mt-3">
                            <button class="btn btn-success me-2" onclick="saveContract()">ثبت قرارداد</button>
                            <button class="btn btn-info" onclick="generateInvoiceFromForm()">صدور فاکتور</button>
                        </div>
                    </div>
                </div>

                <!-- فاکتورها -->
                <div class="tab-pane fade" id="invoices">
                    <div class="form-section">
                        <select id="invoiceContract" class="form-select mb-3"></select>
                        <button class="btn btn-success me-2" onclick="generateInvoice()">ایجاد فاکتور</button>
                        <button class="btn btn-primary" onclick="printInvoice()">چاپ</button>
                        <button class="btn btn-warning ms-2" onclick="saveAsPDF()">PDF</button>
                    </div>
                    <div id="invoicePreview"></div>
                </div>

                <!-- هزینه‌ها -->
                <div class="tab-pane fade" id="expenses">
                    <div class="form-section">
                        <div class="row g-3">
                            <div class="col-md-5"><select id="expenseType" class="form-select"><option>مواد اولیه</option><option>جرثقیل</option><option>حقوق</option><option>حمل</option><option>سایر</option></select></div>
                            <div class="col-md-4"><input type="number" id="expenseAmount" class="form-control" placeholder="مبلغ"></div>
                            <div class="col-md-3"><button class="btn btn-success w-100" onclick="addExpense()">ثبت</button></div>
                        </div>
                    </div>
                </div>

                <!-- گزارش‌ها -->
                <div class="tab-pane fade" id="reports">
                    <div class="form-section text-center">
                        <button class="btn btn-success btn-lg" onclick="alert('گزارش تولید شد!')">تولید گزارش</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // داده‌ها
        let contracts = JSON.parse(localStorage.getItem('contracts')) || [];
        let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
        let productTypes = ["فوم سقفی", "ورق"];

        // ورود
        function login() {
            if (document.getElementById('username').value === 'admin' && document.getElementById('password').value === '1234') {
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('mainPage').style.display = 'block';
                loadData();
            } else alert('اطلاعات ورود اشتباه است!');
        }

        function logout() {
            document.getElementById('loginPage').style.display = 'block';
            document.getElementById('mainPage').style.display = 'none';
        }

        // ردیف کالا
        function addProductRow() {
            const container = document.getElementById('productRows');
            const row = document.createElement('div');
            row.className = 'product-row';
            row.innerHTML = `
                <div><select class="form-select" onchange="updateProductTypes(this)">${productTypes.map(t => `<option>${t}</option>`).join('')}</select></div>
                <div><input type="text" class="form-control" placeholder="اندازه" oninput="calculateRow(this)"></div>
                <div><input type="number" class="form-control" placeholder="متراژ" oninput="calculateRow(this)"></div>
                <div><input type="number" class="form-control" placeholder="قیمت فی" oninput="calculateRow(this)"></div>
                <div><input type="number" class="form-control" placeholder="جمع ردیف" readonly></div>
                <div><button class="remove-btn" onclick="removeRow(this)" title="حذف"><i class="bi bi-trash"></i></button></div>
            `;
            container.appendChild(row);
            updateTotal();
        }

        function removeRow(btn) {
            btn.closest('.product-row').remove();
            updateTotal();
        }

        function calculateRow(input) {
            const row = input.closest('.product-row');
            const meterage = parseFloat(row.children[2].querySelector('input').value) || 0;
            const unitPrice = parseFloat(row.children[3].querySelector('input').value) || 0;
            const total = meterage * unitPrice;
            row.children[4].querySelector('input').value = total;
            updateTotal();
        }

        function updateTotal() {
            let total = 0;
            document.querySelectorAll('.product-row').forEach(row => {
                const rowTotal = parseFloat(row.children[4].querySelector('input').value) || 0;
                total += rowTotal;
            });
            const advance = parseFloat(document.getElementById('contractAdvance').value) || 0;
            const remaining = total - advance;
            document.getElementById('totalDisplay').textContent = `جمع کل: ${total.toLocaleString()} تومان | مانده: ${remaining.toLocaleString()} تومان`;
        }

        function toggleChecks() {
            document.getElementById('checkSection').style.display = document.getElementById('paymentType').value === 'check' ? 'block' : 'none';
        }

        function addCheck() {
            const container = document.getElementById('checkInputs');
            const div = document.createElement('div');
            div.className = 'row g-2 mb-2';
            div.innerHTML = `
                <div class="col"><input type="number" class="form-control" placeholder="مبلغ چک"></div>
                <div class="col"><input type="text" class="form-control" placeholder="سررسید (1404/08/20)"></div>
                <div class="col"><input type="text" class="form-control" placeholder="بانک"></div>
                <div class="col-auto"><button class="btn btn-danger btn-sm" onclick="this.parentElement.parentElement.remove()">حذف</button></div>
            `;
            container.appendChild(div);
        }

        function saveContract() {
            const products = [];
            document.querySelectorAll('.product-row').forEach(row => {
                products.push({
                    type: row.children[0].querySelector('select').value,
                    size: row.children[1].querySelector('input').value,
                    meterage: parseFloat(row.children[2].querySelector('input').value) || 0,
                    unitPrice: parseFloat(row.children[3].querySelector('input').value) || 0,
                    total: parseFloat(row.children[4].querySelector('input').value) || 0
                });
            });

            const total = products.reduce((s, p) => s + p.total, 0);
            const advance = parseFloat(document.getElementById('contractAdvance').value) || 0;

            const contract = {
                id: Date.now(),
                customer: document.getElementById('contractCustomer').value,
                phone: document.getElementById('contractPhone').value,
                address: document.getElementById('contractAddress').value,
                products: products,
                totalAmount: total,
                advance: advance,
                remaining: total - advance,
                paymentType: document.getElementById('paymentType').value,
                checks: [],
                date: new Date().toLocaleDateString('fa-IR')
            };

            if (contract.paymentType === 'check') {
                document.querySelectorAll('#checkInputs .row').forEach(r => {
                    const inputs = r.querySelectorAll('input');
                    if (inputs[0].value) {
                        contract.checks.push({
                            amount: parseFloat(inputs[0].value),
                            dueDate: inputs[1].value,
                            bank: inputs[2].value
                        });
                    }
                });
            }

            contracts.push(contract);
            localStorage.setItem('contracts', JSON.stringify(contracts));
            alert('قرارداد با موفقیت ثبت شد!');
            loadDashboard();
            loadInvoiceSelect();
        }

        function loadData() {
            loadDashboard();
            loadInvoiceSelect();
        }

        function loadDashboard() {
            const income = contracts.reduce((s, c) => s + c.totalAmount, 0);
            const expenseTotal = expenses.reduce((s, e) => s + e.amount, 0);
            document.getElementById('totalIncome').textContent = income.toLocaleString();
            document.getElementById('totalExpenses').textContent = expenseTotal.toLocaleString();
            document.getElementById('activeContracts').textContent = contracts.length;
            document.getElementById('dueChecks').textContent = contracts.flatMap(c => c.checks).filter(ch => ch.dueDate < new Date().toLocaleDateString('fa-IR')).length;
        }

        function loadInvoiceSelect() {
            const select = document.getElementById('invoiceContract');
            select.innerHTML = '<option value="">-- انتخاب قرارداد --</option>';
            contracts.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = `${c.customer} - ${c.totalAmount.toLocaleString()} تومان`;
                select.appendChild(opt);
            });
        }

        function generateInvoiceFromForm() {
            // شبیه‌سازی از فرم
            const products = [];
            document.querySelectorAll('.product-row').forEach(row => {
                products.push({
                    type: row.children[0].querySelector('select').value,
                    size: row.children[1].querySelector('input').value,
                    meterage: parseFloat(row.children[2].querySelector('input').value) || 0,
                    unitPrice: parseFloat(row.children[3].querySelector('input').value) || 0,
                    total: parseFloat(row.children[4].querySelector('input').value) || 0
                });
            });
            const total = products.reduce((s, p) => s + p.total, 0);
            generateInvoiceHTML({
                customer: document.getElementById('contractCustomer').value,
                phone: document.getElementById('contractPhone').value,
                address: document.getElementById('contractAddress').value,
                products: products,
                totalAmount: total,
                advance: parseFloat(document.getElementById('contractAdvance').value) || 0
            });
        }

        function generateInvoice() {
            const id = document.getElementById('invoiceContract').value;
            if (!id) return alert('قرارداد انتخاب کنید!');
            const contract = contracts.find(c => c.id == id);
            generateInvoiceHTML(contract);
        }

        function generateInvoiceHTML(contract) {
            const html = `
                <div class="invoice-container">
                    <div class="text-center mb-4">
                        <img src="logo.jpg" alt="لوگو" width="100" class="mb-3">
                        <h2>کارخانه یونولیت کلشی فوم</h2>
                        <h3>فاکتور فروش</h3>
                        <p>تاریخ: ${new Date().toLocaleDateString('fa-IR')} | شماره: ${Date.now()}</p>
                    </div>
                    <div class="row mb-4">
                        <div class="col"><strong>مشتری:</strong> ${contract.customer}</div>
                        <div class="col"><strong>تلفن:</strong> ${contract.phone}</div>
                    </div>
                    <table class="table table-bordered">
                        <thead class="table-dark"><tr><th>ردیف</th><th>نوع</th><th>اندازه</th><th>متراژ</th><th>قیمت فی</th><th>جمع</th></tr></thead>
                        <tbody>
                            ${contract.products.map((p, i) => `<tr><td>${i+1}</td><td>${p.type}</td><td>${p.size}</td><td>${p.meterage}</td><td>${p.unitPrice.toLocaleString()}</td><td>${p.total.toLocaleString()}</td></tr>`).join('')}
                            <tr><td colspan="5" class="text-start"><strong>جمع کل:</strong></td><td><strong>${contract.totalAmount.toLocaleString()}</strong></td></tr>
                        </tbody>
                    </table>
                    <div class="row mt-5">
                        <div class="col text-center"><div class="factory-stamp">مهر کارخانه</div></div>
                        <div class="col text-center"><p>راننده: ___________</p></div>
                        <div class="col text-center"><p>تحویل‌گیرنده: ___________</p></div>
                    </div>
                </div>
            `;
            document.getElementById('invoicePreview').innerHTML = html;
        }

        function printInvoice() { window.print(); }
        function saveAsPDF() {
            const element = document.getElementById('invoicePreview');
            html2pdf().from(element).save(`فاکتور_${Date.now()}.pdf`);
        }

        function addExpense() {
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            if (!amount) return alert('مبلغ وارد کنید!');
            expenses.push({ amount, type: document.getElementById('expenseType').value, date: new Date().toLocaleDateString('fa-IR') });
            localStorage.setItem('expenses', JSON.stringify(expenses));
            document.getElementById('expenseAmount').value = '';
            loadDashboard();
            alert('هزینه ثبت شد!');
        }

        // راه‌اندازی اولیه
        window.onload = () => {
            addProductRow();
            loadData();
        };
    </script>
</body>
</html>
