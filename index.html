<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ ÛŒÙˆÙ†ÙˆÙ„ÛŒØª Ú©Ù„Ø´ÛŒâ€ŒÙÙˆÙ… â€“ Ù†Ø³Ø®Ù‡ Û¸</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:Tahoma,Arial,sans-serif}
        body{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;color:#333}
        .container{max-width:1400px;margin:0 auto;background:white;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.2);overflow:hidden;min-height:100vh}
        .login-page{padding:40px;text-align:center}
        .logo{width:150px;height:150px;margin:0 auto 20px;background:#2c3e50;border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-size:24px;font-weight:bold}
        .login-form{max-width:400px;margin:0 auto}
        .input-group{margin-bottom:20px;text-align:right}
        .input-group label{display:block;margin-bottom:8px;font-weight:bold;color:#2c3e50}
        .input-group input{width:100%;padding:12px 15px;border:2px solid #ddd;border-radius:8px;font-size:16px;transition:border-color .3s}
        .input-group input:focus{border-color:#3498db;outline:none}
        .btn{background:#27ae60;color:white;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-size:14px;transition:all .3s;display:inline-flex;align-items:center;gap:8px}
        .btn:hover{opacity:.9;transform:translateY(-2px)}
        .btn-sm{padding:8px 15px;font-size:12px}
        .btn-success{background:#27ae60}.btn-primary{background:#3498db}.btn-warning{background:#f39c12}.btn-danger{background:#e74c3c}.btn-info{background:#17a2b8}.btn-purple{background:#9b59b6}.btn-dark{background:#34495e}
        .dashboard-view{display:none;padding:20px}
        .dashboard-view.active{display:block}
        .stat-card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:20px;border-radius:10px;text-align:center;margin:10px}
        .stat-card h3{font-size:24px;margin-bottom:5px}
        .chart-box{background:#f8f9fa;border:1px solid #ddd;border-radius:10px;padding:15px;margin:15px 0}
        .page{display:none;padding:20px;min-height:500px}
        .page.active{display:block;animation:fadeIn .5s ease-in}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        .top-nav{background:#34495e;padding:0;display:flex;justify-content:center;flex-wrap:wrap}
        .top-nav button{background:none;border:none;color:white;padding:14px 20px;cursor:pointer;transition:all .3s;font-size:14px;white-space:nowrap}
        .top-nav button:hover{background:#3c5570}
        .top-nav button.active{background:#2980b9;font-weight:bold}
        .form-section{background:#f8f9fa;border-radius:10px;padding:20px;margin-bottom:20px;border-right:4px solid #3498db}
        .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px;margin-bottom:15px}
        .form-group{text-align:right}
        .form-group label{display:block;margin-bottom:5px;color:#2c3e50;font-weight:bold}
        .form-group input,.form-group select,.form-group textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:5px;font-size:14px}
        .product-row{display:grid;grid-template-columns:2fr 1fr 1fr 1fr auto;gap:10px;align-items:end;margin-bottom:10px;padding:10px;background:white;border-radius:5px;border:1px solid #ddd}
        .check-row{background:#f0f8ff;padding:10px;margin:5px 0;border-radius:5px;border:1px solid #b0d4f5;display:flex;justify-content:space-between;align-items:center}
        .table-container{overflow-x:auto;margin-top:20px;border-radius:8px;border:1px solid #ddd}
        table{width:100%;border-collapse:collapse}
        th,td{padding:12px;text-align:right;border-bottom:1px solid #ddd}
        th{background:#34495e;color:white;font-weight:bold}
        tr:hover{background:#f5f5f5}
        .notification-container{position:fixed;top:20px;right:20px;z-index:1000;max-width:400px}
        .notification{background:white;padding:15px;margin-bottom:10px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.15);border-right:4px solid #27ae60;display:flex;align-items:center;gap:10px;animation:slideIn .3s ease-out}
        .notification.error{border-right-color:#e74c3c}
        @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
        .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:2000;justify-content:center;align-items:center}
        .modal-content{background:white;padding:30px;border-radius:10px;width:90%;max-width:500px}
        @media print{@page{margin:0;size:80mm auto}body{margin:0;font-size:10pt;width:70mm}.no-print{display:none}}
        .watermark{position:fixed;bottom:10px;right:10px;opacity:.08;z-index:-1;width:200px}
        /* Ø¨Ø²Ø±Ú¯â€ŒØªØ± Ø´Ø¯Ù† Ú©Ø§Ø¯Ø±Ù‡Ø§ÛŒ Ù…Ø­ØµÙˆÙ„Ø§Øª Ùˆ Ú†Ú© */
        .product-row input,.product-row select,
        .check-row input{font-size:16px !important;padding:8px 10px !important;min-height:42px}
        /* Ø­Ø±ÙˆÙ ÙØ§Ø±Ø³ÛŒ ÙÙ‚Ø· */
        .fa-only{ime-mode:active}
    </style>
</head>
<body>
<div class="notification-container" id="notificationContainer"></div>

<!-- ØµÙØ­Ù‡ ÙˆØ±ÙˆØ¯ -->
<div class="container login-page" id="loginPage">
    <div class="logo">Ú©Ù„Ø´ÛŒ ÙÙˆÙ…</div>
    <h1>Ø³ÛŒØ³ØªÙ… Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ ÛŒÙˆÙ†ÙˆÙ„ÛŒØª</h1>
    <div class="login-form">
        <div class="input-group"><label>Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ</label><input id="username" placeholder="admin"></div>
        <div class="input-group"><label>Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label><input id="password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"></div>
        <button class="btn btn-success" onclick="login()">ÙˆØ±ÙˆØ¯</button>
    </div>
</div>

<!-- Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ -->
<div class="container dashboard-view" id="dashboardView">
    <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 20px;background:#34495e;color:white">
        <h2 id="welcomeUser">Ø³Ù„Ø§Ù…ØŒ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯</h2>
        <button class="btn btn-danger btn-sm" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
    </div>
    <nav class="top-nav">
        <button class="active" onclick="showPage('dashboard')">ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</button>
        <button onclick="showPage('contracts')">ğŸ“ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§</button>
        <button onclick="showPage('invoice')">ğŸ§¾ ÙØ§Ú©ØªÙˆØ±</button>
        <button onclick="showPage('delivery')">ğŸšš Ù†ÙˆØ¨Øª Ø§Ø±Ø³Ø§Ù„</button>
        <button onclick="showPage('customers')">ğŸ‘¥ Ù…Ø´ØªØ±ÛŒØ§Ù†</button>
        <button onclick="showPage('workers')">ğŸ‘¨â€ğŸ’¼ Ú©Ø§Ø±Ú©Ù†Ø§Ù†</button>
        <button onclick="showPage('finance')">ğŸ’° Ù…Ø§Ù„ÛŒ</button>
        <button onclick="showPage('checks')">ğŸ¦ Ú†Ú©â€ŒÙ‡Ø§</button>
        <button onclick="showPage('backup')">ğŸ’¾ Ù¾Ø´ØªÛŒØ¨Ø§Ù†</button>
        <button onclick="showPage('reports')">ğŸ“ˆ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§</button>
        <button onclick="showPage('settings')">âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>
    </nav>

    <div class="content">
        <!-- Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ -->
        <div id="dashboard" class="page active">
            <div class="form-section">
                <h3>ğŸ“ˆ Ø¢Ù…Ø§Ø± Ø§Ù…Ø±ÙˆØ²</h3>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px">
                    <div class="stat-card"><h3 id="totalContracts">Û°</h3><div>Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§</div></div>
                    <div class="stat-card"><h3 id="totalIncome">Û°</h3><div>Ø¯Ø±Ø¢Ù…Ø¯ Ú©Ù„</div></div>
                    <div class="stat-card"><h3 id="pendingChecks">Û°</h3><div>Ú†Ú©â€ŒÙ‡Ø§ÛŒ Ø¯Ø± Ø¬Ø±ÛŒØ§Ù†</div></div>
                    <div class="stat-card"><h3 id="nearDueChecks">Û°</h3><div>Ú†Ú©â€ŒÙ‡Ø§ÛŒ Ù†Ø²Ø¯ÛŒÚ© Ø³Ø±Ø±Ø³ÛŒØ¯</div></div>
                    <div class="stat-card"><h3 id="totalCustomers">Û°</h3><div>Ù…Ø´ØªØ±ÛŒØ§Ù†</div></div>
                    <div class="stat-card"><h3 id="totalWorkers">Û°</h3><div>Ú©Ø§Ø±Ú©Ù†Ø§Ù†</div></div>
                </div>
            </div>
            <div class="form-section">
                <h3>ğŸ“Š Ù†Ù…ÙˆØ¯Ø§Ø± Ù…Ø§Ù‡Ø§Ù†Ù‡</h3>
                <div class="chart-box"><canvas id="monthlyChart" height="100"></canvas></div>
            </div>
            <div class="form-section">
                <h3>ğŸš€ Ø¯Ø³ØªØ±Ø³ÛŒ Ø³Ø±ÛŒØ¹</h3>
                <div style="display:flex;gap:10px;flex-wrap:wrap">
                    <button class="btn btn-success" onclick="showPage('contracts')">ğŸ“ Ø«Ø¨Øª Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</button>
                    <button class="btn btn-primary" onclick="showPage('invoice')">ğŸ§¾ ØµØ¯ÙˆØ± ÙØ§Ú©ØªÙˆØ±</button>
                    <button class="btn btn-info" onclick="showPage('customers')">ğŸ‘¥ Ø«Ø¨Øª Ù…Ø´ØªØ±ÛŒ</button>
                    <button class="btn btn-warning" onclick="showPage('finance')">ğŸ’° Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´</button>
                    <button class="btn btn-purple" onclick="showPage('backup')">ğŸ’¾ Ù¾Ø´ØªÛŒØ¨Ø§Ù†</button>
                </div>
            </div>
        </div>

        <!-- Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§ -->
        <div id="contracts" class="page">
            <div class="form-section">
                <h3>ğŸ“ Ø«Ø¨Øª / ÙˆÛŒØ±Ø§ÛŒØ´ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</h3>
                <div class="form-grid">
                    <div class="form-group"><label>Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ *</label><input id="contractCustomer" list="customerList" placeholder="Ù†Ø§Ù… Ú©Ø§Ù…Ù„" onchange="loadCustomerInfo(this,'contract')"></div>
                    <div class="form-group"><label>Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ *</label><input id="contractPhone" placeholder="09123456789" oninput="validateMobile(this)"></div>
                    <div class="form-group"><label>Ø¢Ø¯Ø±Ø³</label><textarea id="contractAddress" rows="2" class="fa-only" oninput="validatePersian(this)"></textarea></div>
                    <div class="form-group"><label>ØªØ§Ø±ÛŒØ® ØªØ­ÙˆÛŒÙ„ *</label><input id="contractDeliveryDate" class="pdate" placeholder="1404/03/25" oninput="validateDate(this)"></div>
                    <div class="form-group"><label>Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª Ù†Ù‚Ø¯ÛŒ (ØªÙˆÙ…Ø§Ù†)</label><input id="contractAdvance" type="number" min="0" value="0" oninput="calculateContract()"></div>
                </div>

                <h4>Ù…Ø­ØµÙˆÙ„Ø§Øª</h4>
                <div id="productRowsContainer"></div>
                <button type="button" class="btn btn-info btn-sm" onclick="addProductRow()">â• Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø­ØµÙˆÙ„</button>

                <h4>ğŸ¦ Ú†Ú©â€ŒÙ‡Ø§ÛŒ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</h4>
                <div id="checkRowsContainer"></div>
                <button type="button" class="btn btn-info btn-sm" onclick="addCheckRow()">â• Ø§ÙØ²ÙˆØ¯Ù† Ú†Ú©</button>

                <div style="background:#e8f4fd;padding:15px;border-radius:8px;margin:15px 0;text-align:center;font-weight:bold">
                    <div id="contractTotalDisplay">Ø¬Ù…Ø¹ Ú©Ù„ Ù…Ø­ØµÙˆÙ„Ø§Øª: Û° ØªÙˆÙ…Ø§Ù†</div>
                    <div id="contractAdvanceDisplay">Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª Ù†Ù‚Ø¯ÛŒ: Û° ØªÙˆÙ…Ø§Ù†</div>
                    <div id="contractCheckDisplay">Ù…Ø¬Ù…ÙˆØ¹ Ú†Ú©â€ŒÙ‡Ø§: Û° ØªÙˆÙ…Ø§Ù†</div>
                    <div id="contractBalanceDisplay" style="color:#e74c3c;font-size:16px">Ù…Ø§Ù†Ø¯Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª: Û° ØªÙˆÙ…Ø§Ù†</div>
                </div>

                <div style="display:flex;gap:10px;margin-top:20px;flex-wrap:wrap">
                    <button class="btn btn-success" onclick="saveContract()">âœ… Ø«Ø¨Øª / Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
                    <button class="btn btn-warning" onclick="resetContractForm()">ğŸ”„ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</button>
                    <button class="btn btn-primary" onclick="printThermal()">ğŸ–¨ï¸ Ú†Ø§Ù¾ Ø­Ø±Ø§Ø±ØªÛŒ</button>
                    <button class="btn btn-dark" onclick="showReturnModal()">â†©ï¸ Ø¨Ø±Ú¯Ø´Øª Ø§Ø² ÙØ±ÙˆØ´</button>
                </div>
            </div>

            <div class="form-section">
                <h3>ğŸ“‹ Ù„ÛŒØ³Øª Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§</h3>
                <div class="search-box"><input id="searchContracts" placeholder="Ø¬Ø³ØªØ¬Ùˆ..." oninput="filterTable('contractsTable',this.value)"></div>
                <div class="table-container"><table><thead><tr><th>Ø±Ø¯ÛŒÙ</th><th>Ù…Ø´ØªØ±ÛŒ</th><th>ØªÙ…Ø§Ø³</th><th>Ù…Ø¨Ù„Øº Ú©Ù„</th><th>Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª</th><th>Ú†Ú©</th><th>Ù…Ø§Ù†Ø¯Ù‡</th><th>ØªØ§Ø±ÛŒØ®</th><th>ÙˆØ¶Ø¹ÛŒØª</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr></thead><tbody id="contractsTable"></tbody></table></div>
            </div>
        </div>

        <!-- ÙØ§Ú©ØªÙˆØ± -->
        <div id="invoice" class="page">
            <div class="form-section">
                <h3>ğŸ§¾ ØµØ¯ÙˆØ± ÙØ§Ú©ØªÙˆØ± ØªØ­ÙˆÛŒÙ„</h3>
                <div class="form-grid invoice-form">
                    <div class="form-group"><label>Ø§Ù†ØªØ®Ø§Ø¨ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ *</label>
                        <select id="invoiceContract" onchange="loadContractForInvoice()">
                            <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ *</label><input id="invoiceCustomer" readonly></div>
                    <div class="form-group"><label>Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ *</label><input id="invoicePhone" readonly></div>
                    <div class="form-group"><label>Ø¢Ø¯Ø±Ø³ Ù…Ø´ØªØ±ÛŒ *</label><textarea id="invoiceAddress" rows="2" readonly></textarea></div>
                    <div class="form-group"><label>Ù†Ø§Ù… Ø±Ø§Ù†Ù†Ø¯Ù‡ *</label><input id="invoiceDriver" placeholder="Ù†Ø§Ù… Ú©Ø§Ù…Ù„ Ø±Ø§Ù†Ù†Ø¯Ù‡"></div>
                    <div class="form-group"><label>Ù¾Ù„Ø§Ú© Ø®ÙˆØ¯Ø±Ùˆ *</label><input id="invoiceCarPlate" placeholder="Ù…Ø«Ø§Ù„: Û±Û±Ø¨ Û±Û²Û³Û´Ûµ"></div>
                    <div class="form-group"><label>ØªØ§Ø±ÛŒØ® ØªØ­ÙˆÛŒÙ„ *</label><input id="invoiceDeliveryDate" class="pdate" placeholder="Û±Û´Û°Û´/Û°Û³/Û²Ûµ"></div>
                </div>

                <h4>ğŸ“¦ Ù…Ø­ØµÙˆÙ„Ø§Øª Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</h4>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Ø±Ø¯ÛŒÙ</th><th>Ù…Ø­ØµÙˆÙ„</th><th>Ù…ØªØ±Ø§Ú˜</th><th>Ù‚ÛŒÙ…Øª ÙÛŒ Ù…ØªØ±</th><th>Ù…Ø¨Ù„Øº Ú©Ù„</th></tr></thead>
                        <tbody id="invoiceProductsTable"></tbody>
                    </table>
                </div>

                <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:20px">
                    <div>
                        <h4>ğŸ“ Ù…Ø­Ù„ Ø§Ù…Ø¶Ø§ Ùˆ Ù…Ù‡Ø± Ú©Ø§Ø±Ø®Ø§Ù†Ù‡</h4>
                        <div class="signature-box" id="factorySignatureBox">
                            <p>Ù…Ù‡Ø± Ùˆ Ø§Ù…Ø¶Ø§ÛŒ Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ ÛŒÙˆÙ†ÙˆÙ„ÛŒØª Ú©Ù„Ø´ÛŒ ÙÙˆÙ…</p>
                            <p>ØªØ§Ø±ÛŒØ®: <span id="factoryDate"></span></p>
                        </div>
                    </div>
                    <div>
                        <h4>ğŸ–‹ï¸ Ù†Ø§Ù… Ùˆ Ø§Ù…Ø¶Ø§ÛŒ Ø±Ø§Ù†Ù†Ø¯Ù‡</h4>
                        <div class="signature-box">
                            <p>Ù†Ø§Ù… Ø±Ø§Ù†Ù†Ø¯Ù‡: <span id="driverNameDisplay"></span></p>
                            <p>Ù¾Ù„Ø§Ú© Ø®ÙˆØ¯Ø±Ùˆ: <span id="carPlateDisplay"></span></p>
                            <p>Ø§Ù…Ø¶Ø§Ø¡: ...........................</p>
                        </div>
                    </div>
                </div>

                <div style="margin-top:20px">
                    <h4>ğŸ–‹ï¸ Ù†Ø§Ù… Ùˆ Ø§Ù…Ø¶Ø§ÛŒ ØªØ­ÙˆÛŒÙ„â€ŒÚ¯ÛŒØ±Ù†Ø¯Ù‡</h4>
                    <div class="signature-box">
                        <p>Ù†Ø§Ù… ØªØ­ÙˆÛŒÙ„â€ŒÚ¯ÛŒØ±Ù†Ø¯Ù‡: <input type="text" id="receiverName" placeholder="Ù†Ø§Ù… Ú©Ø§Ù…Ù„" style="border:none;border-bottom:1px solid #ccc;width:200px"></p>
                        <p>Ú©Ø¯ Ù…Ù„ÛŒ: <input type="text" id="receiverNationalCode" placeholder="Ú©Ø¯ Ù…Ù„ÛŒ" style="border:none;border-bottom:1px solid #ccc;width:150px"></p>
                        <p>Ø§Ù…Ø¶Ø§Ø¡: ...........................</p>
                    </div>
                </div>

                <div style="background:#e8f4fd;padding:15px;border-radius:8px;margin:15px 0">
                    <h4>ğŸ­ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø®Ø§Ù†Ù‡</h4>
                    <p>Ù†Ø§Ù… Ú©Ø§Ø±Ø®Ø§Ù†Ù‡: <strong id="factoryNameDisplay">Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ ÛŒÙˆÙ†ÙˆÙ„ÛŒØª Ú©Ù„Ø´ÛŒ ÙÙˆÙ…</strong></p>
                    <p>Ø¢Ø¯Ø±Ø³: <span id="factoryAddressDisplay">Ø§Ø±ÙˆÙ…ÛŒÙ‡ - Ø¬Ø§Ø¯Ù‡ Ø³Ù„Ù…Ø§Ø³ØŒ Ù†Ø±Ø³ÛŒØ¯Ù‡ Ø¨Ù‡ Ø±ÙˆØ³ØªØ§ÛŒ Ù‚Ø²Ù„ Ø¹Ø§Ø´Ù‚ØŒ Ø®ÛŒØ§Ø¨Ø§Ù† Ø¢Ø²Ø§Ø¯ÛŒ</span></p>
                    <p>ØªÙ„ÙÙ†: <strong id="factoryPhoneDisplay">09149431013</strong></p>
                </div>

                <div style="display:flex;gap:10px;margin-top:20px;flex-wrap:wrap">
                    <button class="btn btn-success" onclick="generateInvoice()">ğŸ§¾ Ø§ÛŒØ¬Ø§Ø¯ ÙØ§Ú©ØªÙˆØ±</button>
                    <button class="btn btn-primary" onclick="printInvoice()">ğŸ–¨ï¸ Ú†Ø§Ù¾ ÙØ§Ú©ØªÙˆØ±</button>
                    <button class="btn btn-info" onclick="downloadInvoicePDF()">ğŸ“„ Ø¯Ø§Ù†Ù„ÙˆØ¯ PDF</button>
                    <button class="btn btn-warning" onclick="resetInvoiceForm()">ğŸ”„ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</button>
                </div>
            </div>
        </div>

        <!-- Ù†ÙˆØ¨Øª Ø§Ø±Ø³Ø§Ù„ -->
        <div id="delivery" class="page">
            <div class="form-section">
                <h3>ğŸšš Ù†ÙˆØ¨Øªâ€ŒØ¯Ù‡ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø¨Ø§Ø±</h3>
                <div class="form-grid">
                    <div class="form-group"><label>Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ *</label><input id="deliveryCustomer" list="customerList" placeholder="Ù†Ø§Ù… Ú©Ø§Ù…Ù„" oninput="loadCustomerInfo(this,'delivery')"></div>
                    <div class="form-group"><label>ØªØ§Ø±ÛŒØ® Ø§Ø±Ø³Ø§Ù„ *</label><input id="deliveryDateInput" class="pdate" placeholder="Û±Û´Û°Û´/Û°Û³/Û²Ûµ" oninput="validateDate(this)"></div>
                    <div class="form-group"><label>Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ *</label><select id="deliveryTimeSlot"><option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option><option value="8-10">Û¸-Û±Û° ØµØ¨Ø­</option><option value="10-12">Û±Û°-Û±Û² Ø¸Ù‡Ø±</option><option value="12-14">Û±Û²-Û±Û´ Ø¨Ø¹Ø¯Ø§Ø²Ø¸Ù‡Ø±</option><option value="14-16">Û±Û´-Û±Û¶ Ø¹ØµØ±</option><option value="16-18">Û±Û¶-Û±Û¸ Ø´Ø¨</option></select></div>
                </div>
                <div class="form-group"><label>ØªÙˆØ¶ÛŒØ­Ø§Øª Ø§Ø±Ø³Ø§Ù„</label><textarea id="deliveryDescription" rows="3"></textarea></div>
                <div style="display:flex;gap:10px"><button class="btn btn-success" onclick="saveDelivery()">âœ… Ø«Ø¨Øª</button><button class="btn btn-warning" onclick="resetDeliveryForm()">ğŸ”„ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</button></div>
            </div>
            <div class="form-section">
                <h3>ğŸ“‹ Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„</h3><div class="search-box"><input placeholder="Ø¬Ø³ØªØ¬Ùˆ..." oninput="filterTable('deliveriesTable',this.value)"></div><div class="table-container"><table><thead><tr><th>Ø±Ø¯ÛŒÙ</th><th>Ù…Ø´ØªØ±ÛŒ</th><th>ØªØ§Ø±ÛŒØ®</th><th>Ø¨Ø§Ø²Ù‡</th><th>ØªÙˆØ¶ÛŒØ­Ø§Øª</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr></thead><tbody id="deliveriesTable"></tbody></table></div>
            </div>
        </div>

        <!-- Ù…Ø´ØªØ±ÛŒØ§Ù† -->
        <div id="customers" class="page">
            <div class="form-section">
                <h3>ğŸ‘¥ Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø´ØªØ±ÛŒØ§Ù†</h3>
                <div class="form-grid">
                    <div class="form-group"><label>Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ *</label><input id="customerName" class="fa-only" placeholder="Ù†Ø§Ù… Ú©Ø§Ù…Ù„" oninput="validatePersian(this)"></div>
                    <div class="form-group"><label>Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ *</label><input id="customerPhone" placeholder="09123456789" oninput="validateMobile(this)"></div>
                    <div class="form-group"><label>Ú©Ø¯ Ù…Ù„ÛŒ *</label><input id="customerNationalCode" placeholder="Ú©Ø¯ Ù…Ù„ÛŒ Û±Û° Ø±Ù‚Ù…ÛŒ" oninput="validateNationalCodeSimple(this)"></div>
                    <div class="form-group"><label>Ù†ÙˆØ¹ Ù…Ø´ØªØ±ÛŒ</label><select id="customerType"><option value="Ø¹Ø§Ø¯ÛŒ">Ø¹Ø§Ø¯ÛŒ</option><option value="Ù¾ÛŒØ´â€ŒØ®Ø±ÛŒØ¯">Ù¾ÛŒØ´â€ŒØ®Ø±ÛŒØ¯</option><option value="Ø¹Ø§Ù…Ù„">Ø¹Ø§Ù…Ù„</option></select></div>
                </div>
                <div class="form-group"><label>Ø¢Ø¯Ø±Ø³</label><textarea id="customerAddress" rows="2" class="fa-only" oninput="validatePersian(this)"></textarea></div>
                <div style="display:flex;gap:10px"><button class="btn btn-success" onclick="saveCustomer()">âœ… Ø«Ø¨Øª / Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button><button class="btn btn-warning" onclick="resetCustomerForm()">ğŸ”„ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</button></div>
            </div>
            <div class="form-section">
                <h3>ğŸ“‹ Ù„ÛŒØ³Øª Ù…Ø´ØªØ±ÛŒØ§Ù†</h3><div class="search-box"><input placeholder="Ø¬Ø³ØªØ¬Ùˆ..." oninput="filterTable('customersTable',this.value)"></div><div class="table-container"><table><thead><tr><th>Ø±Ø¯ÛŒÙ</th><th>Ù†Ø§Ù…</th><th>ØªÙ…Ø§Ø³</th><th>Ú©Ø¯ Ù…Ù„ÛŒ</th><th>Ù†ÙˆØ¹</th><th>Ø¢Ø¯Ø±Ø³</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr></thead><tbody id="customersTable"></tbody></table></div>
            </div>
        </div>

        <!-- Ú©Ø§Ø±Ú©Ù†Ø§Ù† -->
        <div id="workers" class="page">
            <div class="form-section">
                <h3>ğŸ‘¨â€ğŸ’¼ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ú©Ù†Ø§Ù†</h3>
                <div class="form-grid">
                    <div class="form-group"><label>Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ *</label><input id="workerName" class="fa-only" placeholder="Ù†Ø§Ù… Ú©Ø§Ù…Ù„" oninput="validatePersian(this)"></div>
                    <div class="form-group"><label>Ú©Ø¯ Ù…Ù„ÛŒ</label><input id="workerNationalCode" placeholder="Ú©Ø¯ Ù…Ù„ÛŒ" oninput="validateNationalCodeSimple(this)"></div>
                    <div class="form-group"><label>Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³</label><input id="workerPhone" placeholder="09123456789" oninput="validateMobile(this)"></div>
                    <div class="form-group"><label>Ø³Ù…Øª</label><select id="workerPosition"><option>Ú©Ø§Ø±Ú¯Ø±</option><option>Ø±Ø§Ù†Ù†Ø¯Ù‡</option><option>Ø§Ø¯Ø§Ø±ÛŒ</option><option>Ù…Ø¯ÛŒØ±</option></select></div>
                    <div class="form-group"><label>Ø­Ù‚ÙˆÙ‚ Ù¾Ø§ÛŒÙ‡ (ØªÙˆÙ…Ø§Ù†)</label><input id="workerSalary" type="number" min="0"></div>
                    <div class="form-group"><label>ØªØ§Ø±ÛŒØ® Ø§Ø³ØªØ®Ø¯Ø§Ù…</label><input id="workerHireDate" class="pdate" placeholder="Û±Û´Û°Û´/Û°Û³/Û²Ûµ" oninput="validateDate(this)"></div>
                </div>
                <div style="display:flex;gap:10px"><button class="btn btn-success" onclick="saveWorker()">âœ… Ø«Ø¨Øª / Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button><button class="btn btn-warning" onclick="resetWorkerForm()">ğŸ”„ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</button></div>
            </div>
            <div class="form-section">
                <h3>ğŸ“‹ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ú©Ù†Ø§Ù†</h3><div class="search-box"><input placeholder="Ø¬Ø³ØªØ¬Ùˆ..." oninput="filterTable('workersTable',this.value)"></div><div class="table-container"><table><thead><tr><th>Ø±Ø¯ÛŒÙ</th><th>Ù†Ø§Ù…</th><th>Ú©Ø¯ Ù…Ù„ÛŒ</th><th>ØªÙ…Ø§Ø³</th><th>Ø³Ù…Øª</th><th>Ø­Ù‚ÙˆÙ‚</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr></thead><tbody id="workersTable"></tbody></table></div>
            </div>
        </div>

        <!-- Ù…Ø§Ù„ÛŒ -->
        <div id="finance" class="page">
            <div class="form-section">
                <h3>ğŸ’° Ø«Ø¨Øª Ù‡Ø²ÛŒÙ†Ù‡ / Ø¯Ø±Ø¢Ù…Ø¯</h3>
                <div class="form-grid">
                    <div class="form-group"><label>Ù†ÙˆØ¹ ØªØ±Ø§Ú©Ù†Ø´ *</label><select id="transactionType" onchange="toggleWorkerSelect()"><option value="income">Ø¯Ø±Ø¢Ù…Ø¯</option><option value="expense">Ù‡Ø²ÛŒÙ†Ù‡</option></select></div>
                    <div class="form-group"><label>Ù…Ø¨Ù„Øº (ØªÙˆÙ…Ø§Ù†) *</label><input id="transactionAmount" type="number" min="0" step="1" oninput="validatePositive(this)"></div>
                    <div class="form-group"><label>Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ *</label><select id="transactionCategory" onchange="loadSubCategory()"><option value="Ø®Ø±ÛŒØ¯ Ù…ÙˆØ§Ø¯">Ø®Ø±ÛŒØ¯ Ù…ÙˆØ§Ø¯</option><option value="Ø­Ù‚ÙˆÙ‚ Ú©Ø§Ø±Ú¯Ø±Ø§Ù†">Ø­Ù‚ÙˆÙ‚ Ú©Ø§Ø±Ú¯Ø±Ø§Ù†</option><option value="Ú©Ø±Ø§ÛŒÙ‡ Ø±Ø§Ù†Ù†Ø¯Ú¯Ø§Ù†">Ú©Ø±Ø§ÛŒÙ‡ Ø±Ø§Ù†Ù†Ø¯Ú¯Ø§Ù†</option><option value="Ú©Ø±Ø§ÛŒÙ‡ Ø¬Ø±Ø«Ù‚ÛŒÙ„">Ú©Ø±Ø§ÛŒÙ‡ Ø¬Ø±Ø«Ù‚ÛŒÙ„</option><option value="Ø§Ø¬Ø§Ø±Ù‡">Ø§Ø¬Ø§Ø±Ù‡</option><option value="Ø¨Ø±Ù‚">Ø¨Ø±Ù‚</option><option value="Ø¢Ø¨">Ø¢Ø¨</option><option value="Ú¯Ø§Ø²">Ú¯Ø§Ø²</option><option value="Ù„ÙˆØ§Ø²Ù… ÛŒØ¯Ú©ÛŒ">Ù„ÙˆØ§Ø²Ù… ÛŒØ¯Ú©ÛŒ</option><option value="ØªØ¹Ù…ÛŒØ±Ú©Ø§Ø±">ØªØ¹Ù…ÛŒØ±Ú©Ø§Ø±</option><option value="Ù¾Ø§Ø¯Ø§Ø´">Ù¾Ø§Ø¯Ø§Ø´</option><option value="Ø³Ø§ÛŒØ±">Ø³Ø§ÛŒØ±</option></select></div>
                    <div class="form-group" id="workerSelectGroup" style="display:none"><label>Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø§Ø±Ú¯Ø± / Ø±Ø§Ù†Ù†Ø¯Ù‡</label><select id="workerSelect"></select></div>
                    <div class="form-group"><label>ØªØ§Ø±ÛŒØ®</label><input id="transactionDate" class="pdate" placeholder="Û±Û´Û°Û´/Û°Û³/Û²Ûµ" oninput="validateDate(this)"></div>
                </div>
                <div class="form-group"><label>Ø´Ø±Ø­</label><textarea id="transactionDescription" rows="3"></textarea></div>
                <div style="display:flex;gap:10px"><button class="btn btn-success" onclick="saveTransaction()">âœ… Ø«Ø¨Øª</button><button class="btn btn-warning" onclick="resetTransactionForm()">ğŸ”„ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</button></div>
            </div>
            <div class="form-section">
                <h3>ğŸ“Š Ø¢Ù…Ø§Ø± Ù…Ø§Ù„ÛŒ</h3>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px">
                    <div style="background:linear-gradient(135deg,#27ae60 0%,#1b5e20 100%);color:white;padding:20px;border-radius:10px;text-align:center"><div style="font-size:24px;font-weight:bold" id="totalIncomeFinance">Û°</div><div>Ú©Ù„ Ø¯Ø±Ø¢Ù…Ø¯</div></div>
                    <div style="background:linear-gradient(135deg,#e74c3c 0%,#c0392b 100%);color:white;padding:20px;border-radius:10px;text-align:center"><div style="font-size:24px;font-weight:bold" id="totalExpenseFinance">Û°</div><div>Ú©Ù„ Ù‡Ø²ÛŒÙ†Ù‡</div></div>
                    <div style="background:linear-gradient(135deg,#3498db 0%,#2980b9 100%);color:white;padding:20px;border-radius:10px;text-align:center"><div style="font-size:24px;font-weight:bold" id="netProfit">Û°</div><div>Ø³ÙˆØ¯ Ø®Ø§Ù„Øµ</div></div>
                </div>
            </div>
            <div class="form-section">
                <h3>ğŸ“‹ ØªØ§Ø±ÛŒØ®Ú†Ù‡ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§</h3><div class="search-box"><input placeholder="Ø¬Ø³ØªØ¬Ùˆ..." oninput="filterTable('transactionsTable',this.value)"></div><div class="table-container"><table><thead><tr><th>Ø±Ø¯ÛŒÙ</th><th>ØªØ§Ø±ÛŒØ®</th><th>Ù†ÙˆØ¹</th><th>Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</th><th>Ø´Ø±Ø­</th><th>Ù…Ø¨Ù„Øº (ØªÙˆÙ…Ø§Ù†)</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr></thead><tbody id="transactionsTable"></tbody></table></div>
            </div>
        </div>

        <!-- Ú†Ú©â€ŒÙ‡Ø§ -->
        <div id="checks" class="page">
            <div class="form-section">
                <h3>ğŸ¦ Ú†Ú©â€ŒÙ‡Ø§</h3>
                <div style="margin-bottom:10px"><button class="btn btn-success" onclick="addNewCheck()">â• Ø«Ø¨Øª Ú†Ú© Ø¬Ø¯ÛŒØ¯</button></div>
                <div class="search-box"><input placeholder="Ø¬Ø³ØªØ¬Ùˆ..." oninput="filterTable('allChecksTable',this.value)"></div>
                <div class="table-container"><table><thead><tr><th>Ø±Ø¯ÛŒÙ</th><th>Ø´Ù…Ø§Ø±Ù‡</th><th>Ù…Ø´ØªØ±ÛŒ</th><th>Ù…Ø¨Ù„Øº</th><th>Ø³Ø±Ø±Ø³ÛŒØ¯</th><th>Ø¨Ø§Ù†Ú©</th><th>ÙˆØ¶Ø¹ÛŒØª</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr></thead><tbody id="allChecksTable"></tbody></table></div>
            </div>
        </div>

        <!-- Ù¾Ø´ØªÛŒØ¨Ø§Ù† -->
        <div id="backup" class="page">
            <div class="form-section">
                <h3>ğŸ’¾ Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ Ùˆ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ</h3>
                <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center">
                    <button class="btn btn-success" onclick="exportBackup()">ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù¾Ø´ØªÛŒØ¨Ø§Ù† (JSON)</button>
                    <button class="btn btn-primary" onclick="document.getElementById('importFile').click()">ğŸ“¤ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø§Ø² ÙØ§ÛŒÙ„</button>
                    <input type="file" id="importFile" style="display:none" accept=".json" onchange="importBackup(event)">
                    <button class="btn btn-info" onclick="exportToExcel()">ğŸ“Š Ø®Ø±ÙˆØ¬ÛŒ Ø§Ú©Ø³Ù„</button>
                    <button class="btn btn-warning" onclick="exportToPDF()">ğŸ“„ Ø®Ø±ÙˆØ¬ÛŒ PDF</button>
                </div>
                <div style="margin-top:20px;text-align:center;color:#666"><p>Ø¢Ø®Ø±ÛŒÙ† Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ: <span id="lastBackupDate">Ù‡ÛŒÚ†</span></p></div>
            </div>
        </div>

        <!-- Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ -->
        <div id="reports" class="page">
            <div class="form-section">
                <h3>ğŸ“ˆ Ú¯Ø²Ø§Ø±Ø´â€ŒÚ¯ÛŒØ±ÛŒ</h3>
                <div class="form-grid">
                    <div class="form-group"><label>Ù†ÙˆØ¹ Ú¯Ø²Ø§Ø±Ø´</label><select id="reportType"><option value="financial">Ù…Ø§Ù„ÛŒ</option><option value="contracts">Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§</option><option value="checks">Ú†Ú©â€ŒÙ‡Ø§</option><option value="customers">Ù…Ø´ØªØ±ÛŒØ§Ù†</option><option value="tax">Ù…Ø§Ù„ÛŒØ§ØªÛŒ</option></select></div>
                    <div class="form-group"><label>Ø§Ø² ØªØ§Ø±ÛŒØ®</label><input id="reportFromDate" class="pdate" placeholder="Û±Û´Û°Û´/Û°Û±/Û°Û±" oninput="validateDate(this)"></div>
                    <div class="form-group"><label>ØªØ§ ØªØ§Ø±ÛŒØ®</label><input id="reportToDate" class="pdate" placeholder="Û±Û´Û°Û´/Û±Û²/Û²Û¹" oninput="validateDate(this)"></div>
                </div>
                <div style="display:flex;gap:10px"><button class="btn btn-success" onclick="generateReport()">ğŸ“Š Ø§ÛŒØ¬Ø§Ø¯</button><button class="btn btn-info" onclick="exportReportToExcel()">ğŸ“Š Ø§Ú©Ø³Ù„</button><button class="btn btn-warning" onclick="exportReportToPDF()">ğŸ“„ PDF</button><button class="btn btn-primary" onclick="printReport()">ğŸ–¨ï¸ Ú†Ø§Ù¾</button></div>
            </div>
            <div class="form-section"><h3>ğŸ“‹ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ú¯Ø²Ø§Ø±Ø´</h3><div id="reportPreview" style="padding:20px;background:#f8f9fa;border-radius:10px;min-height:200px"><p style="text-align:center;color:#666;padding:40px">Ú¯Ø²Ø§Ø±Ø´ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p></div></div>
        </div>

        <!-- ØªÙ†Ø¸ÛŒÙ…Ø§Øª -->
        <div id="settings" class="page">
            <div class="form-section">
                <h3>âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³ÛŒØ³ØªÙ…</h3>
                <div class="form-grid">
                    <div class="form-group"><label>Ù†Ø§Ù… Ø´Ø±Ú©Øª *</label><input id="companyName" value="Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ ÛŒÙˆÙ†ÙˆÙ„ÛŒØª Ú©Ù„Ø´ÛŒ ÙÙˆÙ…"></div>
                    <div class="form-group"><label>Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø´Ø±Ú©Øª *</label><input id="companyPhone" value="09149431013"></div>
                    <div class="form-group"><label>Ø¢Ø¯Ø±Ø³ Ø´Ø±Ú©Øª</label><textarea id="companyAddress" rows="2">Ø§Ø±ÙˆÙ…ÛŒÙ‡ - Ø¬Ø§Ø¯Ù‡ Ø³Ù„Ù…Ø§Ø³ØŒ Ù†Ø±Ø³ÛŒØ¯Ù‡ Ø¨Ù‡ Ø±ÙˆØ³ØªØ§ÛŒ Ù‚Ø²Ù„ Ø¹Ø§Ø´Ù‚ØŒ Ø®ÛŒØ§Ø¨Ø§Ù† Ø¢Ø²Ø§Ø¯ÛŒ</textarea></div>
                    <div class="form-group"><label>Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÙˆÚ¯Ùˆ</label><input type="file" id="logoUpload" accept="image/*" onchange="uploadLogo(event)"><img id="logoPreview" class="logo-preview" style="display:none"></div>
                </div>
                <div style="display:flex;gap:10px"><button class="btn btn-success" onclick="saveSettings()">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡</button><button class="btn btn-info" onclick="showSystemInfo()">â„¹ï¸ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³ÛŒØ³ØªÙ…</button></div>
            </div>
            <div class="form-section">
                <h3>ğŸ” ØªØºÛŒÛŒØ± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</h3>
                <div class="form-grid">
                    <div class="form-group"><label>Ø±Ù…Ø² ÙØ¹Ù„ÛŒ</label><input type="password" id="currentPasswordSettings"></div>
                    <div class="form-group"><label>Ø±Ù…Ø² Ø¬Ø¯ÛŒØ¯</label><input type="password" id="newPasswordSettings" placeholder="Ø­Ø¯Ø§Ù‚Ù„ Û´ Ú©Ø§Ø±Ø§Ú©ØªØ±"></div>
                    <div class="form-group"><label>ØªÚ©Ø±Ø§Ø± Ø±Ù…Ø² Ø¬Ø¯ÛŒØ¯</label><input type="password" id="confirmNewPasswordSettings"></div>
                </div>
                <button class="btn btn-purple" onclick="changePasswordFromSettings()">ØªØºÛŒÛŒØ± Ø±Ù…Ø²</button>
            </div>
        </div>
    </div>
</div>

<!-- datalist Ø¨Ø±Ø§ÛŒ Ù…Ø´ØªØ±ÛŒØ§Ù† -->
<datalist id="customerList"></datalist>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø±Ú¯Ø´Øª Ø§Ø² ÙØ±ÙˆØ´ -->
<div class="modal" id="returnModal">
    <div class="modal-content">
        <h3>â†©ï¸ Ø¨Ø±Ú¯Ø´Øª Ø§Ø² ÙØ±ÙˆØ´</h3>
        <div class="form-group"><label>Ø§Ù†ØªØ®Ø§Ø¨ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</label><select id="returnContract" onchange="loadReturnContract()"></select></div>
        <div class="form-group"><label>Ù…Ø¨Ù„Øº Ø¨Ø±Ú¯Ø´ØªÛŒ (ØªÙˆÙ…Ø§Ù†)</label><input id="returnAmount" type="number" min="0"></div>
        <div class="form-group"><label>Ø¯Ù„ÛŒÙ„ Ø¨Ø±Ú¯Ø´Øª</label><textarea id="returnReason" rows="3"></textarea></div>
        <div style="display:flex;gap:10px">
            <button class="btn btn-success" onclick="saveReturn()">âœ… Ø«Ø¨Øª Ø¨Ø±Ú¯Ø´Øª</button>
            <button class="btn btn-warning" onclick="closeModal('returnModal')">Ø§Ù†ØµØ±Ø§Ù</button>
        </div>
    </div>
</div>

<script>
/* ==================== Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ ==================== */
let appData={
    contracts:[],customers:[],workers:[],transactions:[],checks:[],deliveries:[],
    returns:[],auditLog:[],
    settings:{companyName:'Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ ÛŒÙˆÙ†ÙˆÙ„ÛŒØª Ú©Ù„Ø´ÛŒ ÙÙˆÙ…',companyPhone:'09149431013',companyAddress:'Ø§Ø±ÙˆÙ…ÛŒÙ‡ - Ø¬Ø§Ø¯Ù‡ Ø³Ù„Ù…Ø§Ø³',logo:null},
    auth:{username:'admin',password: btoa('1234')},
    currentUser:''
};
let editingId=null,productRowCount=0,checkRowCount=0;
let monthlyChart=null;

/* ==================== ÙˆØ±ÙˆØ¯ Ùˆ Ø®Ø±ÙˆØ¬ ==================== */
function login(){
    const u=document.getElementById('username').value;
    const p=document.getElementById('password').value;
    if(u==='admin' && btoa(p)==='MTIzNA=='){
        appData.currentUser=u;
        document.getElementById('loginPage').style.display='none';
        document.getElementById('dashboardView').style.display='block';
        document.getElementById('welcomeUser').textContent=`${u}ØŒ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯`;
        loadData();
        drawMonthlyChart();
        showNotification('ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚');
    }else{showNotification('Ù†Ø§Ù…â€ŒÚ©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª','error');}
}
function logout(){if(confirm('Ø®Ø§Ø±Ø¬ Ù…ÛŒâ€ŒØ´ÙˆÛŒØ¯ØŸ')){saveData();location.reload();}}

/* ==================== Ù†Ø§ÙˆØ¨Ø±ÛŒ ==================== */
function showPage(pageId){
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    document.querySelectorAll('.top-nav button').forEach(b=>b.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');
    event.target.classList.add('active');
    if(pageId==='dashboard'){updateDashboard();drawMonthlyChart();}
    if(pageId==='contracts'){displayContracts();}
    if(pageId==='invoice'){loadContractsForInvoice();}
    if(pageId==='delivery'){displayDeliveries();}
    if(pageId==='customers')displayCustomers();
    if(pageId==='workers')displayWorkers();
    if(pageId==='finance')displayTransactions();
    if(pageId==='checks'){displayAllChecks();}
}

/* ==================== ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ ==================== */
function toShamsi(date=new Date()){
    return date.toLocaleDateString('fa-IR-u-nu-latn',{year:'numeric',month:'2-digit',day:'2-digit'}).replace(/\//g,'/');
}
function fillTodayDates(){
    const today=toShamsi();
    document.querySelectorAll('.pdate').forEach(el=>{if(!el.value)el.value=today;});
}

/* ==================== Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø³Ø§Ø¯Ù‡ ==================== */
function validateMobile(input){
    input.value=input.value.replace(/[^0-9]/g,'').slice(0,11);
}
function validateNationalCodeSimple(input){
    input.value=input.value.replace(/[^0-9]/g,'').slice(0,10);
}
function validateDate(input){
    input.value=input.value.replace(/[^0-9\/]/g,'');
}
function validatePersian(input){
    input.value=input.value.replace(/[a-zA-Z0-9@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]+/g,'');
}
function validatePositive(input){
    if(parseFloat(input.value)<0){input.value='';showNotification('Ù…Ø¨Ù„Øº Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ù…Ù†ÙÛŒ Ø¨Ø§Ø´Ø¯','error');}
}

/* ==================== Ù…Ø´ØªØ±ÛŒ â€“ ØªÚ©Ø±Ø§Ø±ÛŒ Ù†Ø¨ÙˆØ¯Ù† Ù…ÙˆØ¨Ø§ÛŒÙ„ ==================== */
function isMobileUnique(phone,excludeId=null){
    return !appData.customers.some(c=>c.phone===phone && c.id!==excludeId);
}
function fillCustomerList(){
    const list=document.getElementById('customerList');
    list.innerHTML='';
    appData.customers.forEach(c=>{
        const option=document.createElement('option');
        option.value=c.name;
        option.dataset.phone=c.phone;
        option.dataset.address=c.address;
        list.appendChild(option);
    });
}
function loadCustomerInfo(input,prefix){
    const val=input.value;
    const customer=appData.customers.find(c=>c.name===val);
    if(customer){
        document.getElementById(prefix+'Customer').value=customer.name;
        if(prefix==='contract'){
            document.getElementById('contractPhone').value=customer.phone;
            document.getElementById('contractAddress').value=customer.address;
        }
    }
}

/* ==================== Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¨Ø§ Ù†Ù…ÙˆØ¯Ø§Ø± ==================== */
function updateDashboard(){
    document.getElementById('totalContracts').textContent=appData.contracts.length;
    const income=appData.transactions.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
    document.getElementById('totalIncome').textContent=income.toLocaleString('fa-IR');
    document.getElementById('totalCustomers').textContent=appData.customers.length;
    document.getElementById('totalWorkers').textContent=appData.workers.length;
    const pending=appData.checks.filter(c=>c.status==='Ø¯Ø± Ø¬Ø±ÛŒØ§Ù†').length;
    document.getElementById('pendingChecks').textContent=pending;
    const near=appData.checks.filter(c=>isNearDue(c.dueDate)&&c.status==='Ø¯Ø± Ø¬Ø±ÛŒØ§Ù†').length;
    document.getElementById('nearDueChecks').textContent=near;
    if(near)showNotification(`${near} Ú†Ú© Ù†Ø²Ø¯ÛŒÚ© Ø³Ø±Ø±Ø³ÛŒØ¯ Ø§Ø³Øª!`,'warning');
}
function isNearDue(dueDate){
    const today=new Date();
    const[y,m,d]=dueDate.split('/').map(Number);
    const due=new Date(y+621,m-1,d);
    const diff=(due-today)/(1000*60*60*24);
    return diff>=0&&diff<=3;
}
function drawMonthlyChart(){
    const ctx=document.getElementById('monthlyChart').getContext('2d');
    const months=['ÙØ±ÙˆØ±Ø¯ÛŒÙ†','Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª','Ø®Ø±Ø¯Ø§Ø¯','ØªÛŒØ±','Ù…Ø±Ø¯Ø§Ø¯','Ø´Ù‡Ø±ÛŒÙˆØ±','Ù…Ù‡Ø±','Ø¢Ø¨Ø§Ù†','Ø¢Ø°Ø±','Ø¯ÛŒ','Ø¨Ù‡Ù…Ù†','Ø§Ø³ÙÙ†Ø¯'];
    const incomeData=Array(12).fill(0);
    const expenseData=Array(12).fill(0);
    appData.transactions.forEach(t=>{
        const[yr,mn]=t.date.split('/');
        if(yr==='1404'){
            const m=parseInt(mn)-1;
            if(t.type==='income')incomeData[m]+=t.amount;
            else expenseData[m]+=t.amount;
        }
    });
    if(monthlyChart)monthlyChart.destroy();
    monthlyChart=new Chart(ctx,{
        type:'bar',
        data:{
            labels:months,
            datasets:[
                {label:'Ø¯Ø±Ø¢Ù…Ø¯',data:incomeData,backgroundColor:'#27ae60'},
                {label:'Ù‡Ø²ÛŒÙ†Ù‡',data:expenseData,backgroundColor:'#e74c3c'}
            ]
        },
        options:{responsive:true,plugins:{legend:{position:'top'}},scales:{y:{beginAtZero:true}}}
    });
}

/* ==================== Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§ ==================== */
function addProductRow(){
    productRowCount++;
    const row=document.createElement('div');
    row.className='product-row';
    row.setAttribute('data-row',productRowCount);
    row.innerHTML=`
        <div class="form-group"><label>Ù†ÙˆØ¹ Ù…Ø­ØµÙˆÙ„</label><select class="productType" onchange="calculateContract()"><option value="ÙÙˆÙ… Ø³Ù‚ÙÛŒ">ÙÙˆÙ… Ø³Ù‚ÙÛŒ</option><option value="ÙˆØ±Ù‚ ÛŒÙˆÙ†ÙˆÙ„ÛŒØª">ÙˆØ±Ù‚ ÛŒÙˆÙ†ÙˆÙ„ÛŒØª</option><option value="Ù¾Ø§Ù†Ù„">Ù¾Ø§Ù†Ù„</option><option value="Ø³ÙØ§Ø±Ø´ÛŒ">Ø³ÙØ§Ø±Ø´ÛŒ</option></select></div>
        <div class="form-group"><label>Ù…ØªØ±Ø§Ú˜ (Ù…ØªØ±)</label><input type="number" class="productMeterage" min="0" step="0.1" oninput="calculateContract()"></div>
        <div class="form-group"><label>Ù‚ÛŒÙ…Øª ÙÛŒ Ù…ØªØ± (ØªÙˆÙ…Ø§Ù†)</label><input type="number" class="productPrice" min="0" oninput="calculateContract()"></div>
        <div class="form-group"><label>Ù…Ø¨Ù„Øº Ú©Ù„</label><input class="productTotal" readonly style="background:#f8f9fa;font-weight:bold"></div>
        <button type="button" class="btn btn-danger btn-sm" onclick="removeProductRow(${productRowCount})">âœ•</button>
    `;
    document.getElementById('productRowsContainer').appendChild(row);
}
function removeProductRow(rowNumber){const row=document.querySelector(`[data-row="${rowNumber}"]`);if(row){row.remove();calculateContract();}}
function addCheckRow(){
    checkRowCount++;
    const row=document.createElement('div');
    row.className='check-row';
    row.setAttribute('data-check',checkRowCount);
    row.innerHTML=`
        <div class="form-grid" style="grid-template-columns:1fr 1fr 1fr 1fr;gap:5px">
            <div class="form-group"><label>Ø´Ù…Ø§Ø±Ù‡ Ú†Ú©</label><input class="checkNumber" placeholder="Ø´Ù…Ø§Ø±Ù‡ Ú†Ú©"></div>
            <div class="form-group"><label>Ù…Ø¨Ù„Øº (ØªÙˆÙ…Ø§Ù†)</label><input type="number" class="checkAmount" min="0" oninput="calculateContract()"></div>
            <div class="form-group"><label>ØªØ§Ø±ÛŒØ® Ø³Ø±Ø±Ø³ÛŒØ¯</label><input class="checkDueDate pdate" placeholder="1404/03/25" oninput="validateDate(this)"></div>
            <div class="form-group"><label>Ø¨Ø§Ù†Ú©</label><input class="checkBank" placeholder="Ù†Ø§Ù… Ø¨Ø§Ù†Ú©" class="fa-only" oninput="validatePersian(this)"></div>
        </div>
        <button type="button" class="btn btn-danger btn-sm" onclick="removeCheckRow(${checkRowCount})">âœ•</button>
    `;
    document.getElementById('checkRowsContainer').appendChild(row);
}
function removeCheckRow(checkNumber){const row=document.querySelector(`[data-check="${checkNumber}"]`);if(row){row.remove();calculateContract();}}
function calculateContract(){
    let totalProducts=0;
    document.querySelectorAll('.product-row').forEach(row=>{
        const m=parseFloat(row.querySelector('.productMeterage').value)||0;
        const p=parseFloat(row.querySelector('.productPrice').value)||0;
        const total=m*p;
        row.querySelector('.productTotal').value=total.toLocaleString('fa-IR');
        totalProducts+=total;
    });
    let totalChecks=0;
    document.querySelectorAll('.check-row').forEach(row=>{
        totalChecks+=parseFloat(row.querySelector('.checkAmount').value)||0;
    });
    const advance=parseFloat(document.getElementById('contractAdvance').value)||0;
    const balance=totalProducts-advance-totalChecks;
    document.getElementById('contractTotalDisplay').textContent=`Ø¬Ù…Ø¹ Ú©Ù„ Ù…Ø­ØµÙˆÙ„Ø§Øª: ${totalProducts.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†`;
    document.getElementById('contractAdvanceDisplay').textContent=`Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª Ù†Ù‚Ø¯ÛŒ: ${advance.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†`;
    document.getElementById('contractCheckDisplay').textContent=`Ù…Ø¬Ù…ÙˆØ¹ Ú†Ú©â€ŒÙ‡Ø§: ${totalChecks.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†`;
    document.getElementById('contractBalanceDisplay').innerHTML=`Ù…Ø§Ù†Ø¯Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª: <span style="color:${balance>0?'#27ae60':balance<0?'#e74c3c':'#f39c12'}">${balance.toLocaleString('fa-IR')}</span> ØªÙˆÙ…Ø§Ù†`;
}
function saveContract(){
    try{
        const customer=document.getElementById('contractCustomer').value.trim();
        const phone=document.getElementById('contractPhone').value.trim();
        if(!customer||!phone){showNotification('Ù†Ø§Ù… Ùˆ ØªÙ…Ø§Ø³ Ù…Ø´ØªØ±ÛŒ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª','error');return;}
        if(!isMobileUnique(phone,editingId)){showNotification('Ø§ÛŒÙ† Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øª Ø´Ø¯Ù‡','error');return;}
        const products=[],checks=[];
        document.querySelectorAll('.product-row').forEach(row=>{
            const m=parseFloat(row.querySelector('.productMeterage').value)||0;
            const p=parseFloat(row.querySelector('.productPrice').value)||0;
            if(m>0&&p>0)products.push({type:row.querySelector('.productType').value,meterage:m,price:p,total:m*p});
        });
        document.querySelectorAll('.check-row').forEach(row=>{
            const num=row.querySelector('.checkNumber').value.trim();
            const amt=parseFloat(row.querySelector('.checkAmount').value)||0;
            const due=row.querySelector('.checkDueDate').value;
            const bank=row.querySelector('.checkBank').value.trim();
            if(num&&amt>0&&due&&bank){
                checks.push({number:num,amount:amt,dueDate:due,bank:bank,status:'Ø¯Ø± Ø¬Ø±ÛŒØ§Ù†'});
            }
        });
        const totalProducts=products.reduce((s,p)=>s+p.total,0);
        const totalChecks=checks.reduce((s,c)=>s+c.amount,0);
        const advance=parseFloat(document.getElementById('contractAdvance').value)||0;
        const balance=totalProducts-advance-totalChecks;
        const contractNumber=generateContractNumber();
        const contract={id:editingId||Date.now(),contractNumber,customer,phone,address:document.getElementById('contractAddress').value,deliveryDate:document.getElementById('contractDeliveryDate').value,products,checks,totalAmount:totalProducts,advance,checkAmount:totalChecks,balance,date:new Date().toLocaleDateString('fa-IR'),status:'ÙØ¹Ø§Ù„'};
        if(editingId){const i=appData.contracts.findIndex(c=>c.id===editingId);appData.contracts[i]=contract;}else{appData.contracts.push(contract);}
        checks.forEach(c=>appData.checks.push({id:Date.now()+Math.random(),contractId:contract.id,customer,number:c.number,amount:c.amount,dueDate:c.dueDate,bank:c.bank,status:'Ø¯Ø± Ø¬Ø±ÛŒØ§Ù†',createdDate:new Date().toLocaleDateString('fa-IR')}));
        appData.transactions.push({id:Date.now(),type:'income',amount:totalProducts,category:'ÙØ±ÙˆØ´',description:`Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø¨Ø§ ${customer}`,date:new Date().toLocaleDateString('fa-IR')});
        const existing=appData.customers.find(c=>c.phone===phone);
        if(!existing)appData.customers.push({id:Date.now(),name:customer,phone,address:contract.address,type:'Ø¹Ø§Ø¯ÛŒ',registrationDate:new Date().toLocaleDateString('fa-IR')});
        logAudit('Ø«Ø¨Øª/ÙˆÛŒØ±Ø§ÛŒØ´ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯',contractNumber);
        saveData();updateAll();resetContractForm();showNotification(`Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø«Ø¨Øª Ø´Ø¯! Ø´Ù…Ø§Ø±Ù‡: ${contractNumber}`);
        fillCustomerList();
    }catch(e){
        logAudit('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯',e.message);
        showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯','error');
    }
}
function resetContractForm(){editingId=null;document.getElementById('contractCustomer').value='';document.getElementById('contractPhone').value='';document.getElementById('contractAddress').value='';document.getElementById('contractAdvance').value='0';document.getElementById('contractDeliveryDate').value='';productRowCount=0;checkRowCount=0;document.getElementById('productRowsContainer').innerHTML='';document.getElementById('checkRowsContainer').innerHTML='';addProductRow();addCheckRow();calculateContract();}
function displayContracts(){
    const tbody=document.getElementById('contractsTable');tbody.innerHTML='';
    if(appData.contracts.length===0){tbody.innerHTML='<tr><td colspan="10" style="text-align:center;padding:20px">Ù‡ÛŒÚ† Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</td></tr>';return;}
    appData.contracts.forEach((c,i)=>{
        const row=document.createElement('tr');
        row.innerHTML=`
            <td>${i+1}</td><td>${c.customer}</td><td>${c.phone}</td><td>${c.totalAmount.toLocaleString('fa-IR')}</td><td>${c.advance.toLocaleString('fa-IR')}</td><td>${c.checkAmount.toLocaleString('fa-IR')}</td>
            <td style="color:${c.balance>0?'#27ae60':c.balance<0?'#e74c3c':'#f39c12'};font-weight:bold">${c.balance.toLocaleString('fa-IR')}</td><td>${c.date}</td><td><span class="status-${c.status}">${c.status}</span></td>
            <td>
                <button class="btn btn-info btn-sm" onclick="viewContract(${c.id})">Ù…Ø´Ø§Ù‡Ø¯Ù‡</button>
                <button class="btn btn-warning btn-sm" onclick="editContract(${c.id})">ÙˆÛŒØ±Ø§ÛŒØ´</button>
                <button class="btn btn-danger btn-sm" onclick="deleteContract(${c.id})">Ø­Ø°Ù</button>
                <button class="btn btn-primary btn-sm" onclick="printThermal(${c.id})">Ú†Ø§Ù¾</button>
            </td>
        `;tbody.appendChild(row);
    });
}
function viewContract(id){const c=appData.contracts.find(x=>x.id===id);if(!c)return;let txt=`Ù…Ø´ØªØ±ÛŒ: ${c.customer}\nØªÙ…Ø§Ø³: ${c.phone}\nØªØ§Ø±ÛŒØ®: ${c.date}\n\nÙ…Ø­ØµÙˆÙ„Ø§Øª:\n`;c.products.forEach((p,i)=>txt+=`${i+1}. ${p.type} - ${p.meterage} Ù…ØªØ± Ã— ${p.price.toLocaleString('fa-IR')} = ${p.total.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†\n`);txt+=`\nØ¬Ù…Ø¹ Ú©Ù„: ${c.totalAmount.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†\nÙ†Ù‚Ø¯ÛŒ: ${c.advance.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†\nÚ†Ú©: ${c.checkAmount.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†\nÙ…Ø§Ù†Ø¯Ù‡: ${c.balance.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†`;alert(txt);}
function editContract(id){const c=appData.contracts.find(x=>x.id===id);if(!c)return;editingId=c.id;document.getElementById('contractCustomer').value=c.customer;document.getElementById('contractPhone').value=c.phone;document.getElementById('contractAddress').value=c.address;document.getElementById('contractAdvance').value=c.advance;document.getElementById('contractDeliveryDate').value=c.deliveryDate;productRowCount=0;checkRowCount=0;document.getElementById('productRowsContainer').innerHTML='';document.getElementById('checkRowsContainer').innerHTML='';c.products.forEach(p=>{addProductRow();const row=document.querySelector(`[data-row="${productRowCount}"]`);row.querySelector('.productType').value=p.type;row.querySelector('.productMeterage').value=p.meterage;row.querySelector('.productPrice').value=p.price;});c.checks.forEach(ch=>{addCheckRow();const row=document.querySelector(`[data-check="${checkRowCount}"]`);row.querySelector('.checkNumber').value=ch.number;row.querySelector('.checkAmount').value=ch.amount;row.querySelector('.checkDueDate').value=ch.dueDate;row.querySelector('.checkBank').value=ch.bank;});calculateContract();showNotification('Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø¯Ø± Ø­Ø§Ù„Øª ÙˆÛŒØ±Ø§ÛŒØ´ Ù‚Ø±Ø§Ø± Ú¯Ø±ÙØª','info');}
function deleteContract(id){if(confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')){appData.contracts=appData.contracts.filter(c=>c.id!==id);appData.checks=appData.checks.filter(c=>c.contractId!==id);logAudit('Ø­Ø°Ù Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯',id);saveData();displayContracts();updateDashboard();showNotification('Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø­Ø°Ù Ø´Ø¯');}}

/* ==================== Ø¨Ø±Ú¯Ø´Øª Ø§Ø² ÙØ±ÙˆØ´ ==================== */
function showReturnModal(){
    const sel=document.getElementById('returnContract');
    sel.innerHTML='<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</option>';
    appData.contracts.filter(c=>c.status==='ÙØ¹Ø§Ù„').forEach(c=>{
        const opt=document.createElement('option');
        opt.value=c.id;
        opt.textContent=`${c.customer} - ${c.date} - ${c.totalAmount.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†`;
        sel.appendChild(opt);
    });
    document.getElementById('returnModal').style.display='flex';
}
function closeModal(id){document.getElementById(id).style.display='none';}
function loadReturnContract(){
    const cid=document.getElementById('returnContract').value;
    if(!cid)return;
    const c=appData.contracts.find(x=>x.id==cid);
    document.getElementById('returnAmount').value=c.totalAmount;
}
function saveReturn(){
    const cid=document.getElementById('returnContract').value;
    const amount=parseFloat(document.getElementById('returnAmount').value)||0;
    const reason=document.getElementById('returnReason').value.trim();
    if(!cid||!amount){showNotification('Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ùˆ Ù…Ø¨Ù„Øº Ø¨Ø±Ú¯Ø´ØªÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯','error');return;}
    const c=appData.contracts.find(x=>x.id==cid);
    const ret={id:Date.now(),contractId:cid,customer:c.customer,amount,reason,date:new Date().toLocaleDateString('fa-IR')};
    appData.returns.push(ret);
    appData.transactions.push({id:Date.now(),type:'expense',amount,category:'Ø¨Ø±Ú¯Ø´Øª Ø§Ø² ÙØ±ÙˆØ´',description:`Ø¨Ø±Ú¯Ø´Øª Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ ${c.customer} - ${reason}`,date:ret.date});
    c.status='Ø¨Ø±Ú¯Ø´Øª Ø®ÙˆØ±Ø¯Ù‡';
    logAudit('Ø¨Ø±Ú¯Ø´Øª Ø§Ø² ÙØ±ÙˆØ´',c.contractNumber);
    saveData();updateAll();closeModal('returnModal');showNotification('Ø¨Ø±Ú¯Ø´Øª Ø§Ø² ÙØ±ÙˆØ´ Ø«Ø¨Øª Ø´Ø¯');
}

/* ==================== Ú†Ø§Ù¾ Ø­Ø±Ø§Ø±ØªÛŒ ==================== */
function printThermal(id=null){
    const c=id?appData.contracts.find(x=>x.id===id):appData.contracts[appData.contracts.length-1];
    if(!c){showNotification('Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯','error');return;}
    const styles=`
        <style>
            @media print{@page{margin:0;size:80mm auto}body{margin:0;font-size:10pt;width:70mm}}
            body{width:70mm;margin:2mm auto;font-family:Tahoma;font-size:10pt}
            .center{text-align:center}.bold{font-weight:bold}.line{border-top:1px dashed #000;margin:3px 0}.logo{width:40px;margin:0 auto;display:block}
        </style>`;
    const content=`
        ${styles}
        <div class="center">
            <img class="logo" src="${appData.settings.logo||''}" alt="Ù„ÙˆÚ¯Ùˆ">
            <div class="bold">${appData.settings.companyName}</div>
            <div>ØªØ§Ø±ÛŒØ®: ${c.date}</div>
        </div>
        <div class="line"></div>
        <div>
            <div>Ù…Ø´ØªØ±ÛŒ: ${c.customer}</div>
            <div>ØªÙ„ÙÙ†: ${c.phone}</div>
        </div>
        <div class="line"></div>
        <table style="width:100%;font-size:9pt;">
            <thead><tr><th>#</th><th>Ú©Ø§Ù„Ø§</th><th>Ù…ØªØ±</th><th>ÙÛŒ</th><th>Ú©Ù„</th></tr></thead>
            <tbody>
                ${c.products.map((p,i)=>`<tr><td>${i+1}</td><td>${p.type}</td><td>${p.meterage}</td><td>${p.price.toLocaleString('fa-IR')}</td><td>${p.total.toLocaleString('fa-IR')}</td></tr>`).join('')}
            </tbody>
        </table>
        <div class="line"></div>
        <div class="bold">
            Ø¬Ù…Ø¹: ${c.totalAmount.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†<br>
            Ù†Ù‚Ø¯ÛŒ: ${c.advance.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†<br>
            Ú†Ú©: ${c.checkAmount.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†<br>
            <span style="color:${c.balance>0?'green':c.balance<0?'red':'orange'}">Ù…Ø§Ù†Ø¯Ù‡: ${c.balance.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†</span>
        </div>
        <div class="line"></div>
        <div class="center" style="font-size:8pt;">Ø¢Ø¯Ø±Ø³: ${appData.settings.companyAddress}<br>ØªÙ„ÙÙ†: ${appData.settings.companyPhone}</div>
    `;
    let iframe=document.getElementById('thermalFrame');
    if(iframe)document.body.removeChild(iframe);
    iframe=document.createElement('iframe');
    iframe.id='thermalFrame';
    iframe.style.position='absolute';iframe.style.top='-9999px';
    document.body.appendChild(iframe);
    iframe.contentDocument.write(content);
    iframe.contentDocument.close();
    iframe.contentWindow.focus();
    iframe.contentWindow.print();
}

/* ==================== ÙØ§Ú©ØªÙˆØ± â€“ ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† Ø¯Ø³ØªÛŒ ØªØ¹Ø¯Ø§Ø¯/Ù†ÙˆØ¹ Ú©Ø§Ù„Ø§ ==================== */
function loadContractsForInvoice(){
    const select=document.getElementById('invoiceContract');
    select.innerHTML='<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</option>';
    appData.contracts.filter(c=>c.status==='ÙØ¹Ø§Ù„').forEach(c=>{
        const option=document.createElement('option');
        option.value=c.id;
        option.textContent=`${c.customer} - ${c.date} - ${c.totalAmount.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†`;
        select.appendChild(option);
    });
    document.getElementById('factoryNameDisplay').textContent=appData.settings.companyName;
    document.getElementById('factoryAddressDisplay').textContent=appData.settings.companyAddress;
    document.getElementById('factoryPhoneDisplay').textContent=appData.settings.companyPhone;
    document.getElementById('factoryDate').textContent=new Date().toLocaleDateString('fa-IR');
}
function loadContractForInvoice(){
    const contractId=document.getElementById('invoiceContract').value;
    if(!contractId)return;
    const c=appData.contracts.find(x=>x.id==contractId);
    if(!c)return;
    document.getElementById('invoiceCustomer').value=c.customer;
    document.getElementById('invoicePhone').value=c.phone;
    document.getElementById('invoiceAddress').value=c.address||'';
    const tbody=document.getElementById('invoiceProductsTable');
    tbody.innerHTML='';
    c.products.forEach((p,i)=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
            <td>${i+1}</td>
            <td><input type="text" value="${p.type}" style="width:100%;border:1px solid #ccc;padding:4px" onchange="updateInvoiceProduct(${i},'type',this.value)"></td>
            <td><input type="number" value="${p.meterage}" style="width:100%;border:1px solid #ccc;padding:4px" onchange="updateInvoiceProduct(${i},'meterage',this.value)"></td>
            <td>${p.price.toLocaleString('fa-IR')}</td>
            <td id="inv-total-${i}">${p.total.toLocaleString('fa-IR')}</td>`;
        tbody.appendChild(tr);
    });
    const totalRow=document.createElement('tr');
    totalRow.style.fontWeight='bold';totalRow.style.background='#f0f8ff';
    totalRow.innerHTML=`<td colspan="4">Ø¬Ù…Ø¹ Ú©Ù„</td><td>${c.totalAmount.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†</td>`;
    tbody.appendChild(totalRow);
}
function updateInvoiceProduct(idx,field,val){
    const c=appData.contracts.find(x=>x.id==document.getElementById('invoiceContract').value);
    if(!c)return;
    if(field==='meterage'){
        c.products[idx].meterage=parseFloat(val)||0;
        c.products[idx].total=c.products[idx].meterage*c.products[idx].price;
    }else{
        c.products[idx].type=val;
    }
    document.getElementById(`inv-total-${idx}`).textContent=c.products[idx].total.toLocaleString('fa-IR');
}
function generateInvoice(){
    const contractId=document.getElementById('invoiceContract').value;
    const driver=document.getElementById('invoiceDriver').value.trim();
    const carPlate=document.getElementById('invoiceCarPlate').value.trim();
    const deliveryDate=document.getElementById('invoiceDeliveryDate').value;
    const receiverName=document.getElementById('receiverName').value.trim();
    if(!contractId){showNotification('Ù„Ø·ÙØ§ ÛŒÚ© Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯','error');return;}
    if(!driver){showNotification('Ù†Ø§Ù… Ø±Ø§Ù†Ù†Ø¯Ù‡ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª','error');return;}
    if(!carPlate){showNotification('Ù¾Ù„Ø§Ú© Ø®ÙˆØ¯Ø±Ùˆ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª','error');return;}
    if(!deliveryDate){showNotification('ØªØ§Ø±ÛŒØ® ØªØ­ÙˆÛŒÙ„ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª','error');return;}
    document.getElementById('driverNameDisplay').textContent=driver;
    document.getElementById('carPlateDisplay').textContent=carPlate;
    showNotification('ÙØ§Ú©ØªÙˆØ± Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯. Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ú†Ø§Ù¾ ÛŒØ§ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ù†ÛŒØ¯.');
}
function printInvoice(){
    const contractId=document.getElementById('invoiceContract').value;
    if(!contractId){showNotification('Ù„Ø·ÙØ§ Ø§Ø¨ØªØ¯Ø§ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯','error');return;}
    const c=appData.contracts.find(x=>x.id==contractId);
    const driver=document.getElementById('invoiceDriver').value;
    const carPlate=document.getElementById('invoiceCarPlate').value;
    const deliveryDate=document.getElementById('invoiceDeliveryDate').value;
    const receiverName=document.getElementById('receiverName').value;
    const printWindow=window.open('','invoicePrint','width=800,height=600');
    printWindow.document.write(`
        <html dir="rtl">
        <head><title>ÙØ§Ú©ØªÙˆØ± ØªØ­ÙˆÛŒÙ„ Ú©Ø§Ù„Ø§</title></head>
        <body style="font-family:Tahoma;padding:20px;max-width:800px;margin:0 auto">
        <div style="text-align:center;border-bottom:2px solid #333;padding-bottom:10px;margin-bottom:20px">
            <h1>ÙØ§Ú©ØªÙˆØ± ØªØ­ÙˆÛŒÙ„ Ú©Ø§Ù„Ø§</h1>
            <h3>${appData.settings.companyName}</h3>
        </div>
        <div style="margin-bottom:20px">
            <h3>Ù…Ø´Ø®ØµØ§Øª Ù…Ø´ØªØ±ÛŒ</h3>
            <p><strong>Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ:</strong> ${c.customer}</p>
            <p><strong>ØªÙ„ÙÙ†:</strong> ${c.phone}</p>
            <p><strong>Ø¢Ø¯Ø±Ø³:</strong> ${c.address||'Ù†Ø¯Ø§Ø±Ø¯'}</p>
        </div>
        <div style="margin-bottom:20px">
            <h3>Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªØ­ÙˆÛŒÙ„</h3>
            <p><strong>Ø±Ø§Ù†Ù†Ø¯Ù‡:</strong> ${driver}</p>
            <p><strong>Ù¾Ù„Ø§Ú© Ø®ÙˆØ¯Ø±Ùˆ:</strong> ${carPlate}</p>
            <p><strong>ØªØ§Ø±ÛŒØ® ØªØ­ÙˆÛŒÙ„:</strong> ${deliveryDate}</p>
        </div>
        <h3>Ù„ÛŒØ³Øª Ù…Ø­ØµÙˆÙ„Ø§Øª</h3>
        <table style="width:100%;border-collapse:collapse;border:1px solid #ddd">
            <thead><tr style="background:#34495e;color:white"><th>Ø±Ø¯ÛŒÙ</th><th>Ù…Ø­ØµÙˆÙ„</th><th>Ù…ØªØ±Ø§Ú˜</th><th>ÙÛŒ Ù…ØªØ±</th><th>Ù…Ø¨Ù„Øº Ú©Ù„</th></tr></thead>
            <tbody>
                ${c.products.map((p,i)=>`<tr><td>${i+1}</td><td>${p.type}</td><td>${p.meterage}</td><td>${p.price.toLocaleString('fa-IR')}</td><td>${p.total.toLocaleString('fa-IR')}</td></tr>`).join('')}
                <tr style="font-weight:bold;background:#f0f8ff"><td colspan="4">Ø¬Ù…Ø¹ Ú©Ù„</td><td>${c.totalAmount.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†</td></tr>
            </tbody>
        </table>
        <div style="display:flex;justify-content:space-between;margin-top:40px">
            <div style="border:2px dashed #ccc;padding:15px;width:45%;min-height:120px;text-align:center">
                <h4>Ù…Ù‡Ø± Ùˆ Ø§Ù…Ø¶Ø§ÛŒ Ú©Ø§Ø±Ø®Ø§Ù†Ù‡</h4>
                <p>${appData.settings.companyName}</p>
                <p>ØªØ§Ø±ÛŒØ®: ${new Date().toLocaleDateString('fa-IR')}</p>
                <p>Ø§Ù…Ø¶Ø§Ø¡: ...........................</p>
            </div>
            <div style="border:2px dashed #ccc;padding:15px;width:45%;min-height:120px;text-align:center">
                <h4>Ø§Ù…Ø¶Ø§ÛŒ Ø±Ø§Ù†Ù†Ø¯Ù‡</h4>
                <p>Ù†Ø§Ù…: ${driver}</p>
                <p>Ù¾Ù„Ø§Ú©: ${carPlate}</p>
                <p>Ø§Ù…Ø¶Ø§Ø¡: ...........................</p>
            </div>
        </div>
        <div style="margin-top:20px">
            <div style="border:2px dashed #ccc;padding:15px;min-height:120px;text-align:center">
                <h4>Ø§Ù…Ø¶Ø§ÛŒ ØªØ­ÙˆÛŒÙ„â€ŒÚ¯ÛŒØ±Ù†Ø¯Ù‡</h4>
                <p>Ù†Ø§Ù…: ${receiverName||'...................'}</p>
                <p>Ú©Ø¯ Ù…Ù„ÛŒ: ${document.getElementById('receiverNationalCode').value||'...................'}</p>
                <p>Ø§Ù…Ø¶Ø§Ø¡: ...........................</p>
            </div>
        </div>
        <div style="margin-top:30px;text-align:center;border-top:1px solid #ccc;padding-top:10px;font-size:12px">
            <p>Ø§ÛŒÙ† ÙØ§Ú©ØªÙˆØ± Ø¨Ù‡ Ù…Ù†Ø²Ù„Ù‡ Ø±Ø³ÛŒØ¯ ØªØ­ÙˆÛŒÙ„ Ú©Ø§Ù„Ø§ Ù…ÛŒâ€ŒØ¨Ø§Ø´Ø¯.</p>
            <p>${appData.settings.companyName} - ${appData.settings.companyAddress} - ØªÙ„ÙÙ†: ${appData.settings.companyPhone}</p>
        </div>
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
    printWindow.close();
}
function downloadInvoicePDF(){
    const contractId=document.getElementById('invoiceContract').value;
    if(!contractId){showNotification('Ù„Ø·ÙØ§ Ø§Ø¨ØªØ¯Ø§ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯','error');return;}
    const c=appData.contracts.find(x=>x.id==contractId);
    const driver=document.getElementById('invoiceDriver').value;
    const carPlate=document.getElementById('invoiceCarPlate').value;
    const deliveryDate=document.getElementById('invoiceDeliveryDate').value;
    const receiverName=document.getElementById('receiverName').value;
    const {jsPDF}=window.jspdf;
    const doc=new jsPDF({orientation:'p',unit:'mm',format:'a4'});
    doc.setFont('Tahoma');
    doc.addImage(appData.settings.logo||'', 'PNG', 170, 10, 30, 30, undefined, 'FAST');
    doc.text(appData.settings.companyName, 10, 20);
    doc.text(`ØªØ§Ø±ÛŒØ®: ${new Date().toLocaleDateString('fa-IR')}`, 10, 30);
    doc.text(`Ù…Ø´ØªØ±ÛŒ: ${c.customer}`, 10, 40);
    doc.text(`ØªÙ„ÙÙ†: ${c.phone}`, 10, 50);
    doc.text(`Ø¢Ø¯Ø±Ø³: ${c.address}`, 10, 60);
    doc.text(`Ø±Ø§Ù†Ù†Ø¯Ù‡: ${driver}`, 10, 70);
    doc.text(`Ù¾Ù„Ø§Ú©: ${carPlate}`, 10, 80);
    doc.text(`ØªØ§Ø±ÛŒØ® ØªØ­ÙˆÛŒÙ„: ${deliveryDate}`, 10, 90);
    doc.autoTable({
        head:[['Ø±Ø¯ÛŒÙ','Ù…Ø­ØµÙˆÙ„','Ù…ØªØ±Ø§Ú˜','ÙÛŒ (ØªÙˆÙ…Ø§Ù†)','Ú©Ù„ (ØªÙˆÙ…Ø§Ù†)']],
        body:c.products.map((p,i)=>[i+1,p.type,p.meterage,p.price.toLocaleString('fa-IR'),p.total.toLocaleString('fa-IR')]),
        startY:100,
        theme:'grid',
        styles:{font:'Tahoma',halign:'right'}
    });
    const finalY=doc.lastAutoTable.finalY+10;
    doc.text(`Ø¬Ù…Ø¹ Ú©Ù„: ${c.totalAmount.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†`, 10, finalY);
    doc.text(`Ù†Ù‚Ø¯ÛŒ: ${c.advance.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†`, 10, finalY+10);
    doc.text(`Ú†Ú©: ${c.checkAmount.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†`, 10, finalY+20);
    doc.text(`Ù…Ø§Ù†Ø¯Ù‡: ${c.balance.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†`, 10, finalY+30);
    doc.save(`ÙØ§Ú©ØªÙˆØ±-ØªØ­ÙˆÛŒÙ„-${c.customer}-${deliveryDate}.pdf`);
    showNotification('PDF ÙØ§Ú©ØªÙˆØ± Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯');
}
function resetInvoiceForm(){
    document.getElementById('invoiceContract').value='';
    document.getElementById('invoiceCustomer').value='';
    document.getElementById('invoicePhone').value='';
    document.getElementById('invoiceAddress').value='';
    document.getElementById('invoiceDriver').value='';
    document.getElementById('invoiceCarPlate').value='';
    document.getElementById('invoiceDeliveryDate').value='';
    document.getElementById('receiverName').value='';
    document.getElementById('receiverNationalCode').value='';
    document.getElementById('driverNameDisplay').textContent='';
    document.getElementById('carPlateDisplay').textContent='';
    document.getElementById('invoiceProductsTable').innerHTML='';
}

/* ==================== Ù†ÙˆØ¨Øª Ø§Ø±Ø³Ø§Ù„ ==================== */
function saveDelivery(){
    const customer=document.getElementById('deliveryCustomer').value.trim();
    const date=document.getElementById('deliveryDateInput').value;
    const slot=document.getElementById('deliveryTimeSlot').value;
    if(!customer||!date||!slot){showNotification('ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø³ØªØ§Ø±Ù‡â€ŒØ¯Ø§Ø± Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯','error');return;}
    const delivery={id:Date.now(),customer,date,timeSlot:slot,description:document.getElementById('deliveryDescription').value};
    appData.deliveries.push(delivery);
    logAudit('Ø«Ø¨Øª Ù†ÙˆØ¨Øª Ø§Ø±Ø³Ø§Ù„',customer);
    saveData();displayDeliveries();resetDeliveryForm();showNotification('Ù†ÙˆØ¨Øª Ø§Ø±Ø³Ø§Ù„ Ø«Ø¨Øª Ø´Ø¯');
}
function resetDeliveryForm(){document.getElementById('deliveryCustomer').value='';document.getElementById('deliveryDateInput').value='';document.getElementById('deliveryTimeSlot').value='';document.getElementById('deliveryDescription').value='';}
function displayDeliveries(){
    const tbody=document.getElementById('deliveriesTable');tbody.innerHTML='';
    if(appData.deliveries.length===0){tbody.innerHTML='<tr><td colspan="6" style="text-align:center;padding:20px">Ù†ÙˆØ¨ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</td></tr>';return;}
    appData.deliveries.forEach((d,i)=>{
        const row=document.createElement('tr');
        row.innerHTML=`
            <td>${i+1}</td><td>${d.customer}</td><td>${d.date}</td><td>${d.timeSlot}</td><td>${d.description}</td>
            <td>
                <button class="btn btn-warning btn-sm" onclick="editDelivery(${d.id})">ÙˆÛŒØ±Ø§ÛŒØ´</button>
                <button class="btn btn-danger btn-sm" onclick="deleteDelivery(${d.id})">Ø­Ø°Ù</button>
            </td>
        `;tbody.appendChild(row);
    });
}
function editDelivery(id){const d=appData.deliveries.find(x=>x.id===id);if(!d)return;document.getElementById('deliveryCustomer').value=d.customer;document.getElementById('deliveryDateInput').value=d.date;document.getElementById('deliveryTimeSlot').value=d.timeSlot;document.getElementById('deliveryDescription').value=d.description;appData.deliveries=appData.deliveries.filter(x=>x.id!==id);saveData();displayDeliveries();showNotification('Ù†ÙˆØ¨Øª Ø¯Ø± Ø­Ø§Ù„Øª ÙˆÛŒØ±Ø§ÛŒØ´ Ù‚Ø±Ø§Ø± Ú¯Ø±ÙØª','info');}
function deleteDelivery(id){if(confirm('Ù†ÙˆØ¨Øª Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')){appData.deliveries=appData.deliveries.filter(x=>x.id!==id);saveData();displayDeliveries();showNotification('Ù†ÙˆØ¨Øª Ø­Ø°Ù Ø´Ø¯');}}

/* ==================== Ù…Ø´ØªØ±ÛŒØ§Ù† ==================== */
function saveCustomer(){
    try{
        const name=document.getElementById('customerName').value.trim();
        const phone=document.getElementById('customerPhone').value.trim();
        const nationalCode=document.getElementById('customerNationalCode').value.trim();
        if(!name||!phone||!nationalCode){showNotification('Ù†Ø§Ù…ØŒ ØªÙ…Ø§Ø³ Ùˆ Ú©Ø¯ Ù…Ù„ÛŒ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª','error');return;}
        if(!/^09[0-9]{9}$/.test(phone)){showNotification('Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Û±Û° Ø±Ù‚Ù…ÛŒ Ùˆ Ø¨Ø§ Û°Û¹ Ø´Ø±ÙˆØ¹ Ø´ÙˆØ¯','error');return;}
        if(!isMobileUnique(phone,editingId)){showNotification('Ø§ÛŒÙ† Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øª Ø´Ø¯Ù‡','error');return;}
        const customer={id:editingId||Date.now(),name,phone,nationalCode,address:document.getElementById('customerAddress').value,type:document.getElementById('customerType').value,registrationDate:new Date().toLocaleDateString('fa-IR')};
        if(editingId){const i=appData.customers.findIndex(c=>c.id===editingId);appData.customers[i]=customer;}else{appData.customers.push(customer);}
        logAudit('Ø«Ø¨Øª/ÙˆÛŒØ±Ø§ÛŒØ´ Ù…Ø´ØªØ±ÛŒ',name);
        saveData();displayCustomers();resetCustomerForm();fillCustomerList();showNotification('Ù…Ø´ØªØ±ÛŒ Ø«Ø¨Øª Ø´Ø¯');
    }catch(e){
        logAudit('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù…Ø´ØªØ±ÛŒ',e.message);
        showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù…Ø´ØªØ±ÛŒ','error');
    }
}
function resetCustomerForm(){editingId=null;document.getElementById('customerName').value='';document.getElementById('customerPhone').value='';document.getElementById('customerNationalCode').value='';document.getElementById('customerAddress').value='';document.getElementById('customerType').value='Ø¹Ø§Ø¯ÛŒ';}
function displayCustomers(){
    const tbody=document.getElementById('customersTable');tbody.innerHTML='';
    if(appData.customers.length===0){tbody.innerHTML='<tr><td colspan="7" style="text-align:center;padding:20px">Ù…Ø´ØªØ±ÛŒâ€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</td></tr>';return;}
    appData.customers.forEach((c,i)=>{
        const row=document.createElement('tr');
        row.innerHTML=`
            <td>${i+1}</td><td>${c.name}</td><td>${c.phone}</td><td>${c.nationalCode}</td><td>${c.type}</td><td>${c.address}</td>
            <td>
                <button class="btn btn-warning btn-sm" onclick="editCustomer(${c.id})">ÙˆÛŒØ±Ø§ÛŒØ´</button>
                <button class="btn btn-danger btn-sm" onclick="deleteCustomer(${c.id})">Ø­Ø°Ù</button>
            </td>
        `;tbody.appendChild(row);
    });
}
function editCustomer(id){const c=appData.customers.find(x=>x.id===id);if(!c)return;editingId=c.id;document.getElementById('customerName').value=c.name;document.getElementById('customerPhone').value=c.phone;document.getElementById('customerNationalCode').value=c.nationalCode;document.getElementById('customerAddress').value=c.address;document.getElementById('customerType').value=c.type;showNotification('Ù…Ø´ØªØ±ÛŒ Ø¯Ø± Ø­Ø§Ù„Øª ÙˆÛŒØ±Ø§ÛŒØ´ Ù‚Ø±Ø§Ø± Ú¯Ø±ÙØª','info');}
function deleteCustomer(id){if(confirm('Ù…Ø´ØªØ±ÛŒ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')){appData.customers=appData.customers.filter(x=>x.id!==id);saveData();displayCustomers();fillCustomerList();showNotification('Ù…Ø´ØªØ±ÛŒ Ø­Ø°Ù Ø´Ø¯');}}

/* ==================== Ú©Ø§Ø±Ú©Ù†Ø§Ù† ==================== */
function saveWorker(){
    try{
        const name=document.getElementById('workerName').value.trim();
        const phone=document.getElementById('workerPhone').value.trim();
        const nationalCode=document.getElementById('workerNationalCode').value.trim();
        if(!name){showNotification('Ù†Ø§Ù… Ú©Ø§Ø±Ú¯Ø± Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª','error');return;}
        if(phone&&!/^09[0-9]{9}$/.test(phone)){showNotification('Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª','error');return;}
        const worker={id:editingId||Date.now(),name,nationalCode,phone,position:document.getElementById('workerPosition').value,salary:parseFloat(document.getElementById('workerSalary').value)||0,hireDate:document.getElementById('workerHireDate').value};
        if(editingId){const i=appData.workers.findIndex(w=>w.id===editingId);appData.workers[i]=worker;}else{appData.workers.push(worker);}
        logAudit('Ø«Ø¨Øª/ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ø±Ú¯Ø±',name);
        saveData();displayWorkers();resetWorkerForm();showNotification('Ú©Ø§Ø±Ú¯Ø± Ø«Ø¨Øª Ø´Ø¯');
    }catch(e){
        logAudit('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ú©Ø§Ø±Ú¯Ø±',e.message);
        showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ú©Ø§Ø±Ú¯Ø±','error');
    }
}
function resetWorkerForm(){editingId=null;document.getElementById('workerName').value='';document.getElementById('workerNationalCode').value='';document.getElementById('workerPhone').value='';document.getElementById('workerPosition').value='Ú©Ø§Ø±Ú¯Ø±';document.getElementById('workerSalary').value='';document.getElementById('workerHireDate').value='';}
function displayWorkers(){
    const tbody=document.getElementById('workersTable');tbody.innerHTML='';
    if(appData.workers.length===0){tbody.innerHTML='<tr><td colspan="7" style="text-align:center;padding:20px">Ú©Ø§Ø±Ú¯Ø±ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</td></tr>';return;}
    appData.workers.forEach((w,i)=>{
        const row=document.createElement('tr');
        row.innerHTML=`
            <td>${i+1}</td><td>${w.name}</td><td>${w.nationalCode||'-'}</td><td>${w.phone||'-'}</td><td>${w.position}</td><td>${w.salary.toLocaleString('fa-IR')}</td>
            <td>
                <button class="btn btn-warning btn-sm" onclick="editWorker(${w.id})">ÙˆÛŒØ±Ø§ÛŒØ´</button>
                <button class="btn btn-danger btn-sm" onclick="deleteWorker(${w.id})">Ø­Ø°Ù</button>
            </td>
        `;tbody.appendChild(row);
    });
}
function editWorker(id){const w=appData.workers.find(x=>x.id===id);if(!w)return;editingId=w.id;document.getElementById('workerName').value=w.name;document.getElementById('workerNationalCode').value=w.nationalCode;document.getElementById('workerPhone').value=w.phone;document.getElementById('workerPosition').value=w.position;document.getElementById('workerSalary').value=w.salary;document.getElementById('workerHireDate').value=w.hireDate;showNotification('Ú©Ø§Ø±Ú¯Ø± Ø¯Ø± Ø­Ø§Ù„Øª ÙˆÛŒØ±Ø§ÛŒØ´ Ù‚Ø±Ø§Ø± Ú¯Ø±ÙØª','info');}
function deleteWorker(id){if(confirm('Ú©Ø§Ø±Ú¯Ø± Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')){appData.workers=appData.workers.filter(x=>x.id!==id);saveData();displayWorkers();showNotification('Ú©Ø§Ø±Ú¯Ø± Ø­Ø°Ù Ø´Ø¯');}}

/* ==================== Ù…Ø§Ù„ÛŒ ==================== */
function toggleWorkerSelect(){
    const cat=document.getElementById('transactionCategory').value;
    const group=document.getElementById('workerSelectGroup');
    const sel=document.getElementById('workerSelect');
    if(cat==='Ø­Ù‚ÙˆÙ‚ Ú©Ø§Ø±Ú¯Ø±Ø§Ù†'||cat==='Ú©Ø±Ø§ÛŒÙ‡ Ø±Ø§Ù†Ù†Ø¯Ú¯Ø§Ù†'){
        group.style.display='block';
        sel.innerHTML='<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>';
        const list=cat==='Ø­Ù‚ÙˆÙ‚ Ú©Ø§Ø±Ú¯Ø±Ø§Ù†'?appData.workers.filter(w=>w.position!=='Ø±Ø§Ù†Ù†Ø¯Ù‡'):appData.workers.filter(w=>w.position==='Ø±Ø§Ù†Ù†Ø¯Ù‡');
        list.forEach(w=>{const o=document.createElement('option');o.value=w.name;o.textContent=`${w.name} (${w.phone})`;sel.appendChild(o);});
    }else{group.style.display='none';}
}
function loadSubCategory(){toggleWorkerSelect();}
function saveTransaction(){
    try{
        const type=document.getElementById('transactionType').value;
        const amount=parseFloat(document.getElementById('transactionAmount').value);
        const category=document.getElementById('transactionCategory').value;
        const worker=document.getElementById('workerSelect').value;
        if(!amount||amount<=0){showNotification('Ù…Ø¨Ù„Øº Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯','error');return;}
        const description=`${document.getElementById('transactionDescription').value} ${worker?`(${worker})`:''}`;
        const transaction={id:Date.now(),type,amount,category,description,date:document.getElementById('transactionDate').value||new Date().toLocaleDateString('fa-IR')};
        appData.transactions.push(transaction);
        logAudit('Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´',`${type} ${amount}`);
        saveData();displayTransactions();resetTransactionForm();showNotification('ØªØ±Ø§Ú©Ù†Ø´ Ø«Ø¨Øª Ø´Ø¯');
    }catch(e){
        logAudit('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´',e.message);
        showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´','error');
    }
}
function resetTransactionForm(){document.getElementById('transactionAmount').value='';document.getElementById('transactionDescription').value='';document.getElementById('transactionDate').value='';document.getElementById('workerSelect').value='';}
function displayTransactions(){
    const tbody=document.getElementById('transactionsTable');tbody.innerHTML='';
    if(appData.transactions.length===0){tbody.innerHTML='<tr><td colspan="7" style="text-align:center;padding:20px">ØªØ±Ø§Ú©Ù†Ø´ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</td></tr>';return;}
    const income=appData.transactions.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
    const expense=appData.transactions.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
    document.getElementById('totalIncomeFinance').textContent=income.toLocaleString('fa-IR');
    document.getElementById('totalExpenseFinance').textContent=expense.toLocaleString('fa-IR');
    document.getElementById('netProfit').textContent=(income-expense).toLocaleString('fa-IR');
    appData.transactions.forEach((t,i)=>{
        const row=document.createElement('tr');
        row.innerHTML=`
            <td>${i+1}</td><td>${t.date}</td><td>${t.type==='income'?'Ø¯Ø±Ø¢Ù…Ø¯':'Ù‡Ø²ÛŒÙ†Ù‡'}</td><td>${t.category}</td><td>${t.description}</td><td>${t.amount.toLocaleString('fa-IR')}</td>
            <td>
                <button class="btn btn-warning btn-sm" onclick="editTransaction(${t.id})">ÙˆÛŒØ±Ø§ÛŒØ´</button>
                <button class="btn btn-danger btn-sm" onclick="deleteTransaction(${t.id})">Ø­Ø°Ù</button>
            </td>
        `;tbody.appendChild(row);
    });
}
function editTransaction(id){const t=appData.transactions.find(x=>x.id===id);if(!t)return;document.getElementById('transactionType').value=t.type;document.getElementById('transactionAmount').value=t.amount;document.getElementById('transactionCategory').value=t.category;document.getElementById('transactionDescription').value=t.description;document.getElementById('transactionDate').value=t.date;toggleWorkerSelect();appData.transactions=appData.transactions.filter(x=>x.id!==id);saveData();displayTransactions();showNotification('ØªØ±Ø§Ú©Ù†Ø´ Ø¯Ø± Ø­Ø§Ù„Øª ÙˆÛŒØ±Ø§ÛŒØ´ Ù‚Ø±Ø§Ø± Ú¯Ø±ÙØª','info');}
function deleteTransaction(id){if(confirm('ØªØ±Ø§Ú©Ù†Ø´ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')){appData.transactions=appData.transactions.filter(x=>x.id!==id);saveData();displayTransactions();showNotification('ØªØ±Ø§Ú©Ù†Ø´ Ø­Ø°Ù Ø´Ø¯');}}

/* ==================== Ú†Ú©â€ŒÙ‡Ø§ â€“ Ø«Ø¨Øª Ø¬Ø¯ÛŒØ¯ + Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ ØªØ§Ø±ÛŒØ®ÛŒ ==================== */
function sortChecksByDueDate(){
    appData.checks.sort((a,b)=>{
        const [y1,m1,d1]=a.dueDate.split('/').map(Number);
        const [y2,m2,d2]=b.dueDate.split('/').map(Number);
        return new Date(y1,m1-1,d1)-new Date(y2,m2-1,d2);
    });
}
function addNewCheck(){
    const num  = prompt('Ø´Ù…Ø§Ø±Ù‡ Ú†Ú©:');
    const amt  = parseFloat(prompt('Ù…Ø¨Ù„Øº (ØªÙˆÙ…Ø§Ù†):'))||0;
    const due  = prompt('ØªØ§Ø±ÛŒØ® Ø³Ø±Ø±Ø³ÛŒØ¯ (Û±Û´Û°Û´/Û°Û³/Û²Ûµ):');
    const bank = prompt('Ø¨Ø§Ù†Ú©:');
    const cust = prompt('Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ:');
    if(!num||!due||!bank||!cust)return;
    appData.checks.push({
        id:Date.now(),
        contractId:null,
        customer:cust,
        number:num,
        amount:amt,
        dueDate:due,
        bank:bank,
        status:'Ø¯Ø± Ø¬Ø±ÛŒØ§Ù†',
        createdDate:new Date().toLocaleDateString('fa-IR')
    });
    sortChecksByDueDate();
    saveData();displayAllChecks();
    showNotification('Ú†Ú© Ø¬Ø¯ÛŒØ¯ Ø«Ø¨Øª Ø´Ø¯');
}
function displayAllChecks(){
    sortChecksByDueDate();
    const tbody=document.getElementById('allChecksTable');tbody.innerHTML='';
    if(appData.checks.length===0){tbody.innerHTML='<tr><td colspan="8" style="text-align:center;padding:20px">Ú†Ú©ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</td></tr>';return;}
    appData.checks.forEach((c,i)=>{
        const row=document.createElement('tr');
        row.innerHTML=`
            <td>${i+1}</td><td>${c.number}</td><td>${c.customer}</td><td>${c.amount.toLocaleString('fa-IR')}</td><td>${c.dueDate}</td><td>${c.bank}</td><td>${c.status}</td>
            <td>
                <button class="btn btn-warning btn-sm" onclick="editCheck(${c.id})">ÙˆÛŒØ±Ø§ÛŒØ´</button>
                <button class="btn btn-danger btn-sm" onclick="deleteCheck(${c.id})">Ø­Ø°Ù</button>
            </td>
        `;tbody.appendChild(row);
    });
}
function editCheck(id){const c=appData.checks.find(x=>x.id===id);if(!c)return;const status=prompt('ÙˆØ¶Ø¹ÛŒØª Ø¬Ø¯ÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ø¯Ø± Ø¬Ø±ÛŒØ§Ù† / Ù¾Ø§Ø³â€ŒØ´Ø¯Ù‡ / Ø¨Ø±Ú¯Ø´ØªÛŒ / ÙˆØµÙˆÙ„â€ŒØ¬Ø²Ø¦ÛŒ)',c.status);if(status){c.status=status;logAudit('ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ú†Ú©',`${c.number} â†’ ${status}`);saveData();displayAllChecks();showNotification('ÙˆØ¶Ø¹ÛŒØª Ú†Ú© Ø¨Ù‡â€ŒØ±ÙˆØ² Ø´Ø¯');}}
function deleteCheck(id){if(confirm('Ú†Ú© Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')){appData.checks=appData.checks.filter(x=>x.id!==id);saveData();displayAllChecks();showNotification('Ú†Ú© Ø­Ø°Ù Ø´Ø¯');}}

/* ==================== Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ ==================== */
function updateBackupInfo(){document.getElementById('lastBackupDate').textContent=localStorage.getItem('lastBackup')||'Ù‡ÛŒÚ†';}
function exportBackup(){
    const data=JSON.stringify(appData);
    const encrypted=btoa(data);
    const blob=new Blob([encrypted],{type:'application/json'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download=`backup-${new Date().toLocaleDateString('fa-IR')}.json`;
    a.click();
    showNotification('Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø±Ù…Ø²Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯Ù‡ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯');
}
function importBackup(e){
    const file=e.target.files[0];if(!file)return;
    const reader=new FileReader();
    reader.onload=function(ev){
        try{
            const decrypted=atob(ev.target.result);
            localStorage.setItem('kaleshiFoamDataV8',decrypted);
            location.reload();
        }catch{showNotification('ÙØ§ÛŒÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª','error');}
    };
    reader.readAsText(file);
}
function exportToExcel(){
    const wb=XLSX.utils.book_new();
    const ws1=XLSX.utils.json_to_sheet(appData.contracts);
    const ws2=XLSX.utils.json_to_sheet(appData.customers);
    const ws3=XLSX.utils.json_to_sheet(appData.workers);
    const ws4=XLSX.utils.json_to_sheet(appData.transactions);
    const ws5=XLSX.utils.json_to_sheet(appData.checks);
    XLSX.utils.book_append_sheet(wb,ws1,'Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§');
    XLSX.utils.book_append_sheet(wb,ws2,'Ù…Ø´ØªØ±ÛŒØ§Ù†');
    XLSX.utils.book_append_sheet(wb,ws3,'Ú©Ø§Ø±Ú©Ù†Ø§Ù†');
    XLSX.utils.book_append_sheet(wb,ws4,'ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§');
    XLSX.utils.book_append_sheet(wb,ws5,'Ú†Ú©â€ŒÙ‡Ø§');
    XLSX.writeFile(wb,`Ú¯Ø²Ø§Ø±Ø´-Ú©Ø§Ù…Ù„-${new Date().toLocaleDateString('fa-IR')}.xlsx`);
}
function exportToPDF(){
    const {jsPDF}=window.jspdf;
    const doc=new jsPDF();
    doc.text('Ú¯Ø²Ø§Ø±Ø´ Ú©Ø§Ù…Ù„',10,10);
    doc.text(JSON.stringify(appData,null,2),10,20);
    doc.save(`Ú¯Ø²Ø§Ø±Ø´-Ú©Ø§Ù…Ù„-${new Date().toLocaleDateString('fa-IR')}.pdf`);
}

/* ==================== Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ â€“ Ù†Ù…Ø§ÛŒØ´ ÙˆØ§Ù‚Ø¹ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ ==================== */
function generateReport(){
    const type=document.getElementById('reportType').value;
    const from=document.getElementById('reportFromDate').value;
    const to=document.getElementById('reportToDate').value;
    let html=`<h3>Ú¯Ø²Ø§Ø±Ø´ ${type}</h3><p>Ø§Ø² ${from} ØªØ§ ${to}</p><table border="1" width="100%" style="text-align:center"><thead><tr><th>Ø±Ø¯ÛŒÙ</th><th>Ù…Ø´Ø®ØµØ§Øª</th><th>Ù…Ø¨Ù„Øº (ØªÙˆÙ…Ø§Ù†)</th></tr></thead><tbody>`;
    if(type==='financial'){
        const income=appData.transactions.filter(t=>t.type==='income'&&t.date>=from&&t.date<=to).reduce((s,t)=>s+t.amount,0);
        const expense=appData.transactions.filter(t=>t.type==='expense'&&t.date>=from&&t.date<=to).reduce((s,t)=>s+t.amount,0);
        html+=`<tr><td>1</td><td>Ú©Ù„ Ø¯Ø±Ø¢Ù…Ø¯</td><td>${income.toLocaleString('fa-IR')}</td></tr>`;
        html+=`<tr><td>2</td><td>Ú©Ù„ Ù‡Ø²ÛŒÙ†Ù‡</td><td>${expense.toLocaleString('fa-IR')}</td></tr>`;
        html+=`<tr><td>3</td><td>Ø³ÙˆØ¯ Ø®Ø§Ù„Øµ</td><td>${(income-expense).toLocaleString('fa-IR')}</td></tr>`;
    }
    if(type==='contracts'){
        const list=appData.contracts.filter(c=>c.date>=from&&c.date<=to);
        list.forEach((c,i)=>{html+=`<tr><td>${i+1}</td><td>${c.customer}</td><td>${c.totalAmount.toLocaleString('fa-IR')}</td></tr>`;});
    }
    if(type==='checks'){
        const list=appData.checks.filter(ch=>ch.dueDate>=from&&ch.dueDate<=to);
        list.forEach((ch,i)=>{html+=`<tr><td>${i+1}</td><td>${ch.customer} - ${ch.number}</td><td>${ch.amount.toLocaleString('fa-IR')}</td></tr>`;});
    }
    html+='</tbody></table>';
    document.getElementById('reportPreview').innerHTML=html||'<p style="text-align:center;padding:40px">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</p>';
}
function exportReportToExcel(){
    const wb=XLSX.utils.book_new();
    const ws=XLSX.utils.json_to_sheet(appData.transactions);
    XLSX.utils.book_append_sheet(wb,ws,'Ú¯Ø²Ø§Ø±Ø´');
    XLSX.writeFile(wb,`Ú¯Ø²Ø§Ø±Ø´-Ø§Ù†ØªØ®Ø§Ø¨ÛŒ-${new Date().toLocaleDateString('fa-IR')}.xlsx`);
}
function exportReportToPDF(){
    const {jsPDF}=window.jspdf;
    const doc=new jsPDF();
    doc.text('Ú¯Ø²Ø§Ø±Ø´ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ',10,10);
    doc.text(JSON.stringify(appData.transactions,null,2),10,20);
    doc.save(`Ú¯Ø²Ø§Ø±Ø´-Ø§Ù†ØªØ®Ø§Ø¨ÛŒ-${new Date().toLocaleDateString('fa-IR')}.pdf`);
}
function printReport(){
    const printWindow=window.open('','printWindow');
    printWindow.document.write(document.getElementById('reportPreview').innerHTML);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
    printWindow.close();
}

/* ==================== ØªÙ†Ø¸ÛŒÙ…Ø§Øª ==================== */
function saveSettings(){
    appData.settings.companyName=document.getElementById('companyName').value;
    appData.settings.companyPhone=document.getElementById('companyPhone').value;
    appData.settings.companyAddress=document.getElementById('companyAddress').value;
    saveData();applyLogo();showNotification('ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
}
function loadSettings(){
    document.getElementById('companyName').value=appData.settings.companyName;
    document.getElementById('companyPhone').value=appData.settings.companyPhone;
    document.getElementById('companyAddress').value=appData.settings.companyAddress;
    if(appData.settings.logo){document.getElementById('logoPreview').src=appData.settings.logo;document.getElementById('logoPreview').style.display='block';}
}
function showSystemInfo(){
    alert(`ÙˆØ±Ú˜Ù† Ø¨Ø±Ù†Ø§Ù…Ù‡: Û¸.Û°\nØªØ§Ø±ÛŒØ® Ø³Ø§Ø®Øª: Û²Û°Û²Ûµ\nØ³Ø§Ø²Ù†Ø¯Ù‡: Ú©Ù„Ø´ÛŒâ€ŒÙÙˆÙ…\nØ­Ø¬Ù… Ø¯Ø§Ø¯Ù‡: ${JSON.stringify(appData).length} Ú©Ø§Ø±Ø§Ú©ØªØ±`);
}
function changePasswordFromSettings(){
    const current=document.getElementById('currentPasswordSettings').value;
    const newPass=document.getElementById('newPasswordSettings').value;
    const confirmPass=document.getElementById('confirmNewPasswordSettings').value;
    if(btoa(current)!==appData.auth.password){showNotification('Ø±Ù…Ø² ÙØ¹Ù„ÛŒ Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª','error');return;}
    if(newPass.length<4){showNotification('Ø±Ù…Ø² Ø¬Ø¯ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ Û´ Ú©Ø§Ø±Ø§Ú©ØªØ± Ø¨Ø§Ø´Ø¯','error');return;}
    if(newPass!==confirmPass){showNotification('ØªÚ©Ø±Ø§Ø± Ø±Ù…Ø² Ù…Ø·Ø§Ø¨Ù‚Øª Ù†Ø¯Ø§Ø±Ø¯','error');return;}
    appData.auth.password=btoa(newPass);
    saveData();
    document.getElementById('currentPasswordSettings').value='';
    document.getElementById('newPasswordSettings').value='';
    document.getElementById('confirmNewPasswordSettings').value='';
    showNotification('Ø±Ù…Ø² Ø¹ÙˆØ¶ Ø´Ø¯');
}
function applyLogo(){
    if(appData.settings.logo){
        document.getElementById('logoPreview').src=appData.settings.logo;
        document.getElementById('logoPreview').style.display='block';
    }
}
function uploadLogo(e){
    const file=e.target.files[0];
    if(!file)return;
    const reader=new FileReader();
    reader.onload=function(ev){
        appData.settings.logo=ev.target.result;
        saveData();
        applyLogo();
        showNotification('Ù„ÙˆÚ¯Ùˆ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯');
    };
    reader.readAsDataURL(file);
}

/* ==================== Ù„Ø§Ú¯ Ø¹Ù…Ù„ÛŒØ§Øª ==================== */
function logAudit(action,detail){
    appData.auditLog.push({timestamp:new Date().toISOString(),user:appData.currentUser||'unknown',action,detail});
    localStorage.setItem('kaleshiFoamAuditV8',JSON.stringify(appData.auditLog));
}

/* ==================== ØªÙˆØ§Ø¨Ø¹ Ø¹Ù…ÙˆÙ…ÛŒ ==================== */
function filterTable(tableId,value){
    const rows=document.querySelectorAll(`#${tableId} tr`);
    rows.forEach(r=>{const txt=r.textContent||r.innerText;if(txt.indexOf(value)>-1){r.style.display=''}else{r.style.display='none';}});
}
function updateAll(){
    updateDashboard();
    displayContracts();
    displayDeliveries();
    displayCustomers();
    displayWorkers();
    displayTransactions();
    displayAllChecks();
    updateBackupInfo();
    loadSettings();
}
function generateContractNumber(){
    const year=new Date().toLocaleDateString('fa-IR').split('/')[0];
    const seq=(parseInt(localStorage.getItem('contractSeq')||'0')+1).toString().padStart(4,'0');
    localStorage.setItem('contractSeq',seq);
    return `${year}-${seq}`;
}

/* ==================== Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ùˆ Ø°Ø®ÛŒØ±Ù‡ ==================== */
function loadData(){
    try{
        const saved=localStorage.getItem('kaleshiFoamDataV8');
        if(saved){appData=JSON.parse(saved);applyLogo();}
        const audit=localStorage.getItem('kaleshiFoamAuditV8');
        if(audit){appData.auditLog=JSON.parse(audit);}
        updateAll();
        fillCustomerList();
        fillTodayDates();
    }catch(e){
        console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§:',e);
        showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§','error');
    }
}
function saveData(){localStorage.setItem('kaleshiFoamDataV8',JSON.stringify(appData));localStorage.setItem('lastBackup',new Date().toLocaleDateString('fa-IR'));}

/* ==================== Ø§Ø¹Ù„Ø§Ù† ==================== */
function showNotification(msg,type='success'){
    const n=document.createElement('div');n.className=`notification ${type}`;
    n.innerHTML=`<span>${type==='error'?'âŒ':'âœ…'}</span><span>${msg}</span><button onclick="this.parentElement.remove()" style="margin-left:auto;background:none;border:none;font-size:18px;cursor:pointer">Ã—</button>`;
    document.getElementById('notificationContainer').appendChild(n);setTimeout(()=>n.remove(),4000);
}

/* ==================== Ø´Ø±ÙˆØ¹ Ø¨Ø±Ù†Ø§Ù…Ù‡ ==================== */
window.onload=()=>{
    fillTodayDates();
    addProductRow();
    addCheckRow();
    calculateContract();
    document.addEventListener('keydown',e=>{
        if(e.ctrlKey && e.key==='s'){e.preventDefault();saveData();showNotification('Ø°Ø®ÛŒØ±Ù‡ Ø®ÙˆØ¯Ú©Ø§Ø± Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯');}
        if(e.ctrlKey && e.key==='p'){e.preventDefault();printThermal();}
    });
};
</script>
</body>
</html>
