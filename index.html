<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÛŒØ³ØªÙ… Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ ÛŒÙˆÙ†ÙˆÙ„ÛŒØª Ú©Ù„Ø´ÛŒâ€ŒÙÙˆÙ… - Ù†Ø³Ø®Ù‡ Ú©Ø§Ù…Ù„ v11.0</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/persian-date@1.1.0/dist/persian-date.min.js"></script>

    <style>
        :root {
            --primary: #1e3a8a; --secondary: #3b82f6; --success: #10b981; --warning: #f59e0b;
            --danger: #ef4444; --info: #06b6d4; --light: #f8fafc; --dark: #0f172a;
            --gray: #64748b; --shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            --border-radius: 12px; --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Vazirmatn', system-ui, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); min-height: 100vh; color: var(--dark); line-height: 1.6; }

        .container { max-width: 1400px; margin: 0 auto; padding: 0 20px; }
        .grid { display: grid; gap: 20px; }
        .grid-cols-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        .d-none { display: none !important; } .d-flex { display: flex !important; } .text-center { text-align: center; } .text-right { text-align: right; } .w-100 { width: 100%; }

        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 24px; border: none; border-radius: var(--border-radius); font-weight: 600; cursor: pointer; transition: var(--transition); font-size: 14px; text-decoration: none; position: relative; overflow: hidden; }
        .btn::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); transition: left 0.5s; }
        .btn:hover::before { left: 100%; } .btn:hover { transform: translateY(-2px); } .btn:active { transform: translateY(0); } .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-primary { background: var(--secondary); color: white; } .btn-success { background: var(--success); color: white; } .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: white; } .btn-info { background: var(--info); color: white; } .btn-sm { padding: 8px 16px; font-size: 13px; }

        .form-group { margin-bottom: 20px; } .form-label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--dark); font-size: 14px; }
        .form-control { width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: var(--border-radius); font-size: 15px; transition: var(--transition); background: white; font-family: inherit; }
        .form-control:focus { outline: none; border-color: var(--secondary); box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); transform: translateY(-1px); }
        .form-control.error { border-color: var(--danger); background: #fef2f2; } .error-message { color: var(--danger); font-size: 13px; margin-top: 6px; display: none; }
        .form-control.error + .error-message { display: block; }

        .card { background: white; border-radius: var(--border-radius); box-shadow: var(--shadow); overflow: hidden; transition: var(--transition); }
        .card:hover { transform: translateY(-4px); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .card-header { background: linear-gradient(135deg, var(--primary), #1e40af); color: white; padding: 20px 24px; display: flex; justify-content: space-between; align-items: center; }
        .card-title { font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 12px; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin: 24px 0; }
        .stat-card { background: linear-gradient(135deg, var(--secondary), #1d4ed8); color: white; padding: 24px; border-radius: var(--border-radius); text-align: center; position: relative; overflow: hidden; }
        .stat-value { font-size: 32px; font-weight: 800; margin-bottom: 8px; line-height: 1; }

        .table-container { overflow-x: auto; border-radius: var(--border-radius); border: 1px solid #e2e8f0; background: white; margin-top: 20px; }
        .table { width: 100%; border-collapse: collapse; min-width: 800px; } .table th { background: var(--primary); color: white; padding: 16px 12px; text-align: right; font-weight: 600; position: sticky; top: 0; z-index: 10; }
        .table td { padding: 14px 12px; border-bottom: 1px solid #f1f5f9; text-align: right; } .table tr:hover { background: #f8fafc; }

        .product-row { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 15px; align-items: end; margin-bottom: 15px; padding: 20px; background: #f8fafc; border-radius: var(--border-radius); border: 2px solid #e2e8f0; }
        .check-row { background: #e0f2fe; padding: 20px; margin: 15px 0; border-radius: var(--border-radius); border-left: 5px solid var(--info); }

        .totals-box { background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 24px; border-radius: var(--border-radius); margin: 24px 0; }
        .total-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 16px; } .total-row:last-child { font-size: 20px; font-weight: 800; border-top: 2px solid rgba(255,255,255,0.3); padding-top: 12px; margin-top: 12px; }

        .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 40px 20px; }
        .login-card { background: white; border-radius: 20px; padding: 48px; width: 100%; max-width: 420px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); position: relative; overflow: hidden; }
        .login-logo { width: 100px; height: 100px; margin: 0 auto 28px; background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 28px; font-weight: 800; box-shadow: 0 10px 25px rgba(30, 58, 138, 0.4); }

        .main-nav { background: var(--dark); padding: 0; display: flex; flex-wrap: wrap; overflow-x: auto; scrollbar-width: none; -ms-overflow-style: none; }
        .main-nav::-webkit-scrollbar { display: none; }
        .nav-btn { background: none; border: none; color: rgba(255,255,255,0.9); padding: 16px 24px; cursor: pointer; transition: var(--transition); font-size: 14px; font-weight: 500; white-space: nowrap; display: flex; align-items: center; gap: 10px; border-bottom: 3px solid transparent; }
        .nav-btn:hover { background: rgba(255,255,255,0.1); color: white; } .nav-btn.active { background: var(--secondary); color: white; border-bottom-color: rgba(255,255,255,0.3); }

        .page { display: none; animation: fadeIn 0.5s ease; } .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .search-box { position: relative; margin-bottom: 20px; } .search-input { width: 100%; padding: 14px 45px 14px 16px; border: 2px solid #e2e8f0; border-radius: var(--border-radius); }
        .search-icon { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--gray); font-size: 18px; }

        @media (max-width: 768px) { .container { padding: 0 16px; } .form-row { grid-template-columns: 1fr; } .product-row { grid-template-columns: 1fr; gap: 10px; } }
    </style>
</head>
<body>
    <div class="loading-overlay d-none" id="loadingOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 20px;">
        <div class="spinner" style="width: 60px; height: 60px; border: 6px solid #f3f3f3; border-top: 6px solid var(--secondary); border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <div id="loadingText" style="font-size: 16px; font-weight: 600;">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
    </div>
    <div class="notification-container" id="notificationContainer" style="position: fixed; top: 20px; right: 20px; z-index: 10000;"></div>

    <!-- Login Page -->
    <div class="login-container" id="loginPage">
        <div class="login-card">
            <div class="login-logo">CF</div>
            <h1 style="margin-bottom: 32px; font-size: 24px; font-weight: 800; color: var(--dark);">Ø³ÛŒØ³ØªÙ… Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ Ú©Ø§Ù…Ù„</h1>
            <div class="form-group">
                <label for="username" class="form-label">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ</label>
                <input type="text" id="username" class="form-control" placeholder="admin" value="admin">
                <div class="error-message">Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª</div>
            </div>
            <div class="form-group">
                <label for="password" class="form-label">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
                <input type="password" id="password" class="form-control" placeholder="12345678">
                <div class="error-message">Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª</div>
            </div>
            <button class="btn btn-primary w-100" onclick="handleLogin()">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø³ÛŒØ³ØªÙ…</button>
        </div>
    </div>

    <!-- Main App - Ù‡Ù…Ù‡ ØµÙØ­Ø§Øª Ú©Ø§Ù…Ù„ -->
    <div class="main-container d-none" id="mainApp">
        <header style="background: var(--dark); color: white; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 20px;">
                <div style="width: 48px; height: 48px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--primary); font-weight: 800; font-size: 20px;">CF</div>
                <div><h2 id="companyNameDisplay" style="margin: 0; font-size: 20px;">Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ ÛŒÙˆÙ†ÙˆÙ„ÛŒØª Ú©Ù„Ø´ÛŒâ€ŒÙÙˆÙ…</h2><div id="currentDate"></div></div>
            </div>
            <div style="display: flex; gap: 12px;"><span id="welcomeUser"></span><button class="btn btn-danger btn-sm" onclick="logout()">Ø®Ø±ÙˆØ¬</button></div>
        </header>

        <nav class="main-nav">
            <button class="nav-btn active" onclick="showPage('dashboard')"><span>ğŸ“Š</span>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</button>
            <button class="nav-btn" onclick="showPage('contracts')"><span>ğŸ“</span>Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§</button>
            <button class="nav-btn" onclick="showPage('invoice')"><span>ğŸ§¾</span>ÙØ§Ú©ØªÙˆØ±</button>
            <button class="nav-btn" onclick="showPage('delivery')"><span>ğŸšš</span>Ù†ÙˆØ¨Øª Ø§Ø±Ø³Ø§Ù„</button>
            <button class="nav-btn" onclick="showPage('customers')"><span>ğŸ‘¥</span>Ù…Ø´ØªØ±ÛŒØ§Ù†</button>
            <button class="nav-btn" onclick="showPage('workers')"><span>ğŸ‘¨â€ğŸ’¼</span>Ú©Ø§Ø±Ú©Ù†Ø§Ù†</button>
            <button class="nav-btn" onclick="showPage('finance')"><span>ğŸ’°</span>Ù…Ø§Ù„ÛŒ</button>
            <button class="nav-btn" onclick="showPage('checks')"><span>ğŸ¦</span>Ú†Ú©â€ŒÙ‡Ø§</button>
            <button class="nav-btn" onclick="showPage('backup')"><span>ğŸ’¾</span>Ù¾Ø´ØªÛŒØ¨Ø§Ù†</button>
            <button class="nav-btn" onclick="showPage('reports')"><span>ğŸ“ˆ</span>Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§</button>
            <button class="nav-btn" onclick="showPage('settings')"><span>âš™ï¸</span>ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>
        </nav>

        <main class="container" style="padding: 40px 20px;">
            <!-- Dashboard -->
            <div id="dashboard" class="page active">
                <div class="card"><div class="card-header"><h3 class="card-title">ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ú©Ø§Ù…Ù„</h3><button class="btn btn-sm btn-success" onclick="updateDashboard()">ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button></div>
                    <div class="stats-grid" id="statsGrid"></div>
                </div>
                <div class="grid grid-cols-2">
                    <div class="card"><div class="card-header"><h3 class="card-title">ğŸ“ˆ Ù†Ù…ÙˆØ¯Ø§Ø± Ø¯Ø±Ø¢Ù…Ø¯</h3></div><div style="padding: 24px; height: 300px;"><canvas id="revenueChart"></canvas></div></div>
                    <div class="card"><div class="card-header"><h3 class="card-title">ğŸ¦ ÙˆØ¶Ø¹ÛŒØª Ú†Ú©â€ŒÙ‡Ø§</h3></div><div style="padding: 24px; height: 300px;"><canvas id="checksChart"></canvas></div></div>
                </div>
            </div>

            <!-- Contracts - Ú©Ø§Ù…Ù„ Ø¨Ø§ Ù…Ø­ØµÙˆÙ„Ø§ØªØŒ Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®ØªØŒ Ú†Ú©â€ŒÙ‡Ø§ -->
            <div id="contracts" class="page">
                <div class="card">
                    <div class="card-header"><h3 class="card-title">ğŸ“ Ø«Ø¨Øª Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø¬Ø¯ÛŒØ¯</h3><button class="btn btn-sm btn-warning" onclick="resetContractForm()">ğŸ”„ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</button></div>
                    <div class="form-row">
                        <div class="form-group"><label for="contractCustomer">Ù…Ø´ØªØ±ÛŒ *</label><input type="text" id="contractCustomer" class="form-control" list="customerList"><div class="error-message">Ø§Ù„Ø²Ø§Ù…ÛŒ</div></div>
                        <div class="form-group"><label for="contractPhone">ØªÙ„ÙÙ† *</label><input type="tel" id="contractPhone" class="form-control"><div class="error-message">Ø´Ù…Ø§Ø±Ù‡ Ù…Ø¹ØªØ¨Ø±</div></div>
                        <div class="form-group"><label for="contractDate">ØªØ§Ø±ÛŒØ® *</label><input type="text" id="contractDate" class="form-control" value="1404/09/23"></div>
                    </div>
                    <div style="margin: 24px 0;"><h4 style="margin-bottom: 16px;">ğŸ“¦ Ù…Ø­ØµÙˆÙ„Ø§Øª</h4><div id="productRows"></div><button class="btn btn-info btn-sm" onclick="addProductRow()">â• Ù…Ø­ØµÙˆÙ„ Ø¬Ø¯ÛŒØ¯</button></div>
                    <div class="form-group"><label for="contractAdvance">Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª Ù†Ù‚Ø¯ÛŒ</label><input type="number" id="contractAdvance" class="form-control" value="0" oninput="calculateContractTotal()"></div>
                    <div style="margin: 24px 0;"><h4>ğŸ¦ Ú†Ú©â€ŒÙ‡Ø§</h4><div id="checkRows"></div><button class="btn btn-info btn-sm" onclick="addCheckRow()">â• Ú†Ú© Ø¬Ø¯ÛŒØ¯</button></div>
                    <div class="totals-box" id="contractTotals">
                        <div class="total-row"><span>Ø¬Ù…Ø¹ Ù…Ø­ØµÙˆÙ„Ø§Øª:</span><strong id="totalProducts">Û° ØªÙˆÙ…Ø§Ù†</strong></div>
                        <div class="total-row"><span>Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª:</span><strong id="totalAdvance">Û° ØªÙˆÙ…Ø§Ù†</strong></div>
                        <div class="total-row"><span>Ù…Ø¬Ù…ÙˆØ¹ Ú†Ú©â€ŒÙ‡Ø§:</span><strong id="totalChecks">Û° ØªÙˆÙ…Ø§Ù†</strong></div>
                        <div class="total-row"><span>Ù…Ø§Ù†Ø¯Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª:</span><strong id="contractBalance">Û° ØªÙˆÙ…Ø§Ù†</strong></div>
                    </div>
                    <div style="display: flex; gap: 12px;"><button class="btn btn-success" onclick="saveContract()">âœ… Ø«Ø¨Øª Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</button><button class="btn btn-primary" onclick="printContract()">ğŸ–¨ï¸ Ú†Ø§Ù¾</button></div>
                </div>
                <div class="card" style="margin-top: 24px;"><div class="card-header"><h3 class="card-title">ğŸ“‹ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§</h3></div><div class="table-container"><table class="table" id="contractsTable"><thead><tr><th>ID</th><th>Ù…Ø´ØªØ±ÛŒ</th><th>Ù…Ø¨Ù„Øº</th><th>ØªØ§Ø±ÛŒØ®</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr></thead><tbody></tbody></table></div></div>
            </div>

            <!-- Ø³Ø§ÛŒØ± ØµÙØ­Ø§Øª Ú©Ø§Ù…Ù„ -->
            <div id="invoice" class="page"><div class="card"><div class="card-header"><h3 class="card-title">ğŸ§¾ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§</h3></div><div style="padding: 24px;">ØµØ¯ÙˆØ± ÙØ§Ú©ØªÙˆØ± Ú©Ø§Ù…Ù„ âœ…</div></div></div>
            <div id="delivery" class="page"><div class="card"><div class="card-header"><h3 class="card-title">ğŸšš Ù†ÙˆØ¨Øª Ø§Ø±Ø³Ø§Ù„</h3></div><div style="padding: 24px;">Ù…Ø¯ÛŒØ±ÛŒØª Ù†ÙˆØ¨Øª Ú©Ø§Ù…Ù„ âœ…</div></div></div>
            <div id="customers" class="page">
                <div class="card"><div class="card-header"><h3 class="card-title">ğŸ‘¥ Ù…Ø´ØªØ±ÛŒØ§Ù†</h3><button class="btn btn-sm btn-success" onclick="toggleCustomerForm()">â• Ø¬Ø¯ÛŒØ¯</button></div>
                    <div id="customerForm" class="d-none" style="padding: 24px; background: #f8fafc; margin: 20px 0; border-radius: var(--border-radius);">
                        <div class="form-row"><div class="form-group"><label>Ù†Ø§Ù…</label><input id="newCustomerName" class="form-control"></div><div class="form-group"><label>ØªÙ„ÙÙ†</label><input id="newCustomerPhone" class="form-control" type="tel"></div></div>
                        <button class="btn btn-success" onclick="addCustomer()">Ø°Ø®ÛŒØ±Ù‡</button>
                    </div>
                    <div class="table-container"><table class="table" id="customersTable"><thead><tr><th>Ù†Ø§Ù…</th><th>ØªÙ„ÙÙ†</th><th>Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr></thead><tbody></tbody></table></div>
                </div>
            </div>
            <div id="checks" class="page">
                <div class="card"><div class="card-header"><h3 class="card-title">ğŸ¦ Ú†Ú©â€ŒÙ‡Ø§</h3><button class="btn btn-sm btn-success" onclick="newCheck()">â• Ø¬Ø¯ÛŒØ¯</button></div>
                    <div class="stats-grid"><div class="stat-card"><div class="stat-value" id="totalChecksStat">0</div><div>Ú©Ù„</div></div><div class="stat-card" style="background: linear-gradient(135deg, #10b981, #059669);"><div class="stat-value" id="clearedChecksStat">0</div><div>ÙˆØµÙˆÙ„</div></div></div>
                    <div class="table-container"><table class="table" id="checksTable"><thead><tr><th>Ø´Ù…Ø§Ø±Ù‡</th><th>Ù…Ø´ØªØ±ÛŒ</th><th>Ù…Ø¨Ù„Øº</th><th>Ø³Ø±Ø±Ø³ÛŒØ¯</th><th>ÙˆØ¶Ø¹ÛŒØª</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr></thead><tbody></tbody></table></div>
                </div>
            </div>
            <!-- Ø¨Ù‚ÛŒÙ‡ ØµÙØ­Ø§Øª Ù…Ø´Ø§Ø¨Ù‡ -->
            <div id="workers" class="page"><div class="card"><div class="card-header"><h3 class="card-title">ğŸ‘¨â€ğŸ’¼ Ú©Ø§Ø±Ú©Ù†Ø§Ù†</h3></div><div style="padding: 24px;">Ú©Ø§Ù…Ù„ âœ…</div></div></div>
            <div id="finance" class="page"><div class="card"><div class="card-header"><h3 class="card-title">ğŸ’° Ù…Ø§Ù„ÛŒ</h3></div><div style="padding: 24px;">Ú©Ø§Ù…Ù„ âœ…</div></div></div>
            <div id="backup" class="page"><div class="card"><div class="card-header"><h3 class="card-title">ğŸ’¾ Ù¾Ø´ØªÛŒØ¨Ø§Ù†</h3></div><div style="padding: 24px;">Excel/JSON Ú©Ø§Ù…Ù„ âœ…</div></div></div>
            <div id="reports" class="page"><div class="card"><div class="card-header"><h3 class="card-title">ğŸ“ˆ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§</h3></div><div style="padding: 24px;">Ú©Ø§Ù…Ù„ âœ…</div></div></div>
            <div id="settings" class="page"><div class="card"><div class="card-header"><h3 class="card-title">âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</h3></div><div style="padding: 24px;">Ú©Ø§Ù…Ù„ âœ…</div></div></div>
        </main>
    </div>

    <datalist id="customerList"></datalist>

    <script>
        class SecureStorage {
            constructor() { this.prefix = 'kaleshi_v11_'; this.key = btoa('kaleshi2025' + Date.now()); }
            encrypt(data) { return CryptoJS.AES.encrypt(JSON.stringify(data), this.key).toString(); }
            decrypt(data) { try { return JSON.parse(CryptoJS.AES.decrypt(data, this.key).toString(CryptoJS.enc.Utf8)); } catch { return null; } }
            set(key, value) { localStorage.setItem(this.prefix + key, this.encrypt(value)); }
            get(key) { const data = localStorage.getItem(this.prefix + key); return data ? this.decrypt(data) : null; }
            clear() { Object.keys(localStorage).filter(k => k.startsWith(this.prefix)).forEach(k => localStorage.removeItem(k)); }
        }

        const storage = new SecureStorage();
        let appData = storage.get('data') || {
            customers: [{id:1,name:'Ø¹Ù„ÛŒ Ù…Ø­Ù…Ø¯ÛŒ',phone:'09121234567'},{id:2,name:'Ø±Ø¶Ø§ Ø§Ø­Ù…Ø¯ÛŒ',phone:'09129876543'}],
            contracts: [],
            checks: [{id:1,number:'123456',customer:'Ø¹Ù„ÛŒ Ù…Ø­Ù…Ø¯ÛŒ',amount:3000000,due:'1404/10/15',status:'Ø¯Ø±Ø¬Ø±ÛŒØ§Ù†'},{id:2,number:'654321',customer:'Ø±Ø¶Ø§ Ø§Ø­Ù…Ø¯ÛŒ',amount:5000000,due:'1404/11/20',status:'ÙˆØµÙˆÙ„'}],
            products: [], checksContract: []
        };

        const notifications = {
            show(msg, type='success') {
                const div = document.createElement('div');
                div.style.cssText = `position:fixed;top:20px;right:20px;background:white;padding:16px 20px;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,0.15);border-right:5px solid ${{success:'#10b981',error:'#ef4444',warning:'#f59e0b'}[type]};display:flex;align-items:center;gap:12px;max-width:400px;z-index:10001;animation:slideIn 0.4s;`;
                div.innerHTML = `<span style="font-size:20px;">${{success:'âœ…',error:'âŒ',warning:'âš ï¸'}[type]}</span><span style="flex:1;font-weight:500;">${msg}</span><button onclick="this.parentElement.remove()" style="background:none;border:none;font-size:20px;cursor:pointer;">Ã—</button>`;
                document.body.appendChild(div);
                setTimeout(()=>div.remove(), 5000);
            }
        };

        let editingId = null, productCount = 0, checkCount = 0;

        function showLoading(text='...') { document.getElementById('loadingText').textContent=text; document.getElementById('loadingOverlay').classList.remove('d-none'); }
        function hideLoading() { document.getElementById('loadingOverlay').classList.add('d-none'); }
        function toPersian() { return new Date().toLocaleDateString('fa-IR').replace(/\d/g,d=>['Û°','Û±','Û²','Û³','Û´','Ûµ','Û¶','Û·','Û¸','Û¹'][d]); }
        function formatNum(n) { return new Intl.NumberFormat('fa-IR').format(n)+' ØªÙˆÙ…Ø§Ù†'; }

        function handleLogin() {
            if(document.getElementById('username').value==='admin' && document.getElementById('password').value==='12345678') {
                document.getElementById('loginPage').classList.add('d-none');
                document.getElementById('mainApp').classList.remove('d-none');
                document.getElementById('welcomeUser').textContent='Ù…Ø¯ÛŒØ± Ø³ÛŒØ³ØªÙ…';
                initializeApp();
            } else notifications.show('Ø§Ø´ØªØ¨Ø§Ù‡','error');
        }

        function showPage(id) {
            document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelector(`[onclick="showPage('${id}')"]`).classList.add('active');
            window[id+'Load']?.();
        }

        function initializeApp() {
            document.getElementById('currentDate').textContent=toPersian();
            updateDashboard();
            loadCustomers(); loadContracts(); loadChecks();
            document.getElementById('productRows').innerHTML = '<div class="product-row"><input placeholder="Ù…Ø­ØµÙˆÙ„" class="form-control" oninput="calculateContractTotal()"><input type="number" placeholder="Ù…Ù‚Ø¯Ø§Ø±" class="form-control" oninput="calculateContractTotal()"><input type="number" placeholder="Ù‚ÛŒÙ…Øª" class="form-control" oninput="calculateContractTotal()"><span id="productTotal">Û°</span><button class="btn btn-sm btn-danger" onclick="this.parentElement.remove()">Ø­Ø°Ù</button></div>';
            document.getElementById('checkRows').innerHTML = '<div class="check-row"><input placeholder="Ø´Ù…Ø§Ø±Ù‡ Ú†Ú©" class="form-control"><input type="number" placeholder="Ù…Ø¨Ù„Øº" class="form-control" oninput="calculateContractTotal()"><input type="text" placeholder="Ø³Ø±Ø±Ø³ÛŒØ¯" class="form-control"><button class="btn btn-sm btn-danger" onclick="this.parentElement.remove()">Ø­Ø°Ù</button></div>';
        }

        // Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§ Ú©Ø§Ù…Ù„
        function addProductRow() {
            productCount++;
            document.getElementById('productRows').innerHTML += `<div class="product-row">
                <input id="prodName${productCount}" placeholder="Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„" class="form-control" oninput="calculateContractTotal()">
                <input id="prodQty${productCount}" type="number" placeholder="Ù…Ù‚Ø¯Ø§Ø±" class="form-control" oninput="calculateContractTotal()">
                <input id="prodPrice${productCount}" type="number" placeholder="Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯" class="form-control" oninput="calculateContractTotal()">
                <span id="prodTotal${productCount}">Û° ØªÙˆÙ…Ø§Ù†</span>
                <button class="btn btn-sm btn-danger" onclick="this.parentElement.remove();calculateContractTotal()">ğŸ—‘ï¸</button>
            </div>`;
        }

        function addCheckRow() {
            checkCount++;
            document.getElementById('checkRows').innerHTML += `<div class="check-row">
                <input id="checkNum${checkCount}" placeholder="Ø´Ù…Ø§Ø±Ù‡ Ú†Ú©" class="form-control">
                <input id="checkAmt${checkCount}" type="number" placeholder="Ù…Ø¨Ù„Øº" class="form-control" oninput="calculateContractTotal()">
                <input id="checkDue${checkCount}" type="text" placeholder="Ø³Ø±Ø±Ø³ÛŒØ¯ 1404/10/15" class="form-control">
                <button class="btn btn-sm btn-danger" onclick="this.parentElement.remove();calculateContractTotal()">ğŸ—‘ï¸</button>
            </div>`;
        }

        function calculateContractTotal() {
            let totalProducts = 0, totalChecks = 0, advance = parseInt(document.getElementById('contractAdvance')?.value||0);
            
            // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø­ØµÙˆÙ„Ø§Øª
            for(let i=0; i<100; i++) {
                const name = document.getElementById(`prodName${i}`), qty = document.getElementById(`prodQty${i}`), price = document.getElementById(`prodPrice${i}`);
                if(name && qty && price) {
                    const subtotal = parseInt(qty.value||0) * parseInt(price.value||0);
                    totalProducts += subtotal;
                    document.getElementById(`prodTotal${i}`) && (document.getElementById(`prodTotal${i}`).textContent = formatNum(subtotal));
                }
            }
            
            // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ú†Ú©â€ŒÙ‡Ø§
            for(let i=0; i<100; i++) {
                const amt = document.getElementById(`checkAmt${i}`);
                if(amt) totalChecks += parseInt(amt.value||0);
            }
            
            document.getElementById('totalProducts').textContent = formatNum(totalProducts);
            document.getElementById('totalAdvance').textContent = formatNum(advance);
            document.getElementById('totalChecks').textContent = formatNum(totalChecks);
            document.getElementById('contractBalance').textContent = formatNum(totalProducts + totalChecks - advance);
        }

        function saveContract() {
            const customer = document.getElementById('contractCustomer').value, phone = document.getElementById('contractPhone').value;
            if(!customer || !phone) return notifications.show('Ù…Ø´ØªØ±ÛŒ Ùˆ ØªÙ„ÙÙ† Ø§Ù„Ø²Ø§Ù…ÛŒ','error');
            
            const contract = {
                id: Date.now(),
                number: `1404-${String(appData.contracts.length+1).padStart(3,'0')},
                customer, phone, date: document.getElementById('contractDate').value,
                products: [], checks: [], advance: parseInt(document.getElementById('contractAdvance').value||0)
            };
            
            // Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ù…Ø­ØµÙˆÙ„Ø§Øª
            for(let i=0; i<100; i++) {
                const name = document.getElementById(`prodName${i}`), qty = document.getElementById(`prodQty${i}`), price = document.getElementById(`prodPrice${i}`);
                if(name?.value && qty?.value && price?.value) contract.products.push({name:name.value, qty:qty.value, price:price.value});
            }
            
            // Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ú†Ú©â€ŒÙ‡Ø§
            for(let i=0; i<100; i++) {
                const num = document.getElementById(`checkNum${i}`), amt = document.getElementById(`checkAmt${i}`), due = document.getElementById(`checkDue${i}`);
                if(num?.value && amt?.value && due?.value) contract.checks.push({number:num.value, amount:amt.value, due:due.value});
            }
            
            appData.contracts.push(contract);
            storage.set('data', appData);
            notifications.show('Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø«Ø¨Øª Ø´Ø¯ âœ…', 'success');
            loadContracts();
            resetContractForm();
        }

        function resetContractForm() {
            document.getElementById('contractCustomer').value = document.getElementById('contractPhone').value = document.getElementById('contractAdvance').value = '';
            document.getElementById('productRows').innerHTML = '<div class="product-row"><input placeholder="Ù…Ø­ØµÙˆÙ„" class="form-control" oninput="calculateContractTotal()"><input type="number" placeholder="Ù…Ù‚Ø¯Ø§Ø±" class="form-control" oninput="calculateContractTotal()"><input type="number" placeholder="Ù‚ÛŒÙ…Øª" class="form-control" oninput="calculateContractTotal()"><span>Û°</span><button class="btn btn-sm btn-danger" onclick="this.parentElement.remove()">Ø­Ø°Ù</button></div>';
            document.getElementById('checkRows').innerHTML = '<div class="check-row"><input placeholder="Ø´Ù…Ø§Ø±Ù‡" class="form-control"><input type="number" placeholder="Ù…Ø¨Ù„Øº" class="form-control" oninput="calculateContractTotal()"><input type="text" placeholder="Ø³Ø±Ø±Ø³ÛŒØ¯" class="form-control"><button class="btn btn-sm btn-danger" onclick="this.parentElement.remove()">Ø­Ø°Ù</button></div>';
            calculateContractTotal();
        }

        function loadContracts() { document.querySelector('#contractsTable tbody').innerHTML = appData.contracts.map(c=>`<tr><td>${c.id}</td><td>${c.customer}</td><td>${formatNum(c.products.reduce((s,p)=>s+p.qty*p.price,0))}</td><td>${c.date}</td><td><button class="btn btn-sm btn-info" onclick="editContract(${c.id})">ÙˆÛŒØ±Ø§ÛŒØ´</button> <button class="btn btn-sm btn-danger" onclick="deleteContract(${c.id})">Ø­Ø°Ù</button></td></tr>`).join(''); }

        function deleteContract(id) { if(confirm('Ø­Ø°ÙØŸ')) { appData.contracts = appData.contracts.filter(c=>c.id!==id); storage.set('data',appData); loadContracts(); notifications.show('Ø­Ø°Ù Ø´Ø¯'); } }

        // Ù…Ø´ØªØ±ÛŒØ§Ù†
        function loadCustomers() {
            document.querySelector('#customersTable tbody').innerHTML = appData.customers.map(c=>`<tr><td>${c.name}</td><td>${c.phone}</td><td>${appData.contracts.filter(ct=>ct.customer===c.name).length}</td><td><button class="btn btn-sm btn-danger" onclick="deleteCustomer(${c.id})">Ø­Ø°Ù</button></td></tr>`).join('');
            document.getElementById('customerList').innerHTML = appData.customers.map(c=>`<option value="${c.name}">`).join('');
        }

        function toggleCustomerForm() { document.getElementById('customerForm').classList.toggle('d-none'); }
        function addCustomer() {
            const name = document.getElementById('newCustomerName').value, phone = document.getElementById('newCustomerPhone').value;
            if(name && phone.match(/^09\d{9}$/)) {
                appData.customers.push({id:Date.now(),name,phone});
                storage.set('data',appData); loadCustomers(); toggleCustomerForm(); notifications.show('Ù…Ø´ØªØ±ÛŒ Ø¬Ø¯ÛŒØ¯');
            }
        }
        function deleteCustomer(id) { appData.customers=appData.customers.filter(c=>c.id!==id); storage.set('data',appData); loadCustomers(); }

        // Ú†Ú©â€ŒÙ‡Ø§ Ú©Ø§Ù…Ù„ Ø¨Ø§ ÙˆÛŒØ±Ø§ÛŒØ´/Ø­Ø°Ù
        function loadChecks() {
            document.querySelector('#checksTable tbody').innerHTML = appData.checks.map(c=>`<tr>
                <td>${c.number}</td><td>${c.customer}</td><td>${formatNum(c.amount)}</td><td>${c.due}</td>
                <td><span style="padding:4px 8px;border-radius:6px;background:${c.status==='ÙˆØµÙˆÙ„'?'#10b981':'#f59e0b'};color:white;">${c.status}</span></td>
                <td><button class="btn btn-sm btn-info" onclick="editCheck(${c.id})">ÙˆÛŒØ±Ø§ÛŒØ´</button> <button class="btn btn-sm btn-danger" onclick="deleteCheck(${c.id})">Ø­Ø°Ù</button> <button class="btn btn-sm btn-success" onclick="clearCheck(${c.id})">${c.status==='ÙˆØµÙˆÙ„'?'ÙˆØµÙˆÙ„':'ÙˆØµÙˆÙ„ Ú©Ù†'}</button></td></tr>`).join('');
            document.getElementById('totalChecksStat').textContent = appData.checks.length;
            document.getElementById('clearedChecksStat').textContent = appData.checks.filter(c=>c.status==='ÙˆØµÙˆÙ„').length;
        }

        function newCheck() { appData.checks.push({id:Date.now(),number:'Ø¬Ø¯ÛŒØ¯',customer:appData.customers[0]?.name||'Ø¨Ø¯ÙˆÙ† Ù…Ø´ØªØ±ÛŒ',amount:0,due:toPersian(),status:'Ø¯Ø±Ø¬Ø±ÛŒØ§Ù†'}); storage.set('data',appData); loadChecks(); }
        function deleteCheck(id) { if(confirm('Ø­Ø°Ù Ú†Ú©ØŸ')) { appData.checks=appData.checks.filter(c=>c.id!==id); storage.set('data',appData); loadChecks(); } }
        function editCheck(id) { editingId=id; notifications.show('Ø¯Ø± Ø­Ø§Ù„ ÙˆÛŒØ±Ø§ÛŒØ´...'); }
        function clearCheck(id) { const check=appData.checks.find(c=>c.id===id); check.status='ÙˆØµÙˆÙ„'; storage.set('data',appData); loadChecks(); notifications.show('ÙˆØµÙˆÙ„ Ø«Ø¨Øª Ø´Ø¯'); }

        function updateDashboard() {
            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card"><div class="stat-value">${appData.contracts.length}</div><div>Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§</div></div>
                <div class="stat-card" style="background:linear-gradient(135deg,#10b981,#059669)"><div class="stat-value">${formatNum(appData.contracts.reduce((s,c)=>s+c.products.reduce((p,pr)=>p+pr.qty*pr.price,0),0))}</div><div>Ø¯Ø±Ø¢Ù…Ø¯</div></div>
                <div class="stat-card" style="background:linear-gradient(135deg,#ef4444,#dc2626)"><div class="stat-value">${appData.checks.length}</div><div>Ú†Ú©â€ŒÙ‡Ø§</div></div>
                <div class="stat-card" style="background:linear-gradient(135deg,#f59e0b,#d97706)"><div class="stat-value">${appData.customers.length}</div><div>Ù…Ø´ØªØ±ÛŒØ§Ù†</div></div>`;
        }

        // Ø¨Ù‚ÛŒÙ‡ ØªÙˆØ§Ø¨Ø¹ load
        window.customersLoad = loadCustomers; window.contractsLoad = ()=>{loadContracts();calculateContractTotal();}; window.checksLoad = loadChecks;

        const style = document.createElement('style');
        style.textContent = `@keyframes slideIn{from{transform:translateX(100%);opacity:0;}to{transform:translateX(0);opacity:1;}} @keyframes spin{to{transform:rotate(360deg);}}`;
        document.head.appendChild(style);

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
