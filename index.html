<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>سیستم حسابداری کارخانه - آفلاین (نسخه اصلاح‌شده)</title>

  <!-- UI -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/font-face.css" rel="stylesheet">

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment-jalaali@0.9.6/build/moment-jalaali.js"></script>

  <style>
    :root {
      --primary: #1e3a8a;
      --secondary: #3b82f6;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --bg: #f8f9fa;
    }
    body { font-family: 'Vazir', Tahoma, system-ui; background: var(--bg); }
    .nav-link { cursor: pointer; }
    .nav-link.active { background: var(--secondary); color: #fff !important; border-radius: 8px; }
    .card { border-radius: 12px; }
    .section-title { font-weight: 700; color: var(--primary); }
    .badge { font-size: 12px; }
    .table td, .table th { vertical-align: middle; }
    .tiny { font-size: 12px; color: #666; }
    .stat { background: linear-gradient(135deg, var(--secondary), #1d4ed8); color: #fff; border-radius: 12px; padding: 16px; text-align: center; }
    .stat .val { font-size: 20px; font-weight: 800; }
    .grid { display: grid; gap: 12px; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); }
  </style>
</head>

<body>
  <div class="container py-3">
    <!-- Header -->
    <header class="d-flex justify-content-between align-items-center mb-3">
      <div class="d-flex align-items-center gap-2">
        <div class="fw-bold" style="color:var(--primary)">سیستم حسابداری کارخانه (آفلاین)</div>
        <span class="tiny" id="appDate"></span>
      </div>
      <div class="d-flex align-items-center gap-2">
        <button class="btn btn-sm btn-outline-primary" id="btnExport">خروجی JSON</button>
        <label class="btn btn-sm btn-outline-success mb-0">
          ورودی JSON
          <input type="file" id="importFile" accept=".json" hidden>
        </label>
        <button class="btn btn-sm btn-outline-danger" id="btnClear">پاکسازی داده‌ها</button>
      </div>
    </header>

    <!-- Nav -->
    <ul class="nav nav-pills mb-3" id="mainTabs">
      <li class="nav-item"><a class="nav-link active" data-target="dashboard">داشبورد</a></li>
      <li class="nav-item"><a class="nav-link" data-target="contracts">قراردادها</a></li>
      <li class="nav-item"><a class="nav-link" data-target="checks">چک‌ها</a></li>
      <li class="nav-item"><a class="nav-link" data-target="income">درآمدها</a></li>
      <li class="nav-item"><a class="nav-link" data-target="customers">مشتریان</a></li>
      <li class="nav-item"><a class="nav-link" data-target="reports">گزارش‌ها</a></li>
      <li class="nav-item"><a class="nav-link" data-target="settings">تنظیمات</a></li>
    </ul>

    <!-- Pages -->
    <div id="pages">

      <!-- Dashboard -->
      <section id="dashboard" class="page">
        <div class="grid mb-3">
          <div class="stat"><div>قراردادها</div><div class="val" id="statContracts">0</div></div>
          <div class="stat"><div>چک‌ها</div><div class="val" id="statChecks">0</div></div>
          <div class="stat"><div>درآمدها</div><div class="val" id="statIncome">0</div></div>
          <div class="stat"><div>مشتریان</div><div class="val" id="statCustomers">0</div></div>
          <div class="stat" style="background:linear-gradient(135deg,#10b981,#059669)"><div>مجموع درآمد</div><div class="val" id="statIncomeSum">0</div></div>
        </div>
        <div class="card">
          <div class="card-header fw-bold">نمودار مبلغ قراردادها (ماه جاری)</div>
          <div class="card-body">
            <canvas id="contractsChart" height="120"></canvas>
          </div>
        </div>
      </section>

      <!-- Contracts -->
      <section id="contracts" class="page" style="display:none">
        <div class="card mb-3">
          <div class="card-header fw-bold">ثبت قرارداد جدید</div>
          <div class="card-body">
            <div class="row g-2">
              <div class="col-md-4">
                <label class="form-label">مشتری</label>
                <input id="cCustomer" class="form-control" list="dlCustomers" placeholder="نام مشتری">
              </div>
              <div class="col-md-3">
                <label class="form-label">مبلغ (تومان)</label>
                <input id="cAmount" type="number" min="0" class="form-control" placeholder="مثلاً 20000000">
              </div>
              <div class="col-md-3">
                <label class="form-label">تاریخ</label>
                <input id="cDate" class="form-control" placeholder="1404/01/01">
              </div>
              <div class="col-md-2 d-grid">
                <label class="form-label">&nbsp;</label>
                <button class="btn btn-success" id="btnAddContract">ثبت</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span class="fw-bold">لیست قراردادها</span>
            <input id="cSearch" class="form-control" placeholder="جستجو..." style="max-width:220px">
          </div>
          <div class="card-body table-responsive">
            <table class="table table-striped align-middle">
              <thead>
                <tr>
                  <th>#</th><th>مشتری</th><th>مبلغ</th><th>تاریخ</th><th>عملیات</th>
                </tr>
              </thead>
              <tbody id="cTbody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Checks -->
      <section id="checks" class="page" style="display:none">
        <div class="card mb-3">
          <div class="card-header fw-bold">ثبت چک جدید</div>
          <div class="card-body">
            <div class="row g-2">
              <div class="col-md-3">
                <label class="form-label">شماره چک</label>
                <input id="kNumber" class="form-control" placeholder="مثلاً 123456">
              </div>
              <div class="col-md-3">
                <label class="form-label">مشتری</label>
                <input id="kCustomer" class="form-control" list="dlCustomers" placeholder="نام مشتری">
              </div>
              <div class="col-md-3">
                <label class="form-label">مبلغ (تومان)</label>
                <input id="kAmount" type="number" min="0" class="form-control">
              </div>
              <div class="col-md-3">
                <label class="form-label">سررسید</label>
                <input id="kDueDate" class="form-control" placeholder="1404/01/01">
              </div>
            </div>
            <div class="row g-2 mt-1">
              <div class="col-md-3 d-grid">
                <button class="btn btn-success" id="btnAddCheck">ثبت</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span class="fw-bold">لیست چک‌ها</span>
            <input id="kSearch" class="form-control" placeholder="جستجو..." style="max-width:220px">
          </div>
          <div class="card-body table-responsive">
            <table class="table table-striped align-middle">
              <thead>
                <tr>
                  <th>#</th><th>شماره</th><th>مشتری</th><th>مبلغ</th><th>سررسید</th><th>مانده روز</th><th>وضعیت</th><th>عملیات</th>
                </tr>
              </thead>
              <tbody id="kTbody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Income -->
      <section id="income" class="page" style="display:none">
        <div class="card mb-3">
          <div class="card-header fw-bold">ثبت درآمد جدید</div>
          <div class="card-body">
            <div class="row g-2">
              <div class="col-md-3">
                <label class="form-label">دسته‌بندی</label>
                <select id="iCategory" class="form-control">
                  <option value="فروش">فروش</option>
                  <option value="دریافت چک">دریافت چک</option>
                  <option value="سایر">سایر</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">مبلغ (تومان)</label>
                <input id="iAmount" type="number" min="0" class="form-control">
              </div>
              <div class="col-md-3">
                <label class="form-label">تاریخ</label>
                <input id="iDate" class="form-control" placeholder="1404/01/01">
              </div>
              <div class="col-md-3">
                <label class="form-label">شرح</label>
                <input id="iDesc" class="form-control" placeholder="توضیح">
              </div>
              <div class="col-md-12 d-grid mt-2">
                <button class="btn btn-success" id="btnAddIncome">ثبت</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span class="fw-bold">لیست درآمدها</span>
            <input id="iSearch" class="form-control" placeholder="جستجو..." style="max-width:220px">
          </div>
          <div class="card-body table-responsive">
            <table class="table table-striped align-middle">
              <thead>
                <tr>
                  <th>#</th><th>دسته‌بندی</th><th>شرح</th><th>مبلغ</th><th>تاریخ</th><th>عملیات</th>
                </tr>
              </thead>
              <tbody id="iTbody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Customers -->
      <section id="customers" class="page" style="display:none">
        <div class="card mb-3">
          <div class="card-header fw-bold">ثبت مشتری جدید</div>
          <div class="card-body">
            <div class="row g-2">
              <div class="col-md-4">
                <label class="form-label">نام مشتری</label>
                <input id="uName" class="form-control" placeholder="نام و نام خانوادگی">
              </div>
              <div class="col-md-4">
                <label class="form-label">تلفن</label>
                <input id="uPhone" class="form-control" placeholder="0912...">
              </div>
              <div class="col-md-4">
                <label class="form-label">تاریخ ثبت</label>
                <input id="uDate" class="form-control" placeholder="1404/01/01">
              </div>
              <div class="col-md-12 d-grid mt-2">
                <button class="btn btn-success" id="btnAddCustomer">ثبت</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span class="fw-bold">لیست مشتریان</span>
            <input id="uSearch" class="form-control" placeholder="جستجو..." style="max-width:220px">
          </div>
          <div class="card-body table-responsive">
            <table class="table table-striped align-middle">
              <thead>
                <tr>
                  <th>#</th><th>نام</th><th>تلفن</th><th>تاریخ ثبت</th><th>عملیات</th>
                </tr>
              </thead>
              <tbody id="uTbody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Reports -->
      <section id="reports" class="page" style="display:none">
        <div class="card">
          <div class="card-header fw-bold">گزارش‌ها</div>
          <div class="card-body">
            <div class="row g-2 mb-3">
              <div class="col-md-3">
                <label class="form-label">تاریخ شروع</label>
                <input id="rStart" class="form-control" placeholder="1404/01/01">
              </div>
              <div class="col-md-3">
                <label class="form-label">تاریخ پایان</label>
                <input id="rEnd" class="form-control" placeholder="1404/01/30">
              </div>
              <div class="col-md-6 d-grid">
                <label class="form-label">&nbsp;</label>
                <button class="btn btn-primary" id="btnGenerateReport">تولید گزارش</button>
              </div>
            </div>
            <div id="reportResults">
              <div class="alert alert-info">گزارش را بر اساس بازه تاریخ تولید کنید.</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Settings -->
      <section id="settings" class="page" style="display:none">
        <div class="card">
          <div class="card-header fw-bold">تنظیمات</div>
          <div class="card-body">
            <div class="row g-2">
              <div class="col-md-4">
                <label class="form-label">نام شرکت</label>
                <input id="sCompany" class="form-control" value="کارخانه یونولیت کلشی‌فوم">
              </div>
              <div class="col-md-4">
                <label class="form-label">نسخه داده</label>
                <input id="sVersion" class="form-control" value="1.0">
              </div>
              <div class="col-md-4 d-grid">
                <label class="form-label">&nbsp;</label>
                <button class="btn btn-success" id="btnSaveSettings">ذخیره تنظیمات</button>
              </div>
            </div>
            <div class="tiny mt-2">داده‌ها در مرورگر دستگاه شما ذخیره می‌شوند (localStorage). برای انتقال، از خروجی JSON استفاده کنید.</div>
          </div>
        </div>
      </section>

    </div>

    <!-- Datalist -->
    <datalist id="dlCustomers"></datalist>

  </div>

  <script>
    // Init Persian
    moment.loadPersian({usePersianDigits: true});

    // App state
    const KEY = 'factoryAccountingData';
    const App = {
      version: '1.0',
      company: 'کارخانه یونولیت کلشی‌فوم',
      customers: [],
      contracts: [],
      checks: [],
      incomes: []
    };

    // Utils
    const toISO = (sh) => {
      if (!sh) return new Date().toISOString();
      const m = moment(sh, 'YYYY/MM/DD'); // Jalali parse
      return m.isValid() ? m.toDate().toISOString() : new Date().toISOString();
    };
    const toShamsi = (iso) => moment(iso).format('YYYY/MM/DD');
    const fmt = (n) => Number(n||0).toLocaleString('fa-IR');

    // Storage
    function load() {
      const raw = localStorage.getItem(KEY);
      if (raw) {
        try {
          const parsed = JSON.parse(raw);
          if (parsed.version) Object.assign(App, parsed);
        } catch (e) {}
      }
      render
