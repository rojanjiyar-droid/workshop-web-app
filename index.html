// مشکل 1: فعال کردن پیش پرداخت
function toggleCheckSection() {
    const paymentType = document.getElementById('paymentType').value;
    const checkSection = document.getElementById('checkSection');
    const advanceInput = document.getElementById('contractAdvance');
    
    if (paymentType === 'check') {
        checkSection.style.display = 'block';
        advanceInput.disabled = true;
        advanceInput.value = '0';
    } else {
        checkSection.style.display = 'none';
        advanceInput.disabled = false; // اینجا اصلاح شد
        document.getElementById('checkList').innerHTML = '';
        contractChecks = [];
    }
    calculateTotal(); // اضافه شد
}

// مشکل 2: اصلاح محاسبات مانده
function calculateTotal() {
    let totalAmount = 0;
    let hasError = false;
    
    document.querySelectorAll('.product-row').forEach(row => {
        const meterage = parseFloat(row.querySelector('.productMeterage').value) || 0;
        const unitPrice = parseFloat(row.querySelector('.productUnitPrice').value) || 0;
        
        if (meterage < 0 || unitPrice < 0) {
            hasError = true;
        }
        
        totalAmount += meterage * unitPrice;
    });
    
    const advanceInput = document.getElementById('contractAdvance');
    const advance = parseFloat(advanceInput.value) || 0;
    const balance = totalAmount - advance;
    
    const balanceDisplay = document.getElementById('balanceDisplay');
    
    if (hasError || balance < 0) {
        balanceDisplay.style.backgroundColor = '#ffebee';
        balanceDisplay.style.color = '#c62828';
        balanceDisplay.innerHTML = 
            `❌ جمع کل: ${totalAmount.toLocaleString('fa-IR')} تومان | پیش پرداخت: ${advance.toLocaleString('fa-IR')} تومان | مانده: ${balance.toLocaleString('fa-IR')} تومان`;
    } else {
        balanceDisplay.style.backgroundColor = '#e8f5e8';
        balanceDisplay.style.color = '#2e7d32';
        balanceDisplay.innerHTML = 
            `✅ جمع کل: ${totalAmount.toLocaleString('fa-IR')} تومان | پیش پرداخت: ${advance.toLocaleString('fa-IR')} تومان | مانده: ${balance.toLocaleString('fa-IR')} تومان`;
    }
}

// مشکل 3: ذخیره‌سازی داده‌ها
function saveAllData() {
    const allData = {
        customers: customers,
        agents: agents,
        workers: workers,
        expenses: expenses,
        checks: checks,
        contracts: contracts,
        invoices: invoices,
        lastSave: new Date().toISOString(),
        version: '1.0'
    };
    
    try {
        localStorage.setItem('kalashiFoamData', JSON.stringify(allData));
        console.log('داده‌ها با موفقیت ذخیره شدند:', allData);
        return true;
    } catch (error) {
        console.error('خطا در ذخیره‌سازی:', error);
        showAlert('خطا در ذخیره‌سازی داده‌ها', 'error');
        return false;
    }
}

function loadAllData() {
    try {
        const savedData = localStorage.getItem('kalashiFoamData');
        if (savedData) {
            const data = JSON.parse(savedData);
            customers = data.customers || [];
            agents = data.agents || [];
            workers = data.workers || [];
            expenses = data.expenses || [];
            checks = data.checks || [];
            contracts = data.contracts || [];
            invoices = data.invoices || [];
            console.log('داده‌ها با موفقیت بارگذاری شدند');
        } else {
            console.log('هیچ داده‌ای برای بارگذاری وجود ندارد');
        }
    } catch (error) {
        console.error('خطا در بارگذاری داده‌ها:', error);
        showAlert('خطا در بارگذاری داده‌های ذخیره شده', 'error');
    }
}

// مشکل 4: ثبت قرارداد با اعتبارسنجی بهتر
function addContract() {
    // اعتبارسنجی فیلدهای اجباری
    const customer = document.getElementById('contractCustomer').value.trim();
    const phone = document.getElementById('contractPhone').value.trim();
    const deliveryDate = document.getElementById('deliveryDate').value;
    
    if (!customer) {
        showAlert('لطفا نام مشتری را وارد کنید', 'error');
        document.getElementById('contractCustomer').focus();
        return;
    }
    
    if (!phone) {
        showAlert('لطفا شماره تماس را وارد کنید', 'error');
        document.getElementById('contractPhone').focus();
        return;
    }
    
    if (!deliveryDate) {
        showAlert('لطفا تاریخ تحویل را انتخاب کنید', 'error');
        return;
    }
    
    // جمع‌آوری محصولات
    const products = [];
    let hasValidProduct = false;
    
    document.querySelectorAll('.product-row').forEach((row, index) => {
        const meterage = parseFloat(row.querySelector('.productMeterage').value) || 0;
        const unitPrice = parseFloat(row.querySelector('.productUnitPrice').value) || 0;
        
        if (meterage > 0 && unitPrice > 0) {
            hasValidProduct = true;
            products.push({
                type: row.querySelector('.productType').value,
                size: row.querySelector('.productSize').value.trim(),
                meterage: meterage,
                unitPrice: unitPrice,
                total: meterage * unitPrice
            });
        }
    });
    
    if (!hasValidProduct) {
        showAlert('لطفا حداقل یک محصول با مقادیر معتبر وارد کنید', 'error');
        return;
    }
    
    // محاسبات مالی
    const totalAmount = products.reduce((sum, product) => sum + product.total, 0);
    const advance = parseFloat(document.getElementById('contractAdvance').value) || 0;
    const paymentType = document.getElementById('paymentType').value;
    
    // اعتبارسنجی پرداخت
    if (paymentType === 'cash' && advance > totalAmount) {
        showAlert('پیش پرداخت نمی‌تواند از جمع کل بیشتر باشد', 'error');
        return;
    }
    
    if (paymentType === 'check' && contractChecks.length === 0) {
        showAlert('برای پرداخت چکی، حداقل یک چک اضافه کنید', 'error');
        return;
    }
    
    // ایجاد قرارداد
    const contract = {
        id: 'C' + Date.now(),
        customer: customer,
        phone: phone,
        address: document.getElementById('contractAddress').value.trim(),
        contractType: document.getElementById('contractType').value,
        deliveryDate: deliveryDate,
        advance: advance,
        paymentType: paymentType,
        products: products,
        totalAmount: totalAmount,
        balance: totalAmount - advance,
        checks: paymentType === 'check' ? [...contractChecks] : [],
        date: getCurrentPersianDate(),
        status: 'active',
        createdBy: currentUser ? currentUser.name : 'مدیر سیستم'
    };
    
    // ذخیره‌سازی
    contracts.push(contract);
    
    if (saveAllData()) {
        showAlert(`قرارداد با شماره ${contract.id} با موفقیت ثبت شد`, 'success');
        updateDashboard();
        resetContractForm();
        
        // ایجاد فاکتور خودکار
        setTimeout(() => generateInvoiceFromContract(contract), 1000);
    }
}

// مشکل 5: ریست فرم بعد از ثبت
function resetContractForm() {
    // پاک کردن فیلدها
    document.getElementById('contractCustomer').value = '';
    document.getElementById('contractPhone').value = '';
    document.getElementById('contractAddress').value = '';
    document.getElementById('deliveryDate').value = '';
    document.getElementById('contractAdvance').value = '';
    
    // پاک کردن چک‌ها
    document.getElementById('checkList').innerHTML = '';
    contractChecks = [];
    
    // پاک کردن محصولات (نگه داشتن فقط یک ردیف خالی)
    const productRowsContainer = document.getElementById('productRowsContainer');
    const firstRow = productRowsContainer.querySelector('[data-row="1"]');
    
    // پاک کردن تمام ردیف‌ها به جز اولی
    const allRows = productRowsContainer.querySelectorAll('.product-row');
    allRows.forEach((row, index) => {
        if (index > 0) {
            row.remove();
        }
    });
    
    // ریست کردن ردیف اول
    if (firstRow) {
        firstRow.querySelector('.productSize').value = '';
        firstRow.querySelector('.productMeterage').value = '';
        firstRow.querySelector('.productUnitPrice').value = '';
        firstRow.querySelector('.productTotal').value = '';
    }
    
    productRowsCount = 1;
    updateRemoveButtons();
    
    // ریست کردن نمایش مانده
    document.getElementById('balanceDisplay').innerHTML = 
        'جمع کل: ۰ تومان | پیش پرداخت: ۰ تومان | مانده: ۰ تومان';
    document.getElementById('balanceDisplay').style.backgroundColor = '#e8f4fd';
    document.getElementById('balanceDisplay').style.color = '#2c3e50';
    
    // ریست کردن نوع پرداخت
    document.getElementById('paymentType').value = 'cash';
    toggleCheckSection();
}

// اضافه کردن event listener برای پیش پرداخت
document.addEventListener('DOMContentLoaded', function() {
    // اضافه کردن event listener برای پیش پرداخت
    const advanceInput = document.getElementById('contractAdvance');
    if (advanceInput) {
        advanceInput.addEventListener('input', calculateTotal);
        advanceInput.addEventListener('change', calculateTotal);
    }
    
    // فعال کردن پیش پرداخت در ابتدا
    advanceInput.disabled = false;
});
