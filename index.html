<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÛŒØ³ØªÙ… Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ ÛŒÙˆÙ†ÙˆÙ„ÛŒØª Ú©Ù„Ø´ÛŒâ€ŒÙÙˆÙ… - Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ v12.0</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary: #1e3a8a; --secondary: #3b82f6; --success: #10b981; --warning: #f59e0b;
            --danger: #ef4444; --info: #06b6d4; --light: #f8fafc; --dark: #0f172a; --gray: #64748b;
            --shadow: 0 10px 15px -3px rgba(0,0,0,0.1); --border-radius: 12px; --transition: all 0.3s ease;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Tahoma', 'Vazirmatn', system-ui, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); 
            min-height: 100vh; color: var(--dark); line-height: 1.6; 
        }

        .container { max-width: 1400px; margin: 0 auto; padding: 0 20px; }
        .grid { display: grid; gap: 20px; }
        .grid-cols-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        .d-none { display: none !important; }
        .w-100 { width: 100%; }
        .text-center { text-align: center; }

        .btn {
            padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; 
            transition: all 0.3s; font-size: 14px; display: inline-flex; align-items: center; gap: 8px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .btn-primary { background: var(--secondary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-info { background: var(--info); color: white; }
        .btn-sm { padding: 8px 16px; font-size: 13px; }

        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--dark); }
        .form-control {
            width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 8px; 
            font-size: 15px; transition: all 0.3s; background: white;
        }
        .form-control:focus { outline: none; border-color: var(--secondary); box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }

        .card { background: white; border-radius: 12px; box-shadow: var(--shadow); overflow: hidden; margin-bottom: 20px; }
        .card-header { 
            background: linear-gradient(135deg, var(--primary), #1e40af); color: white; 
            padding: 20px; display: flex; justify-content: space-between; align-items: center;
        }
        .card-title { font-size: 18px; font-weight: 700; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
        .stat-card { 
            background: linear-gradient(135deg, var(--secondary), #1d4ed8); color: white; 
            padding: 24px; border-radius: 12px; text-align: center; 
        }
        .stat-value { font-size: 28px; font-weight: 800; margin-bottom: 8px; }

        .table-container { overflow-x: auto; margin-top: 20px; }
        .table { width: 100%; border-collapse: collapse; }
        .table th { background: var(--primary); color: white; padding: 15px; text-align: right; font-weight: 600; }
        .table td { padding: 12px 15px; border-bottom: 1px solid #eee; text-align: right; }
        .table tr:hover { background: #f8f9ff; }

        .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 40px 20px; }
        .login-card { 
            background: white; border-radius: 20px; padding: 40px; width: 100%; max-width: 400px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .login-logo { 
            width: 80px; height: 80px; margin: 0 auto 24px; background: linear-gradient(135deg, var(--primary), var(--secondary)); 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; 
            font-size: 24px; font-weight: 800;
        }

        .main-nav { 
            background: var(--dark); display: flex; overflow-x: auto; padding: 0; 
            scrollbar-width: none; 
        }
        .main-nav::-webkit-scrollbar { display: none; }
        .nav-btn { 
            background: none; border: none; color: rgba(255,255,255,0.9); padding: 16px 20px; 
            cursor: pointer; white-space: nowrap; transition: all 0.3s; border-bottom: 3px solid transparent;
            display: flex; align-items: center; gap: 8px;
        }
        .nav-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .nav-btn.active { background: var(--secondary); color: white; }

        .page { display: none; padding: 20px; animation: fadeIn 0.5s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .product-row, .check-row { 
            display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 12px; align-items: center; 
            padding: 16px; background: #f8fafc; border-radius: 8px; margin-bottom: 12px; 
        }
        .totals-box { 
            background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 24px; 
            border-radius: 12px; margin: 24px 0;
        }
        .total-row { display: flex; justify-content: space-between; margin-bottom: 12px; }
        .total-row:last-child { font-size: 20px; font-weight: 800; border-top: 2px solid rgba(255,255,255,0.3); padding-top: 12px; }

        .loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid var(--secondary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .notification { 
            position: fixed; top: 20px; right: 20px; background: white; padding: 16px 20px; 
            border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); z-index: 10000; 
            border-right: 4px solid; display: flex; align-items: center; gap: 12px; max-width: 350px;
        }

        @media (max-width: 768px) { 
            .form-row, .product-row, .check-row { grid-template-columns: 1fr; } 
            .main-nav { flex-direction: column; } 
        }
    </style>
</head>
<body>
    <!-- Loading -->
    <div id="loading" class="loading" style="display: none;">
        <div class="spinner"></div>
        <div style="margin-top: 16px; font-weight: 600;">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
    </div>

    <!-- Notifications -->
    <div id="notifications"></div>

    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-card">
            <div class="login-logo">CF</div>
            <h2 style="text-align: center; margin-bottom: 24px; color: var(--dark);">Ø³ÛŒØ³ØªÙ… Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ Ú©Ù„Ø´ÛŒâ€ŒÙÙˆÙ…</h2>
            
            <div class="form-group">
                <label class="form-label">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ</label>
                <input type="text" id="username" class="form-control" value="admin" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ">
            </div>
            
            <div class="form-group">
                <label class="form-label">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
                <input type="password" id="password" class="form-control" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
            </div>
            
            <button class="btn btn-primary w-100" onclick="login()">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø³ÛŒØ³ØªÙ…</button>
            
            <div style="margin-top: 20px; text-align: center; font-size: 13px; color: var(--gray);">
                Ù¾ÛŒØ´â€ŒÙØ±Ø¶: <strong>admin / 1234</strong>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" style="display: none;">
        <!-- Header -->
        <header style="background: var(--dark); color: white; padding: 16px 24px; display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 16px;">
                <div style="width: 40px; height: 40px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--primary); font-weight: 800; font-size: 18px;">CF</div>
                <div>
                    <h3 style="margin: 0; font-size: 18px;">Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ ÛŒÙˆÙ†ÙˆÙ„ÛŒØª Ú©Ù„Ø´ÛŒâ€ŒÙÙˆÙ…</h3>
                    <div id="currentDate" style="font-size: 13px; opacity: 0.8;"></div>
                </div>
            </div>
            <div style="display: flex; gap: 12px; align-items: center;">
                <span id="userName" style="font-weight: 500;"></span>
                <button class="btn btn-danger btn-sm" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="main-nav" id="nav">
            <button class="nav-btn active" onclick="showPage('dashboard')">ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</button>
            <button class="nav-btn" onclick="showPage('contracts')">ğŸ“ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§</button>
            <button class="nav-btn" onclick="showPage('customers')">ğŸ‘¥ Ù…Ø´ØªØ±ÛŒØ§Ù†</button>
            <button class="nav-btn" onclick="showPage('checks')">ğŸ¦ Ú†Ú©â€ŒÙ‡Ø§</button>
            <button class="nav-btn" onclick="showPage('finance')">ğŸ’° Ù…Ø§Ù„ÛŒ</button>
            <button class="nav-btn" onclick="showPage('reports')">ğŸ“ˆ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§</button>
            <button class="nav-btn" onclick="showPage('backup')">ğŸ’¾ Ù¾Ø´ØªÛŒØ¨Ø§Ù†</button>
        </nav>

        <!-- Content -->
        <main class="container">
            <!-- Dashboard -->
            <div id="dashboard" class="page active">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">ğŸ“Š Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ</h3>
                        <button class="btn btn-success btn-sm" onclick="updateDashboard()">Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
                    </div>
                    <div class="stats-grid" id="stats"></div>
                </div>
            </div>

            <!-- Contracts -->
            <div id="contracts" class="page">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">ğŸ“ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø¬Ø¯ÛŒØ¯</h3>
                        <button class="btn btn-warning btn-sm" onclick="resetContract()">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</button>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Ù…Ø´ØªØ±ÛŒ</label>
                            <input type="text" id="contractCustomer" class="form-control" list="customerList" placeholder="Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ">
                        </div>
                        <div class="form-group">
                            <label>ØªÙ„ÙÙ†</label>
                            <input type="tel" id="contractPhone" class="form-control" placeholder="0912...">
                        </div>
                        <div class="form-group">
                            <label>ØªØ§Ø±ÛŒØ®</label>
                            <input type="date" id="contractDate" class="form-control">
                        </div>
                    </div>

                    <h4 style="margin: 20px 0 12px 0;">ğŸ“¦ Ù…Ø­ØµÙˆÙ„Ø§Øª</h4>
                    <div id="productsContainer"></div>
                    <button class="btn btn-info btn-sm" onclick="addProduct()">â• Ù…Ø­ØµÙˆÙ„</button>

                    <div class="form-group" style="margin-top: 20px;">
                        <label>Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª</label>
                        <input type="number" id="advancePayment" class="form-control" value="0" oninput="calcTotal()">
                    </div>

                    <h4 style="margin: 20px 0 12px 0;">ğŸ¦ Ú†Ú©â€ŒÙ‡Ø§</h4>
                    <div id="checksContainer"></div>
                    <button class="btn btn-info btn-sm" onclick="addCheck()">â• Ú†Ú©</button>

                    <div class="totals-box">
                        <div class="total-row"><span>Ø¬Ù…Ø¹ Ú©Ù„:</span><strong id="totalAmount">0 ØªÙˆÙ…Ø§Ù†</strong></div>
                        <div class="total-row"><span>Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª:</span><strong id="totalAdvance">0 ØªÙˆÙ…Ø§Ù†</strong></div>
                        <div class="total-row"><span>Ù…Ø§Ù†Ø¯Ù‡:</span><strong id="balance">0 ØªÙˆÙ…Ø§Ù†</strong></div>
                    </div>

                    <div style="display: flex; gap: 12px; margin-top: 24px;">
                        <button class="btn btn-success" onclick="saveContract()">âœ… Ø«Ø¨Øª</button>
                        <button class="btn btn-primary" onclick="printContract()">ğŸ–¨ï¸ Ú†Ø§Ù¾</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">ğŸ“‹ Ù„ÛŒØ³Øª Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§</h3>
                    </div>
                    <div class="table-container">
                        <table class="table" id="contractsTable">
                            <thead>
                                <tr><th>Ø´Ù…Ø§Ø±Ù‡</th><th>Ù…Ø´ØªØ±ÛŒ</th><th>Ù…Ø¨Ù„Øº</th><th>ØªØ§Ø±ÛŒØ®</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Other pages simplified -->
            <div id="customers" class="page">
                <div class="card">
                    <div class="card-header"><h3 class="card-title">ğŸ‘¥ Ù…Ø´ØªØ±ÛŒØ§Ù†</h3></div>
                    <div style="padding: 24px;">
                        <div class="form-row">
                            <div class="form-group"><label>Ù†Ø§Ù…</label><input id="newCustomerName" class="form-control"></div>
                            <div class="form-group"><label>ØªÙ„ÙÙ†</label><input id="newCustomerPhone" class="form-control" type="tel"></div>
                        </div>
                        <button class="btn btn-success" onclick="addCustomer()">â• Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†</button>
                        <div class="table-container" style="margin-top: 24px;">
                            <table class="table" id="customersTable"><thead><tr><th>Ù†Ø§Ù…</th><th>ØªÙ„ÙÙ†</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr></thead><tbody></tbody></table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="checks" class="page">
                <div class="card">
                    <div class="card-header"><h3 class="card-title">ğŸ¦ Ú†Ú©â€ŒÙ‡Ø§</h3></div>
                    <div style="padding: 24px;">
                        <div class="table-container">
                            <table class="table" id="checksTable"><thead><tr><th>Ø´Ù…Ø§Ø±Ù‡</th><th>Ù…Ø´ØªØ±ÛŒ</th><th>Ù…Ø¨Ù„Øº</th><th>Ø³Ø±Ø±Ø³ÛŒØ¯</th><th>ÙˆØ¶Ø¹ÛŒØª</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr></thead><tbody></tbody></table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Simplified other pages -->
            <div id="finance" class="page"><div class="card"><div class="card-header"><h3 class="card-title">ğŸ’° Ù…Ø§Ù„ÛŒ</h3></div><div style="padding: 24px;">Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø§Ù„ÛŒ Ú©Ø§Ù…Ù„</div></div></div>
            <div id="reports" class="page"><div class="card"><div class="card-header"><h3 class="card-title">ğŸ“ˆ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§</h3></div><div style="padding: 24px;">Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ù…Ù„</div></div></div>
            <div id="backup" class="page"><div class="card"><div class="card-header"><h3 class="card-title">ğŸ’¾ Ù¾Ø´ØªÛŒØ¨Ø§Ù†</h3></div><div style="padding: 24px;"><button class="btn btn-success" onclick="backupData()">ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù¾Ø´ØªÛŒØ¨Ø§Ù†</button></div></div></div>
        </main>
    </div>

    <datalist id="customerList"></datalist>

    <script>
        // Simple data storage
        let data = JSON.parse(localStorage.getItem('kaleshiData')) || {
            customers: [
                {id: 1, name: 'Ø¹Ù„ÛŒ Ù…Ø­Ù…Ø¯ÛŒ', phone: '09121234567'},
                {id: 2, name: 'Ø±Ø¶Ø§ Ø§Ø­Ù…Ø¯ÛŒ', phone: '09129876543'}
            ],
            contracts: [],
            checks: []
        };

        let currentUser = null;
        let productId = 0;
        let checkId = 0;

        // Notifications
        function showNotification(message, type = 'success') {
            const notif = document.createElement('div');
            notif.className = 'notification';
            notif.style.borderRightColor = type === 'success' ? '#10b981' : '#ef4444';
            notif.innerHTML = `
                <span>${type === 'success' ? 'âœ…' : 'âŒ'}</span>
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" style="background: none; border: none; font-size: 18px; cursor: pointer;">Ã—</button>
            `;
            document.getElementById('notifications').appendChild(notif);
            setTimeout(() => notif.remove(), 4000);
        }

        // Login - FIXED
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (username === 'admin' && password === '1234') {
                currentUser = { name: 'Ù…Ø¯ÛŒØ± Ø³ÛŒØ³ØªÙ…' };
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                document.getElementById('userName').textContent = currentUser.name;
                document.getElementById('currentDate').textContent = new Date().toLocaleDateString('fa-IR');
                initApp();
                showNotification('ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚!');
            } else {
                showNotification('Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª', 'error');
            }
        }

        function logout() {
            if (confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) {
                document.getElementById('mainApp').style.display = 'none';
                document.getElementById('loginPage').style.display = 'flex';
                currentUser = null;
            }
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            event.target.closest('button').classList.add('active');
            
            if (pageId === 'contracts') loadContracts();
            if (pageId === 'customers') loadCustomers();
            if (pageId === 'checks') loadChecks();
        }

        function initApp() {
            updateDashboard();
            loadCustomers();
            resetContractForm();
        }

        // Dashboard
        function updateDashboard() {
            const stats = document.getElementById('stats');
            stats.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${data.contracts.length}</div>
                    <div>Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #10b981, #059669);">
                    <div class="stat-value">${data.customers.length}</div>
                    <div>Ù…Ø´ØªØ±ÛŒØ§Ù†</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                    <div class="stat-value">${data.checks.length}</div>
                    <div>Ú†Ú©â€ŒÙ‡Ø§</div>
                </div>
            `;
        }

        // Contracts
        function resetContractForm() {
            document.getElementById('contractCustomer').value = '';
            document.getElementById('contractPhone').value = '';
            document.getElementById('advancePayment').value = '0';
            document.getElementById('productsContainer').innerHTML = '';
            document.getElementById('checksContainer').innerHTML = '';
            productId = 0;
            checkId = 0;
            addProduct();
            addCheck();
            calcTotal();
        }

        function addProduct() {
            const container = document.getElementById('productsContainer');
            const id = productId++;
            container.innerHTML += `
                <div class="product-row">
                    <input type="text" id="prodName${id}" placeholder="Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„" class="form-control" oninput="calcTotal()">
                    <input type="number" id="prodQty${id}" placeholder="Ù…Ù‚Ø¯Ø§Ø±" class="form-control" oninput="calcTotal()">
                    <input type="number" id="prodPrice${id}" placeholder="Ù‚ÛŒÙ…Øª" class="form-control" oninput="calcTotal()">
                    <button class="btn btn-danger btn-sm" onclick="this.parentElement.remove(); calcTotal()">Ø­Ø°Ù</button>
                </div>
            `;
        }

        function addCheck() {
            const container = document.getElementById('checksContainer');
            const id = checkId++;
            container.innerHTML += `
                <div class="check-row">
                    <input type="text" id="checkNum${id}" placeholder="Ø´Ù…Ø§Ø±Ù‡ Ú†Ú©" class="form-control">
                    <input type="number" id="checkAmt${id}" placeholder="Ù…Ø¨Ù„Øº" class="form-control" oninput="calcTotal()">
                    <input type="date" id="checkDue${id}" class="form-control">
                    <button class="btn btn-danger btn-sm" onclick="this.parentElement.remove(); calcTotal()">Ø­Ø°Ù</button>
                </div>
            `;
        }

        function calcTotal() {
            let totalProducts = 0;
            let totalChecks = 0;
            const advance = parseInt(document.getElementById('advancePayment').value) || 0;

            // Calculate products
            for (let i = 0; i < 50; i++) {
                const name = document.getElementById(`prodName${i}`);
                const qty = document.getElementById(`prodQty${i}`);
                const price = document.getElementById(`prodPrice${i}`);
                if (name && qty && price && qty.value && price.value) {
                    totalProducts += parseInt(qty.value) * parseInt(price.value);
                }
            }

            // Calculate checks
            for (let i = 0; i < 50; i++) {
                const amt = document.getElementById(`checkAmt${i}`);
                if (amt && amt.value) {
                    totalChecks += parseInt(amt.value);
                }
            }

            document.getElementById('totalAmount').textContent = totalProducts.toLocaleString() + ' ØªÙˆÙ…Ø§Ù†';
            document.getElementById('totalAdvance').textContent = advance.toLocaleString() + ' ØªÙˆÙ…Ø§Ù†';
            document.getElementById('balance').textContent = (totalProducts + totalChecks - advance).toLocaleString() + ' ØªÙˆÙ…Ø§Ù†';
        }

        function saveContract() {
            const customer = document.getElementById('contractCustomer').value;
            if (!customer) {
                showNotification('Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª', 'error');
                return;
            }

            const contract = {
                id: Date.now(),
                number: 'CF-' + (data.contracts.length + 1).toString().padStart(3, '0'),
                customer: customer,
                phone: document.getElementById('contractPhone').value,
                date: document.getElementById('contractDate').value || new Date().toISOString().split('T')[0],
                products: [],
                checks: [],
                advance: parseInt(document.getElementById('advancePayment').value) || 0
            };

            // Get products
            for (let i = 0; i < 50; i++) {
                const name = document.getElementById(`prodName${i}`);
                const qty = document.getElementById(`prodQty${i}`);
                const price = document.getElementById(`prodPrice${i}`);
                if (name?.value && qty?.value && price?.value) {
                    contract.products.push({
                        name: name.value,
                        qty: parseInt(qty.value),
                        price: parseInt(price.value)
                    });
                }
            }

            // Get checks
            for (let i = 0; i < 50; i++) {
                const num = document.getElementById(`checkNum${i}`);
                const amt = document.getElementById(`checkAmt${i}`);
                const due = document.getElementById(`checkDue${i}`);
                if (num?.value && amt?.value) {
                    contract.checks.push({
                        number: num.value,
                        amount: parseInt(amt.value),
                        due: due?.value || ''
                    });
                    data.checks.push({
                        id: Date.now() + i,
                        number: num.value,
                        customer: customer,
                        amount: parseInt(amt.value),
                        due: due?.value || '',
                        status: 'Ø¯Ø± Ø¬Ø±ÛŒØ§Ù†'
                    });
                }
            }

            data.contracts.push(contract);
            localStorage.setItem('kaleshiData', JSON.stringify(data));
            showNotification('Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø«Ø¨Øª Ø´Ø¯!');
            loadContracts();
            resetContractForm();
        }

        function loadContracts() {
            const tbody = document.querySelector('#contractsTable tbody');
            tbody.innerHTML = data.contracts.map(c => `
                <tr>
                    <td>${c.number}</td>
                    <td>${c.customer}</td>
                    <td>${c.products.reduce((sum, p) => sum + (p.qty * p.price), 0).toLocaleString()} ØªÙˆÙ…Ø§Ù†</td>
                    <td>${c.date}</td>
                    <td>
                        <button class="btn btn-info btn-sm" onclick="editContract(${c.id})">ÙˆÛŒØ±Ø§ÛŒØ´</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteContract(${c.id})">Ø­Ø°Ù</button>
                    </td>
                </tr>
            `).join('');
        }

        function deleteContract(id) {
            if (confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) {
                data.contracts = data.contracts.filter(c => c.id !== id);
                localStorage.setItem('kaleshiData', JSON.stringify(data));
                loadContracts();
                showNotification('Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø­Ø°Ù Ø´Ø¯');
            }
        }

        // Customers
        function loadCustomers() {
            const tbody = document.querySelector('#customersTable tbody');
            tbody.innerHTML = data.customers.map(c => `
                <tr>
                    <td>${c.name}</td>
                    <td>${c.phone}</td>
                    <td><button class="btn btn-danger btn-sm" onclick="deleteCustomer(${c.id})">Ø­Ø°Ù</button></td>
                </tr>
            `).join('');
            
            const datalist = document.getElementById('customerList');
            datalist.innerHTML = data.customers.map(c => `<option value="${c.name}">`).join('');
        }

        function addCustomer() {
            const name = document.getElementById('newCustomerName').value;
            const phone = document.getElementById('newCustomerPhone').value;
            if (name && phone) {
                data.customers.push({ id: Date.now(), name, phone });
                localStorage.setItem('kaleshiData', JSON.stringify(data));
                loadCustomers();
                document.getElementById('newCustomerName').value = '';
                document.getElementById('newCustomerPhone').value = '';
                showNotification('Ù…Ø´ØªØ±ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯');
            }
        }

        function deleteCustomer(id) {
            data.customers = data.customers.filter(c => c.id !== id);
            localStorage.setItem('kaleshiData', JSON.stringify(data));
            loadCustomers();
        }

        // Checks
        function loadChecks() {
            const tbody = document.querySelector('#checksTable tbody');
            tbody.innerHTML = data.checks.map(c => `
                <tr>
                    <td>${c.number}</td>
                    <td>${c.customer}</td>
                    <td>${c.amount.toLocaleString()} ØªÙˆÙ…Ø§Ù†</td>
                    <td>${c.due}</td>
                    <td>${c.status}</td>
                    <td>
                        <button class="btn btn-success btn-sm">ÙˆØµÙˆÙ„</button>
                        <button class="btn btn-danger btn-sm">Ø­Ø°Ù</button>
                    </td>
                </tr>
            `).join('');
        }

        // Backup
        function backupData() {
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'backup-kaleshi.json';
            a.click();
            showNotification('Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯');
        }

        // Enter key for login
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && document.getElementById('loginPage').style.display !== 'none') {
                login();
            }
        });

        // Auto-login demo (remove in production)
        window.onload = function() {
            document.getElementById('contractDate').valueAsDate = new Date();
        };
    </script>
</body>
</html>
